function EventEmitter(){this.lists={},this.queue={},this.links={}}function EventHandler(e,t,i,n){if("function"!=typeof e)throw Error("EventHandler expects function as 1st argument");this.func=e,this.scope=t,this.data=null==i?[]:[].concat(i),this.once=n,this.listens=[]}function Observable(e,t,i,n,s){this.id=++Observable.count,this.value=e,this.targets={},this.sources={},this.set(t,i,n,s)}function Timer(e,t){this.func=e,this.scope=t}function Defer(){this.set.apply(this,arguments),this.pending=!0}function Gate(e,t){this.inputs={},this.method=e,this.value=t,this.events=new EventEmitter}function Loader(){this.reset(),this.data={}}function Drag(e){this.element=e,this.events=new EventEmitter,this.offset={x:0,y:0},this.origin={x:0,y:0},this.point={x:0,y:0},this.mouse={x:0,y:0},this.begin={x:0,y:0},this.delta={x:0,y:0},this.scale={x:1,y:1},this.moves=0,this.min={x:-(1/0),y:-(1/0)},this.max={x:1/0,y:1/0},this.bind("mousedown",this.element),this.bind("touchstart",this.element)}function Momentum(){this.speed={x:0,y:0,z:0},this.point={x:0,y:0,z:0},this.delta={x:0,y:0,z:0},this.target={x:0,y:0,z:0},this.points=[]}function FileImport(){this.element=dom.div("file-import hand"),this.events=new EventEmitter,this.input=dom.input("file"),this.input.setAttribute("accept",".json"),this.input.setAttribute("multiple","multiple"),Atlas.set(this.element,"i-file-load","absmid"),dom.on("change",this.input,f.binds(this.onInputChange,this)),dom.on("tap",this.element,f.binds(this.input.click,this.input))}function TileView(){this.events=new EventEmitter,this.element=dom.div("tile-view"),this.econtent=dom.div("tile-content",this.element),this.ehelpers=dom.div("tile-helpers",this.element),this.setClients(),this.setLayout()}function PointProjector(e){this.camera=e,this.points=[],this.matrix=new THREE.Matrix4,this.inverse=new THREE.Matrix4,this.viewport=new THREE.Vector3}function Imagery(){this.get=new Loader,this.list={},this.submaterialIndex=0,this.slotIndex=0,this.products={},this.productsList=[],this.obvMaterialsList=new Observable([]),this.obvProductsLoaded=new Observable(!1),this.pixel=this.makePixel("white"),this.bump=this.makePixel("black"),this.normal=this.makePixel("rgb(127, 127, 255)"),this.buffer=document.createElement("canvas"),this.btx=this.buffer.getContext("2d");var e=this.pixel.image;this.skybox=new THREE.CubeTexture([e,e,e,e,e,e]),this.skybox.needsUpdate=!0,this.baseMaps={norcon:{color:16777215},subtract:{color:16726391},wireframe:{},normal:{},void:{}},this.materials={},this.usedProducts={};for(var t in this.baseMaps)this.addMaterial(t),this.setMaterial(t,null);this.materials.flume=this.materials.pipe=this.materials.drain,this.materials.flat=this.materials.floor,this.materials.slope=this.materials.roof,this.materials.Material__26=this.materials.black,this.materials.wire_000000000=this.materials.gold}function Sampler(){this.samples=[]}function Sample(e,t){for(var i in e)this[i]=e[i];this.progress=0,this.parent=t,this.joints=[],this.meshes=[],this.box=new THREE.Box3,this.boxSize=new THREE.Vector3,this.boxCenter=new THREE.Vector3,this.boxLength=1,null==this.id&&(this.id=f.range(10).map(f.randchar).join("")),this.src&&(this.name=this.src.replace(/\.[^\.]*$/,"").split("/").pop()),this.object?this.configure(this.object):this.src&&(this.format=this.src.replace(/^.*\.([^.]+)$/,"$1").toLowerCase())}function SampleJoint(e){var t=e.name.slice(1).split("_");this.object=e,this.name=e.name,this.parts=t,this.id=t[0],this.param=t[1],this.extra=t[2],this.depth=t[3],this.point=new THREE.Vector3,this.normal=new THREE.Vector3,this.up=new THREE.Vector3,this.matrix=new THREE.Matrix4,this.setFromMatrix(e.matrixWorld)}f={},f.nop=function(){},f.identity=function(e){return e},f.sum=function(e,t){return e+t},f.sub=function(e,t){return e-t},f.nsort=function(e,t){var i=t?-1:1;return function(t,n){return null==t||null==n?-1:i*(t[e]-n[e])}},f.zerosort=function(e,t){return e&&t?e[0]-t[0]:0},f.sort=function(e,t,i){for(var n=e.length,s=[],r=0;r<n;r++){var o=e[r];s.push([t.call(i,o),o])}s.sort(f.zerosort);for(var r=0;r<n;r++)e[r]=s[r][1];return e},f.max=function(e){return Math.max.apply(0,e)},f.min=function(e){return Math.min.apply(0,e)},f.amap=function(e,t,i,n,s,r){if(e&&e.length&&"function"==typeof t)for(var o=0,a=[];o<e.length;o++)a.push(t.call(i,e[o],n,s,r));return a},f.atog=function(e,t,i){if(e){for(var n=e.length-1;n>=0;n--)if(e[n]===t){if(i)return;e.splice(n,1)}i&&e.push(t)}},f.apick=function(e,t,i,n){if(e)for(var s,r=0,o=e.length;r<o;r++)if(s=e[r],(s&&s[t]===i)^n)return s},f.apickf=function(e,t,i,n){if(e)for(var s,r=0,o=e.length;r<o;r++)if(s=e[r],t.call(i,s)^n)return s},f.afind=function(e,t,i,n){if(e)for(var s,r=0,o=e.length,a=[];r<o;r++)s=e[r],(s&&s[t]===i)^n&&a.push(s);return a},f.afindf=function(e,t,i,n){if(e)for(var s,r=0,o=e.length,a=[];r<o;r++)s=e[r],t.call(i,s)^n&&a.push(s);return a},f.adiff=function(e,t){for(var i={prev:t||[],next:e||[],rem:[],remi:[],remc:0,add:[],addi:[],addc:0},n=i.prev.length-1;n>=0;n--){var s=i.prev[n],r=i.next.indexOf(s);r===-1&&(i.rem.push(s),i.remi.push(n),i.remc++)}for(var r=0;r<i.next.length;r++){var s=i.next[r],n=i.prev.indexOf(s);n===-1&&(i.add.push(s),i.addi.push(r),i.addc++)}return i},f.adrop=function(e,t){var i=e.indexOf(t);return~i&&e.splice(i,1),e},f.aflat=function(e){return[].concat.apply([],e)},f.jeq=function(e,t){if(e===t)return!0;var i=typeof e,n=typeof t;if(i!==n)return!1;switch(i){case"boolean":case"number":case"string":return!1}if(e.length!==t.length)return!1;var s;for(s in e)if(s in t==!1)return!1;for(s in t)if(!f.jeq(e[s],t[s]))return!1;return!0},f.seq=function(e,t){return e.length===t.length&&0===f.snot(e,t).length},f.sor=function(){for(var e=[],t=0;t<arguments.length;t++){var i=arguments[t];if(i)for(var n=0;n<i.length;n++){var s=i[n];e.indexOf(s)===-1&&e.push(s)}}return e},f.sand=function(e,t){if(!e||!t)return[];for(var i=[],n=0,s=e.length;n<s;n++){var r=e[n];t.indexOf(r)!==-1&&i.indexOf(r)===-1&&i.push(r)}return i},f.sxor=function(e,t){if(!e||!t)return e?e:t?t:[];for(var i=[].concat(e,t),n=i.length-1;n>=0;n--){var s=i.indexOf(i[n]);n!==s&&(i.splice(n,1),i.splice(s,1),n--)}return i},f.snot=function(e,t){e=e||[],t=t||[];for(var i=[],n=0,s=e.length;n<s;n++){var r=e[n];t.indexOf(r)===-1&&i.indexOf(r)===-1&&i.push(r)}return i},f.uniqp=function(e,t){return function(i,n,s){return!e^s.indexOf(i)===(t?s.lastIndexOf(i):n)}},f.uniq=function(e,t,i){return i.indexOf(e)===t},f.uniqi=function(e,t,i){return i.indexOf(e)!==t},f.uniqm=function(e,t,i){return i.indexOf(e)===i.lastIndexOf(e)},f.uniqim=function(e,t,i){return i.indexOf(e)!==i.lastIndexOf(e)},f.clamp=function(e,t,i){return e<t?t:e>i?i:e},f.rand=function(e){return Math.floor(Math.random()*(+e||1))},f.any=function(e){return e&&e[f.rand(e.length)]},f.charmap="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",f.randchar=function(){return f.any(f.charmap)},f.exp=function(e){var t=0,i=Math.abs(e);if(0===i||!isFinite(i))return i;if(i<1)for(;Math.pow(10,t)>i;)t--;else for(;Math.pow(10,t+1)<=i;)t++;return t},f.hround=function(e){return Math.round(100*e)/100},f.pround=function(e,t){var i=+t||0;if(i<0){var n=Math.pow(10,-i);return Math.round(e/n)*n}var n=Math.pow(10,i);return Math.round(e*n)/n},f.mround=function(e,t){return f.pround(e,t-f.exp(e))},f.xrad=Math.PI/180,f.torad=function(e){return e*f.xrad},f.xdeg=180/Math.PI,f.todeg=function(e){return e*f.xdeg},f.radist=function(e){return Math.abs(e)>Math.PI?e-2*Math.PI*Math.ceil(Math.floor(Math.abs(e)/Math.PI)/2)*(e<0?-1:1):e},f.prop=function(e){var t=arguments;return function(e){for(var i=0;e&&i<t.length;i++)e=e[t[i]];return e}},f.pset=function(e,t){return function(i){i[e]=t}},f.func=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);return function(i){return i[e]&&i[e].apply&&i[e].apply(i,t)}},f.range=function(e){e=+e||0;for(var t=[],i=0;i<e;i++)t.push(i);return t},f.rangep=function(e,t,i){e=isNaN(e)?0:+e,t=null==t?0:t,i=null==i?"number"==typeof t?1:0:i;for(var n=[],s=0;s<e;s++)n.push(i?s*i+t:t);return n},f.qsenc=function(e,t){t||(t="&=");var i=[];for(var n in e){var s=encodeURIComponent(n),r=e[n];if(null!=r)if(r instanceof Array)for(var o=0;o<r.length;o++)i.push(s+t[1]+encodeURIComponent(r[o]));else i.push(s+t[1]+encodeURIComponent(r))}return i.join(t[0])},f.qsdec=function(e,t){t||(t="&=");for(var i={},n=e.split(t[0]),s=0;s<n.length;s++){var r=n[s].split(t[1]),o=decodeURIComponent(r[0]),a=decodeURIComponent(r[1]);if(o in i){var l=i[o];l instanceof Array?l.push(a):i[o]=[l,a]}else i[o]=a}return i},f.follow=function(e,t){for(var i=[];e;e=e[t])i.push(e);return i},f.copy=function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},f.copylist=function(e,t,i){for(var n in t)i.indexOf(n)!==-1&&Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},f.merge=function(){for(var e={},t=0;t<arguments.length;t++)f.copy(e,arguments[t]);return e},f.throttle=function(e,t){var i=0;return function(){var n=new Date;if(n-i>e)return i=n,t.apply(this,arguments)}},f.postpone=function(e,t){var i;return function(){clearTimeout(i),i=setTimeout(t,e)}},f.implode=function(e,t,i,n){return i||(i=/#\{(\w+)\}/g),e.replace(i,function(e,i){return i in t?t[i]:n?e:""})},f.nzformat=function(e,t){if(isNaN(e))return e+"";var i=Math.abs(e),n=t-Math.max(0,f.exp(i)),s=n>1?Array(n).join("0"):"";return(e<i?"-":"")+s+i},f.nformat=function(e,t,i){var n=Math.abs(e),s=e<n,r=isNaN(e)?2:f.exp(n),o=i?"0":" ",a=t-Math.max(0,r)-s-1,l=a>1?Array(a).join(o):"",h=i&&s?"-":o,c=!i&&s?e:n;return h+l+c},f.dformat=function(e,t){var i={Y:"getFullYear",M:"getMonth",D:"getDate",h:"getHours",i:"getMinutes",s:"getSeconds"},n={M:1};return t.replace(/([YMDhis])(\1+)?/g,function(t,s){return f.nzformat(e[i[s]]()+(n[s]||0),t.length)})},f.rgb=function(e){return"rgb("+[255*e[0]|0,255*e[1]|0,255*e[2]|0]+")"},f.rgba=function(e,t){return"rgba("+[255*e[0]|0,255*e[1]|0,255*e[2]|0].concat(isNaN(t)?1:+t)+")"},f.rcolor=function(e){return"rgba("+[255,255,255].map(f.rand).concat(+e||1)+")"},f.softcolor=function(e){var t=2*Math.PI,i=t*e;return[Math.cos(i)/2+.5,Math.cos(i+2/3*t)/2+.5,Math.cos(i+1/3*t)/2+.5]},f.mitm=function(e,t,i,n){var s=e[t],r="function"==typeof s;e[t]=function(){var e=i.call(this,t,arguments,s);return n?e:r?s.apply(this,arguments):s}},f.inspect=function(e,t){for(var i in e)"function"==typeof e[i]&&f.mitm(e,i,t)},f.binds=function(e,t){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){return e.apply(t,arguments)}},f.binda=function(e,t,i){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){return e.apply(t,i)}},f.bindr=function(e,t,i,n){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){for(var s=[],r=0,o=0;o<i.length;o++)s.push(i[o]===n?arguments[r++]:i[o]);for(;r<arguments.length;)s.push(arguments[r++]);return e.apply(t,s)}},f.unit=function(parent,object){arguments.length<2&&(object=parent,parent=null);var proto=parent?f.copy(Object.create(parent.prototype),object):object,Unit=eval("(function "+(proto.unitName||"Unit")+'() {if(typeof this.init === "function") this.init.apply(this, arguments)})');return Unit.New=function(){var e=Object.create(Unit.prototype);return Unit.apply(e,arguments),e},Unit.prototype=proto,proto.protochain=proto.protochain?proto.protochain.concat(proto):[proto],proto.constructor=Unit,Unit},!function(){if(Date.now||(Date.now=function(){return(new Date).getTime()}),window.performance||(window.performance={}),!window.performance.now){var e=window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:Date.now();window.performance.now=function(){return Date.now()-e}}}(),!function(){function e(e){1===e.which&&(r=e)}function t(e){s(r,e,e,!1),r=null}function i(e){o=e.changedTouches[0]}function n(e){s(o,e.changedTouches[0],e,!0),o=null}function s(e,t,i,n){if(e){var s=t.pageX-e.pageX,r=t.pageY-e.pageY,o=n?64:25;if(!(s*s+r*r>o)){var l=window.performance.now();if(!(l-a<50&&i.isTrusted)){a=l;var h=new MouseEvent("tap",{bubbles:!0,cancelable:!0,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,altKey:i.altKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,metaKey:i.metaKey,view:i.view});h.touch=n,i.target.dispatchEvent(h)}}}}var r,o,a;try{new MouseEvent("tap")}catch(e){window.MouseEvent=function(e,t){var i=document.createEvent("MouseEvents");return i.initMouseEvent(e,t.bubbles,t.cancelable,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),i}}document.addEventListener("touchstart",i,!0),document.addEventListener("touchend",n,!0),document.addEventListener("mousedown",e,!0),document.addEventListener("mouseup",t,!0)}(),Function.prototype.bind||(Function.prototype.bind=function(e){var t=Array.prototype.slice.call(arguments,1),i=this;return function(){var n=Array.prototype.slice.call(arguments);return i.apply(e,t.concat(n))}}),window.requestAnimationFrame=window.requestAnimationFrame||window.ORequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.OCancelAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout,dom={},dom.one=function(e,t){return(t||document).querySelector(e)},dom.all=function(e,t){return[].slice.call((t||document).querySelectorAll(e))},dom.elem=function(e,t,i){var n=document.createElement(e);return t&&(n.className=t),i&&i.appendChild(n),n},dom.span=function(e,t){return dom.elem("span",e,t)},dom.div=function(e,t){return dom.elem("div",e,t)},dom.input=function(e,t,i){var n=dom.elem("input",t,i);return n.setAttribute("type",e),n},dom.option=function(e,t,i){var n=dom.elem("option",null,i);return dom.text(n,t),n.value=e,n},dom.img=function(e,t,i){var n=dom.elem("img",t,i);return e&&(n.src=e),n},dom.a=function(e,t,i){var n=dom.elem("a",t,i);return e&&(n.href=e),n},dom.append=function(e,t){if(e instanceof Node)for(var i=1;i<arguments.length;i++){var t=arguments[i];t instanceof Node&&e.appendChild(t)}return e},dom.prepend=function(e,t){e instanceof Node&&t instanceof Node&&e.insertBefore(t,e.firstChild)},dom.insert=function(e,t,i){e instanceof Node&&t instanceof Node&&e.insertBefore(t,i instanceof Node?i:null)},dom.remove=function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t&&t.parentNode&&t.parentNode.removeChild(t)}},dom.empty=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},dom.children=function(){function e(e){return e.nodeType===Node.ELEMENT_NODE}var t=Array.prototype.slice;return function(i){return t.call(i.childNodes).filter(e)}}(),dom.ancestor=function(e,t){for(;e;){if(e===t)return!0;e=e.parentNode}},dom.onceover=function(e,t){return!dom.ancestor(e.relatedTarget,t)&&dom.ancestor(e.target,t)},dom.onceout=function(e,t){return!dom.ancestor(e.relatedTarget,t)},dom.on=function(e,t,i,n){t.addEventListener(e,i,!!n)},dom.off=function(e,t,i,n){t.removeEventListener(e,i,!!n)},dom.pos=function(e,t,i){e&&(null!=t&&(e.style.left="number"==typeof t?Math.round(t)+"px":t),null!=i&&(e.style.top="number"==typeof i?Math.round(i)+"px":i))},dom.size=function(e,t,i){e&&(null!=t&&(e.style.width="number"==typeof t?Math.round(t)+"px":t),null!=t&&(e.style.height="number"==typeof i?Math.round(i)+"px":i))},dom.style=function(e,t){f.copy(e.style,t)},dom.xstyle=function(e,t,i){var n=e.style;n["-webkit-"+t]=i,n["-moz-"+t]=i,n["-ms-"+t]=i,n["-o-"+t]=i,n[t]=i},dom.html=function(e,t){e.innerHTML=t},dom.text=function(e,t){e.textContent=t},dom.display=function(e,t,i){e.style.display=t?null!=i?i:"block":"none"},dom.visible=function(e,t){e.style.visibility=t?"visible":"hidden"},dom.respace=/\s+/,dom.addclass=function(e,t){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),n=t.split(dom.respace).filter(Boolean),s=f.sor(i,n);f.snot(s,i).length&&(e.className=s.join(" "))}},dom.remclass=function(e,t){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),n=t.split(dom.respace).filter(Boolean),s=f.snot(i,n);f.snot(i,s).length&&(e.className=s.join(" "))}},dom.hasclass=function(e,t,i){if(e&&t){var n=e.className.split(dom.respace).filter(Boolean),s=t.split(dom.respace).filter(Boolean),r=f.sand(n,s).length;return i?r:r===s.length}},dom.togclass=function(e,t,i){e&&t&&(arguments.length<3&&(i=!dom.hasclass(e,t)),(i?dom.addclass:dom.remclass)(e,t))},dom.setclass=function(e,t){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),n=i.slice();for(var s in t)f.atog(n,s,!!t[s]);f.sxor(i,n).length&&(e.className=n.join(" "))}},dom.offset=function(e,t,i){for(var n=0,s=0;e&&e!==t;e=e.offsetParent)n+=e.offsetLeft||0,s+=e.offsetTop||0,i&&(n-=e.scrollLeft||0,s-=e.scrollTop||0);return{x:n,y:s}},dom.out=function(e){var t=dom.div(null,document.body),i=dom.elem("textarea",null,document.body);dom.style(t,{top:0,left:0,width:"100%",height:"100%",position:"absolute",zIndex:9e3}),dom.style(i,{left:.1*window.innerWidth+"px",top:.1*window.innerHeight+"px",width:.8*window.innerWidth+"px",height:.8*window.innerHeight+"px",position:"absolute",zIndex:9001,whiteSpace:"nowrap",font:"11px monospace"}),dom.text(i,e),dom.on("click",t,function(){dom.remove(i,t)}),i.focus()},dom.ready=function(e){function t(){document.removeEventListener("DOMContentLoaded",t),window.removeEventListener("load",t),e()}"complete"===document.readyState?e():(document.addEventListener("DOMContentLoaded",t),window.addEventListener("load",t))},kbd={name:{L_ARR:37,U_ARR:38,R_ARR:39,D_ARR:40,SHIFT:16,CTRL:17,ALT:18,CAPS:20,ESC:27,SPACE:32,DEL:46,ENTER:13,TAB:9,BKSP:8,"`":192,"-":189,"=":187,"[":219,"]":221,"\\":220,";":186,"'":222,",":188,".":190,"/":191},map:[],state:{},init:function(){kbd.setmap(),kbd.reset(),window.addEventListener("keydown",kbd.onkeydown,!0),window.addEventListener("keyup",kbd.onkeyup,!0)},setmap:function(){for(var e=48;e<=57;e++)kbd.map[e]=String.fromCharCode(e);for(var e=65;e<=90;e++)kbd.map[e]=String.fromCharCode(e).toLowerCase();for(var t in kbd.name)kbd.map[kbd.name[t]]=t},reset:function(){for(var e=0;e<255;e++)kbd.state[kbd.map[e]]=0},onkeydown:function(e){kbd.setkey(e,1)},onkeyup:function(e){kbd.setkey(e,0)},setkey:function(e,t){kbd.event=e,kbd.down=t,kbd.key=kbd.map[e.keyCode],kbd.changed=kbd.state[kbd.key]!==kbd.down,kbd.state[kbd.key]=kbd.down,kbd.state.SHIFT=+e.shiftKey,kbd.state.CTRL=+e.ctrlKey,kbd.state.ALT=+e.altKey;var i=[];kbd.state.CTRL&&i.push("CTRL"),kbd.state.ALT&&i.push("ALT"),kbd.state.SHIFT&&i.push("SHIFT"),"CTRL"!==kbd.key&&"ALT"!==kbd.key&&"SHIFT"!==kbd.key&&i.push(kbd.key),kbd.seq=i.join("+")}},kbd.init();var perf={precision:4,values:{},time:function(){return window.performance&&window.performance.now?window.performance.now():Date.now?Date.now():(new Date).getTime()},start:function(e){var t=perf.values[e];t||(t=perf.values[e]={totalTime:0,totalCycles:0,totalBest:1/0,totalWorst:-(1/0),localTime:0,localCycles:0,localBest:1/0,localWorst:-(1/0),lastTime:0,startTime:0}),t.startTime=perf.time()},end:function(e,t){var i=perf.values[e];i&&(i.lastTime=perf.time()-i.startTime,i.startTime=0,i.totalCycles++,i.localCycles++,i.totalBest=Math.min(i.totalBest,i.lastTime),i.totalWorst=Math.max(i.totalWorst,i.lastTime),i.localBest=Math.min(i.localBest,i.lastTime),i.localWorst=Math.max(i.localWorst,i.lastTime),i.totalTime+=i.lastTime,i.localTime+=i.lastTime,i.localCycles>=t&&perf.show(e))},flushLocal:function(e){var t=perf.values[e];t&&(t.localTime=0,t.localCycles=0,t.localBest=1/0,t.localWorst=-(1/0))},show:function(e,t){var i=perf.values[e];return i?(console.log("perf",e+":",f.mround(i.localTime/i.localCycles,perf.precision),"avg,",f.mround(i.localBest,perf.precision),"best,",f.mround(i.localWorst,perf.precision),"worst,",f.mround(i.localTime,perf.precision),"ms,",i.localCycles,"cycles,",i.totalCycles,"total cycles,",f.mround(i.totalTime/i.totalCycles,perf.precision),"total avg"),void(t||perf.flushLocal(e))):console.log("perf: no",e)},monitor:function(e,t){setInterval(perf.show,t||1e3,e)}},TWEEN={tweens:[],getAll:function(){return TWEEN.tweens},removeAll:function(){for(var e=TWEEN.tweens.length-1;e>=0;e--)TWEEN.tweens[e].drop=!0},add:function(e){e.drop=!1,TWEEN.tweens.indexOf(e)===-1&&TWEEN.tweens.push(e)},remove:function(e){e.playing=!1,e.drop=!0},loop:function(){TWEEN.update(),TWEEN.timer=requestAnimationFrame(TWEEN.loop)},loopEnd:function(){cancelAnimationFrame(TWEEN.timer)},update:function(e){var t=TWEEN.tweens.length;if(!t)return!1;e=isNaN(e)?window.performance.now():+e;for(var i=t-1;i>=0;i--){var n=TWEEN.tweens[i];!n.drop&&n.update(e)||TWEEN.tweens.splice(i,1)}return!0}};TWEEN.Tween=function(e){this.source={},this.target={},this.delta={},this.durationTime=1e3,this.delayTime=0,this.startTime=null,this.repeatTimes=0,this.enableYoyo=!1,this.reversed=!1,this.easingFunction=TWEEN.Easing.Linear.None,this.interpolationFunction=TWEEN.Interpolation.Linear,this.chainedTweens=[],this.onStartCallbackFired=!1,this.onStartCallback=null,this.onStartScope=null,this.onUpdateCallback=null,this.onUpdateScope=null,this.onCompleteCallback=null,this.onCompleteScope=null,this.onStopCallback=null,this.onStopScope=null,this.playing=!1,e&&this.setSource(e)},TWEEN.Tween.prototype={setSource:function(e){return this.source=e,this},setTarget:function(e){return this.target=e,this},duration:function(e){return this.durationTime=e,this},from:function(e){for(var t in e)this.source[t]=e[t];return this},to:function(e,t){return null!=t&&(this.durationTime=t),this.setTarget(e),this},delay:function(e){return this.delayTime=e,this},repeat:function(e){return this.repeatTimes=e,this},yoyo:function(e){return this.enableYoyo=e,this},easing:function(e){return this.easingFunction=e,this},interpolation:function(e){return this.interpolationFunction=e,this},chain:function(){return this.chainedTweens=arguments,this},onStart:function(e,t){return this.onStartCallback=e,this.onStartScope=t,this},onUpdate:function(e,t){return this.onUpdateCallback=e,this.onUpdateScope=t,this},onComplete:function(e,t){return this.onCompleteCallback=e,this.onCompleteScope=t,this},onStop:function(e,t){return this.onStopCallback=e,this.onStopScope=t,this},stop:function(){return TWEEN.remove(this),this.debug&&console.trace(this.debug,"stop"),null!==this.onStopCallback&&this.onStopCallback.call(this.onStopScope,this.source),this.stopChainedTweens(),this},stopChainedTweens:function(){for(var e=this.chainedTweens.length-1;e>=0;e--)this.chainedTweens[e].stop()},updateSource:function(){this.valuesSource={};for(var e in this.source){var t=this.source[e],i=parseFloat(t,10);isFinite(i)&&(this.valuesSource[e]=i)}return this},updateTarget:function(){this.valuesRelative={},this.valuesTarget={};for(var e in this.target)if(e in this.valuesSource!=!1){var t=this.target[e],i=this.valuesSource[e];if(t instanceof Array)t.length&&(this.valuesTarget[e]=[i].concat(t));else if("string"==typeof t){var n=parseFloat(t,10);isFinite(n)&&(this.valuesRelative[e]=n,this.valuesTarget[e]=i+n)}else"number"==typeof t&&isFinite(t)&&(this.valuesTarget[e]=t)}return this},start:function(e){TWEEN.add(this),this.onStartCallbackFired=!1,this.ended=!1,this.startTime=isNaN(e)?window.performance.now():+e,this.startTime+=this.delayTime,this.updateSource(),this.updateTarget();for(var t in this.valuesTarget)this.delta[t]=this.valuesSource[t];return this.debug&&console.trace(this.debug,"start","\n\tsource:",this.valuesSource,"\n\ttarget:",this.valuesTarget),this},update:function(e){if(this.ended)return this.ended=!1,this.playing=!1,this.debug&&console.log(this.debug,"ended"),!1;if(e<this.startTime)return!0;this.onStartCallbackFired===!1&&(this.onStartCallbackFired=!0,this.playing=!0,null!==this.onStartCallback&&this.onStartCallback.call(this.onStartScope,this.source),this.debug&&console.log(this.debug,"playing"));var t=(e-this.startTime)/this.durationTime;t=t>1?1:t;var i=this.easingFunction(t);for(var n in this.valuesTarget){var s,r=this.valuesTarget[n],o=this.valuesSource[n];s=r instanceof Array?this.interpolationFunction(r,i):o+(r-o)*i,this.delta[n]=s-this.source[n],this.source[n]=s}if(this.debug&&console.log(this.debug,"update","\n\tvalues:",this.source,"\n\tdetta:",this.delta),null!==this.onUpdateCallback&&this.onUpdateCallback.call(this.onUpdateScope,i,this.source),1===t)if(this.repeatTimes>0){this.repeatTimes--;for(var n in this.valuesSource){var o=this.valuesSource[n],r=this.valuesTarget[n];n in this.valuesRelative&&(o+=this.valuesRelative[n]),this.enableYoyo&&(this.valuesTarget[n]=o,o=r),this.valuesSource[n]=o}this.enableYoyo&&(this.reversed=!this.reversed),this.startTime=e+this.delayTime}else{this.ended=!0,null!==this.onCompleteCallback&&this.onCompleteCallback.call(this.onCompleteScope,this.source);for(var a=this.chainedTweens.length-1;a>=0;a--)this.chainedTweens[a].start(this.startTime+this.durationTime)}return!0}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)))},Out:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/n)+1)},InOut:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?-.5*(i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)):i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*.5+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?.5*(e*e*((t+1)*e-t)):.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,s=Math.floor(n),r=TWEEN.Interpolation.Utils.Linear;return t<0?r(e[0],e[1],n):t>1?r(e[i],e[i-1],i-n):r(e[s],e[s+1>i?i:s+1],n-s)},Bezier:function(e,t){for(var i=0,n=e.length-1,s=Math.pow,r=TWEEN.Interpolation.Utils.Bernstein,o=0;o<=n;o++)i+=s(1-t,n-o)*s(t,o)*e[o]*r(n,o);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,s=Math.floor(n),r=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(s=Math.floor(n=i*(1+t))),r(e[(s-1+i)%i],e[s],e[(s+1)%i],e[(s+2)%i],n-s)):t<0?e[0]-(r(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(r(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):r(e[s?s-1:0],e[s],e[i<s+1?i:s+1],e[i<s+2?i:s+2],n-s)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=TWEEN.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i=1;if(e[t])return e[t];for(var n=t;n>1;n--)i*=n;return e[t]=i,i}}(),CatmullRom:function(e,t,i,n,s){var r=.5*(i-e),o=.5*(n-t),a=s*s,l=s*a;return(2*t-2*i+r+o)*l+(-3*t+3*i-2*r-o)*a+r*s+t}}};var dat=dat||{};dat.gui=dat.gui||{},dat.utils=dat.utils||{},dat.controllers=dat.controllers||{},dat.dom=dat.dom||{},dat.color=dat.color||{},dat.utils.css=function(){return{load:function(e,t){t=t||document;var i=t.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,t.getElementsByTagName("head")[0].appendChild(i)},inject:function(e,t){t=t||document;var i=document.createElement("style");i.type="text/css",i.innerHTML=e,t.getElementsByTagName("head")[0].appendChild(i)}}}(),dat.utils.common=function(){var e=Array.prototype.forEach,t=Array.prototype.slice;return{BREAK:{},extend:function(e){return this.each(t.call(arguments,1),function(t){for(var i in t)this.isUndefined(t[i])||(e[i]=t[i])},this),e},defaults:function(e){return this.each(t.call(arguments,1),function(t){for(var i in t)this.isUndefined(e[i])&&(e[i]=t[i])},this),e},compose:function(){var e=t.call(arguments);return function(){for(var i=t.call(arguments),n=e.length-1;0<=n;n--)i=[e[n].apply(this,i)];return i[0]}},each:function(t,i,n){if(t)if(e&&t.forEach&&t.forEach===e)t.forEach(i,n);else if(t.length===t.length+0)for(var s=0,r=t.length;s<r&&!(s in t&&i.call(n,t[s],s)===this.BREAK);s++);else for(s in t)if(i.call(n,t[s],s)===this.BREAK)break},defer:function(e){setTimeout(e,0)},toArray:function(e){return e.toArray?e.toArray():t.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){return e!==e},isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)}}}(),dat.controllers.Controller=function(e){var t=function(e,t){this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onFinishChange=this.__onChange=void 0};return e.extend(t.prototype,{onChange:function(e){return this.__onChange=e,this},onFinishChange:function(e){return this.__onFinishChange=e,this},setValue:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}}),t}(dat.utils.common),dat.dom.dom=function(e){function t(t){return"0"===t||e.isUndefined(t)?0:(t=t.match(n),e.isNull(t)?0:parseFloat(t[1]))}var i={};e.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(t,n){e.each(t,function(e){i[e]=n})});var n=/(\d+(\.\d+)?)px/,s={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(t,i,n){e.isUndefined(i)&&(i=!0),e.isUndefined(n)&&(n=!0),t.style.position="absolute",i&&(t.style.left=0,t.style.right=0),n&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,n,s,r){s=s||{};var o=i[n];if(!o)throw Error("Event type "+n+" not supported.");var a=document.createEvent(o);switch(o){case"MouseEvents":a.initMouseEvent(n,s.bubbles||!1,s.cancelable||!0,window,s.clickCount||1,0,0,s.x||s.clientX||0,s.y||s.clientY||0,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":o=a.initKeyboardEvent||a.initKeyEvent,e.defaults(s,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),o(n,s.bubbles||!1,s.cancelable,window,s.ctrlKey,s.altKey,s.shiftKey,s.metaKey,s.keyCode,s.charCode);break;default:a.initEvent(n,s.bubbles||!1,s.cancelable||!0);
}e.defaults(a,r),t.dispatchEvent(a)},bind:function(e,t,i,n){return e.addEventListener?e.addEventListener(t,i,n||!1):e.attachEvent&&e.attachEvent("on"+t,i),s},unbind:function(e,t,i,n){return e.removeEventListener?e.removeEventListener(t,i,n||!1):e.detachEvent&&e.detachEvent("on"+t,i),s},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var i=e.className.split(/ +/);-1==i.indexOf(t)&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return s},removeClass:function(e,t){if(t){if(void 0!==e.className)if(e.className===t)e.removeAttribute("class");else{var i=e.className.split(/ +/),n=i.indexOf(t);-1!=n&&(i.splice(n,1),e.className=i.join(" "))}}else e.className=void 0;return s},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){return e=getComputedStyle(e),t(e["border-left-width"])+t(e["border-right-width"])+t(e["padding-left"])+t(e["padding-right"])+t(e.width)},getHeight:function(e){return e=getComputedStyle(e),t(e["border-top-width"])+t(e["border-bottom-width"])+t(e["padding-top"])+t(e["padding-bottom"])+t(e.height)},getOffset:function(e){var t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop;while(e=e.offsetParent);return t},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}};return s}(dat.utils.common),dat.controllers.OptionController=function(e,t,i){var n=function(e,s,r){n.superclass.call(this,e,s);var o=this;if(this.__select=document.createElement("select"),i.isArray(r)){var a={};i.each(r,function(e){a[e]=e}),r=a}i.each(r,function(e,t){var i=document.createElement("option");i.innerHTML=t,i.setAttribute("value",e),o.__select.appendChild(i)}),this.updateDisplay(),t.bind(this.__select,"change",function(){o.setValue(this.options[this.selectedIndex].value)}),this.domElement.appendChild(this.__select)};return n.superclass=e,i.extend(n.prototype,e.prototype,{setValue:function(e){return e=n.superclass.prototype.setValue.call(this,e),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),e},updateDisplay:function(){return this.__select.value=this.getValue(),n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.NumberController=function(e,t){function i(e){return e=e.toString(),-1<e.indexOf(".")?e.length-e.indexOf(".")-1:0}var n=function(e,s,r){n.superclass.call(this,e,s),r=r||{},this.__min=r.min,this.__max=r.max,this.__step=r.step,t.isUndefined(this.__step)?this.__impliedStep=0==this.initialValue?1:Math.pow(10,Math.floor(Math.log(Math.abs(this.initialValue))/Math.LN10))/10:this.__impliedStep=this.__step,this.__precision=i(this.__impliedStep)};return n.superclass=e,t.extend(n.prototype,e.prototype,{setValue:function(e){return void 0!==this.__min&&e<this.__min?e=this.__min:void 0!==this.__max&&e>this.__max&&(e=this.__max),void 0!==this.__step&&0!=e%this.__step&&(e=Math.round(e/this.__step)*this.__step),n.superclass.prototype.setValue.call(this,e)},min:function(e){return this.__min=e,this},max:function(e){return this.__max=e,this},step:function(e){return this.__impliedStep=this.__step=e,this.__precision=i(e),this}}),n}(dat.controllers.Controller,dat.utils.common),dat.controllers.NumberControllerBox=function(e,t,i){var n=function(e,s,r){function o(){var e=parseFloat(c.__input.value);i.isNaN(e)||c.setValue(e)}function a(e){var t=h-e.clientY;c.setValue(c.getValue()+t*c.__impliedStep),h=e.clientY}function l(){t.unbind(window,"mousemove",a),t.unbind(window,"mouseup",l)}this.__truncationSuspended=!1,n.superclass.call(this,e,s,r);var h,c=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),t.bind(this.__input,"change",o),t.bind(this.__input,"blur",function(){o(),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}),t.bind(this.__input,"mousedown",function(e){t.bind(window,"mousemove",a),t.bind(window,"mouseup",l),h=e.clientY}),t.bind(this.__input,"keydown",function(e){13===e.keyCode&&(c.__truncationSuspended=!0,this.blur(),c.__truncationSuspended=!1)}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return n.superclass=e,i.extend(n.prototype,e.prototype,{updateDisplay:function(){var e,t=this.__input;if(this.__truncationSuspended)e=this.getValue();else{e=this.getValue();var i=Math.pow(10,this.__precision);e=Math.round(e*i)/i}return t.value=e,n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common),dat.controllers.NumberControllerSlider=function(e,t,i,n,s){function r(e,t,i,n,s){return n+(e-t)/(i-t)*(s-n)}var o=function(e,i,n,s,a){function l(e){e.preventDefault();var i=t.getOffset(c.__background),n=t.getWidth(c.__background);return c.setValue(r(e.clientX,i.left,i.left+n,c.__min,c.__max)),!1}function h(){t.unbind(window,"mousemove",l),t.unbind(window,"mouseup",h),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}o.superclass.call(this,e,i,{min:n,max:s,step:a});var c=this;this.__background=document.createElement("div"),this.__foreground=document.createElement("div"),t.bind(this.__background,"mousedown",function(e){t.bind(window,"mousemove",l),t.bind(window,"mouseup",h),l(e)}),t.addClass(this.__background,"slider"),t.addClass(this.__foreground,"slider-fg"),this.updateDisplay(),this.__background.appendChild(this.__foreground),this.domElement.appendChild(this.__background)};return o.superclass=e,o.useDefaultStyles=function(){i.inject(s)},n.extend(o.prototype,e.prototype,{updateDisplay:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",o.superclass.prototype.updateDisplay.call(this)}}),o}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,"/**\n * dat-gui JavaScript Controller Library\n * http://code.google.com/p/dat-gui\n *\n * Copyright 2011 Data Arts Team, Google Creative Lab\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n */\n\n.slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}"),dat.controllers.FunctionController=function(e,t,i){var n=function(e,i,s){n.superclass.call(this,e,i);var r=this;this.__button=document.createElement("div"),this.__button.innerHTML=void 0===s?"Fire":s,t.bind(this.__button,"click",function(e){return e.preventDefault(),r.fire(),!1}),t.addClass(this.__button,"button"),this.domElement.appendChild(this.__button)};return n.superclass=e,i.extend(n.prototype,e.prototype,{fire:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.BooleanController=function(e,t,i){var n=function(e,i){n.superclass.call(this,e,i);var s=this;this.__prev=this.getValue(),this.__checkbox=document.createElement("input"),this.__checkbox.setAttribute("type","checkbox"),t.bind(this.__checkbox,"change",function(){s.setValue(!s.__prev)},!1),this.domElement.appendChild(this.__checkbox),this.updateDisplay()};return n.superclass=e,i.extend(n.prototype,e.prototype,{setValue:function(e){return e=n.superclass.prototype.setValue.call(this,e),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),e},updateDisplay:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0):this.__checkbox.checked=!1,n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.color.toString=function(e){return function(t){if(1==t.a||e.isUndefined(t.a)){for(t=t.hex.toString(16);6>t.length;)t="0"+t;return"#"+t}return"rgba("+Math.round(t.r)+","+Math.round(t.g)+","+Math.round(t.b)+","+t.a+")"}}(dat.utils.common),dat.color.interpret=function(e,t){var i,n,s=[{litmus:t.isString,conversions:{THREE_CHAR_HEX:{read:function(e){return e=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i),null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString())}},write:e},SIX_CHAR_HEX:{read:function(e){return e=e.match(/^#([A-F0-9]{6})$/i),null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString())}},write:e},CSS_RGB:{read:function(e){return e=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/),null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:e},CSS_RGBA:{read:function(e){return e=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/),null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:e}}},{litmus:t.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:t.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3==e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4==e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:t.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(t.isNumber(e.r)&&t.isNumber(e.g)&&t.isNumber(e.b)&&t.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(t.isNumber(e.r)&&t.isNumber(e.g)&&t.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(t.isNumber(e.h)&&t.isNumber(e.s)&&t.isNumber(e.v)&&t.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(t.isNumber(e.h)&&t.isNumber(e.s)&&t.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}];return function(){n=!1;var e=1<arguments.length?t.toArray(arguments):arguments[0];return t.each(s,function(s){if(s.litmus(e))return t.each(s.conversions,function(s,r){if(i=s.read(e),!1===n&&!1!==i)return n=i,i.conversionName=r,i.conversion=s,t.BREAK}),t.BREAK}),n}}(dat.color.toString,dat.utils.common),dat.GUI=dat.gui.GUI=function(e,t,i,n,s,r,o,a,l,h,c,u,d,p,f){function m(e,t,i,r){if(void 0===t[i])throw Error("Object "+t+' has no property "'+i+'"');r.color?t=new c(t,i):(t=[t,i].concat(r.factoryArgs),t=n.apply(e,t)),r.before instanceof s&&(r.before=r.before.__li),b(e,t),p.addClass(t.domElement,"c"),i=document.createElement("span"),p.addClass(i,"property-name"),i.innerHTML=t.property;var o=document.createElement("div");return o.appendChild(i),o.appendChild(t.domElement),r=v(e,o,r.before),p.addClass(r,L.CLASS_CONTROLLER_ROW),p.addClass(r,typeof t.getValue()),g(e,r,t),e.__controllers.push(t),t}function v(e,t,i){var n=document.createElement("li");return t&&n.appendChild(t),i?e.__ul.insertBefore(n,params.before):e.__ul.appendChild(n),e.onResize(),n}function g(e,t,i){if(i.__li=t,i.__gui=e,f.extend(i,{options:function(t){return 1<arguments.length?(i.remove(),m(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[f.toArray(arguments)]})):f.isArray(t)||f.isObject(t)?(i.remove(),m(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[t]})):void 0},name:function(e){return i.__li.firstElementChild.firstElementChild.innerHTML=e,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof l){var n=new a(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});f.each(["updateDisplay","onChange","onFinishChange"],function(e){var t=i[e],s=n[e];i[e]=n[e]=function(){var e=Array.prototype.slice.call(arguments);return t.apply(i,e),s.apply(n,e)}}),p.addClass(t,"has-slider"),i.domElement.insertBefore(n.domElement,i.domElement.firstElementChild)}else if(i instanceof a){var s=function(t){return f.isNumber(i.__min)&&f.isNumber(i.__max)?(i.remove(),m(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]})):t};i.min=f.compose(s,i.min),i.max=f.compose(s,i.max)}else i instanceof r?(p.bind(t,"click",function(){p.fakeEvent(i.__checkbox,"click")}),p.bind(i.__checkbox,"click",function(e){e.stopPropagation()})):i instanceof o?(p.bind(t,"click",function(){p.fakeEvent(i.__button,"click")}),p.bind(t,"mouseover",function(){p.addClass(i.__button,"hover")}),p.bind(t,"mouseout",function(){p.removeClass(i.__button,"hover")})):i instanceof c&&(p.addClass(t,"color"),i.updateDisplay=f.compose(function(e){return t.style.borderLeftColor=i.__color.toString(),e},i.updateDisplay),i.updateDisplay());i.setValue=f.compose(function(t){return e.getRoot().__preset_select&&i.isModified()&&_(e.getRoot(),!0),t},i.setValue)}function b(e,t){var i=e.getRoot(),n=i.__rememberedObjects.indexOf(t.object);if(-1!=n){var s=i.__rememberedObjectIndecesToControllers[n];if(void 0===s&&(s={},i.__rememberedObjectIndecesToControllers[n]=s),s[t.property]=t,i.load&&i.load.remembered){if(i=i.load.remembered,i[e.preset])i=i[e.preset];else{if(!i.Default)return;i=i.Default}i[n]&&void 0!==i[n][t.property]&&(n=i[n][t.property],t.initialValue=n,t.setValue(n))}}}function y(e){var t=e.__save_row=document.createElement("li");p.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),p.addClass(t,"save-row");var i=document.createElement("span");i.innerHTML="&nbsp;",p.addClass(i,"button gears");var n=document.createElement("span");n.innerHTML="Save",p.addClass(n,"button"),p.addClass(n,"save");var s=document.createElement("span");s.innerHTML="New",p.addClass(s,"button"),p.addClass(s,"save-as");var r=document.createElement("span");r.innerHTML="Revert",p.addClass(r,"button"),p.addClass(r,"revert");var o=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?f.each(e.load.remembered,function(t,i){T(e,i,i==e.preset)}):T(e,"Default",!1),p.bind(o,"change",function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value}),t.appendChild(o),t.appendChild(i),t.appendChild(n),t.appendChild(s),t.appendChild(r),R){var a=function(){l.style.display=e.useLocalStorage?"block":"none"},t=document.getElementById("dg-save-locally"),l=document.getElementById("dg-local-explain");t.style.display="block",t=document.getElementById("dg-local-storage"),"true"===localStorage.getItem(document.location.href+".isLocal")&&t.setAttribute("checked","checked"),a(),p.bind(t,"change",function(){e.useLocalStorage=!e.useLocalStorage,a()})}var h=document.getElementById("dg-new-constructor");p.bind(h,"keydown",function(e){!e.metaKey||67!==e.which&&67!=e.keyCode||S.hide()}),p.bind(i,"click",function(){h.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),S.show(),h.focus(),h.select()}),p.bind(n,"click",function(){e.save()}),p.bind(s,"click",function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)}),p.bind(r,"click",function(){e.revert()})}function w(e){function t(t){return t.preventDefault(),s=t.clientX,p.addClass(e.__closeButton,L.CLASS_DRAG),p.bind(window,"mousemove",i),p.bind(window,"mouseup",n),!1}function i(t){return t.preventDefault(),e.width+=s-t.clientX,e.onResize(),s=t.clientX,!1}function n(){p.removeClass(e.__closeButton,L.CLASS_DRAG),p.unbind(window,"mousemove",i),p.unbind(window,"mouseup",n)}e.__resize_handle=document.createElement("div"),f.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var s;p.bind(e.__resize_handle,"mousedown",t),p.bind(e.__closeButton,"mousedown",t),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function E(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function x(e,t){var i={};return f.each(e.__rememberedObjects,function(n,s){var r={};f.each(e.__rememberedObjectIndecesToControllers[s],function(e,i){r[i]=t?e.initialValue:e.getValue()}),i[s]=r}),i}function T(e,t,i){var n=document.createElement("option");n.innerHTML=t,n.value=t,e.__preset_select.appendChild(n),i&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function _(e,t){var i=e.__preset_select[e.__preset_select.selectedIndex];i.innerHTML=t?i.value+"*":i.value}function k(e){0!=e.length&&u(function(){k(e)}),f.each(e,function(e){e.updateDisplay()})}e.inject(i);var R;try{R="localStorage"in window&&null!==window.localStorage}catch(e){R=!1}var S,M,C=!0,A=!1,H=[],L=function(e){function t(){var e=i.getRoot();e.width+=1,f.defer(function(){--e.width})}var i=this;this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),p.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],e=e||{},e=f.defaults(e,{autoPlace:!0,width:L.DEFAULT_WIDTH}),e=f.defaults(e,{resizable:e.autoPlace,hideable:e.autoPlace}),f.isUndefined(e.load)?e.load={preset:"Default"}:e.preset&&(e.load.preset=e.preset),f.isUndefined(e.parent)&&e.hideable&&H.push(this),e.resizable=f.isUndefined(e.parent)&&e.resizable,e.autoPlace&&f.isUndefined(e.scrollable)&&(e.scrollable=!0);var n,s=R&&"true"===localStorage.getItem(document.location.href+".isLocal");if(Object.defineProperties(this,{parent:{get:function(){return e.parent}},scrollable:{get:function(){return e.scrollable}},autoPlace:{get:function(){return e.autoPlace}},preset:{get:function(){return i.parent?i.getRoot().preset:e.load.preset},set:function(t){for(i.parent?i.getRoot().preset=t:e.load.preset=t,t=0;t<this.__preset_select.length;t++)this.__preset_select[t].value==this.preset&&(this.__preset_select.selectedIndex=t);i.revert()}},width:{get:function(){return e.width},set:function(t){e.width=t,E(i,t)}},name:{get:function(){return e.name},set:function(t){e.name=t,o&&(o.innerHTML=e.name)}},closed:{get:function(){return e.closed},set:function(t){e.closed=t,e.closed?p.addClass(i.__ul,L.CLASS_CLOSED):p.removeClass(i.__ul,L.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=t?L.TEXT_OPEN:L.TEXT_CLOSED)}},load:{get:function(){return e.load}},useLocalStorage:{get:function(){return s},set:function(e){R&&((s=e)?p.bind(window,"unload",n):p.unbind(window,"unload",n),localStorage.setItem(document.location.href+".isLocal",e))}}}),f.isUndefined(e.parent)){if(e.closed=!1,p.addClass(this.domElement,L.CLASS_MAIN),p.makeSelectable(this.domElement,!1),R&&s){i.useLocalStorage=!0;var r=localStorage.getItem(document.location.href+".gui");r&&(e.load=JSON.parse(r))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=L.TEXT_CLOSED,p.addClass(this.__closeButton,L.CLASS_CLOSE_BUTTON),this.domElement.appendChild(this.__closeButton),p.bind(this.__closeButton,"click",function(){i.closed=!i.closed})}else{void 0===e.closed&&(e.closed=!0);var o=document.createTextNode(e.name);p.addClass(o,"controller-name"),r=v(i,o),p.addClass(this.__ul,L.CLASS_CLOSED),p.addClass(r,"title"),p.bind(r,"click",function(e){return e.preventDefault(),i.closed=!i.closed,!1}),e.closed||(this.closed=!1)}e.autoPlace&&(f.isUndefined(e.parent)&&(C&&(M=document.createElement("div"),p.addClass(M,"dg"),p.addClass(M,L.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(M),C=!1),M.appendChild(this.domElement),p.addClass(this.domElement,L.CLASS_AUTO_PLACE)),this.parent||E(i,e.width)),p.bind(window,"resize",function(){i.onResize()}),p.bind(this.__ul,"webkitTransitionEnd",function(){i.onResize()}),p.bind(this.__ul,"transitionend",function(){i.onResize()}),p.bind(this.__ul,"oTransitionEnd",function(){i.onResize()}),this.onResize(),e.resizable&&w(this),this.saveToLocalStorageIfPossible=n=function(){R&&"true"===localStorage.getItem(document.location.href+".isLocal")&&localStorage.setItem(document.location.href+".gui",JSON.stringify(i.getSaveObject()))},i.getRoot(),e.parent||t()};return L.toggleHide=function(){A=!A,f.each(H,function(e){e.domElement.style.zIndex=A?-999:999,e.domElement.style.opacity=A?0:1})},L.CLASS_AUTO_PLACE="a",L.CLASS_AUTO_PLACE_CONTAINER="ac",L.CLASS_MAIN="main",L.CLASS_CONTROLLER_ROW="cr",L.CLASS_TOO_TALL="taller-than-window",L.CLASS_CLOSED="closed",L.CLASS_CLOSE_BUTTON="close-button",L.CLASS_DRAG="drag",L.DEFAULT_WIDTH=245,L.TEXT_CLOSED="Close Controls",L.TEXT_OPEN="Open Controls",p.bind(window,"keydown",function(e){"text"===document.activeElement.type||72!==e.which&&72!=e.keyCode||L.toggleHide()},!1),f.extend(L.prototype,{add:function(e,t){return m(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return m(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;f.defer(function(){t.onResize()})},destroy:function(){this.autoPlace&&M.removeChild(this.domElement)},addFolder:function(e){if(void 0!==this.__folders[e])throw Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};return t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]),t=new L(t),this.__folders[e]=t,e=v(this,t.domElement),p.addClass(e,"folder"),t},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=p.getOffset(e.__ul).top,i=0;f.each(e.__ul.childNodes,function(t){e.autoPlace&&t===e.__save_row||(i+=p.getHeight(t))}),window.innerHeight-t-20<i?(p.addClass(e.domElement,L.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-20+"px"):(p.removeClass(e.domElement,L.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&f.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},remember:function(){if(f.isUndefined(S)&&(S=new d,S.domElement.innerHTML=t),this.parent)throw Error("You can only call remember on a top level GUI.");var e=this;f.each(Array.prototype.slice.call(arguments),function(t){0==e.__rememberedObjects.length&&y(e),-1==e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)}),this.autoPlace&&E(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,0<this.__rememberedObjects.length&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=x(this)),e.folders={},f.each(this.__folders,function(t,i){e.folders[i]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=x(this),_(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=x(this,!0)),this.load.remembered[e]=x(this),this.preset=e,T(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){f.each(this.__controllers,function(t){this.getRoot().load.remembered?b(e||this.getRoot(),t):t.setValue(t.initialValue)},this),f.each(this.__folders,function(e){e.revert(e)}),e||_(this.getRoot(),!1)},listen:function(e){var t=0==this.__listening.length;this.__listening.push(e),t&&k(this.__listening)}}),L}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg {\n  /** Clear list styles */\n  /* Auto-place container */\n  /* Auto-placed GUI's */\n  /* Line items that don't contain folders. */\n  /** Folder names */\n  /** Hides closed items */\n  /** Controller row */\n  /** Name-half (left) */\n  /** Controller-half (right) */\n  /** Controller placement */\n  /** Shorter number boxes when slider is present. */\n  /** Ensure the entire boolean and function row shows a hand */ }\n  .dg ul {\n    list-style: none;\n    margin: 0;\n    padding: 0;\n    width: 100%;\n    clear: both; }\n  .dg.ac {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 0;\n    z-index: 0; }\n  .dg:not(.ac) .main {\n    /** Exclude mains in ac so that we don't hide close button */\n    overflow: hidden; }\n  .dg.main {\n    -webkit-transition: opacity 0.1s linear;\n    -o-transition: opacity 0.1s linear;\n    -moz-transition: opacity 0.1s linear;\n    transition: opacity 0.1s linear; }\n    .dg.main.taller-than-window {\n      overflow-y: auto; }\n      .dg.main.taller-than-window .close-button {\n        opacity: 1;\n        /* TODO, these are style notes */\n        margin-top: -1px;\n        border-top: 1px solid #2c2c2c; }\n    .dg.main ul.closed .close-button {\n      opacity: 1 !important; }\n    .dg.main:hover .close-button,\n    .dg.main .close-button.drag {\n      opacity: 1; }\n    .dg.main .close-button {\n      /*opacity: 0;*/\n      -webkit-transition: opacity 0.1s linear;\n      -o-transition: opacity 0.1s linear;\n      -moz-transition: opacity 0.1s linear;\n      transition: opacity 0.1s linear;\n      border: 0;\n      position: absolute;\n      line-height: 19px;\n      height: 20px;\n      /* TODO, these are style notes */\n      cursor: pointer;\n      text-align: center;\n      background-color: #000; }\n      .dg.main .close-button:hover {\n        background-color: #111; }\n  .dg.a {\n    float: right;\n    margin-right: 15px;\n    overflow-x: hidden; }\n    .dg.a.has-save > ul {\n      margin-top: 27px; }\n      .dg.a.has-save > ul.closed {\n        margin-top: 0; }\n    .dg.a .save-row {\n      position: fixed;\n      top: 0;\n      z-index: 1002; }\n  .dg li {\n    -webkit-transition: height 0.1s ease-out;\n    -o-transition: height 0.1s ease-out;\n    -moz-transition: height 0.1s ease-out;\n    transition: height 0.1s ease-out; }\n  .dg li:not(.folder) {\n    cursor: auto;\n    height: 27px;\n    line-height: 27px;\n    overflow: hidden;\n    padding: 0 4px 0 5px; }\n  .dg li.folder {\n    padding: 0;\n    border-left: 4px solid rgba(0, 0, 0, 0); }\n  .dg li.title {\n    cursor: pointer;\n    margin-left: -4px; }\n  .dg .closed li:not(.title),\n  .dg .closed ul li,\n  .dg .closed ul li > * {\n    height: 0;\n    overflow: hidden;\n    border: 0; }\n  .dg .cr {\n    clear: both;\n    padding-left: 3px;\n    height: 27px; }\n  .dg .property-name {\n    cursor: default;\n    float: left;\n    clear: left;\n    width: 40%;\n    overflow: hidden;\n    text-overflow: ellipsis; }\n  .dg .c {\n    float: left;\n    width: 60%; }\n  .dg .c input[type=text] {\n    border: 0;\n    margin-top: 4px;\n    padding: 3px;\n    width: 100%;\n    float: right; }\n  .dg .has-slider input[type=text] {\n    width: 30%;\n    /*display: none;*/\n    margin-left: 0; }\n  .dg .slider {\n    float: left;\n    width: 66%;\n    margin-left: -5px;\n    margin-right: 0;\n    height: 19px;\n    margin-top: 4px; }\n  .dg .slider-fg {\n    height: 100%; }\n  .dg .c input[type=checkbox] {\n    margin-top: 9px; }\n  .dg .c select {\n    margin-top: 5px; }\n  .dg .cr.function,\n  .dg .cr.function .property-name,\n  .dg .cr.function *,\n  .dg .cr.boolean,\n  .dg .cr.boolean * {\n    cursor: pointer; }\n  .dg .selector {\n    display: none;\n    position: absolute;\n    margin-left: -9px;\n    margin-top: 23px;\n    z-index: 10; }\n  .dg .c:hover .selector,\n  .dg .selector.drag {\n    display: block; }\n  .dg li.save-row {\n    padding: 0; }\n    .dg li.save-row .button {\n      display: inline-block;\n      padding: 0px 6px; }\n  .dg.dialogue {\n    background-color: #222;\n    width: 460px;\n    padding: 15px;\n    font-size: 13px;\n    line-height: 15px; }\n\n/* TODO Separate style and structure */\n#dg-new-constructor {\n  padding: 10px;\n  color: #222;\n  font-family: Monaco, monospace;\n  font-size: 10px;\n  border: 0;\n  resize: none;\n  box-shadow: inset 1px 1px 1px #888;\n  word-wrap: break-word;\n  margin: 12px 0;\n  display: block;\n  width: 440px;\n  overflow-y: scroll;\n  height: 100px;\n  position: relative; }\n\n#dg-local-explain {\n  display: none;\n  font-size: 11px;\n  line-height: 17px;\n  border-radius: 3px;\n  background-color: #333;\n  padding: 8px;\n  margin-top: 10px; }\n  #dg-local-explain code {\n    font-size: 10px; }\n\n#dat-gui-save-locally {\n  display: none; }\n\n/** Main type */\n.dg {\n  color: #eee;\n  font: 11px 'Lucida Grande', sans-serif;\n  text-shadow: 0 -1px 0 #111;\n  /** Auto place */\n  /* Controller row, <li> */\n  /** Controllers */ }\n  .dg.main {\n    /** Scrollbar */ }\n    .dg.main::-webkit-scrollbar {\n      width: 5px;\n      background: #1a1a1a; }\n    .dg.main::-webkit-scrollbar-corner {\n      height: 0;\n      display: none; }\n    .dg.main::-webkit-scrollbar-thumb {\n      border-radius: 5px;\n      background: #676767; }\n  .dg li:not(.folder) {\n    background: #1a1a1a;\n    border-bottom: 1px solid #2c2c2c; }\n  .dg li.save-row {\n    line-height: 25px;\n    background: #dad5cb;\n    border: 0; }\n    .dg li.save-row select {\n      margin-left: 5px;\n      width: 108px; }\n    .dg li.save-row .button {\n      margin-left: 5px;\n      margin-top: 1px;\n      border-radius: 2px;\n      font-size: 9px;\n      line-height: 7px;\n      padding: 4px 4px 5px 4px;\n      background: #c5bdad;\n      color: #fff;\n      text-shadow: 0 1px 0 #b0a58f;\n      box-shadow: 0 -1px 0 #b0a58f;\n      cursor: pointer; }\n      .dg li.save-row .button.gears {\n        background: #c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;\n        height: 7px;\n        width: 8px; }\n      .dg li.save-row .button:hover {\n        background-color: #bab19e;\n        box-shadow: 0 -1px 0 #b0a58f; }\n  .dg li.folder {\n    border-bottom: 0; }\n  .dg li.title {\n    padding-left: 16px;\n    background: black url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;\n    cursor: pointer;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.2); }\n  .dg .closed li.title {\n    background-image: url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==); }\n  .dg .cr.boolean {\n    border-left: 3px solid #806787; }\n  .dg .cr.function {\n    border-left: 3px solid #e61d5f; }\n  .dg .cr.number {\n    border-left: 3px solid #2fa1d6; }\n    .dg .cr.number input[type=text] {\n      color: #2fa1d6; }\n  .dg .cr.string {\n    border-left: 3px solid #1ed36f; }\n    .dg .cr.string input[type=text] {\n      color: #1ed36f; }\n  .dg .cr.function:hover, .dg .cr.boolean:hover {\n    background: #111; }\n  .dg .c input[type=text] {\n    background: #303030;\n    outline: none; }\n    .dg .c input[type=text]:hover {\n      background: #3c3c3c; }\n    .dg .c input[type=text]:focus {\n      background: #494949;\n      color: #fff; }\n  .dg .c .slider {\n    background: #303030;\n    cursor: ew-resize; }\n  .dg .c .slider-fg {\n    background: #2fa1d6; }\n  .dg .c .slider:hover {\n    background: #3c3c3c; }\n    .dg .c .slider:hover .slider-fg {\n      background: #44abda; }\n",dat.controllers.factory=function(e,t,i,n,s,r,o){
return function(a,l,h,c){var u=a[l];return o.isArray(h)||o.isObject(h)?new e(a,l,h):o.isNumber(u)?o.isNumber(h)&&o.isNumber(c)?new i(a,l,h,c):new t(a,l,{min:h,max:c}):o.isString(u)?new n(a,l):o.isFunction(u)?new s(a,l,""):o.isBoolean(u)?new r(a,l):void 0}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(e,t,i){var n=function(e,i){function s(){r.setValue(r.__input.value)}n.superclass.call(this,e,i);var r=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),t.bind(this.__input,"keyup",s),t.bind(this.__input,"change",s),t.bind(this.__input,"blur",function(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}),t.bind(this.__input,"keydown",function(e){13===e.keyCode&&this.blur()}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return n.superclass=e,i.extend(n.prototype,e.prototype,{updateDisplay:function(){return t.isActive(this.__input)||(this.__input.value=this.getValue()),n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(e,t,i,n,s){function r(e,t,i,n){e.style.background="",s.each(l,function(s){e.style.cssText+="background: "+s+"linear-gradient("+t+", "+i+" 0%, "+n+" 100%); "})}function o(e){e.style.background="",e.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",e.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var a=function(e,l){function h(e){p(e),t.bind(window,"mousemove",p),t.bind(window,"mouseup",c)}function c(){t.unbind(window,"mousemove",p),t.unbind(window,"mouseup",c)}function u(){var e=n(this.value);!1!==e?(m.__color.__state=e,m.setValue(m.__color.toOriginal())):this.value=m.__color.toString()}function d(){t.unbind(window,"mousemove",f),t.unbind(window,"mouseup",d)}function p(e){e.preventDefault();var i=t.getWidth(m.__saturation_field),n=t.getOffset(m.__saturation_field),s=(e.clientX-n.left+document.body.scrollLeft)/i;return e=1-(e.clientY-n.top+document.body.scrollTop)/i,1<e?e=1:0>e&&(e=0),1<s?s=1:0>s&&(s=0),m.__color.v=e,m.__color.s=s,m.setValue(m.__color.toOriginal()),!1}function f(e){e.preventDefault();var i=t.getHeight(m.__hue_field),n=t.getOffset(m.__hue_field);return e=1-(e.clientY-n.top+document.body.scrollTop)/i,1<e?e=1:0>e&&(e=0),m.__color.h=360*e,m.setValue(m.__color.toOriginal()),!1}a.superclass.call(this,e,l),this.__color=new i(this.getValue()),this.__temp=new i(0);var m=this;this.domElement=document.createElement("div"),t.makeSelectable(this.domElement,!1),this.__selector=document.createElement("div"),this.__selector.className="selector",this.__saturation_field=document.createElement("div"),this.__saturation_field.className="saturation-field",this.__field_knob=document.createElement("div"),this.__field_knob.className="field-knob",this.__field_knob_border="2px solid ",this.__hue_knob=document.createElement("div"),this.__hue_knob.className="hue-knob",this.__hue_field=document.createElement("div"),this.__hue_field.className="hue-field",this.__input=document.createElement("input"),this.__input.type="text",this.__input_textShadow="0 1px 1px ",t.bind(this.__input,"keydown",function(e){13===e.keyCode&&u.call(this)}),t.bind(this.__input,"blur",u),t.bind(this.__selector,"mousedown",function(e){t.addClass(this,"drag").bind(window,"mouseup",function(e){t.removeClass(m.__selector,"drag")})});var v=document.createElement("div");s.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),s.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(.5>this.__color.v?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),s.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),s.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),s.extend(v.style,{width:"100%",height:"100%",background:"none"}),r(v,"top","rgba(0,0,0,0)","#000"),s.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"}),o(this.__hue_field),s.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"}),t.bind(this.__saturation_field,"mousedown",h),t.bind(this.__field_knob,"mousedown",h),t.bind(this.__hue_field,"mousedown",function(e){f(e),t.bind(window,"mousemove",f),t.bind(window,"mouseup",d)}),this.__saturation_field.appendChild(v),this.__selector.appendChild(this.__field_knob),this.__selector.appendChild(this.__saturation_field),this.__selector.appendChild(this.__hue_field),this.__hue_field.appendChild(this.__hue_knob),this.domElement.appendChild(this.__input),this.domElement.appendChild(this.__selector),this.updateDisplay()};a.superclass=e,s.extend(a.prototype,e.prototype,{updateDisplay:function(){var e=n(this.getValue());if(!1!==e){var t=!1;s.each(i.COMPONENTS,function(i){if(!s.isUndefined(e[i])&&!s.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}},this),t&&s.extend(this.__color.__state,e)}s.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var o=.5>this.__color.v||.5<this.__color.s?255:0,a=255-o;s.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+o+","+o+","+o+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,r(this.__saturation_field,"left","#fff",this.__temp.toString()),s.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+o+","+o+","+o+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}});var l=["-moz-","-o-","-webkit-","-ms-",""];return a}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(e,t,i,n){function s(e,t,i){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space?this.__state[t]:(o(this,t,i),this.__state[t])},set:function(e){"RGB"!==this.__state.space&&(o(this,t,i),this.__state.space="RGB"),this.__state[t]=e}})}function r(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space?this.__state[t]:(a(this),this.__state[t])},set:function(e){"HSV"!==this.__state.space&&(a(this),this.__state.space="HSV"),this.__state[t]=e}})}function o(e,i,s){if("HEX"===e.__state.space)e.__state[i]=t.component_from_hex(e.__state.hex,s);else{if("HSV"!==e.__state.space)throw"Corrupted color state";n.extend(e.__state,t.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}}function a(e){var i=t.rgb_to_hsv(e.r,e.g,e.b);n.extend(e.__state,{s:i.s,v:i.v}),n.isNaN(i.h)?n.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=i.h}var l=function(){if(this.__state=e.apply(this,arguments),!1===this.__state)throw"Failed to interpret color arguments";this.__state.a=this.__state.a||1};return l.COMPONENTS="r g b h s v hex a".split(" "),n.extend(l.prototype,{toString:function(){return i(this)},toOriginal:function(){return this.__state.conversion.write(this)}}),s(l.prototype,"r",2),s(l.prototype,"g",1),s(l.prototype,"b",0),r(l.prototype,"h"),r(l.prototype,"s"),r(l.prototype,"v"),Object.defineProperty(l.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(l.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=t.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}}),l}(dat.color.interpret,dat.color.math=function(){var e;return{hsv_to_rgb:function(e,t,i){var n=e/60-Math.floor(e/60),s=i*(1-t),r=i*(1-n*t);return t=i*(1-(1-n)*t),e=[[i,t,s],[r,i,s],[s,i,t],[s,r,i],[t,s,i],[i,s,r]][Math.floor(e/60)%6],{r:255*e[0],g:255*e[1],b:255*e[2]}},rgb_to_hsv:function(e,t,i){var n=Math.min(e,t,i),s=Math.max(e,t,i),n=s-n;return 0==s?{h:NaN,s:0,v:0}:(e=(e==s?(t-i)/n:t==s?2+(i-e)/n:4+(e-t)/n)/6,0>e&&(e+=1),{h:360*e,s:n/s,v:s/255})},rgb_to_hex:function(e,t,i){return e=this.hex_with_component(0,2,e),e=this.hex_with_component(e,1,t),e=this.hex_with_component(e,0,i)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(t,i,n){return n<<(e=8*i)|t&~(255<<e)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}(),dat.dom.CenteredDiv=function(e,t){var i=function(){this.backgroundElement=document.createElement("div"),t.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),e.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),t.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var i=this;e.bind(this.backgroundElement,"click",function(){i.hide()})};return i.prototype.show=function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),t.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})},i.prototype.hide=function(){var t=this,i=function(){t.domElement.style.display="none",t.backgroundElement.style.display="none",e.unbind(t.domElement,"webkitTransitionEnd",i),e.unbind(t.domElement,"transitionend",i),e.unbind(t.domElement,"oTransitionEnd",i)};e.bind(this.domElement,"webkitTransitionEnd",i),e.bind(this.domElement,"transitionend",i),e.bind(this.domElement,"oTransitionEnd",i),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"},i.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-e.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-e.getHeight(this.domElement)/2+"px"},i}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common),EventEmitter.ADD={},EventEmitter.DEL={},EventEmitter.prototype={_add:function(e,t){e.tail?(t.prev=e.tail,e.tail=e.tail.next=t):e.head=e.tail=t},_rem:function(e,t){t.prev?t.prev.next=t.next:e.head=t.next,t.next?t.next.prev=t.prev:e.tail=t.prev},when:function(e,t,i,n){for(var s in e)this.on(s,e[s],t,i,n)},once:function(e,t,i,n){this.on(e,t,i,n,!0)},on:function(e,t,i,n,s){"function"==typeof t&&this.emit(EventEmitter.ADD,{type:e,func:t,scope:i,data:null==n?[]:[].concat(n),once:s})},off:function(e,t,i){this.emit(EventEmitter.DEL,{type:e,func:t,scope:i})},will:function(e,t){var i=this,n=null==t?[]:[].concat(t);return function(){for(var t=n.slice(),s=0;s<arguments.length;s++)t.push(arguments[s]);i.emit(e,t)}},emit:function(e,t){if(this.debug&&console.log(this.debug,e,t),this._add(this.queue,{type:e,data:null==t?[]:t}),!this.processing){for(this.processing=!0;this.queue.head;)this.dispatch(this.queue.head),this._rem(this.queue,this.queue.head);this.processing=!1}},dispatch:function(e){var t=e.type,i=e.data;switch(t){case EventEmitter.ADD:this._add(this.lists[i.type]||(this.lists[i.type]={}),i);break;case EventEmitter.DEL:for(var t in this.lists)for(var n=this.lists[t],s=n.head;s;s=s.next)null!=i.type&&i.type!==t||null!=i.func&&i.func!==s.func||null!=i.scope&&i.scope!==s.scope||this._rem(n,s);break;default:var n=this.lists[t];if(n)for(var s=n.head;s;s=s.next)s.func.apply(s.scope,s.data.concat(i)),s.once&&this._rem(n,s);for(var r=this.links.head;r;r=r.next)r.emitter.emit(r.prefix?r.prefix+t:t,r.data.concat(i))}},relay:function(e,t,i){this.on(e,t.emit,t,i||e)},link:function(e,t,i){this._add(this.links,{emitter:e,prefix:t,data:null==i?[]:[].concat(i)})},unlink:function(e,t){for(var i=this.links.head;i;i=i.next)null!=e&&e!==i.emitter||null!=t&&t!==i.prefix||this._rem(this.links,i)},clone:function(){var e=new EventEmitter;for(var t in this.lists)e.lists[t]=this.lists[t];return e}},EventHandler.prototype={handleEvent:function(e){return this.apply(e)},apply:function(e){return this.once&&this.release(),this.func.apply(this.scope,[].concat(this.data,e||[]))},listen:function(e,t,i){return this.element&&this.release(),this.type=e,this.element=t,this.capture=!!i,this.element&&this.element.addEventListener&&this.element.addEventListener(this.type,this,this.capture),this},release:function(){return this.element&&this.element.removeEventListener&&this.element.removeEventListener(this.type,this,this.capture),delete this.element,this}},Observable.count=0,Observable.stack=[],Observable.context=null,Observable.unwrap=function(e){return e instanceof Observable?e.read():e},Observable.inContext=function(e,t,i,n,s){Observable.stack.push(Observable.context),Observable.context=e;try{return t.call(i,n,s)}finally{Observable.context=Observable.stack.pop()}},Observable.prototype={set:function(e,t,i,n){return this.reader="function"==typeof t?t:null,this.writer="function"==typeof i?i:null,this.equals="function"==typeof n?n:null,this.scope=e,this.stale=!0,this},read:function(){var e=Observable.context;if(e&&e.id!==this.id&&(this.targets[e.id]=e,e.sources[this.id]=this),this.stale)if(this.stale=!1,this.reader){this.sources={};var t=this.value;this.value=Observable.inContext(this,this.reader,this.scope,this.value),this.debug&&console.log("OB",this.id,"read",t,"->",this.value,"deps:",Object.keys(this.sources).map(Number))}else this.debug&&console.log("OB",this.id,"read stale no reader",this.value);else this.debug&&console.log("OB",this.id,"read utmost",this.value);return this.value},write:function(e){return this.value!==e?(this.writer&&this.writer.call(this.scope,e,this.value),this.debug&&console.log("OB",this.id,"write ok",this.value,"->",e),this.value=e,this.touch()):this.debug&&console.log("OB",this.id,"write fail",e),this},touch:function(e){this.stale=!0,this.debug&&console.trace("OB",this.id,"touched");var t=this.debug;for(var i in this.targets){var n=this.targets[i];delete this.targets[i],t|=n.touch()}return t&&console.log("---> OB",this.id),t},destroy:function(){for(var e in this.sources)delete this.sources[e].targets[this.id],delete this.sources[e];this.touch()}},Timer.prototype={time:0,rate:1,running:!1,play:function(){if(this.running)return this;this.running=!0;var e=this,t=0,i=performance.now(),n=i,s=0,r=0;return!function i(){e.id=requestAnimationFrame(i),t++,s=performance.now(),r=(s-n)*e.rate,e.time+=r,e.func.call(e.scope,e.time,r,t),n=s}(),this},stop:function(){return this.running&&(this.running=!1,cancelAnimationFrame(this.id)),this}},Defer.all=function(e){function t(a,l){var h=e.indexOf(this);return a instanceof Defer?(e[h]=a,void a.then(t,t)):(l?++r:++o,s[h]=a,void(r+o>=n&&setTimeout(function(){i.transition(!o,s)},0)))}var i=new Defer,n=e&&e.length||0,s=new Array(e.length),r=0,o=0;if(!n)return i.resolve(s),i;for(var a=0;a<n;a++){var l=e[a];l instanceof Defer?l.then(t,t,l):(s[a]=l,r++)}return i},Defer.complete=function(e,t){var i=new Defer;return i.success=e,i.value=t,i},Defer.timer=function(e){function t(t,i){var n=new Defer;return setTimeout(function(){n.transition(t,i)},e||0),n}return new Defer(t,t)},Defer.prototype={unsafe:!1,set:function(e,t,i,n){return this.onresolve="function"==typeof e?e:null,this.onreject="function"==typeof t?t:null,this.scope=this.onreject?i:t||i,this.unsafe=!!n,this.unsafe=1,this},abort:function(){return delete this.head,delete this.tail,this.set(null)},then:function(e,t,i,n){return this.push(new Defer(e,t,i,n))},anyway:function(e,t,i){return this.push(new Defer(e,e,t,i))},delay:function(e){return this.push(Defer.timer(e))},push:function(e){return this.tail?this.tail=this.tail.next=e:this.head=this.tail=e,this.dispatch(),e},resolve:function(e,t){return this.transition(!0,e,t)},reject:function(e,t){return this.transition(!1,e,t)},transition:function(e,t){if(this.debug&&console.log("defer",this.debug,e?"resolve":"reject",this.pending?"ok":"no",t),!this.pending)return this;this.pending=!1;var i=e?this.onresolve:this.onreject;if(i)if(this.unsafe)this.value=i.call(this.scope,t,e),this.success=!0;else try{this.value=i.call(this.scope,t,e),this.success=!0}catch(e){this.value=e,this.success=!1}else this.success=e,this.value=t;return this.dispatch(),this},dispatch:function(){if(this.pending)return this;var e=this.head;if(delete this.head,delete this.tail,e)if(this.value instanceof Defer)this.value.push(e);else for(;e;)e.transition(this.success,this.value,this),e=e.next;else if(!this.success)throw this.value;return this}},Gate.prototype={on:function(e){this.inputs[e]=!0,this.check()},off:function(e){this.inputs[e]=!1,this.check()},set:function(e,t){this.inputs[t]=e,this.check()},will:function(e,t){var i=this;return function(){i.set(e,t)}},check:function(e){var t=Gate.UNSET;for(var i in this.inputs)t=Gate.UNSET===t?this.inputs[i]:this.method(t,this.inputs[i]);Gate.UNSET===t&&(t=this.value),(!this.value!=!t||e)&&this.events.emit(t?"opened":"closed",!!t),(this.value!==t||e)&&(this.value=t,this.events.emit("change",t))},constructor:Gate},Gate.UNSET={},Gate.MULTIPLY=function(e,t){return e*t},Gate.ADD=function(e,t){return e+t},Gate.AND=function(e,t){return e&&t},Gate.OR=function(e,t){return e||t},Loader.prototype={randomize:!1,reset:function(){this.units=[],this.defers=[]},wait:function(e){this.defers.push(e)},abort:function(e){e?e.abort():(this.units.forEach(this.abort,this),this.reset())},load:function(e,t,i){var n=Loader.Resource.types[e];if(!n)throw TypeError("Loader: unknown type: "+e);var s={};for(var r in n)s[r]=n[r];for(var r in i)s[r]=i[r];var o=new Loader.Resource(t,s,this);return this.units.push(o),this.defers.push(o.deferTail),o.transport(),o},progress:function(){this.unitsTotal=this.units.length,this.unitsLoaded=0,this.bytesTotal=0,this.bytesLoaded=0;for(var e=0;e<this.unitsTotal;e++){var t=this.units[e];this.unitsLoaded+=t.deferTail.pending?0:1,this.bytesTotal+=t.bytesTotal,this.bytesLoaded+=t.bytesLoaded}"function"==typeof this.onProgressCallback&&this.onProgressCallback.call(this.onProgressScope,this)},onProgress:function(e,t){this.onProgressCallback=e,this.onProgressScope=t},ready:function(e,t,i){var n=Defer.all(this.defers);return arguments.length?n.then(e,t,i):n}},Loader.imageTransport=function(){var e=this,t=new Image;e.data=t,t.onload=function(){e.deferHead.resolve(t)},t.onerror=function(t){e.deferHead.reject(t)},t.onprogress=function(t){e.bytesLoaded=t.loaded,e.bytesTotal=t.total,e.loader.progress()},t.src=e.source},Loader.ajaxTransport=function(){var e=this,t=new XMLHttpRequest,i=[];for(var n in e.query)i.push(encodeURIComponent(n)+"="+encodeURIComponent(e.query[n]));var s=i.join("&");e.request=t,e.requestType=e.requestType?e.requestType.toUpperCase():"GET","GET"===e.requestType&&s&&(e.source+="?"+s),t.open(e.requestType,e.source,!0),t.responseType=e.responseType||"";for(var r in e.headers)t.setRequestHeader(r,e.headers[r]);t.onreadystatechange=function(){4===t.readyState&&(200<=t.status&&t.status<400?(e.data=t[e.responseName||"responseText"],e.deferHead.resolve(e.data)):e.deferHead.reject("HTTP "+t.status))},t.onprogress=function(t){e.bytesLoaded=t.loaded,e.bytesTotal=t.lengthComputable?t.total:3*t.loaded,e.loader.progress()},t.send("POST"===e.requestType?s:null)},Loader.extend=function(e,t){Loader.prototype[e]&&console.warn("Loader.extend: overwriting "+e),Loader.Resource.types[e]=t,Loader.prototype[e]=function(t,i){return this.load(e,t,i)}},Loader.Resource=function(e,t,i){for(var n in t)this[n]=t[n];this.url=e,this.loader=i,this.bytesTotal=0,this.bytesLoaded=0,this.source=(this.url+"").replace(/#.*$/,""),(this.randomize||i.randomize)&&(this.source+="&?"[+!~this.source.indexOf("?")]+Math.random()),this.deferHead=new Defer(this.prepare,this),this.saveAs||this.saveTo?this.defer=this.deferHead.then(this.save,this):this.defer=this.deferHead.then(),this.deferTail=this.defer},Loader.Resource.prototype={save:function(e){var t=this.saveTo||this.loader.data,i=this.saveAs||"data";return t[i]=e},abort:function(){return this.request&&this.request.abort(),this.deferHead.init(null),this.deferTail.init(null),this}},Loader.Resource.types={},!function(){var e={image:{transport:Loader.imageTransport},text:{transport:Loader.ajaxTransport},post:{transport:Loader.ajaxTransport,requestType:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},query:null},json:{transport:Loader.ajaxTransport,prepare:JSON.parse},xml:{responseName:"responseXML",transport:Loader.ajaxTransport},buffer:{responseType:"arraybuffer",responseName:"response",transport:Loader.ajaxTransport}};for(var t in e)Loader.extend(t,e[t])}(),Loader.extend("obj",{transport:Loader.ajaxTransport,saveMetadata:!1,computeBoundingBox:!1,randomColor:!0,verbose:!1,prepare:function(e){function t(e){return e<0&&(e=c.vertices.length+e+1),c.vertices[e]||h.verbose&&console.warn("Loader.obj: undefined vertex "+e),e<u?o.vertices.push(c.vertices[e])-1:e-u}function i(){o=new THREE.Geometry,a=new THREE.MeshBasicMaterial,l=new THREE.Mesh(o,a),h.randomColor&&a.color.set(Math.round(16777215*Math.random())),u=c.vertices.length,c.meshes.push(l)}function n(e,t,i,n,s,r,a,l,c,u){if(v.subVectors(a[i],a[t]),g.subVectors(a[e],a[t]),v.cross(g),!v.x&&!v.y&&!v.z)return void(h.verbose&&console.warn('[Loader.obj] collapsed face "'+h.url+'":',u,[e,t,i]));v.normalize();var d=new THREE.Face3(n[e],n[t],n[i]);d.normal.copy(v),c&&d.vertexNormals.push(r[e],r[t],r[i]),o.faceVertexUvs[0].push(l?[s[e],s[t],s[i]]:b),o.faces.push(d)}function s(){o&&o.vertices.length&&(h.computeBoundingBox&&o.computeBoundingBox(),p.add(l))}function r(){d&&(d=!1,s(),i())}for(var o,a,l,h=this,c={vertices:[],normals:[],meshes:[],uvs:[]},u=0,d=!0,p=new THREE.Object3D,f=p,m=new THREE.Vector2,v=new THREE.Vector3,g=new THREE.Vector3,b=[m,m,m],y=-1,w=0;w!==-1;){var E=e.indexOf("\n",w+1),x=e.substr(w,E-w).replace(/#.*/,"").trim();if(y++,w=E,x){var T=x.split(/\s+/),_=T[0],k=T.slice(1);switch(_){case"mtllib":break;case"o":break;case"s":break;case"usemtl":l.material.name=k.join(" ");break;case"g":l.name=k.join(" ");break;case"v":r();var R=new THREE.Vector3(parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2]));c.vertices.push(R),o.vertices.push(R);break;case"vn":c.normals.push(new THREE.Vector3(parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2])));break;case"vt":c.uvs.push(new THREE.Vector2(parseFloat(k[0]),parseFloat(k[1])));break;case"f":for(var S=k.length,M=!0,C=!0,A=[],H=[],L=[],N=[],I=0;I<S;I++){var P=k[I].split("/"),D=t(parseInt(P[0])-1),O=c.uvs[parseInt(P[1])-1],B=c.normals[parseInt(P[2])-1];A.push(D),H.push(O),L.push(B),N.push(o.vertices[D]),C&=!!O,M&=!!B}if(4===S)n(0,1,3,A,H,L,N,C,M,y),n(1,2,3,A,H,L,N,C,M,y);else{if(3!==S){h.verbose&&console.warn("[Loader.obj] unknown face with",S,"vertices");continue}n(0,1,2,A,H,L,N,C,M,y)}d=!0;break;default:h.verbose&&console.log('Loader.obj: unhandled "'+x+'"')}}}return s(),this.saveMetadata&&(f.metadata=c),f}}),Drag.prototype={active:!1,disabled:!1,start:function(e,t){this.active=!0,this.moves=0,this.begin.x=e,this.begin.y=t,this.origin.x=this.point.x,this.origin.y=this.point.y,this.offset.x=this.delta.x=0,this.offset.y=this.delta.y=0},move:function(e,t){this.active&&(this.moves++,this.delta.x=-this.point.x,this.delta.y=-this.point.y,this.offset.x=(e-this.begin.x)*this.scale.x,this.offset.y=(t-this.begin.y)*this.scale.y,this.point.x=Math.min(this.max.x,Math.max(this.min.x,this.origin.x+this.offset.x)),this.point.y=Math.min(this.max.y,Math.max(this.min.y,this.origin.y+this.offset.y)),this.delta.x+=this.point.x,this.delta.y+=this.point.y)},end:function(){this.active=!1},enable:function(){this.disabled=!1},disable:function(){this.active&&this.end(),this.disabled=!0},bind:function(e,t){t&&t.addEventListener(e,this)},unbind:function(e,t){t&&t.removeEventListener(e,this)},handleEvent:function(e){if(!this.disabled){if(this.mouse.x=0,this.mouse.y=0,e.touches){for(var t=e.touches.length,i=0;i<t;i++){var n=e.touches[i];this.mouse.x+=n.pageX,this.mouse.y+=n.pageY}this.mouse.x/=t,this.mouse.y/=t}else this.mouse.x=e.pageX,this.mouse.y=e.pageY;var s;switch(e.type){case"mousedown":if(1!==e.which)return;this.mouseActive||(this.mouseActive=!0,this.bind("mousemove",window),this.bind("mouseup",window)),this.start(this.mouse.x,this.mouse.y),s="start";break;case"mousemove":if(!this.mouseActive)return;this.move(this.mouse.x,this.mouse.y),s="drag";break;case"mouseup":if(!this.mouseActive)return;this.mouseActive=!1,this.unbind("mousemove",window),this.unbind("mouseup",window),this.end(),s="end";break;case"touchstart":this.touchActive||(this.touchActive=!0,this.bind("touchstart",window),this.bind("touchmove",window),this.bind("touchend",window),this.unbind("touchstart",this.element)),this.start(this.mouse.x,this.mouse.y),s="start";break;case"touchmove":if(!this.touchActive)return;this.move(this.mouse.x,this.mouse.y),s="drag";break;case"touchend":if(!this.touchActive)return;e.touches.length?this.start(this.mouse.x,this.mouse.y):(this.touchActive=!1,this.unbind("touchstart",window),this.unbind("touchmove",window),this.unbind("touchend",window),this.bind("touchstart",this.element),this.end(),s="end")}s&&this.events.emit(s,[this,e]),e.preventDefault()}}},Momentum.prototype={pointsLength:5,friction:Math.pow(.87,.06),threshold:1e-5,time:function(){return window.performance&&window.performance.now?window.performance.now():Date.now?Date.now():(new Date).getTime()},push:function(e,t,i){this.point.x=+e||0,this.point.y=+t||0,this.point.z=+i||0,this.point.t=this.time(),this.points.push({x:this.point.x,y:this.point.y,z:this.point.z,t:this.point.t});var n=this.points.length-this.pointsLength;n>0&&this.points.splice(0,n)},updateSpeed:function(){this.speed0=Math.sqrt(this.speed.x*this.speed.x+this.speed.y*this.speed.y+this.speed.z*this.speed.z)},updateAccel:function(e){this.limit=1/(1-this.friction)},updateTarget:function(){this.target.x=this.point.x+this.speed.x*this.limit,this.target.y=this.point.y+this.speed.y*this.limit,this.target.z=this.point.z+this.speed.z*this.limit},updateDistance:function(){this.delta.x=this.target.x-this.point.x,this.delta.y=this.target.y-this.point.y,this.delta.z=this.target.z-this.point.z,this.distance=Math.sqrt(this.delta.x*this.delta.x+this.delta.y*this.delta.y+this.delta.z*this.delta.z)},updateDuration:function(){this.duration=Math.log(this.threshold/this.speed0)/Math.log(this.friction)},go:function(){if(!(this.points.length<2)){var e=this.points[0],t=this.point.x-e.x,i=this.point.y-e.y,n=this.point.z-e.z,s=this.point.t-e.t;this.speed.x=t/s,this.speed.y=i/s,this.speed.z=n/s,this.updateSpeed(),this.updateAccel(),this.updateTarget(),this.updateDuration(),this.updateDistance(),this.start()}},to:function(e,t,i){this.target.x=+e||0,this.target.y=+t||0,this.target.z=+i||0,this.updateDistance(),this.updateAccel(),this.speed.x=this.delta.x/this.limit,this.speed.y=this.delta.y/this.limit,this.speed.z=this.delta.z/this.limit,this.updateSpeed(),this.updateDuration(),this.start()},tot:function(e,t,i,n){this.duration=+e||0,this.target.x=+t||0,this.target.y=+i||0,this.target.z=+n||0,this.updateDistance(),this.updateAccel();var s=this.duration,r=this.distance;this.speed.x=this.delta.x/this.limit,this.speed.y=this.delta.y/this.limit,this.speed.z=this.delta.z/this.limit,this.updateSpeed(),this.updateDuration(),this.updateTarget(),this.updateDistance();for(var o=0;Math.abs(s-this.duration)/s>1e-4||Math.abs(r-this.distance)/r>1e-4;){this.friction=Math.pow(this.threshold/this.speed0,1/s),this.limit=1/(1-this.friction),this.updateTarget(),this.updateDistance();var a=r/this.distance;if(this.speed.x*=a,this.speed.y*=a,this.speed.z*=a,this.updateSpeed(),this.updateDuration(),++o>10)break}this.updateTarget(),this.updateDistance(),this.start()},update:function(){if(this.ended=!1,this.active){this.timeNow=this.time(),this.timeDelta=Math.round(this.timeNow-this.timeLast),this.timeLast+=this.timeDelta;for(var e=0,t=0;t<this.timeDelta;t++)e+=Math.pow(this.friction,t);this.delta.x=this.speed.x*e,this.delta.y=this.speed.y*e,this.delta.z=this.speed.z*e,this.point.x+=this.delta.x,this.point.y+=this.delta.y,this.point.z+=this.delta.z;var i=Math.pow(this.friction,this.timeDelta);this.speed.x*=i,this.speed.y*=i,this.speed.z*=i,this.updateSpeed(),this.speed0<this.threshold&&(this.ended=!0,this.stop())}},start:function(){this.updateSpeed(),this.debug&&console.log(this.debug,"start",this.speed0<this.threshold),this.speed0<this.threshold||(this.timeLast=this.time(),this.timeStart=this.timeLast,this.timeEnd=this.timeStart+this.duration,this.active=!0)},stop:function(){this.debug&&console.log(this.debug,"stop",this.active),this.active&&(this.points=[],this.active=!1)}},Block=f.unit({unitName:"Block",etag:"div",ename:"block",visibleMethod:dom.display,cacheSize:!0,x:0,y:0,init:function(e){f.copy(this,e),this.watchAtlas=[],this.watchLocale=[],this.watchEvents=[];for(var t=0;t<this.protochain.length;t++)this.invoke(this.protochain[t],"create");for(var t=0;t<this.protochain.length;t++)this.invoke(this.protochain[t],"createPost")},invoke:function(e,t){if(Object.prototype.hasOwnProperty.call(e,t)&&"function"==typeof e[t])return e[t].call(this)},create:function(){this.events||(this.events=new EventEmitter),this.visible||(this.visible=new Gate(Gate.AND,!this.hidden)),this.element||(this.element=dom.elem(this.etag,null,this.eroot))},createPost:function(){dom.addclass(this.element,this.ename),this.visible.events.on("change",this.visibleMethod,this,this.element),this.visible.check(!0),this.text&&dom.text(this.element,this.text),this.elabel&&this.watchLocale.push(Locale.setText(dom.div("block-label",this.element),this.elabel)),this.etext&&this.watchLocale.push(Locale.setText(this.element,this.etext)),this.etitle&&this.watchLocale.push(Locale.setTitle(this.element,this.etitle)),this.eicon&&(dom.addclass(this.element,"eicon"),this.watchAtlas.push(Atlas.set(this.element,this.eicon,"absmid")))},destroy:function(){this.watchAtlas.forEach(Atlas.free),this.watchAtlas=[],this.watchLocale.forEach(Locale.unwatch),this.watchLocale=[],this.watchEvents.forEach(f.func("release")),this.watchEvents=[],dom.remove(this.element)},resize:function(e,t){e|=0,t|=0,this.cacheSize&&this.width===e&&this.height===t||(this.element.style.width=e+"px",this.element.style.height=t+"px",this.width=e,this.height=t,this.onResize())},autoresize:function(){var e=this.element.offsetWidth,t=this.element.offsetHeight;this.cacheSize&&this.width===e&&this.height===t||(this.width=e,this.height=t,
this.onResize())},onResize:function(){}}),Block.Toggle=f.unit(Block,{unitName:"Block_Toggle",ename:"toggle",active:!0,reset:!1,disabled:!1,deselect:!0,auto:!0,create:function(){this.watchEvents.push(new EventHandler(this.ontap,this).listen("tap",this.element),new EventHandler(this.onover,this).listen("mouseenter",this.element))},createPost:function(){this.update()},ontap:function(){this.auto&&this.toggle(!0)},onover:function(){this.events.emit("hover",this)},toggle:function(e){this.set(!this.active,e)},set:function(e,t,i){return!(!i&&(this.disabled||this.active==e||!this.deselect&&!e))&&(this.reset||(this.active=e,this.update()),t&&(this.events.emit("change",e),this.events.emit(e?"active":"inactive",e)),!0)},update:function(){dom.togclass(this.element,"active",this.active),dom.togclass(this.element,"disabled",this.disabled),dom.togclass(this.element,"hand",!this.disabled&&(this.deselect||!this.active))}}),Block.List=f.unit(Block,{unitName:"Block_List",ename:"list",cname:"list-item",blocks:null,items:null,options:{ename:"list-item",factory:Block},create:function(){this.blocks=[],this.container=this.element},createPost:function(){this.addItemList(this.items)},addItemList:function(e){e&&e.forEach(this.addItem,this)},addItem:function(e){"string"==typeof e&&(e={data:e});var t=f.merge({eroot:this.container},this.options,e);return this.addBlock(new t.factory(t))},addBlock:function(e){return this.blocks.push(e),this.events.emit("block_add",e),e},removeBlock:function(e,t){var i=this.blocks.indexOf(e);return i!==-1&&(this.blocks.splice(i,1),t?e.destroy():dom.remove(e.element),!0)},destroy:function(){Block.prototype.destroy.call(this),this.clearBlocks(!0)},clearBlocks:function(e){for(var t=this.blocks.length-1;t>=0;t--)this.removeBlock(this.blocks[t],e)}}),Block.Menu=f.unit(Block.List,{unitName:"Block_Menu",ename:"menu",active:-1,options:{ename:"menu-item",factory:Block.Toggle},addBlock:function(e){return e.events.when({change:this.onitemchange,hover:this.onitemhover},this,e),e.set(0),Block.List.prototype.addBlock.call(this,e)},removeBlock:function(e,t){var i=Block.List.prototype.removeBlock.call(this,e,t);return i&&e.events.off(null,null,this),i},update:function(){for(var e=this.blocks.length-1;e>=0;e--){var t=this.blocks[e];if(t.active)return this.active=e,this.activeBlock=t,void(this.activeItem=t.data)}this.active=-1,this.activeBlock=null,this.activeItem=null},onitemchange:function(e,t){this.unsetBlocks(e),this.update(),this.events.emit("change",this.activeItem)},onitemhover:function(e){this.events.emit("hover",e)},set:function(e,t){var i=this.blocks[e];i!==this.activeBlock&&(this.unsetBlocks(i,t),i&&i.set(1,t),this.update())},getIndex:function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];if(i.hasOwnProperty("data")&&i.data===e)return t}return-1},setItem:function(e,t){return this.set(this.getIndex(e),t)},unsetBlocks:function(e,t){for(var i=0;i<this.blocks.length;i++){var n=this.blocks[i];n!==e&&n.set(0,t,!0)}}}),Block.Tip=f.unit(Block,{unitName:"Block_Tip",ename:"tip",align:null,distance:8,arrowWidth:12,arrowPadding:8,animationTime:200,tweenDistance:20,create:function(){this.arrow=dom.div("tip-arrow",this.element),this.content=dom.div("tip-content",this.element),this.arrowPoint={x:0,y:0},this.elementPoint={x:0,y:0},this.transitionTween=new TWEEN.Tween({v:+!this.hidden}).easing(TWEEN.Easing.Cubic.Out).to({},this.animationTime).onStart(this.onTransitionStart,this).onUpdate(this.onTransitionUpdate,this).onComplete(this.onTransitionEnd,this)},moveToElement:function(e,t,i){if(e){var n=e.offsetWidth,s=e.offsetHeight,r=dom.offset(e,this.element.offsetParent);null==t&&(t=this.align||this.getAlign(r.x,r.y,n,s));var o=r.x,a=r.y;switch(t){case"left":a+=s/2;break;case"right":o+=n,a+=s/2;break;case"top":o+=n/2;break;case"bottom":o+=n/2,a+=s}this.move(o,a,t,i)}},move:function(e,t,i,n){null==i&&(i=this.align||this.getAlign(e,t,0,0));var s=this.element.offsetParent;if(s){var r,o,a,l,h,c=this.arrowWidth/2,u=this.arrowPadding,d=n||this.distance,p=this.element.offsetWidth,f=this.element.offsetHeight,m=s.offsetWidth,v=s.offsetHeight,g=p/2,b=f/2;switch(i){case"left":r=!1,o=e-p-d,a=t-b,l=p,h=b;break;case"right":r=!1,o=e+d,a=t-b,l=0,h=b;break;case"top":r=!0,o=e-g,a=t-d-f,l=g,h=f;break;case"bottom":r=!0,o=e-g,a=t+d,l=g,h=0;break;default:return}var y=Math.max(0,-o);y&&(r&&(l-=Math.min(g-c-u,y)),o+=y);var w=Math.max(0,o+p-m);w&&(r&&(l+=Math.min(g-c-u,w)),o-=w);var E=Math.max(0,-a);E&&(r||(h-=Math.min(b-c-u,E)),a+=E);var x=Math.max(0,a+f-v);switch(x&&(r||(h+=Math.min(b-c-u,x)),a-=x),i){case"left":d+=w-y;break;case"right":d+=y-w;break;case"top":d+=x-E;break;case"bottom":d+=E-x}this.arrowPoint.x===l&&this.arrowPoint.y===h&&Math.abs(this.elementPoint.x-o)<2&&Math.abs(this.elementPoint.y-a)<2&&this.lastDistance===d&&this.lastAlign===i||(this.arrowPoint.x=l,this.arrowPoint.y=h,this.arrow.style.left=l+"px",this.arrow.style.top=h+"px",this.elementPoint.x=o,this.elementPoint.y=a,this.lastDistance=d,this.lastAlign=i,this.updateTransform())}},alignAxes:{left:{x:1,y:0},right:{x:-1,y:0},top:{x:0,y:1},bottom:{x:0,y:-1}},transitionAxis:null,updateTransform:function(){var e=(1-this.transitionTween.source.v)*this.tweenDistance,t=this.elementPoint,i=this.transitionAxis||this.alignAxes[this.lastAlign||this.align]||{x:0,y:0};this.transform(this.element,t.x+e*i.x,t.y+e*i.y)},transform:function(e,t,i,n){var s=" translateX("+f.hround(t||0)+"px) translateY("+f.hround(i||0)+"px)      scale("+f.hround(n||1)+")";e.style.webkitTransform=s,e.style.mozTransform=s,e.style.msTransform=s,e.style.OTransform=s,e.style.transform=s},getAlign:function(e,t,i,n){var s=this.element.offsetParent;if(!s)return null;var r=s.offsetWidth,o=s.offsetHeight,a=this.element.offsetWidth,l=this.element.offsetHeight,h=t,c=r-e-i,u=o-t-n,d=e,p=["top","right","bottom","left"],f=[h-l,c-a,u-l,d-a],m=Math.max.apply(null,f),v=f.indexOf(m);return p[v]},visibleMethod:function(e,t){return this.initVisible?(this.visible.value&&dom.append(this.tipRoot,this.element),this.transitionTween.target.v=+t,void this.transitionTween.start()):(this.initVisible=!0,this.transitionTween.source.v=+t,this.onTransitionUpdate(),void this.onTransitionEnd())},onTransitionStart:function(){this.inTransition=!0},onTransitionUpdate:function(){this.element.style.opacity=this.transitionTween.source.v,this.updateTransform()},onTransitionEnd:function(){this.visible.value||dom.remove(this.element),this.inTransition=!1}}),Atlas={svg:null,items:[],setSource:function(e){e&&(Atlas.svg=e.documentElement||e,Atlas.svg.removeAttribute("width"),Atlas.svg.removeAttribute("height"),Atlas.update())},update:function(){Atlas.items.forEach(Atlas.updateItem)},set:function(e,t,i){var n=f.apick(Atlas.items,"element",e);return n||(n={element:e},Atlas.items.push(n)),n.id=t,n.name=i,Atlas.svg&&Atlas.updateItem(n),e},free:function(e){for(var t=Atlas.items.length-1;t>=0;t--){var i=Atlas.items[t];if(i.element===e)return dom.remove(i.icon),void Atlas.items.splice(t,1)}},updateItem:function(e){var t=Atlas.get(e.id);t?e.name&&(t.className.baseVal+=" "+e.name):(t=dom.div(e.name),dom.text(t,e.id)),e.icon?(dom.insert(e.element,t,e.icon),dom.remove(e.icon)):dom.append(e.element,t),e.icon=t},get:function(e){if(!Atlas.svg)return null;var t=Atlas.svg.getElementById(e);if(!t)return null;var i=Atlas.svg.cloneNode(!1);return i.appendChild(t.cloneNode(!0)),i.className.baseVal=e,i}},Locale={name:null,data:null,counter:0,assets:{},items:[],add:function(e,t){var i=Locale.assets[e];i||(i=Locale.assets[e]={});for(var n in t)i[n]=t[n]},get:function(e){return Locale.data&&e in Locale.data?Locale.data[e]:Locale.name+"/"+e},set:function(e){Locale.name=e,Locale.data=Locale.assets[Locale.name],Locale.update()},update:function(){Locale.items.forEach(Locale.updateItem)},updateItem:function(e){e.func.call(e.scope,Locale.get(e.token),e.data)},watch:function(e,t,i,n){var s={id:++Locale.counter,token:e,func:t,scope:i,data:n};return Locale.items.push(s),Locale.updateItem(s),s.id},unwatch:function(e){for(var t=Locale.items.length-1;t>=0;t--)if(Locale.items[t].id===e)return void Locale.items.splice(t,1)},setText:function(e,t){return Locale.watch(t,Locale._setText,null,e)},setTitle:function(e,t){return Locale.watch(t,Locale._setAttribute,null,{element:e,name:"title"})},setAttribute:function(e,t,i){return Locale.watch(i,Locale._setAttribute,null,{element:t,name:e})},setHtml:function(e,t){return Locale.watch(t,Locale._setHtml,null,e)},_setAttribute:function(e,t){t.element.setAttribute(t.name,e)},_setText:function(e,t){dom.text(t,e)},_setHtml:function(e,t){dom.html(t,e)}},THREE.Plane.prototype.intersectPlane=function(e,t){for(var i=1e-9,n=this.normal.toArray(),s=this.constant,r=e.normal.toArray(),o=e.constant,a=0;a<6;a++){var l=a<2?1:0,h=a<4?2:1,c=a>>1,u=a%2?l:h,d=a%2?h:l,p=n[c],f=n[u],m=r[c],v=r[u],g=v*p-f*m,b=(m*s-p*o)/g,y=-(f*b+s)/p;if(Math.abs(p)>i&&Math.abs(g)>i){var w=t||new THREE.Ray;return w.direction.crossVectors(this.normal,e.normal).normalize(),w.origin.setComponent(c,y),w.origin.setComponent(u,b),w.origin.setComponent(d,0),w}}},THREE.Box2.prototype.emptyEPS=function(){var e=1e-9;return this.max.x-this.min.x<e||this.max.y-this.min.y<e},THREE.Ray.prototype.atY=function(e,t){var i=(e-this.origin.y)/this.direction.y;return this.at(i,t)},THREE.Ray.prototype.distanceToPlane=function(e,t){var i=e.normal.dot(this.direction);if(0==i)return 0==e.distanceToPoint(this.origin)?0:null;var n=-(this.origin.dot(e.normal)+e.constant)/i;return t||n>=0?n:null},THREE.Ray.prototype.intersectPlane=function(e,t,i){var n=this.distanceToPlane(e,i);return null===n?null:this.at(n,t)},THREE.Sphere.prototype.expandByPoint=function(e){this.center.sub(e);var t=this.center.length()+this.radius;return this.radius=t/2,this.center.setLength(t),this.center.add(e),this},THREE.Sphere.prototype.union=function(e){this.center.sub(e.center);var t=this.center.length()+this.radius,i=t+e.radius;return this.radius=i/2,this.center.setLength(t),this.center.add(e.center),this.center.lerp(e.center,i/t),this},THREE.OrbitControls=function(e,t){function i(){return 2*Math.PI/60/60*f.autoRotateSpeed}function n(){return Math.pow(.95,f.zoomSpeed)}function s(e){if(f.enabled!==!1){if(e.preventDefault(),f.down=!0,0===e.button){if(f.noRotate===!0)return;I=N.ROTATE,v.set(e.clientX,e.clientY)}else if(1===e.button){if(f.noZoom===!0)return;I=N.DOLLY,_.set(e.clientX,e.clientY)}else if(2===e.button){if(f.noPan===!0)return;I=N.PAN,y.set(e.clientX,e.clientY)}document.addEventListener("mousemove",r,!1),document.addEventListener("mouseup",o,!1),f.dispatchEvent(B)}}function r(e){if(f.enabled!==!1){e.preventDefault();var t=f.domElement===document?f.domElement.body:f.domElement,i=t.clientWidth,n=t.clientHeight,s=f.object.position,r=s.clone().sub(f.target),o=r.length();if(o*=Math.tan(f.object.fov/2*Math.PI/180),I===N.ROTATE){if(f.noRotate===!0)return;g.set(e.clientX,e.clientY),b.subVectors(g,v),f.rotateLeft(2*Math.PI*b.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*b.y/t.clientHeight*f.rotateSpeed),v.copy(g)}else if(I===N.DOLLY){if(f.noZoom===!0)return;k.set(e.clientX,e.clientY),R.subVectors(k,_),f.panUp(2*R.y*o/n),_.copy(k)}else if(I===N.PAN){if(f.noPan===!0)return;w.set(e.clientX,e.clientY),E.subVectors(w,y),f.panLeft(2*E.x*o/i),f.panForward(2*E.y*o/n),y.copy(w)}f.update()}}function o(){f.enabled!==!1&&(f.down=!1,document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",o,!1),f.dispatchEvent(j),I=N.NONE)}function a(e){if(f.enabled!==!1&&f.noZoom!==!0){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.deltaY?t=-e.deltaY:void 0!==e.detail&&(t=-e.detail),t>0?f.dollyOut():f.dollyIn(),f.update(),f.dispatchEvent(B),f.dispatchEvent(j)}}function l(e){if(f.enabled===!1||f.noKeys===!0||f.noPan===!0)return!1;switch(e.keyCode){case f.keys.UP:f.pan(0,f.keyPanSpeed),f.update();break;case f.keys.BOTTOM:f.pan(0,-f.keyPanSpeed),f.update();break;case f.keys.LEFT:f.pan(f.keyPanSpeed,0),f.update();break;case f.keys.RIGHT:f.pan(-f.keyPanSpeed,0),f.update();break;default:return!1}return!0}function h(e){if(f.enabled!==!1){switch(e.touches.length){case 1:if(f.noRotate===!0)return;I=N.TOUCH_ROTATE,v.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(f.noZoom===!0)return;I=N.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);_.set(0,n);break;case 3:if(f.noPan===!0)return;I=N.TOUCH_PAN,y.set(e.touches[0].pageX,e.touches[0].pageY);break;default:I=N.NONE}f.dispatchEvent(B)}}function c(e){if(f.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=f.domElement===document?f.domElement.body:f.domElement;switch(e.touches.length){case 1:if(f.noRotate===!0)return;if(I!==N.TOUCH_ROTATE)return;g.set(e.touches[0].pageX,e.touches[0].pageY),b.subVectors(g,v),f.rotateLeft(2*Math.PI*b.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*b.y/t.clientHeight*f.rotateSpeed),v.copy(g),f.update();break;case 2:if(f.noZoom===!0)return;if(I!==N.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,s=Math.sqrt(i*i+n*n);k.set(0,s),C*=_.y/k.y,_.copy(k),f.update();break;case 3:if(f.noPan===!0)return;if(I!==N.TOUCH_PAN)return;w.set(e.touches[0].pageX,e.touches[0].pageY),E.subVectors(w,y),f.pan(E.x,E.y),y.copy(w),f.update();break;default:I=N.NONE}}}function u(){f.enabled!==!1&&(f.dispatchEvent(j),I=N.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=2,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.borderBox=new THREE.Box3;var d=this.borderBox.min,p=this.borderBox.max;d.x=d.y=d.z=-(1/0),p.x=p.y=p.z=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var f=this,m=1e-6,v=new THREE.Vector2,g=new THREE.Vector2,b=new THREE.Vector2,y=new THREE.Vector2,w=new THREE.Vector2,E=new THREE.Vector2,x=new THREE.Vector3,T=new THREE.Vector3,_=new THREE.Vector2,k=new THREE.Vector2,R=new THREE.Vector2,S=0,M=0,C=1,A=new THREE.Vector3,H=new THREE.Vector3,L=new THREE.Quaternion,N={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},I=N.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var P=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),D=P.clone().inverse(),O={type:"change"},B={type:"start"},j={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=i()),M-=e},this.rotateUp=function(e){void 0===e&&(e=i()),S-=e},this.panLeft=function(e){var t=this.object.matrix.elements;x.set(t[0],t[1],t[2]);var i=x.length();x.y=0,x.setLength(i),x.multiplyScalar(-e),A.add(x)},this.panUp=function(e){var t=this.object.matrix.elements;x.set(t[4],t[5],t[6]);var i=x.length();x.x=x.z=0,x.setLength(i),x.multiplyScalar(e),A.add(x)},this.panForward=function(e){var t=this.object.matrix.elements;x.set(t[8],t[9],t[10]);var i=x.length();x.y=0,x.setLength(i),x.multiplyScalar(-e),A.add(x)},this.pan=function(e,t){var i=f.domElement===document?f.domElement.body:f.domElement;if(void 0!==f.object.fov){var n=f.object.position,s=n.clone().sub(f.target),r=s.length();r*=Math.tan(f.object.fov/2*Math.PI/180),f.panLeft(2*e*r/i.clientHeight),f.panUp(2*t*r/i.clientHeight)}else void 0!==f.object.top?(f.panLeft(e*(f.object.right-f.object.left)/i.clientWidth),f.panUp(t*(f.object.top-f.object.bottom)/i.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=n()),C/=e},this.dollyOut=function(e){void 0===e&&(e=n()),C*=e},this.update=function(){var e=this.object.position;T.copy(e).sub(this.target),T.applyQuaternion(P);var t=Math.atan2(T.x,T.z),n=Math.atan2(Math.sqrt(T.x*T.x+T.z*T.z),T.y);this.autoRotate&&this.rotateLeft(i()),t+=M,n+=S,this.disableBorders||(n=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,n))),n=Math.max(m,Math.min(Math.PI-m,n)),this.radius=T.length()*C,this.disableBorders||(this.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this.radius))),this.target.add(A),this.disableBorders||this.borderBox.isEmpty()||(this.target.min(this.borderBox.max),this.target.max(this.borderBox.min)),T.x=this.radius*Math.sin(n)*Math.sin(t),T.y=this.radius*Math.cos(n),T.z=this.radius*Math.sin(n)*Math.cos(t),T.applyQuaternion(D),e.copy(this.target).add(T),T.lengthSq()&&this.object.lookAt(this.target),M=0,S=0,C=1,A.set(0,0,0),(H.distanceToSquared(this.object.position)>m||8*(1-L.dot(this.object.quaternion))>m)&&(this.changed=!0,this.dispatchEvent(O),H.copy(this.object.position),L.copy(this.object.quaternion))},this.reset=function(){I=N.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.domElement.addEventListener("contextmenu",function(e){f.enabled!==!1&&e.preventDefault()},!1),this.onKeyDown=l,this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("wheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1),this.domElement.addEventListener("touchstart",h,!1),this.domElement.addEventListener("touchend",u,!1),this.domElement.addEventListener("touchmove",c,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),function(){"use strict";var e=function(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};e.prototype=Object.create(THREE.MeshBasicMaterial.prototype),e.prototype.constructor=e;var t=function(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};t.prototype=Object.create(THREE.LineBasicMaterial.prototype),t.prototype.constructor=t;var i=new e({visible:!1,transparent:!1});THREE.TransformGizmo=function(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),i={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};this.activePlane=i.XYZE,i.YZ.rotation.set(0,Math.PI/2,0),i.XZ.rotation.set(-Math.PI/2,0,0);for(var n in i)i[n].name=n,this.planes.add(i[n]),this.planes[n]=i[n];var s=function(e,t){for(var i in e)for(n=e[i].length;n--;){var s=e[i][n][0],r=e[i][n][1],o=e[i][n][2];s.name=i,r&&s.position.set(r[0],r[1],r[2]),o&&s.rotation.set(o[0],o[1],o[2]),t.add(s)}};s(this.handleGizmos,this.handles),s(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof THREE.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name===e?t.material.highlight(!0):t.material.highlight(!1))})}},THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformGizmo.prototype.constructor=THREE.TransformGizmo,THREE.TransformGizmo.prototype.update=function(e,t){var i=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,1,0),s=new THREE.Matrix4;this.traverse(function(r){r.name.search("E")!==-1?r.quaternion.setFromRotationMatrix(s.lookAt(t,i,n)):r.name.search("X")===-1&&r.name.search("Y")===-1&&r.name.search("Z")===-1||r.quaternion.setFromEuler(e)})},THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var n=new THREE.Geometry,s=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));s.position.y=.5,s.updateMatrix(),n.merge(s.geometry,s.matrix);var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(n,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(r,new t({color:16711680}))]],Y:[[new THREE.Mesh(n,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(n,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new e({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),i)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()},THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoTranslate.prototype.constructor=THREE.TransformGizmoTranslate,THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var e=function(e,t,i){var n=new THREE.BufferGeometry,s=[];i=i?i:1;for(var r=0;r<=64*i;++r)"x"===t&&s.push(0,Math.cos(r/32*Math.PI)*e,Math.sin(r/32*Math.PI)*e),"y"===t&&s.push(Math.cos(r/32*Math.PI)*e,0,Math.sin(r/32*Math.PI)*e),"z"===t&&s.push(Math.sin(r/32*Math.PI)*e,Math.cos(r/32*Math.PI)*e,0);return n.addAttribute("position",new THREE.Float32BufferAttribute(s,3)),n};this.handleGizmos={X:[[new THREE.Line(new e(1,"x",.5),new t({color:16711680}))]],Y:[[new THREE.Line(new e(1,"y",.5),new t({color:65280}))]],Z:[[new THREE.Line(new e(1,"z",.5),new t({color:255}))]],E:[[new THREE.Line(new e(1.25,"z",1),new t({color:13421568}))]],XYZE:[[new THREE.Line(new e(1,"z",1),new t({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.12,2,24),i)]],XYZE:[[new THREE.Mesh]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){THREE.TransformGizmo.prototype.update.apply(this,arguments);var i=new THREE.Matrix4,n=new THREE.Euler(0,0,1),s=new THREE.Quaternion,r=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,h=new THREE.Quaternion,c=new THREE.Quaternion,u=t.clone();n.copy(this.planes.XY.rotation),s.setFromEuler(n),i.makeRotationFromQuaternion(s).getInverse(i),u.applyMatrix4(i),this.traverse(function(e){s.setFromEuler(n),"X"===e.name&&(l.setFromAxisAngle(r,Math.atan2(-u.y,u.z)),s.multiplyQuaternions(s,l),e.quaternion.copy(s)),"Y"===e.name&&(h.setFromAxisAngle(o,Math.atan2(u.x,u.z)),s.multiplyQuaternions(s,h),e.quaternion.copy(s)),"Z"===e.name&&(c.setFromAxisAngle(a,Math.atan2(u.y,u.x)),s.multiplyQuaternions(s,c),e.quaternion.copy(s))})},this.init()},THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoRotate.prototype.constructor=THREE.TransformGizmoRotate,THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var n=new THREE.Geometry,s=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));s.position.y=.5,s.updateMatrix(),n.merge(s.geometry,s.matrix);var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(n,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(r,new t({color:16711680}))]],Y:[[new THREE.Mesh(n,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(n,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),new e({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.4,.4,.4),i)]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()},THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoScale.prototype.constructor=THREE.TransformGizmoScale,THREE.TransformControls=function(e,t){function i(e){if(void 0!==a.object&&h!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e,i=o(t,c[l].pickers.children),n=null;i&&(n=i.object.name,e.preventDefault()),a.axis!==n&&(a.axis=n,a.update(),a.dispatchEvent(p))}}function n(e){if(void 0!==a.object&&h!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var i=o(t,c[l].pickers.children);if(i){e.preventDefault(),e.stopPropagation(),a.dispatchEvent(f),a.axis=i.object.name,a.update(),k.copy(G).sub(V).normalize(),c[l].setActivePlane(a.axis,k);var n=o(t,[c[l].activePlane]);n&&(O.copy(a.object.position),B.copy(a.object.scale),j.extractRotation(a.object.matrix),X.extractRotation(a.object.matrixWorld),F.extractRotation(a.object.parent.matrixWorld),z.setFromMatrixScale(R.getInverse(a.object.parent.matrixWorld)),w.copy(n.point))}}h=!0}}function s(e){if(void 0!==a.object&&null!==a.axis&&h!==!1&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e,i=o(t,[c[l].activePlane]);i!==!1&&(e.preventDefault(),e.stopPropagation(),y.copy(i.point),"translate"===l?(y.sub(w),y.multiply(z),"local"===a.space&&(y.applyMatrix4(R.getInverse(X)),a.axis.search("X")===-1&&(y.x=0),a.axis.search("Y")===-1&&(y.y=0),a.axis.search("Z")===-1&&(y.z=0),y.applyMatrix4(j),a.object.position.copy(O),a.object.position.add(y)),"world"!==a.space&&a.axis.search("XYZ")===-1||(a.axis.search("X")===-1&&(y.x=0),a.axis.search("Y")===-1&&(y.y=0),a.axis.search("Z")===-1&&(y.z=0),y.applyMatrix4(R.getInverse(F)),a.object.position.copy(O),a.object.position.add(y)),null!==a.translationSnap&&("local"===a.space&&a.object.position.applyMatrix4(R.getInverse(X)),a.axis.search("X")!==-1&&(a.object.position.x=Math.round(a.object.position.x/a.translationSnap)*a.translationSnap),a.axis.search("Y")!==-1&&(a.object.position.y=Math.round(a.object.position.y/a.translationSnap)*a.translationSnap),a.axis.search("Z")!==-1&&(a.object.position.z=Math.round(a.object.position.z/a.translationSnap)*a.translationSnap),"local"===a.space&&a.object.position.applyMatrix4(X))):"scale"===l?(y.sub(w),y.multiply(z),"local"===a.space&&("XYZ"===a.axis?(T=1+y.y/Math.max(B.x,B.y,B.z),a.object.scale.x=B.x*T,a.object.scale.y=B.y*T,a.object.scale.z=B.z*T):(y.applyMatrix4(R.getInverse(X)),"X"===a.axis&&(a.object.scale.x=B.x*(1+y.x/B.x)),"Y"===a.axis&&(a.object.scale.y=B.y*(1+y.y/B.y)),"Z"===a.axis&&(a.object.scale.z=B.z*(1+y.z/B.z))))):"rotate"===l&&(y.sub(V),y.multiply(z),S.copy(w).sub(V),S.multiply(z),"E"===a.axis?(y.applyMatrix4(R.getInverse(_)),S.applyMatrix4(R.getInverse(_)),E.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.set(Math.atan2(S.z,S.y),Math.atan2(S.x,S.z),Math.atan2(S.y,S.x)),M.setFromRotationMatrix(R.getInverse(F)),D.setFromAxisAngle(k,E.z-x.z),L.setFromRotationMatrix(X),M.multiplyQuaternions(M,D),M.multiplyQuaternions(M,L),a.object.quaternion.copy(M)):"XYZE"===a.axis?(D.setFromEuler(y.clone().cross(S).normalize()),M.setFromRotationMatrix(R.getInverse(F)),N.setFromAxisAngle(D,-y.clone().angleTo(S)),L.setFromRotationMatrix(X),M.multiplyQuaternions(M,N),M.multiplyQuaternions(M,L),a.object.quaternion.copy(M)):"local"===a.space?(y.applyMatrix4(R.getInverse(X)),S.applyMatrix4(R.getInverse(X)),E.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.set(Math.atan2(S.z,S.y),Math.atan2(S.x,S.z),Math.atan2(S.y,S.x)),L.setFromRotationMatrix(j),null!==a.rotationSnap?(N.setFromAxisAngle(C,Math.round((E.x-x.x)/a.rotationSnap)*a.rotationSnap),I.setFromAxisAngle(A,Math.round((E.y-x.y)/a.rotationSnap)*a.rotationSnap),P.setFromAxisAngle(H,Math.round((E.z-x.z)/a.rotationSnap)*a.rotationSnap)):(N.setFromAxisAngle(C,E.x-x.x),I.setFromAxisAngle(A,E.y-x.y),P.setFromAxisAngle(H,E.z-x.z)),"X"===a.axis&&L.multiplyQuaternions(L,N),"Y"===a.axis&&L.multiplyQuaternions(L,I),"Z"===a.axis&&L.multiplyQuaternions(L,P),a.object.quaternion.copy(L)):"world"===a.space&&(E.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.set(Math.atan2(S.z,S.y),Math.atan2(S.x,S.z),Math.atan2(S.y,S.x)),M.setFromRotationMatrix(R.getInverse(F)),null!==a.rotationSnap?(N.setFromAxisAngle(C,Math.round((E.x-x.x)/a.rotationSnap)*a.rotationSnap),I.setFromAxisAngle(A,Math.round((E.y-x.y)/a.rotationSnap)*a.rotationSnap),P.setFromAxisAngle(H,Math.round((E.z-x.z)/a.rotationSnap)*a.rotationSnap)):(N.setFromAxisAngle(C,E.x-x.x),I.setFromAxisAngle(A,E.y-x.y),P.setFromAxisAngle(H,E.z-x.z)),L.setFromRotationMatrix(X),"X"===a.axis&&M.multiplyQuaternions(M,N),"Y"===a.axis&&M.multiplyQuaternions(M,I),"Z"===a.axis&&M.multiplyQuaternions(M,P),M.multiplyQuaternions(M,L),a.object.quaternion.copy(M))),a.update(),a.dispatchEvent(p),a.dispatchEvent(v))}}function r(e){e.preventDefault(),void 0!==e.button&&0!==e.button||(h&&null!==a.axis&&(m.mode=l,
a.dispatchEvent(m)),h=!1,"TouchEvent"in window&&e instanceof TouchEvent?(a.axis=null,a.update(),a.dispatchEvent(p)):i(e))}function o(i,n){var s=t.getBoundingClientRect(),r=(i.clientX-s.left)/s.width,o=(i.clientY-s.top)/s.height;b.set(2*r-1,-(2*o)+1),g.setFromCamera(b,e);var a=g.intersectObjects(n,!0);return!!a[0]&&a[0]}THREE.Object3D.call(this),t=void 0!==t?t:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null;var a=this,l="translate",h=!1,c={translate:new THREE.TransformGizmoTranslate,rotate:new THREE.TransformGizmoRotate,scale:new THREE.TransformGizmoScale};for(var u in c){var d=c[u];d.visible=u===l,this.add(d)}var p={type:"change"},f={type:"mouseDown"},m={type:"mouseUp",mode:l},v={type:"objectChange"},g=new THREE.Raycaster,b=new THREE.Vector2,y=new THREE.Vector3,w=new THREE.Vector3,E=new THREE.Vector3,x=new THREE.Vector3,T=1,_=new THREE.Matrix4,k=new THREE.Vector3,R=new THREE.Matrix4,S=new THREE.Vector3,M=new THREE.Quaternion,C=new THREE.Vector3(1,0,0),A=new THREE.Vector3(0,1,0),H=new THREE.Vector3(0,0,1),L=new THREE.Quaternion,N=new THREE.Quaternion,I=new THREE.Quaternion,P=new THREE.Quaternion,D=new THREE.Quaternion,O=new THREE.Vector3,B=new THREE.Vector3,j=new THREE.Matrix4,F=new THREE.Matrix4,z=new THREE.Vector3,V=new THREE.Vector3,U=new THREE.Euler,X=new THREE.Matrix4,G=new THREE.Vector3,W=new THREE.Euler;t.addEventListener("mousedown",n,!1),t.addEventListener("touchstart",n,!1),t.addEventListener("mousemove",i,!1),t.addEventListener("touchmove",i,!1),t.addEventListener("mousemove",s,!1),t.addEventListener("touchmove",s,!1),t.addEventListener("mouseup",r,!1),t.addEventListener("mouseout",r,!1),t.addEventListener("touchend",r,!1),t.addEventListener("touchcancel",r,!1),t.addEventListener("touchleave",r,!1),this.dispose=function(){t.removeEventListener("mousedown",n),t.removeEventListener("touchstart",n),t.removeEventListener("mousemove",i),t.removeEventListener("touchmove",i),t.removeEventListener("mousemove",s),t.removeEventListener("touchmove",s),t.removeEventListener("mouseup",r),t.removeEventListener("mouseout",r),t.removeEventListener("touchend",r),t.removeEventListener("touchcancel",r),t.removeEventListener("touchleave",r)},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return l},this.setMode=function(e){l=e?e:l,"scale"===l&&(a.space="local");for(var t in c)c[t].visible=t===l;this.update(),a.dispatchEvent(p)},this.setTranslationSnap=function(e){a.translationSnap=e},this.setRotationSnap=function(e){a.rotationSnap=e},this.setSize=function(e){a.size=e,this.update(),a.dispatchEvent(p)},this.setSpace=function(e){a.space=e,this.update(),a.dispatchEvent(p)},this.update=function(){void 0!==a.object&&(a.object.updateMatrixWorld(),V.setFromMatrixPosition(a.object.matrixWorld),U.setFromRotationMatrix(R.extractRotation(a.object.matrixWorld)),e.updateMatrixWorld(),G.setFromMatrixPosition(e.matrixWorld),W.setFromRotationMatrix(R.extractRotation(e.matrixWorld)),T=V.distanceTo(G)/6*a.size,this.position.copy(V),this.scale.set(T,T,T),e instanceof THREE.PerspectiveCamera?k.copy(G).sub(V).normalize():e instanceof THREE.OrthographicCamera&&k.copy(G).normalize(),"local"===a.space?c[l].update(U,k):"world"===a.space&&c[l].update(new THREE.Euler,k),c[l].highlight(a.axis))}},THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformControls.prototype.constructor=THREE.TransformControls}(),function(){function e(e){var t=new Map;if("Connections"in e)for(var i=e.Connections.properties.connections,n=0,s=i.length;n<s;++n){var r=i[n];t.has(r[0])||t.set(r[0],{parents:[],children:[]});var o={ID:r[1],relationship:r[2]};t.get(r[0]).parents.push(o),t.has(r[1])||t.set(r[1],{parents:[],children:[]});var a={ID:r[0],relationship:r[2]};t.get(r[1]).children.push(a)}return t}function t(e){var t=new Map;if("Video"in e.Objects.subNodes){var n=e.Objects.subNodes.Video;for(var s in n){var r=n[s];if("Content"in r.properties){var o=i(n[s]);t.set(parseInt(s),o)}}}return t}function i(e){var t,i=e.properties.Content,n=new Uint8Array(i),s=e.properties.RelativeFilename||e.properties.Filename,r=s.slice(s.lastIndexOf(".")+1).toLowerCase();switch(r){case"bmp":t="image/bmp";break;case"jpg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;default:return void console.warn("FBXLoader: No support image type "+r)}return window.URL.createObjectURL(new Blob([n],{type:t}))}function n(e,t,i,n){var r=new Map;if("Texture"in e.Objects.subNodes){var o=e.Objects.subNodes.Texture;for(var a in o){var l=s(o[a],t,i,n);r.set(parseInt(a),l)}}return r}function s(e,t,i,n){var s,r=e.id,o=e.name,a=e.properties.FileName,l=e.properties.RelativeFilename,h=n.get(r).children;if(void 0!==h&&h.length>0&&i.has(h[0].ID))s=i.get(h[0].ID);else if(void 0!==l&&"/"!==l[0]&&null===l.match(/^[a-zA-Z]:/))s=l;else{var c=a.split(/[\\\/]/);s=c.length>0?c[c.length-1]:a}var u=t.path;0===s.indexOf("blob:")&&t.setPath(void 0);var d=t.load(s);d.name=o,d.FBX_ID=r;var p=e.properties.Scaling;p&&(d.repeat.x=p.value[0],d.repeat.y=p.value[1]);var f=e.properties.WrapModeU,m=e.properties.WrapModeV,v=void 0!==f?f.value:0,g=void 0!==m?m.value:0;return d.wrapS=0===v?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,d.wrapT=0===g?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,t.setPath(u),d}function r(e,t,i){var n=new Map;if("Material"in e.Objects.subNodes){var s=e.Objects.subNodes.Material;for(var r in s){var a=o(s[r],t,i);n.set(parseInt(r),a)}}return n}function o(e,t,i){var n=e.id,s=e.attrName,r=e.properties.ShadingModel;"object"==typeof r&&(r=r.value);var o,l=i.get(n).children,h=a(e.properties,t,l);switch(r.toLowerCase()){case"unknown":case"phong":o=new THREE.MeshPhongMaterial;break;case"lambert":o=new THREE.MeshLambertMaterial;break;default:console.warn("No implementation given for material type "+r+" in FBXLoader.js.  Defaulting to basic material"),o=new THREE.MeshBasicMaterial({color:3342591})}return o.setValues(h),o.name=s,o}function a(e,t,i){var n={},s=e.Diffuse||e.DiffuseColor;s&&(n.color=Y(s));var r=e.Specular||e.SpecularColor;r&&(n.specular=Y(r)),e.Shininess&&(n.shininess=e.Shininess.value);var o=e.Emissive||e.EmissiveColor;o&&(n.emissive=Y(o)),e.EmissiveFactor&&(n.emissiveIntensity=e.EmissiveFactor.value),e.Opacity&&(n.opacity=e.Opacity.value),n.opacity<1&&(n.transparent=!0);for(var a=0,l=i.length;a<l;++a){var h=i[a],c=h.relationship;switch(c){case"DiffuseColor":case' "DiffuseColor':case"3dsMax|maps|texmap_diffuse":case' "3dsMax|maps|texmap_diffuse':n.map=t.get(h.ID);break;case"Bump":case' "Bump':case"3dsMax|maps|texmap_bump":case' "3dsMax|maps|texmap_bump':n.bumpMap=t.get(h.ID);break;case"NormalMap":case' "NormalMap':n.normalMap=t.get(h.ID);break;case' "AmbientColor':case' "EmissiveColor':case"AmbientColor":case"EmissiveColor":default:console.warn("Unknown texture application of type "+c+", skipping texture")}}return n}function l(e,t){var i={};if("Deformer"in e.Objects.subNodes){var n=e.Objects.subNodes.Deformer;for(var s in n){var r=n[s];if("Skin"===r.attrType){var o=t.get(parseInt(s)),a=h(o,n);a.FBX_ID=parseInt(s),i[s]=a}}}return i}function h(e,t){for(var i={},n=e.children,s=0,r=n.length;s<r;++s){var o=n[s],a=t[o.ID],l={FBX_ID:o.ID,index:s,indices:[],weights:[],transform:Z(a.subNodes.Transform.properties.a),transformLink:Z(a.subNodes.TransformLink.properties.a),linkMode:a.properties.Mode};"Indexes"in a.subNodes&&(l.indices=G(a.subNodes.Indexes.properties.a),l.weights=X(a.subNodes.Weights.properties.a)),i[o.ID]=l}return{map:i,bones:[]}}function c(e,t,i){var n=new Map;if("Geometry"in e.Objects.subNodes){var s=e.Objects.subNodes.Geometry;for(var r in s){var o=t.get(parseInt(r)),a=u(s[r],o,i);n.set(parseInt(r),a)}}return n}function u(e,t,i){switch(e.attrType){case"Mesh":return d(e,t,i);case"NurbsCurve":return y(e)}}function d(e,t,i){for(var n=0;n<t.children.length;++n){var s=i[t.children[n].ID];if(void 0!==s)break}return p(e,s)}function p(e,t){var i=new P,n=e.subNodes,s=X(n.Vertices.properties.a),r=G(n.PolygonVertexIndex.properties.a);if(n.LayerElementNormal)var o=f(n.LayerElementNormal[0]);if(n.LayerElementUV)var a=m(n.LayerElementUV[0]);if(n.LayerElementColor)var l=v(n.LayerElementColor[0]);if(n.LayerElementMaterial)var h=g(n.LayerElementMaterial[0]);for(var c=[],u=0,d=0;d<r.length;d++){var p=r[d],y=!1;p<0&&(p^=-1,r[d]=p,y=!0);var w=new L,E=[],x=[];if(w.position.fromArray(s,3*p),t){var T=t.map;for(var _ in T)for(var k=T[_],R=k.indices,S=0;S<R.length;S++){var M=R[S];if(M===p){x.push(k.weights[S]),E.push(k.index);break}}if(x.length>4){console.warn("FBXLoader: Vertex has more than 4 skinning weights assigned to vertex.  Deleting additional weights.");var C=[0,0,0,0],A=[0,0,0,0];x.forEach(function(e,t){var i=e,n=E[t];A.forEach(function(e,t,s){if(i>e){s[t]=i,i=e;var r=C[t];C[t]=n,n=r}})}),E=C,x=A}for(var H=x.length;H<4;++H)x[H]=0,E[H]=0;w.skinWeights.fromArray(x),w.skinIndices.fromArray(E)}if(o&&w.normal.fromArray(b(d,u,p,o)),a&&w.uv.fromArray(b(d,u,p,a)),l&&w.color.fromArray(b(d,u,p,l)),c.push(w),y){var N=new I;if(N.genTrianglesFromVertices(c),void 0!==h){var D=b(d,u,p,h);N.materialIndex=D[0]}else N.materialIndex=0;i.faces.push(N),c=[],u++,y=!1}}var O=i.flattenToBuffers(),B=new THREE.BufferGeometry;B.name=e.name,B.addAttribute("position",new THREE.Float32BufferAttribute(O.vertexBuffer,3)),O.normalBuffer.length>0&&B.addAttribute("normal",new THREE.Float32BufferAttribute(O.normalBuffer,3)),O.uvBuffer.length>0&&B.addAttribute("uv",new THREE.Float32BufferAttribute(O.uvBuffer,2)),n.LayerElementColor&&B.addAttribute("color",new THREE.Float32BufferAttribute(O.colorBuffer,3)),t&&(B.addAttribute("skinIndex",new THREE.Float32BufferAttribute(O.skinIndexBuffer,4)),B.addAttribute("skinWeight",new THREE.Float32BufferAttribute(O.skinWeightBuffer,4)),B.FBX_Deformer=t);for(var j=O.materialIndexBuffer,F=j[0],z=0,H=0;H<j.length;++H)j[H]!==F&&(B.addGroup(z,H-z,F),F=j[H],z=H);return B}function f(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType,n=X(e.subNodes.Normals.properties.a),s=[];return"IndexToDirect"===i&&("NormalIndex"in e.subNodes?s=G(e.subNodes.NormalIndex.properties.a):"NormalsIndex"in e.subNodes&&(s=G(e.subNodes.NormalsIndex.properties.a))),{dataSize:3,buffer:n,indices:s,mappingType:t,referenceType:i}}function m(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType,n=X(e.subNodes.UV.properties.a),s=[];return"IndexToDirect"===i&&(s=G(e.subNodes.UVIndex.properties.a)),{dataSize:2,buffer:n,indices:s,mappingType:t,referenceType:i}}function v(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType,n=X(e.subNodes.Colors.properties.a),s=[];return"IndexToDirect"===i&&(s=X(e.subNodes.ColorIndex.properties.a)),{dataSize:4,buffer:n,indices:s,mappingType:t,referenceType:i}}function g(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};for(var n=G(e.subNodes.Materials.properties.a),s=[],r=0,o=n.length;r<o;++r)s.push(r);return{dataSize:1,buffer:n,indices:s,mappingType:t,referenceType:i}}function b(e,t,i,n){return te[n.mappingType][n.referenceType](e,t,i,n)}function y(e){if(void 0===THREE.NURBSCurve)return console.error("THREE.FBXLoader relies on THREE.NURBSCurve for any nurbs present in the model.  Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var t=parseInt(e.properties.Order);if(isNaN(t))return console.error("FBXLoader: Invalid Order "+e.properties.Order+" given for geometry ID: "+e.id),new THREE.BufferGeometry;for(var i=t-1,n=X(e.subNodes.KnotVector.properties.a),s=[],r=X(e.subNodes.Points.properties.a),o=0,a=r.length;o<a;o+=4)s.push((new THREE.Vector4).fromArray(r,o));var l,h;if("Closed"===e.properties.Form)s.push(s[0]);else if("Periodic"===e.properties.Form){l=i,h=n.length-1-l;for(var o=0;o<i;++o)s.push(s[o])}for(var c=new THREE.NURBSCurve(i,n,s,l,h),u=c.getPoints(7*s.length),d=new Float32Array(3*u.length),o=0,a=u.length;o<a;++o)u[o].toArray(d,3*o);var p=new THREE.BufferGeometry;return p.addAttribute("position",new THREE.BufferAttribute(d,3)),p}function w(e,t,i,n,s){var r=new THREE.Group,o=e.Objects.subNodes.Model,a=[],l=new Map;for(var h in o){for(var c=parseInt(h),u=o[h],d=t.get(c),p=null,f=0;f<d.parents.length;++f)for(var m in i){var v=i[m],g=v.map,b=g[d.parents[f].ID];if(b){var y=p;p=new THREE.Bone,v.bones[b.index]=p,null!==y&&p.add(y)}}if(!p)switch(u.attrType){case"Mesh":for(var w=null,x=null,T=[],_=0,k=d.children.length;_<k;++_){var R=d.children[_];n.has(R.ID)&&(w=n.get(R.ID)),s.has(R.ID)&&T.push(s.get(R.ID))}if(T.length>1?x=T:T.length>0?x=T[0]:(x=new THREE.MeshBasicMaterial({color:3342591}),T.push(x)),"color"in w.attributes)for(var M=0,C=T.length;M<C;++M)T[M].vertexColors=THREE.VertexColors;if(w.FBX_Deformer){for(var A=0,H=T.length;A<H;++A)T[A].skinning=!0;p=new THREE.SkinnedMesh(w,x)}else p=new THREE.Mesh(w,x);break;case"NurbsCurve":for(var w=null,_=0,k=d.children.length;_<k;++_){var R=d.children[_];n.has(R.ID)&&(w=n.get(R.ID))}x=new THREE.LineBasicMaterial({color:3342591,linewidth:5}),p=new THREE.Line(w,x);break;default:p=new THREE.Object3D}p.name=u.attrName.replace(/:/,"").replace(/_/,"").replace(/-/,""),p.FBX_ID=c,a.push(p),l.set(c,p)}for(var L=0,N=a.length;L<N;++L){var p=a[L],u=o[p.FBX_ID];if("Lcl_Translation"in u.properties&&p.position.fromArray(X(u.properties.Lcl_Translation.value)),"Lcl_Rotation"in u.properties){var I=X(u.properties.Lcl_Rotation.value).map(K);I.push("ZYX"),p.rotation.fromArray(I)}if("Lcl_Scaling"in u.properties&&p.scale.fromArray(X(u.properties.Lcl_Scaling.value)),"PreRotation"in u.properties){var P=(new THREE.Euler).setFromVector3(W(u.properties.PreRotation).multiplyScalar(re),"ZYX");P=(new THREE.Quaternion).setFromEuler(P);var D=(new THREE.Quaternion).setFromEuler(p.rotation);P.multiply(D),p.rotation.setFromQuaternion(P,"ZYX")}for(var d=t.get(p.FBX_ID),O=0;O<d.parents.length;O++){var B=Q(a,function(e){return e.FBX_ID===d.parents[O].ID});if(B>-1){a[B].add(p);break}}null===p.parent&&r.add(p)}r.updateMatrixWorld(!0);var j=e.Objects.subNodes.Pose;for(var h in j)if("BindPose"===j[h].attrType){j=j[h];break}if(j)for(var F=j.subNodes.PoseNode,z=new Map,V=0,U=F.length;V<U;++V){var u=F[V],G=Z(u.subNodes.Matrix.properties.a);z.set(parseInt(u.id),G)}for(var m in i){var v=i[m],g=v.map;for(var Y in g){var b=g[Y],q=b.index,J=v.bones[q];if(!z.has(J.FBX_ID))break;var $=z.get(J.FBX_ID);J.matrixWorld.copy($)}v.skeleton=new THREE.Skeleton(v.bones);for(var d=t.get(v.FBX_ID),ee=d.parents,te=0,ie=ee.length;te<ie;++te){var ne=ee[te];if(n.has(ne.ID))for(var se=ne.ID,oe=t.get(se),f=0;f<oe.parents.length;++f)if(l.has(oe.parents[f].ID)){var p=l.get(oe.parents[f].ID);p.bind(v.skeleton,p.matrixWorld);break}}}r.updateMatrixWorld(!0),r.skeleton={bones:a};var ae=E(e,t,r);return S(r,ae),r}function E(e,t,i){var n=e.Objects.subNodes.AnimationCurveNode,s=e.Objects.subNodes.AnimationCurve,r=e.Objects.subNodes.AnimationLayer,o=e.Objects.subNodes.AnimationStack,a={curves:new Map,layers:{},stacks:{},length:0,fps:30,frames:0},l=[];for(var h in n)if(h.match(/\d+/)){var c=x(e,n[h],t,i);l.push(c)}for(var u=new Map,d=0;d<l.length;++d)null!==l[d]&&u.set(l[d].id,l[d]);var p=[];for(h in s)if(h.match(/\d+/)){var f=T(s[h]);if(!t.has(f.id))continue;p.push(f);var m=t.get(f.id).parents[0],v=m.ID,g=m.relationship,b="";if(g.match(/X/))b="x";else if(g.match(/Y/))b="y";else{if(!g.match(/Z/))continue;b="z"}u.get(v).curves[b]=f}u.forEach(function(e){var t=e.containerBoneID;if(a.curves.has(t)||a.curves.set(t,{T:null,R:null,S:null}),a.curves.get(t)[e.attr]=e,"R"===e.attr){var i=e.curves;if(i.x.values=i.x.values.map(K),i.y.values=i.y.values.map(K),i.z.values=i.z.values.map(K),null!==e.preRotations){var n=(new THREE.Euler).setFromVector3(e.preRotations,"ZYX");n=(new THREE.Quaternion).setFromEuler(n);for(var s=new THREE.Euler,r=new THREE.Quaternion,o=0;o<i.x.times.length;++o)s.set(i.x.values[o],i.y.values[o],i.z.values[o],"ZYX"),r.setFromEuler(s).premultiply(n),s.setFromQuaternion(r,"ZYX"),i.x.values[o]=s.x,i.y.values[o]=s.y,i.z.values[o]=s.z}}});for(var h in r){for(var y=[],w=t.get(parseInt(h)).children,E=0;E<w.length;E++)if(u.has(w[E].ID)){var k=u.get(w[E].ID),R=k.containerBoneID;void 0===y[R]&&(y[R]={T:null,R:null,S:null}),y[R][k.attr]=k}a.layers[h]=y}for(var h in o){for(var S=[],w=t.get(parseInt(h)).children,M={max:0,min:Number.MAX_VALUE},E=0;E<w.length;++E){var C=a.layers[w[E].ID];if(void 0!==C){S.push(C);for(var A=0,H=C.length;A<H;++A){var y=C[A];y&&_(y,M)}}}M.max>M.min&&(a.stacks[h]={name:o[h].attrName,layers:S,length:M.max-M.min,frames:30*(M.max-M.min)})}return a}function x(e,t,i,n){var s=e.Objects.subNodes.Model,r={id:t.id,attr:t.attrName,internalID:t.id,attrX:!1,attrY:!1,attrZ:!1,containerBoneID:-1,containerID:-1,curves:{x:null,y:null,z:null},preRotations:null};if(!r.attr.match(/S|R|T/))return null;for(var o in t.properties)o.match(/X/)&&(r.attrX=!0),o.match(/Y/)&&(r.attrY=!0),o.match(/Z/)&&(r.attrZ=!0);for(var a=i.get(r.id),l=a.parents,h=l.length-1;h>=0;--h){var c=Q(n.skeleton.bones,function(e){return e.FBX_ID===l[h].ID});if(c>-1){r.containerBoneID=c,r.containerID=l[h].ID;var u=s[r.containerID.toString()];"PreRotation"in u.properties&&(r.preRotations=W(u.properties.PreRotation).multiplyScalar(Math.PI/180));break}}return r}function T(e){return{version:null,id:e.id,internalID:e.id,times:X(e.subNodes.KeyTime.properties.a).map(U),values:X(e.subNodes.KeyValueFloat.properties.a),attrFlag:G(e.subNodes.KeyAttrFlags.properties.a),attrData:X(e.subNodes.KeyAttrDataFloat.properties.a)}}function _(e,t){e.R&&k(e.R.curves,t),e.S&&k(e.S.curves,t),e.T&&k(e.T.curves,t)}function k(e,t){e.x&&R(e.x,t),e.y&&R(e.y,t),e.z&&R(e.z,t)}function R(e,t){t.max=e.times[e.times.length-1]>t.max?e.times[e.times.length-1]:t.max,t.min=e.times[0]<t.min?e.times[0]:t.min}function S(e,t){void 0===e.animations&&(e.animations=[]);var i=t.stacks;for(var n in i){for(var s=i[n],r={name:s.name,fps:30,length:s.length,hierarchy:[]},o=e.skeleton.bones,a=0,l=o.length;a<l;++a){var h=o[a],c=h.name.replace(/.*:/,""),u=Q(o,function(e){return h.parent===e});r.hierarchy.push({parent:u,name:c,keys:[]})}for(var d=0;d<=s.frames;d++)for(var a=0,l=o.length;a<l;++a)for(var h=o[a],p=a,f=s.layers[0][p],m=0,v=r.hierarchy.length;m<v;++m){var g=r.hierarchy[m];g.name===h.name&&g.keys.push(M(t,f,h,d))}e.animations.push(THREE.AnimationClip.parseAnimation(r,o))}}function M(e,t,i,n){var s={time:n/e.fps,pos:i.position.toArray(),rot:i.quaternion.toArray(),scl:i.scale.toArray()};if(void 0===t)return s;try{if(C(t,"T")&&A(t.T,n)&&(s.pos=[t.T.curves.x.values[n],t.T.curves.y.values[n],t.T.curves.z.values[n]]),C(t,"R")&&A(t.R,n)){var r=t.R.curves.x.values[n],o=t.R.curves.y.values[n],a=t.R.curves.z.values[n];ne.setFromEuler(ie.set(r,o,a,"ZYX")),s.rot=ne.toArray()}C(t,"S")&&A(t.S,n)&&(s.scl=[t.S.curves.x.values[n],t.S.curves.y.values[n],t.S.curves.z.values[n]])}catch(e){console.log(i),console.log(e)}return s}function C(e,t){if(void 0===e)return!1;var i=e[t];return!!i&&se.every(function(e){return null!==i.curves[e]})}function A(e,t){return se.every(function(i){return H(e.curves[i],t)})}function H(e,t){return void 0!==e.values[t]}function L(){this.position=new THREE.Vector3,this.normal=new THREE.Vector3,this.uv=new THREE.Vector2,this.color=new THREE.Vector3,this.skinIndices=new THREE.Vector4(0,0,0,0),this.skinWeights=new THREE.Vector4(0,0,0,0)}function N(){this.vertices=[]}function I(){this.triangles=[],this.materialIndex=0}function P(){this.faces=[],this.skeleton=null}function D(){}function O(){}function B(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function j(){}function F(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===q(e,0,t.length)}function z(e){function t(t){var i=e[t-1];return e=e.slice(n+t),n++,i}for(var i=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],n=0,s=0;s<i.length;++s){var r=t(1);if(r==i[s])return!1}return!0}function V(e){var t=/FBXVersion: (\d+)/,i=e.match(t);if(i){var n=parseInt(i[1]);return n}throw new Error("FBXLoader: Cannot find the version number for the file given.")}function U(e){return e/46186158e3}function X(e){for(var t=e.split(","),i=0,n=t.length;i<n;i++)t[i]=parseFloat(t[i]);return t}function G(e){for(var t=e.split(","),i=0,n=t.length;i<n;i++)t[i]=parseInt(t[i]);return t}function W(e){return(new THREE.Vector3).fromArray(e.value)}function Y(e){return(new THREE.Color).fromArray(e.value)}function Z(e){return(new THREE.Matrix4).fromArray(X(e))}function q(e,t,i){void 0===t&&(t=0),void 0===i&&(i=e.byteLength);var n=new Uint8Array(e,t,i);if(void 0!==window.TextDecoder)return(new TextDecoder).decode(n);for(var s="",r=0,o=n.length;r<o;r++)s+=String.fromCharCode(n[r]);return s}function K(e){return e*re}function Q(e,t){for(var i=0,n=e.length;i<n;i++)if(t(e[i]))return i;return-1}function J(e,t){for(var i=0,n=e.length,s=t.length;i<s;i++,n++)e[n]=t[i]}function $(e,t,i,n){for(var s=i,r=0;s<n;s++,r++)e[r]=t[s];return e}THREE.FBXLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},Object.assign(THREE.FBXLoader.prototype,{load:function(e,t,i,n){var s=this,r=e.split(/[\\\/]/);r.pop(),r=r.join("/")+"/";var o=new THREE.FileLoader(this.manager);o.setResponseType("arraybuffer"),o.load(e,function(i){try{var o=s.parse(i,r);t(o)}catch(t){window.setTimeout(function(){n&&n(t),s.manager.itemError(e)},0)}},i,n)},parse:function(i,s){var o;if(F(i))o=(new O).parse(i);else{var a=q(i);if(!z(a))throw self.manager.itemError(url),new Error("FBXLoader: Unknown format.");if(V(a)<7e3)throw self.manager.itemError(url),new Error("FBXLoader: FBX version not supported for file at "+url+", FileVersion: "+V(a));o=(new D).parse(a)}var h=e(o),u=t(o),d=n(o,new THREE.TextureLoader(this.manager).setPath(s),u,h),p=r(o,d,h),f=l(o,h),m=c(o,h,f),v=w(o,h,f,m,p);return v}});var ee=[],te={ByPolygonVertex:{Direct:function(e,t,i,n){var s=e*n.dataSize,r=e*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)},IndexToDirect:function(e,t,i,n){var s=n.indices[e],r=s*n.dataSize,o=s*n.dataSize+n.dataSize;return $(ee,n.buffer,r,o)}},ByPolygon:{Direct:function(e,t,i,n){var s=t*n.dataSize,r=t*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)},IndexToDirect:function(e,t,i,n){var s=n.indices[t],r=s*n.dataSize,o=s*n.dataSize+n.dataSize;return $(ee,n.buffer,r,o)}},ByVertice:{Direct:function(e,t,i,n){var s=i*n.dataSize,r=i*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)}},AllSame:{IndexToDirect:function(e,t,i,n){var s=n.indices[0]*n.dataSize,r=n.indices[0]*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)}}},ie=new THREE.Euler,ne=new THREE.Quaternion,se=["x","y","z"];Object.assign(L.prototype,{copy:function(e){var t=e||new L;return t.position.copy(this.position),t.normal.copy(this.normal),t.uv.copy(this.uv),t.skinIndices.copy(this.skinIndices),t.skinWeights.copy(this.skinWeights),t},flattenToBuffers:function(e,t,i,n,s,r){this.position.toArray(e,e.length),this.normal.toArray(t,t.length),this.uv.toArray(i,i.length),this.color.toArray(n,n.length),this.skinIndices.toArray(s,s.length),this.skinWeights.toArray(r,r.length)}}),Object.assign(N.prototype,{copy:function(e){for(var t=e||new N,i=0;i<this.vertices.length;++i)this.vertices[i].copy(t.vertices[i]);return t},flattenToBuffers:function(e,t,i,n,s,r){for(var o=this.vertices,a=0,l=o.length;a<l;++a)o[a].flattenToBuffers(e,t,i,n,s,r)}}),Object.assign(I.prototype,{copy:function(e){for(var t=e||new I,i=0;i<this.triangles.length;++i)this.triangles[i].copy(t.triangles[i]);return t.materialIndex=this.materialIndex,t},genTrianglesFromVertices:function(e){for(var t=2;t<e.length;++t){var i=new N;i.vertices[0]=e[0],i.vertices[1]=e[t-1],i.vertices[2]=e[t],this.triangles.push(i)}},flattenToBuffers:function(e,t,i,n,s,r,o){for(var a=this.triangles,l=this.materialIndex,h=0,c=a.length;h<c;++h)a[h].flattenToBuffers(e,t,i,n,s,r),J(o,[l,l,l])}}),Object.assign(P.prototype,{flattenToBuffers:function(){for(var e=[],t=[],i=[],n=[],s=[],r=[],o=[],a=this.faces,l=0,h=a.length;l<h;++l)a[l].flattenToBuffers(e,t,i,n,s,r,o);return{vertexBuffer:e,normalBuffer:t,uvBuffer:i,colorBuffer:n,skinIndexBuffer:s,skinWeightBuffer:r,materialIndexBuffer:o}}}),Object.assign(D.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new j,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=e.split("\n");for(var i in t){var n=t[i];if(!n.match(/^[\s\t]*;/)&&!n.match(/^[\s\t]*$/)){var s=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):(.*){",""),r=n.match(s);if(r){for(var o=r[1].trim().replace(/^"/,"").replace(/"$/,""),a=r[2].split(","),l=0,n=a.length;l<n;l++)a[l]=a[l].trim().replace(/^"/,"").replace(/"$/,"");this.parseNodeBegin(n,o,a||null)}else{var h=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),r=n.match(h);if(r){var c=r[1].replace(/^"/,"").replace(/"$/,"").trim(),u=r[2].replace(/^"/,"").replace(/"$/,"").trim();this.parseNodeProperty(n,c,u)}else{var d=new RegExp("^\\t{"+(this.currentIndent-1)+"}}");n.match(d)?this.nodeEnd():n.match(/^[^\s\t}]/)&&this.parseNodePropertyContinued(n)}}}}return this.allNodes},parseNodeBegin:function(e,t,i){var n={name:t,properties:{},subNodes:{}},s=this.parseNodeAttr(i),r=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(t,n);else if(t in r.subNodes){var o=r.subNodes[t];this.isFlattenNode(r.subNodes[t])&&(""===s.id?(r.subNodes[t]=[],r.subNodes[t].push(o)):(r.subNodes[t]={},r.subNodes[t][o.id]=o)),""===s.id?r.subNodes[t].push(n):r.subNodes[t][s.id]=n}else"number"==typeof s.id||s.id.match(/^\d+$/)?(r.subNodes[t]={},r.subNodes[t][s.id]=n):r.subNodes[t]=n;i&&(n.id=s.id,n.attrName=s.name,n.attrType=s.type),this.pushStack(n)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var i="",n="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:i,type:n}},parseNodeProperty:function(e,t,i){var n=this.getCurrentNode(),s=n.name;if(void 0!==s){var r=s.match(/Properties(\d)+/);if(r)return void this.parseNodeSpecialProperty(e,t,i)}if("C"==t){var o=i.split(",").slice(1),a=parseInt(o[0]),l=parseInt(o[1]),h=i.split(",").slice(3);t="connections",i=[a,l],J(i,h),void 0===n.properties[t]&&(n.properties[t]=[])}if("Node"==t){var c=parseInt(i);n.properties.id=c,n.id=c}t in n.properties?Array.isArray(n.properties[t])?n.properties[t].push(i):n.properties[t]+=i:Array.isArray(n.properties[t])?n.properties[t].push(i):n.properties[t]=i,this.setCurrentProp(n.properties,t)},parseNodePropertyContinued:function(e){this.currentProp[this.currentPropName]+=e},parseNodeSpecialProperty:function(e,t,i){for(var n=i.split('",'),s=0,r=n.length;s<r;s++)n[s]=n[s].trim().replace(/^\"/,"").replace(/\s/,"_");var o=n[0],a=n[1],l=n[2],h=n[3],c=n[4];switch(a){case"int":case"Bool":case"Integer":c=parseInt(c);break;case"double":case"Float":case"Number":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector":case"Vector3D":c=X(c)}this.getPrevNode().properties[o]={type:a,type2:l,flag:h,value:c},this.setCurrentProp(this.getPrevNode().properties,o)},nodeEnd:function(){this.popStack()},isFlattenNode:function(e){return"subNodes"in e&&"properties"in e}}),Object.assign(O.prototype,{parse:function(e){var t=new B(e);t.skip(23);var i=t.getUint32();console.log("FBX binary version: "+i);for(var n=new j;!this.endOfContent(t);){var s=this.parseNode(t,i);null!==s&&n.add(s.name,s)}return n},endOfContent:function(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+15>=e.size()},parseNode:function(e,t){var i=t>=7500?e.getUint64():e.getUint32(),n=t>=7500?e.getUint64():e.getUint32(),s=t>=7500?e.getUint64():e.getUint32(),r=e.getUint8(),o=e.getString(r);if(this.propertyListLen=s,0===i)return null;for(var a=[],l=0;l<n;l++)a.push(this.parseProperty(e));var h=a.length>0?a[0]:"",c=a.length>1?a[1]:"",u=a.length>2?a[2]:"",d={},p={},f=!1;for(1===n&&e.getOffset()===i&&(f=!0);i>e.getOffset();){var m=this.parseNode(e,t);if(null!==m)if(m.singleProperty!==!0)if("Connections"!==o||"C"!==m.name)if(m.name.match(/^Properties\d+$/))for(var v=Object.keys(m.properties),l=0,g=v.length;l<g;l++){var b=v[l];p[b]=m.properties[b]}else if(o.match(/^Properties\d+$/)&&"P"===m.name){var y,w=m.propertyList[0],E=m.propertyList[1],x=m.propertyList[2],T=m.propertyList[3];0===w.indexOf("Lcl ")&&(w=w.replace("Lcl ","Lcl_")),0===E.indexOf("Lcl ")&&(E=E.replace("Lcl ","Lcl_")),y="ColorRGB"===E||"Vector"===E||"Vector3D"===E||0===E.indexOf("Lcl_")?[m.propertyList[4],m.propertyList[5],m.propertyList[6]]:m.propertyList[4],0===E.indexOf("Lcl_")&&(y=y.toString()),p[w]={type:E,type2:x,flag:T,value:y}}else void 0===d[m.name]?"number"==typeof m.id?(d[m.name]={},d[m.name][m.id]=m):d[m.name]=m:""===m.id?(Array.isArray(d[m.name])||(d[m.name]=[d[m.name]]),d[m.name].push(m)):void 0===d[m.name][m.id]?d[m.name][m.id]=m:(Array.isArray(d[m.name][m.id])||(d[m.name][m.id]=[d[m.name][m.id]]),d[m.name][m.id].push(m));else{for(var _=[],l=1,g=m.propertyList.length;l<g;l++)_[l-1]=m.propertyList[l];void 0===p.connections&&(p.connections=[]),p.connections.push(_)}else{var k=m.propertyList[0];Array.isArray(k)?(m.properties[m.name]=m.propertyList[0],d[m.name]=m,m.properties.a=k.toString()):p[m.name]=k}}return{singleProperty:f,id:h,attrName:c,attrType:u,name:o,properties:p,propertyList:a,subNodes:d}},parseProperty:function(e){var t=e.getChar();switch(t){case"F":return e.getFloat32();case"D":return e.getFloat64();case"L":return e.getInt64();case"I":return e.getInt32();case"Y":return e.getInt16();case"C":return e.getBoolean();case"f":case"d":case"l":case"i":case"b":var i=e.getUint32(),n=e.getUint32(),s=e.getUint32();if(0===n)switch(t){case"f":return e.getFloat32Array(i);case"d":return e.getFloat64Array(i);case"l":return e.getInt64Array(i);case"i":return e.getInt32Array(i);case"b":return e.getBooleanArray(i)}if(void 0===window.Zlib)throw new Error("FBXLoader: Import inflate.min.js from https://github.com/imaya/zlib.js");var r=new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(s))),o=new B(r.decompress().buffer);switch(t){case"f":return o.getFloat32Array(i);case"d":return o.getFloat64Array(i);case"l":return o.getInt64Array(i);case"i":return o.getInt32Array(i);case"b":return o.getBooleanArray(i)}case"S":var a=e.getUint32();return e.getString(a);case"R":var a=e.getUint32();return e.getArrayBuffer(a);default:throw new Error("FBXLoader: Unknown property type "+t)}}}),Object.assign(B.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1===(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getBoolean());return t},getInt8:function(){var e=this.dv.getInt8(this.offset);return this.offset+=1,e},getInt8Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt8());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint8Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint8());return t},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt16Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt16());return t},getUint16:function(){var e=this.dv.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},getUint16Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint16());return t},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt32());return t;
},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getUint32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint32());return t},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e},getInt64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getUint64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint64());return t},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getChar:function(){return String.fromCharCode(this.getUint8())},getString:function(e){for(var t="";e>0;){var i=this.getUint8();if(e--,0===i)break;t+=String.fromCharCode(i)}return this.skip(e),t}}),Object.assign(j.prototype,{add:function(e,t){this[e]=t},searchConnectionParent:function(e){if(void 0===this.__cache_search_connection_parent&&(this.__cache_search_connection_parent=[]),void 0!==this.__cache_search_connection_parent[e])return this.__cache_search_connection_parent[e];this.__cache_search_connection_parent[e]=[];for(var t=this.Connections.properties.connections,i=[],n=0;n<t.length;++n)if(t[n][0]==e){var s=0===t[n][1]?-1:t[n][1];i.push(s)}return i.length>0?(J(this.__cache_search_connection_parent[e],i),i):(this.__cache_search_connection_parent[e]=[-1],[-1])},searchConnectionChildren:function(e){if(void 0===this.__cache_search_connection_children&&(this.__cache_search_connection_children=[]),void 0!==this.__cache_search_connection_children[e])return this.__cache_search_connection_children[e];this.__cache_search_connection_children[e]=[];for(var t=this.Connections.properties.connections,i=[],n=0;n<t.length;++n)t[n][1]==e&&i.push(0===t[n][0]?-1:t[n][0]);return i.length>0?(J(this.__cache_search_connection_children[e],i),i):(this.__cache_search_connection_children[e]=[],[])},searchConnectionType:function(e,t){var i=e+","+t;if(void 0===this.__cache_search_connection_type&&(this.__cache_search_connection_type={}),void 0!==this.__cache_search_connection_type[i])return this.__cache_search_connection_type[i];this.__cache_search_connection_type[i]="";for(var n=this.Connections.properties.connections,s=0;s<n.length;++s)if(n[s][0]==e&&n[s][1]==t)return this.__cache_search_connection_type[i]=n[s][2],n[s][2];return this.__cache_search_connection_type[e]=null,null}});var re=Math.PI/180}(),THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FillShader={uniforms:{color:{value:new THREE.Color(1,1,1)},alpha:{value:1},lineAlpha:{value:1},fillAlpha:{value:.2}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3  color;","uniform float alpha;","uniform float lineAlpha;","uniform float fillAlpha;","#define PI 3.141592653589793","#define XRAD 0.017453292519943295","float drawLine(float angle, float step, float thick) {","float a = angle * XRAD;","float ks = thick / step;","float len = dot(gl_FragCoord.xy, vec2(cos(a), sin(a)));","float dist = abs((2.0 * mod(len, step) / step) - 1.0);","return clamp((ks - dist) / ks, 0.0, 1.0);","}","void main() {","gl_FragColor = vec4(color, alpha);","return;","float line1 = drawLine(-30.0, 10.0, 2.0);","float line2 = drawLine(80.0, 20.0, 2.0);","float level = fillAlpha + lineAlpha * max(line1 * 0.9, line2 * 0.3);","gl_FragColor = vec4(color, alpha * level);","}"].join("\n")},THREE.OverlayShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)},drawColor:{value:new THREE.Color(1,1,1)},drawAlpha:{value:1},lineAlpha:{value:1},lineAngle:{value:0},fillAlpha:{value:0},edgeAlpha:{value:1}},vertexShader:["void main() {","gl_Position = vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","uniform vec3  drawColor;","uniform float drawAlpha;","uniform float lineAlpha;","uniform float lineAngle;","uniform float fillAlpha;","uniform float edgeAlpha;","float edgeBasic(sampler2D image, vec2 pixel) {","vec4 mtl = texture2D(image, pixel + resolution * vec2(-1.0,  1.0));","vec4 mtc = texture2D(image, pixel + resolution * vec2( 0.0,  1.0));","vec4 mtr = texture2D(image, pixel + resolution * vec2( 1.0,  1.0));","vec4 mcl = texture2D(image, pixel + resolution * vec2(-1.0,  0.0));","vec4 mcc = texture2D(image, pixel + resolution * vec2( 0.0,  0.0));","vec4 mcr = texture2D(image, pixel + resolution * vec2( 1.0,  0.0));","vec4 mbl = texture2D(image, pixel + resolution * vec2(-1.0, -1.0));","vec4 mbc = texture2D(image, pixel + resolution * vec2( 0.0, -1.0));","vec4 mbr = texture2D(image, pixel + resolution * vec2( 1.0, -1.0));","float dtl = abs(mtl.r - mcc.r) / 2.0;","float dtc = abs(mtc.r - mcc.r) / 1.0;","float dtr = abs(mtr.r - mcc.r) / 2.0;","float dcl = abs(mcl.r - mcc.r) / 1.0;","float dcr = abs(mcr.r - mcc.r) / 1.0;","float dbl = abs(mbl.r - mcc.r) / 2.0;","float dbc = abs(mbc.r - mcc.r) / 1.0;","float dbr = abs(mbr.r - mcc.r) / 2.0;","return 0.4 * (dtl + dtc + dtr + dcl + dcr + dbl + dbc + dbr);","}","float edgeFreiChen(sampler2D image, vec2 pixel) {","float n1 = 0.3535533845424652;","float n2 = 0.1666666716337204;","float n3 = 0.1666666716337204;","float n4 = 0.6666666865348816;","mat3 I;","mat3 G[9];","G[0] = mat3( n1, 0, -n1, 0.5, 0, -0.5, n1, 0, -n1 );","G[1] = mat3( n1, 0.5, n1, 0, 0, 0, -n1, -0.5, -n1 );","G[2] = mat3( 0, n1, -0.5, -n1, 0, n1, 0.5, -n1, 0 );","G[3] = mat3( 0.5, -n1, 0, -n1, 0, n1, 0, n1, -0.5 );","G[4] = mat3( 0, -0.5, 0, 0.5, 0, 0.5, 0, -0.5, 0 );","G[5] = mat3( -0.5, 0, 0.5, 0, 0, 0, 0.5, 0, -0.5 );","G[6] = mat3( n2, -n3, n2, -n3, n4, -n3, n2, -n3, n2 );","G[7] = mat3( -n3, n2, -n3, n2, n4, n2, -n3, n2, -n3 );","G[8] = mat3( n3, n3, n3, n3, n3, n3, n3, n3, n3 );","vec3 sample;","for (float i=0.0; i<3.0; i++) {","for (float j=0.0; j<3.0; j++) {","sample = texture2D(image, pixel + resolution * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","}","float cnv[9];","for (int i=0; i<9; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3;","}","float M = (cnv[0] + cnv[1]) + (cnv[2] + cnv[3]);","float S = (cnv[4] + cnv[5]) + (cnv[6] + cnv[7]) + (cnv[8] + M);","return sqrt(M / S);","}","float edgeSobel(sampler2D image, vec2 pixel) {","mat3 I;","mat3 G[2];","G[0] = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","G[1] = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","vec3 sample;","for (float i=0.0; i<3.0; i++)","for (float j=0.0; j<3.0; j++) {","sample = texture2D(image, pixel + resolution * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","float cnv[2];","for (int i=0; i<2; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3; ","}","return 0.017 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]);","}","float drawLine(float angle, float step, float thick) {","float pi = 3.141592653589793;","float kx = cos(angle / 180.0 * pi);","float ky = sin(angle / 180.0 * pi);","float ks = thick / step;","float len = dot(gl_FragCoord.xy, vec2(kx, ky));","float dist = abs((2.0 * mod(len, step) / step) - 1.0);","return clamp((ks - dist) * (1.0 / ks), 0.0, 1.0);","}","void main() {","vec2 pixel = gl_FragCoord.xy * resolution;","float fill = texture2D(tDiffuse, pixel).r;","float line1 = drawLine(-30.0 + lineAngle, 10.0, 2.0);","float line2 = drawLine( 80.0 + lineAngle, 20.0, 2.0);","float level = 0.0;","level += edgeAlpha * edgeBasic(tDiffuse, pixel);","level += lineAlpha * max(fill * line1 * 0.9, fill * line2 * 0.3);","level += fillAlpha * fill;","if(level > 0.0) {","gl_FragColor = vec4(drawColor, drawAlpha * level);","} else {","gl_FragColor = vec4(0.0);","}","}"].join("\n")},THREE.HorizontalBlurShader={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.VerticalBlurShader={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2(  1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0,  1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2(  1.0,  1.0 ) ) * resolution ).xyz;","vec4 rgbaM = texture2D( tDiffuse,   gl_FragCoord.xy * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE ), max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},FileImport.prototype={onInputChange:function(){for(var e=0;e<this.input.files.length;e++)this.events.emit("import",this.input.files[e]);this.input.value=null}},TileView.VERTICAL_SPLIT=1,TileView.HORIZONTAL_SPLIT=2,TileView.prototype={width:0,height:0,helperSize:1,makeFrame:function(e,t){var i={source:e,parent:t};return e&&e[0]?(i.split="v"===e[0]?TileView.VERTICAL_SPLIT:TileView.HORIZONTAL_SPLIT,i.head=this.makeFrame(e[1],i),i.tail=this.makeFrame(e[2],i),i.position=e[3]||.5,this.splits.push(i)):(i.index=this.frames.length,this.frames.push(i)),i},setLayout:function(e){this.splits=[],this.frames=[],this.root=this.makeFrame(e),this.helpers=[],this.ehelpers.innerHTML="";for(var t=0;t<this.splits.length;t++){var i=this.splits[t],n=new Drag(dom.div("tile-helper",this.ehelpers));n.min.x=n.min.y=0,n.max.x=n.max.y=1,n.events.on("start",this.startHelper,this,i),n.events.on("drag",this.dragHelper,this,i),this.helpers.push(n)}this.update()},setClients:function(e){if(this.clients=e||[],this.econtent.innerHTML="",e)for(var t=0;t<e.length;t++){var i=e[t];i&&i.element&&(dom.addclass(i.element,"tile-client"),dom.append(this.econtent,i.element))}},resize:function(e,t){this.width=e,this.height=t,this.setElement(this.element,NaN,NaN,this.width,this.height),this.update()},autoresize:function(){this.width=this.element.offsetWidth,this.height=this.element.offsetHeight,this.setElement(this.element,NaN,NaN,NaN,NaN),this.update()},update:function(){this.resizeFrame(this.root,0,0,this.width,this.height),this.helpers.forEach(this.updateHelper,this),this.clients.forEach(this.updateClient,this),this.events.emit("update")},resizeFrame:function(e,t,i,n,s){switch(arguments.length>1?(e.x=t,e.y=i,e.w=n,e.h=s):(t=e.x,i=e.y,n=e.w,s=e.h),e.split){case TileView.VERTICAL_SPLIT:var r=e.h*e.position,o=e.h*(1-e.position);this.resizeFrame(e.head,t,i,n,r),this.resizeFrame(e.tail,t,i+r,n,o);break;case TileView.HORIZONTAL_SPLIT:var a=e.w*e.position,l=e.w*(1-e.position);this.resizeFrame(e.head,t,i,a,s),this.resizeFrame(e.tail,t+a,i,l,s)}},setElement:function(e,t,i,n,s){if(e){var r=e.style;r.top=i+"px",r.left=t+"px",r.width=n+"px",r.height=s+"px"}},showClients:function(){this.setClients(),this.frames.forEach(function(e,t){var i=dom.div("tile-client tile-client-test",this.econtent),n=dom.div("tile-client-index absmid",i),s=dom.div("tile-client-size absmid",i);i.style.backgroundColor=f.rcolor(),n.innerHTML=t,this.clients[t]={element:i,resize:function(e,t){s.innerHTML=Math.round(e)+"x"+Math.round(t)}}},this),this.update()},startHelper:function(e,t){t.point.x=t.origin.x=e.position,t.point.y=t.origin.y=e.position},dragHelper:function(e,t){e.split===TileView.VERTICAL_SPLIT?e.position=f.clamp(t.point.y,0,1):e.position=f.clamp(t.point.x,0,1),e.source[3]=e.position,this.resizeFrame(e),this.update()},updateHelper:function(e,t){var i=this.splits[t];if(i.split===TileView.VERTICAL_SPLIT){var n=i.position*i.h;this.setElement(e.element,i.x,i.y+n,i.w,this.helperSize),dom.addclass(e.element,"tile-helper-vertical"),dom.remclass(e.element,"tile-helper-horizontal"),e.scale.y=1/i.h}else{var s=i.position*i.w;this.setElement(e.element,i.x+s,i.y,this.helperSize,i.h),dom.addclass(e.element,"tile-helper-horizontal"),dom.remclass(e.element,"tile-helper-vertical"),e.scale.x=1/i.w}},updateClient:function(e,t){if(e){var i=this.frames[t];e.element&&dom.display(e.element,!!i),i&&(this.setElement(e.element,i.x,i.y,i.w,i.h),e.resize&&e.resize(i.w,i.h),e.setViewport&&e.setViewport(i))}}},PointProjector.prototype={clear:function(){this.points=[]},addPoint:function(e,t){var i={world:new THREE.Vector3,screen:new THREE.Vector2,local:!!e,visible:!1};return t&&this.points.push(i),i},remPoint:function(e){var t=this.points.indexOf(e);~t&&this.points.splice(t,1)},viewportToWorld:function(e,t,i){return t||(t=new THREE.Vector3),t.copy(e),t.applyMatrix4(this.inverse),i&&t.sub(this.camera.position),t},worldToViewport:function(e,t,i){return t||(t=new THREE.Vector3),t.copy(e),i&&t.add(this.camera.position),t.applyMatrix4(this.matrix),t},viewportToScreen:function(e,t){return t||(t=new THREE.Vector2),t.x=(e.x/2+.5)*this.width,t.y=(-e.y/2+.5)*this.height,t},screenToViewport:function(e,t){return t||(t=new THREE.Vector3),t.x=e.x/this.width*2-1,t.y=-(e.y/this.height*2-1),t.z=-1,t},screenToWorld:function(e,t,i){return this.screenToViewport(e,this.viewport),this.viewportToWorld(this.viewport,t,i)},worldToScreen:function(e,t,i){return this.worldToViewport(e,this.viewport,i),this.viewportToScreen(this.viewport,t)},resize:function(e,t){this.width=e,this.height=t},updateMatrices:function(){this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.matrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.inverse.getInverse(this.camera.projectionMatrix),this.inverse.multiplyMatrices(this.camera.matrixWorld,this.inverse)},updatePoint:function(e){this.worldToViewport(e.world,this.viewport,e.local),this.viewportToScreen(this.viewport,e.screen),e.local?e.distance=e.world.length():e.distance=e.world.distanceTo(this.camera.position),e.visible=-1<=this.viewport.x&&this.viewport.x<=1&&-1<=this.viewport.y&&this.viewport.y<=1&&-1<=this.viewport.z&&this.viewport.z<=1},update:function(){this.points.forEach(this.updatePoint,this)}},Imagery.prototype={folders:{thumbs:"images/thumbs/",textures:"images/textures/"},types:{alpha:1,normal:2,texture:3,logo:11,thumb:12,icon:21},materialOptions:{defaults:{factory:THREE.MeshPhongMaterial,makeMap:!0,side:THREE.DoubleSide},norcon:{makeMap:!1,factory:THREE.LineBasicMaterial,vertexColors:THREE.VertexColors,linewidth:2,visible:!1},subtract:{visible:!1,transparent:!0,opacity:.5},blue:{makeEnv:!0,reflectivity:.25,shininess:22},gold:{makeEnv:!0,makeBump:!0,reflectivity:.8,shininess:95},black:{makeEnv:!0,reflectivity:.3,shininess:70},glass:{makeEnv:!0,transparent:!0,opacity:.9,reflectivity:.8,side:THREE.FrontSide},corner:{makeAlpha:!0,transparent:!0},pcorner:{makeAlpha:!0,transparent:!0},cut:{transparent:!0,opacity:0},wall:{makeNormal:!0},roof:{makeNormal:!0},normal:{factory:THREE.MeshNormalMaterial,makeMap:!1},wireframe:{wireframe:!0}},textureOptions:{},makeTexture:function(e){var t=new THREE.Texture;return t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.minFilter=THREE.LinearMipMapLinearFilter,t.magFilter=THREE.LinearFilter,t.anisotropy=4,t.image=this.pixel.image,f.copy(t,e),t.needsUpdate=!0,t},makeMaterial:function(e,t){var i=f.merge(this.materialOptions.defaults,this.materialOptions[e]||this.materialOptions[t],{name:e}),n=f.copy({},this.textureOptions[e]||this.textureOptions[t]);i.makeMap&&(i.map=this.makeTexture(n)),i.makeAlpha&&(i.alphaMap=this.makeTexture(n)),i.makeNormal&&(i.normalMap=this.makeTexture(n),i.normalMap.image=this.normal.image),i.makeBump&&(i.bumpMap=this.makeTexture(n),i.bumpMap.image=this.bump.image),i.makeEnv&&(i.envMap=this.skybox);var s=i.factory;delete i.makeMap,delete i.makeAlpha,delete i.makeNormal,delete i.makeBump,delete i.makeEnv,delete i.factory;var r=new s(i);return r.persistent=!0,r.implicit=!0,r.needsUpdate=!0,r.obvImplicit=new Observable(r.implicit),r.obvFabric=new Observable,r.obvLoaded=(new Observable).set(this,function(){this.setMaterialProduct(r,this.getLoadedProduct(r))}),r},configureSampleMaterial:function(e){if(e&&e.material){if("subtract"===e.name)return void(e.material=this.materials.subtract);for(var t=e.material,i=[t.map,t.bumpMap,t.normalMap].filter(Boolean),n=0;n<i.length;n++){var s=i[n],r={image:s.image};this.tileTexture(r),s.wrapS=THREE.RepeatWrapping,s.wrapT=THREE.RepeatWrapping,s.image=r.image,s.repeat.x*=r.repeatX,s.repeat.y*=r.repeatY}t.envMap=this.skybox,t.needsUpdate=!0}},readMaterialLoaded:function(){this.materials[m.name],this.usedProducts[m.name]},addMaterial:function(e,t){var i=this.materials[e]=this.makeMaterial(e,t);return Observable.inContext(null,this.addMaterialInContext,this,i),i},addMaterialInContext:function(e){this.obvMaterialsList.write(this.obvMaterialsList.read().concat(e))},remMaterialInContext:function(e){this.obvMaterialsList.write(f.adrop(this.obvMaterialsList.read().slice(),e))},copyMaterial:function(e,t){e&&t&&(e.implicit?this.setMaterial(e,null):this.setMaterial(e,this.usedProducts[t.name]))},rootMaterial:function(e){var t=this.materials[e];if(t){for(;t.parent;)t=t.parent;return t.name}},addSubmaterial:function(e){var t=this.materials[e];if(t){t.submaterials||(t.submaterials=[]);var i=this.rootMaterial(e),n=t.name+"-"+ ++this.submaterialIndex,s=this.addMaterial(n,i);return t.submaterials.push(s),s.parent=t,this.setMaterial(s,this.usedProducts[e]),s}},remSubmaterial:function(e){var t=e instanceof THREE.Material?e:this.materials[e];t&&(t.parent&&f.adrop(t.parent.submaterials,t),t.dispose(),delete this.usedProducts[t.name],delete this.materials[t.name],Observable.inContext(null,this.remMaterialInContext,this,t))},setMapImage:function(e,t,i){e&&t&&(e.image!==t.image&&(e.image=t.image,e.needsUpdate=!0),e.repeat.x=t.repeatX||1,e.repeat.y=t.repeatY||1,i&&(e.repeat.x=1/(t.cloneX||1)))},setMaterialProduct:function(e,t){if(e&&t){e.obvFabric&&e.obvFabric.write(t),e.color&&e.color.set(t.color||16777215);var i=["outer","fouter"].indexOf(t.unit)!==-1;if(this.setMapImage(e.map,t.texture||this.pixel,i),this.setMapImage(e.bumpMap,t.bump||this.bump,i),this.setMapImage(e.normalMap,t.normal||this.normal,i),this.setMapImage(e.alphaMap,t.alpha||this.pixel,i),e.submaterials)for(var n=0;n<e.submaterials.length;n++){var s=e.submaterials[n];s.implicit&&this.setMaterialProduct(s,t)}}},setImplicitProduct:function(e,t){if(t){for(var i=e.parent;i&&i.implicit;)i=i.parent;e.implicit=!!i&&t===this.usedProducts[i.name]}else e.implicit=!0;e.implicit&&(t=null),e.obvImplicit.write(e.implicit),this.usedProducts[e.name]=t;var n=e.submaterials;if(n)for(var s=0;s<n.length;s++){var r=n[s];this.setImplicitProduct(r,this.usedProducts[r.name])}},isProductLoaded:function(e){return e&&(!e.texture||Observable.unwrap(e.texture.loaded))&&(!e.normal||Observable.unwrap(e.normal.loaded))&&(!e.alpha||Observable.unwrap(e.alpha.loaded))},getLoadedProduct:function(e){for(var t="object"==typeof e?e:this.materials[e];t;){var i=this.usedProducts[t.name];if(this.isProductLoaded(i))return i;if(!t.parent)return this.baseMaps[t.name];t=t.parent}},getUsedProduct:function(e){for(var t="object"==typeof e?e:this.materials[e];t;){var i=this.usedProducts[t.name];if(i)return i;if(!t.parent)return this.baseMaps[t.name];t=t.parent}},setMaterial:function(e,t){var i="object"==typeof e?e:this.materials[e];i&&("object"!=typeof t&&(t=this.products[t]),t&&!t.id&&(t=null),this.setImplicitProduct(i,t),this.setMaterialProduct(i,this.getLoadedProduct(i)))},textureColor:function(e,t,i){this.buffer.width=t,this.buffer.height=i,this.btx.drawImage(e,0,0);for(var n=this.btx.getImageData(0,0,t,i),s=n.data,r=s.length,o=1/(t*i),a=0,l=0,h=0,c=0;c<r;c+=4)a+=s[c+0],l+=s[c+1],h+=s[c+2];return a*o<<16^l*o<<8^h*o<<0},tileTexture:function(e){if(e){var t=e.image;e.width=t.naturalWidth||t.width,e.height=t.naturalHeight||t.height,e.color=this.textureColor(t,e.width,e.height);var i=512,n=i/e.height,s=e.height/e.width;e.cloneX=1,e.cloneY=1,e.repeatX=(e.resolution||1)*n*s,e.repeatY=(e.resolution||1)*n;var r=!(e.width&e.width-1),o=!(e.height&e.height-1);if(!r||!o){for(var a=this.fitTileSize(e.width,e.height,10),l=this.makeCanvas(a.spaceX,a.spaceY),h=0;h<a.cloneX;h++)for(var c=0;c<a.cloneY;c++)l.drawImage(t,0,0,a.sourceX,a.sourceY,h*a.sizeX,c*a.sizeY,a.sizeX,a.sizeY);e.image=l.canvas,e.width=a.spaceX,e.height=a.spaceY,e.cloneX=a.cloneX,e.cloneY=a.cloneY,e.repeatX/=a.cloneX,e.repeatY/=a.cloneY,this.debugFit(a,e)}}},fitTileSize:function(e,t,i){for(var n={sourceX:e,sourceY:t,score:1/0},s=0;s<=i;s++){var r=1<<s,o=Math.round(r/e),a=(r-e*o)/e;if(o)for(var l=0;l<=i;l++){var h=1<<l,c=Math.round(h/t),u=(h-t*c)/t,d=Math.abs(a),p=Math.abs(u),f=Math.abs(a-u),m=Math.sqrt(o*c),v=d+p+f/2+m/10;c&&v<n.score&&(n.sizeX=r/o,n.sizeY=h/c,n.cloneX=o,n.cloneY=c,n.spaceX=r,n.spaceY=h,n.errorX=a,n.errorY=u,n.error=f,n.score=v)}}return n},debugFit:function(e,t){var i;e.error>.4?i=console.error:Math.abs(e.errorX)>.4||Math.abs(e.errorY)>.4?i=console.warn:this.debug&&(i=console.log),i&&i.call(console,"tile:",e.sourceX+"x"+e.sourceY,"->",Math.round(e.sizeX)+"x"+Math.round(e.sizeY),"("+e.spaceX+"x"+e.spaceY+",",e.cloneX+"x"+e.cloneY+")","errors:",+e.errorX.toFixed(2),"-",+e.errorY.toFixed(2),"=",e.error,"\n",t.url)},normalColor:function(e,t,i){return"rgb("+new THREE.Vector3(e,t,i).normalize().multiplyScalar(127).addScalar(127).toArray().map(Math.round)+")"},unwrapCubemap3x2:function(e){for(var t=e.height/2,i=[],n=0;n<2;n++)for(var s=0;s<3;s++){var r=this.makeCanvas(t,t);r.drawImage(e,s*t,n*t,t,t,0,0,t,t),i.push(r.canvas)}var o=[i[2],i[0],i[4],i[3],i[5],i[1]];this.skybox.image=o,this.skybox.needsUpdate=!0},makeCanvas:function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,i.getContext("2d")},makePixel:function(e){var t=this.makeCanvas(1,1);return t.fillStyle=e,t.fillRect(0,0,1,1),{image:t.canvas}},makePattern:function(e,t,i,n){var s=this.makeCanvas(t,i);"function"==typeof n&&n.apply(this,[s,t,i].concat([].slice.call(arguments,4)));var r=512*e/i;return{loaded:!0,width:t,height:i,repeatX:r,repeatY:r,image:s.canvas}},drawDash:function(e,t,i,n,s,r){e.fillStyle=n,e.fillRect(0,0,t,i),e.lineWidth=s,e.strokeStyle=r,e.beginPath(),e.moveTo(2*t,-i),e.lineTo(-t,2*i),e.moveTo(2*t,0),e.lineTo(0,2*i),e.moveTo(t,-i),e.lineTo(-t,i),e.stroke()},drawGrid:function(e,t,i,n,s,r){e.fillStyle=n,e.fillRect(0,0,t,i),e.fillStyle=r,e.fillRect(0,0,t,s),e.fillRect(0,0,s,i)},drawStripe:function(e,t,i,n,s,r,o){e.fillStyle=n,e.fillRect(0,0,t,i),e.fillStyle=r,e.fillRect(0,0,o?s:t,o?i:s)},drawChecker:function(e,t,i,n,s){var r=t>>1,o=i>>1;e.fillStyle=n||"white",e.fillRect(0,0,t,i),e.fillStyle=s||"black",e.fillRect(0,0,r,o),e.fillRect(r,o,r,o)},drawCloud:function(e,t,i,n,s){this.drawRandom(e,t,i,n,s),e.save(),e.globalAlpha=.4,e.scale(4,4),e.drawImage(e.canvas,0,0),e.scale(4,4),e.drawImage(e.canvas,0,0),e.restore()},drawRandom:function(e,t,i,n,s){for(var r=e.getImageData(0,0,t,i),o=r.data,a=255*n|0,l=255*s|0,h=0;h<o.length;h+=4)o[h+0]=o[h+1]=o[h+2]=f.rand(a)+l,o[h+3]=255;e.putImageData(r,0,0)}},Sampler.prototype={folder:"",setImagery:function(e){this.imagery=e},addSample:function(e){if(e&&!e.hide&&(e.object||e.src)){var t=new Sample(e,this),i=f.apick(this.samples,"id",t.id);return i&&(f.adrop(this.samples,i),console.warn("Sample with id",t.id,"already exists")),this.samples.push(t),t}},readFile:function(e){var t=new FileReader,i=new Defer(function(){return JSON.parse(t.result)});return dom.on("load",t,f.binds(i.resolve,i)),t.readAsText(e),i.then(function(e){var t=new THREE.ObjectLoader,i=new Defer;return t.parse(e,function(e){i.resolve(e)}),i}).then(function(t){return this.addSample({id:e.name,src:e.name,object:t})},this)}},Sample.prototype={traverse:function(e,t,i,n,s,r){if(e&&(null==r&&(r=0),t.call(i||this,e,n,r),e.children))for(var o=e.children.length,a=s?0:o-1;s?a<o:a>=0;s?a++:a--)this.traverse(e.children[a],t,i,n,s,r+1)},load:function(){if(this.object&&(this.deferLoad=(new Defer).resolve(this)),this.deferLoad)return this.deferLoad;var e=new Defer,t=this.parent.folder+this.src;if(!this.src)return e.resolve(null),e;switch(this.format){case"obj":var i=new Loader;i.obj(t).defer.push(e);break;case"fbx":var i=new THREE.FBXLoader;i.load(t,function(t){e.resolve(t)},void 0,function(t){e.reject(t)});break;default:case"json":var i=new Loader;i.onProgress(function(){this.broken||(this.progress=i.bytesLoaded/i.bytesTotal)},this),i.json(t).defer.then(function(e){var t=new THREE.ObjectLoader,i=new Defer;return t.parse(e,function(e){i.resolve(e)}),i},this).push(e)}return this.deferLoad=e.then(this.configure,this.loadError,this),this.deferLoad},loadError:function(e){throw this.broken=!0,this.progress=1,console.warn("Sample load error",this.src||this.id,e),e},configure:function(e){if(e)return e.position.length()&&console.error("sample",this.src||this.id,"not zero position:",e.position),this.progress=1,this.object=e,this.object.updateMatrixWorld(),this.config||(this.config={}),this.width||(this.width=this.config.width||1),this.height||(this.height=this.config.height||1),this.depth||(this.depth=this.config.depth||1),this.meshes||(this.meshes=this.config.meshes||[]),this.parts=[],this.box.makeEmpty(),this.object.updateMatrixWorld(),this.traverse(this.object,this.configureObject),this.box.getCenter(this.boxCenter),this.box.getSize(this.boxSize),this.boxLength=this.boxSize.length(),this},canReplace:function(e){var t=this.joints.slice();e:for(var i=0;i<e.length;i++){for(var n=e[i],s=t.length-1;s>=0;s--){var r=t[s];if(n.canConnect(r)){t.splice(s,1);continue e}}return!1}return!0},configureSubtract:function(e){return e.parent.remove(e),e.geometry?(this.subtractMesh&&console.warn("sample",this.src||this.id,"has multiple subtract meshes"),this.subtractMesh=e,void(e.visible=!0)):void console.error("sample",this.src||this.id,"subtract mesh without geometry")},configureObject:function(e){var t=this.parent.imagery;if(0===e.name.indexOf(":")){e.visible=!1;var i=new SampleJoint(e);if(i.makeDebugLine){var n=i.makeDebugLine();t&&(n.material=t.materials.norcon),this.object.add(n)}return void this.joints.push(i)}if("subtract"===e.name)return void this.configureSubtract(e);if(e.geometry){t&&t.configureSampleMaterial(e),e.geometry.persistent=!0,e.geometry.boundingBox||e.geometry.computeBoundingBox();var s=new THREE.Box3;s.copy(e.geometry.boundingBox).applyMatrix4(e.matrixWorld),this.box.union(s)}},smoothShadeGeometry:function(e){var t=new THREE.Geometry;return e instanceof THREE.BufferGeometry?t.fromBufferGeometry(e):t.copy(e),t.mergeVertices(),t.computeVertexNormals(),t.computeFaceNormals(),t},clone:function(){if(this.object)return this.object.clone(!0)},describeObject:function(e,t,i){var n=[];i&&n.push(Array(i+1).join("\t")),n.push(e.type),n.push("name: {"+e.name+"}"),e.material&&n.push("mat: {"+e.material.name+"}"),e.geometry&&n.push("v:",e.geometry instanceof THREE.BufferGeometry?e.geometry.attributes.position.count:e.geometry.vertices.length),n.push("pos: ["+[f.mround(e.position.x,3),f.mround(e.position.y,3),f.mround(e.position.z,3)].join(", ")+"]"),n.push("rot: ["+[f.hround(f.xdeg*e.rotation.x),f.hround(f.xdeg*e.rotation.y),f.hround(f.xdeg*e.rotation.z)].join(", ")+"]"),console.log.apply(console,n)},describe:function(){console.log("sample id: {"+this.id+"} src: {"+(this.src||"")+"}"),this.traverse(this.object,this.describeObject,this,null,!0)}},SampleJoint.prototype={setFromMatrix:function(e){this.matrix.copy(e),this.point.setFromMatrixPosition(this.matrix),this.normal.set(1,0,0).applyMatrix4(this.matrix).sub(this.point),this.up.set(0,1,0).applyMatrix4(this.matrix).sub(this.point)},clone:function(){return new SampleJoint(this.object)},paramPairsAllow:[["f","m"],["u","u"],["u","f"],["u","m"],["FP","MP"],["female","male"],["uniform","uniform"],["uniform","female"],["uniform","male"],["in","out"],["inner","outer"],["internal","external"]],
paramPairsEqual:function(e){return f.seq(e,this)},canConnect:function(e){return this.id===e.id&&this.paramPairsAllow.some(this.paramPairsEqual,[this.param,e.param])},canConnectList:function(e){return e.filter(this.canConnect,this)},makeDebugLine:function(){var e=new THREE.Line(new THREE.Geometry);return e.name="debug-connection-normal",e.geometry.vertices.push(new THREE.Vector3,this.normal.clone().setLength(20)),e.geometry.colors.push(new THREE.Color(0,0,0),new THREE.Color(1,0,0)),e.position.copy(this.point),e}},View3=f.unit({unitName:"View3",ename:"view-3",enableGrid:!1,enableRender:!0,enableWireframe:!1,enableRaycast:!0,enableStencil:!0,enableFXAA:!0,enableBloom:!0,renderTarget:null,clearColor:"#f4f4f4",focusThetaMin:.5,focusThetaMax:2.2,focusDistance:1,focusDuration:500,stencilRaycastMask:-1,stencilNone:{value:1,params:{}},stencilLit:{value:2,params:{drawColor:"#00f0ff",drawAlpha:1,lineAlpha:.11,lineAngle:0,edgeAlpha:.8,fillAlpha:.2}},stencilHover:{value:4,params:{drawColor:"#00ffb3",drawAlpha:1,lineAlpha:.2,lineAngle:0,edgeAlpha:.8,fillAlpha:.11}},stencilSelect:{value:8,params:{drawColor:"#00FF77",drawAlpha:1,lineAlpha:.4,lineAngle:0,edgeAlpha:.9,fillAlpha:.2}},init:function(e){for(var t in e)this[t]=e[t];this.element=dom.div("view-3",this.eroot),this.events=new EventEmitter,this.scene=new THREE.Scene,this.ambLight=new THREE.AmbientLight(16777215,.2),this.dirLight=new THREE.DirectionalLight(16777215,1),this.camera=new THREE.PerspectiveCamera,this.orbit=new THREE.OrbitControls(this.camera,this.element),this.raycaster=new THREE.Raycaster,this.root=new THREE.Object3D,this.grid=new THREE.Object3D,this.lastcam=new THREE.Matrix4,this.animatedConnections=[],this.scene.autoUpdate=!1,this.mouse=new THREE.Vector2(1/0,1/0),this.mouse2=new THREE.Vector3,this.mouse3=new THREE.Vector3,this.updatePointer(),this.renderer||(this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.autoClear=!1,this.renderer.clear(),dom.append(this.element,this.renderer.domElement)),this.srScene=new THREE.Scene,this.srPlane=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2)),this.srCamera=new THREE.OrthographicCamera(-1,1,1,-1,-1,1),this.srCamera.updateProjectionMatrix(),this.srScene.add(this.srPlane),this.smCopy=this.makeShader(THREE.CopyShader),this.smFill=this.makeShader(THREE.FillShader),this.smOverlay=this.makeShader(THREE.OverlayShader),this.smHBlur=this.makeShader(THREE.HorizontalBlurShader),this.smVBlur=this.makeShader(THREE.VerticalBlurShader),this.smFXAA=this.makeShader(THREE.FXAAShader),this.clearButton=dom.div("view-clear out-02 hand",this.element),Atlas.set(this.clearButton,"i-cross","absmid"),new EventHandler(this.events.will("view_clear")).listen("tap",this.clearButton),this.transform=new THREE.TransformControls(this.camera,this.element),this.transform.addEventListener("change",f.binds(this.onTransformControlsChange,this)),this.projector=new PointProjector(this.camera),this.markers=new UI.MarkerSystem({eroot:this.element,projector:this.projector}),this.markers.events.on("marker_tap",this.onMarkerTap,this),this.wireMaterial=new THREE.MeshBasicMaterial({wireframe:!0,color:0}),this.debugBox=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:16711935,transparent:!0,opacity:.2})),this.debugBox.visible=!1,this.cameraTween=new TWEEN.Tween({x:0,y:0,z:0}).easing(TWEEN.Easing.Cubic.Out),this.orbitTween=new TWEEN.Tween({x:0,y:0,z:0}).easing(TWEEN.Easing.Cubic.Out),this.makeGridSystem(),this.makePreloader(),this.dirLight.position.set(-100,100,100),this.dirLight.target.position.set(0,0,0),this.camera.position.set(1,1,1),this.treeBox=new THREE.Box3,this.treeCenter=new THREE.Vector3,this.treeSize=new THREE.Vector3,this.treeLength=1,this.focusOnTree(0),this.root.add(this.ambLight),this.root.add(this.dirLight),this.scene.add(this.root),this.scene.add(this.grid),this.scene.add(this.transform),new EventHandler(this.onMouseMove,this).listen("mousemove",this.element),new EventHandler(this.onMouseOut,this).listen("mouseout",this.element),new EventHandler(this.onTap,this).listen("tap",this.element)},makeShader:function(e){if(e)return new THREE.ShaderMaterial({vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:THREE.UniformsUtils.clone(e.uniforms)})},makeGrid:function(){for(var e=10,t=200,i=new THREE.Color(3355443),n=new THREE.Color(12303291),s=2*e/t,r=[],o=[],a=-t,l=0,h=-e;a<=t;a++,h+=s){r.push(-e,0,h,e,0,h),r.push(h,0,-e,h,0,e);var c=a%10===0?i:n;c.toArray(o,l),l+=3,c.toArray(o,l),l+=3,c.toArray(o,l),l+=3,c.toArray(o,l),l+=3}var u=new THREE.BufferGeometry;u.addAttribute("position",new THREE.Float32BufferAttribute(r,3)),u.addAttribute("color",new THREE.Float32BufferAttribute(o,3));var d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});return d.transparent=!0,new THREE.LineSegments(u,d)},makeGridSystem:function(){this.gridXZ=this.makeGrid(),this.gridXY=this.makeGrid(),this.gridYZ=this.makeGrid(),this.gridXZ.normal=new THREE.Vector3(0,1,0),this.gridXY.normal=new THREE.Vector3(0,0,1),this.gridYZ.normal=new THREE.Vector3(1,0,0),this.grid.add(this.gridXZ),this.grid.add(this.gridXY),this.grid.add(this.gridYZ),this.gridXY.rotation.x=Math.PI/2,this.gridYZ.rotation.z=Math.PI/2},makePreloader:function(){this.preloaderBox=dom.div("view-preloader-box absmid out-03 hidden",this.element),this.preloaderBlocks=[];for(var e=0;e<10;e++)this.preloaderBlocks.push(dom.div("view-preloader-block",this.preloaderBox))},setLoading:function(e){this.preloaderEnabled!==!!e&&(this.preloaderEnabled=!!e,dom.togclass(this.preloaderBox,"hidden",!e))},setProgress:function(e){if(this.preloaderProgress!==e){this.preloaderProgress=e;for(var t=this.preloaderBlocks.length,i=f.clamp(e,0,1)*t,n=Math.floor(i),s=i-n,r=0;r<t;r++)this.preloaderBlocks[r].style.opacity=r<n?1:r>n?0:s}},setPreloader:function(e){this.preloaderSamples=e,this.updatePreloader()},updatePreloader:function(){var e=1,t=this.preloaderSamples&&this.preloaderSamples.length;if(t){e=0;for(var i=0;i<t;i++)e+=this.preloaderSamples[i].progress;e/=t}this.setProgress(e),this.setLoading(e<1),e>=1&&delete this.preloaderSamples},updateLights:function(){this.dirLight.position.copy(this.camera.position)},updateGrid:function(){if(this.enableGrid){this.raycaster.setFromCamera({x:0,y:0},this.camera);var e=this.raycaster.ray.direction,t=e.dot(this.gridXZ.normal),i=e.dot(this.gridXY.normal),n=e.dot(this.gridYZ.normal);this.gridXZ.material.opacity=Math.abs(t),this.gridXY.material.opacity=Math.abs(i),this.gridYZ.material.opacity=Math.abs(n)}},orbitTo:function(e,t,i,n){var s=1e-9,r=this.camera.position,o=this.orbit.target;e||(e=o);var a=new THREE.Vector3,l=new THREE.Vector3,h=new THREE.Matrix4,c=r.distanceTo(o),u=this.orbit.minDistance,d=this.orbit.maxDistance,p=f.clamp(isNaN(i)?c:i,u,d);a.subVectors(r,o).setLength(p);var m=Math.acos(a.y/p),v=Math.max(this.focusThetaMin,this.orbit.minPolarAngle),g=Math.min(this.focusThetaMax,this.orbit.maxPolarAngle),b=f.clamp(isNaN(n)?m:n,v,g);if(Math.abs(b-m)>s){var y=l;y.set(-a.z,0,a.x).normalize(),h.makeRotationAxis(y,m-b),a.applyMatrix4(h)}l.addVectors(e,a),this.orbitTween.stop(),this.cameraTween.stop(),t?(o.distanceToSquared(e)>s&&this.orbitTween.from(o).to(e,t).start(),r.distanceToSquared(l)>s&&this.cameraTween.from(r).to(l,t).start()):(r.copy(l),o.copy(e),this.orbit.update())},focusOnTree:function(e){isNaN(e)&&(e=this.focusDuration),this.updateTreeSize();var t=this.getFitDistance(this.treeSize,1.5,1.5);this.orbitTo(this.treeCenter,e,t)},focusOnNode:function(e,t){isNaN(t)&&(t=this.focusDuration),this.orbitTo(e.localCenter,t)},getFitDistance:function(e,t,i){var n=this.camera.fov*f.xrad/2,s=this.camera.aspect,r=Math.max(e.x,e.y,e.z)/2,o=r*(t||1)/Math.tan(n*s),a=r*(i||1)/Math.tan(n);return s?Math.max(o,a):a},lookAt:function(){},setTree:function(e){this.selectNode(null),this.hoverNode(null),this.tree&&(this.root.remove(this.tree.object),this.tree.events.off(null,null,this)),this.tree=e,this.tree&&(this.root.add(this.tree.object),this.root.updateMatrixWorld(),this.tree.traverse(this.updateNodeStencil,this),this.tree.events.on("connect_start",this.onConnectStart,this)),this.animatedConnections.forEach(this.onConnectEnd,this),this.updateTreeSize(),this.updateProjection(),this.updateConnectionTree(),this.focusOnTree(),this.needsRedraw=!0},onConnectStart:function(e){var t=this.animatedConnections.indexOf(e);t===-1&&(this.animatedConnections.push(e),e.events.on("connect_end",this.onConnectEnd,this))},onConnectEnd:function(e){var t=this.animatedConnections.indexOf(e);t!==-1&&(e.events.off(null,null,this),e.node.updateSize(),this.animatedConnections.splice(t,1))},updateTreeSize:function(){this.tree?(this.tree.updateSize(),this.treeBox.copy(this.tree.box),this.treeSize.copy(this.tree.boxSize),this.treeCenter.copy(this.tree.boxCenter),this.treeLength=this.tree.boxLength):(this.treeBox.makeEmpty(),this.treeCenter.set(0,0,0),this.treeSize.set(1,1,1).normalize(),this.treeLength=1),this.debugBox.position.copy(this.treeCenter),this.debugBox.scale.copy(this.treeSize)},updateConnectionTree:function(){var e=this.markers.markers.slice();this.tree&&(this.tree.object.updateMatrixWorld(),this.tree.traverseConnections(this.updateConnection,this,e));for(var t=0;t<e.length;t++)this.markers.removeMarker(e[t])},updateConnection:function(e,t){if(e.marker){this.markers.addMarker(e.marker);var i=t.indexOf(e.marker);i!==-1&&t.splice(i,1)}e.animating&&this.onConnectStart(e)},updateProjection:function(){this.camera.fov=30,this.camera.aspect=this.width/this.height,this.camera.far=100*this.treeLength,this.camera.near=.01*this.treeLength,this.camera.updateProjectionMatrix(),this.projector.updateMatrices(),this.needsRetrace=!0},onTransformControlsChange:function(){var e=this.transformConnection;e&&(e.updateControl(),this.updateConnectionTree()),this.needsRedraw=!0},onKey:function(e){if(e.ctrlKey||e.shiftKey||e.altKey);else if(kbd.down&&kbd.changed)switch(kbd.key){case"1":return this.transform.setMode("translate");case"2":return this.transform.setMode("rotate");case"3":return this.transform.setMode("scale");case"q":return this.transform.setSpace("local");case"w":return this.transform.setSpace("world");case"x":return this.debug=!this.debug,this.enableWireframe=this.debug,this.needsRedraw=!0,this.debugBox.visible=this.debug,dom.togclass(this.markers.element,"debug",this.debug),this.markers.debug=this.debug,void this.markers.update(!0);case"s":return this.verbose=!this.verbose,this.markers.verbose=this.verbose,void this.markers.update(!0);case"z":return this.enableRender=!this.enableRender,void(this.needsRedraw=!0);case"c":return void this.focusOnTree();case"g":return this.enableGrid=!this.enableGrid,void(this.needsRedraw=!0)}},setViewport:function(e){this.viewport=e,this.onResize()},updateConnectionType:function(e,t){console.log(e.marker)},setConnectionTypes:function(e){this.tree&&this.tree.traverseConnections(this.updateConnectionType,this,e)},updateMeshStencil:function(e,t){e.stencilValue=t},updateNodeStencil:function(e){var t=e.selected?this.stencilSelect.value:e.hovered?this.stencilHover.value:e.lit?this.stencilLit.value:this.stencilNone.value;e.sample.traverse(e.sampleObject,this.updateMeshStencil,this,t)},selectConnection:function(e){(!e||e.inactive.value||e.connected)&&(e=null);var t=this.selectedConnection;t!==e&&(t&&(t.selected=!1,t.marker.updateState()),this.selectedConnection=e,e&&(e.selected=!0,e.marker.updateState()),this.events.emit("connection_select",e))},selectNode:function(e){var t=this.nodeSelected;e!==t&&(t&&(t.selected=!1,this.updateNodeStencil(t)),this.nodeSelected=e,e&&(e.selected=!0,this.updateNodeStencil(e)),this.events.emit("node_select",[e,t]),this.needsRedraw=!0)},hoverNode:function(e){var t=this.nodeHovered;e!==t&&(t&&(t.hovered=!1,this.updateNodeStencil(t)),this.nodeHovered=e,e&&(e.hovered=!0,this.updateNodeStencil(e)),dom.togclass(this.element,"hand",!!e),this.events.emit("node_hover",[e,t]),this.needsRedraw=!0)},updatePointer:function(e){this.fpvEnabled?(this.mouse.x=this.width/2,this.mouse.y=this.height/2,this.mouse2.x=0,this.mouse2.y=0):(e&&(this.mouse.x=e.pageX-this.elementOffset.x,this.mouse.y=e.pageY-this.elementOffset.y),this.mouse2.x=this.mouse.x/this.width*2-1,this.mouse2.y=2*-(this.mouse.y/this.height)+1),this.mouse2.z=-1},retrace:function(){if(this.enableRaycast&&this.tree){this.projector.viewportToWorld(this.mouse2,this.mouse3,!0),this.raycaster.setFromCamera(this.mouse2,this.camera);for(var e=this.raycaster.intersectObject(this.scene,!0),t=0;t<e.length;t++){var i=e[t].object;if(i.stencilValue&this.stencilRaycastMask)return void this.hoverNode(i.node)}this.hoverNode(null)}},onMouseMove:function(e){this.updatePointer(e),this.needsRetrace=!0},onMouseOut:function(e){this.mouse.x=1/0,this.mouse.y=1/0,this.updatePointer(),this.needsRetrace=!0},onTap:function(e){e.target===this.element&&(this.transformConnection?(this.transformConnection.detachControl(),this.transformConnection=null,this.updateConnectionTree(),this.needsRedraw=!0):this.selectConnection(null),this.selectNode(this.nodeHovered))},onMarkerTap:function(e){var t=e.connection;t&&(kbd.state.CTRL?(this.transformConnection=t,this.transformConnection.attachControl(this.transform),this.needsRedraw=!0):this.selectConnection(t))},resizeRenderTargets:function(e,t){this.rtStencil=new THREE.WebGLRenderTarget(e,t,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.rt1=this.rtStencil.clone(),this.rt2=this.rtStencil.clone()},resizeShaders:function(e,t){var i=1/e,n=1/t;this.smOverlay&&this.smOverlay.uniforms.resolution.value.set(i,n),this.smFXAA&&this.smFXAA.uniforms.resolution.value.set(i,n),this.smVBlur&&(this.smVBlur.uniforms.v.value=n),this.smHBlur&&(this.smHBlur.uniforms.h.value=i)},onResize:function(){this.width=this.element.offsetWidth,this.height=this.element.offsetHeight,this.elementOffset=dom.offset(this.element),this.projector.resize(this.width,this.height),this.viewport||(this.renderer.setSize(this.width,this.height),this.resizeRenderTargets(this.width,this.height),this.resizeShaders(this.width,this.height)),this.updateProjection(),this.needsRedraw=!0},draw:function(){function e(){var e=d;d=u,u=e}function t(){o?(a.setViewport(o.x,o.y,o.w,o.h),a.setScissor(o.x,o.y,o.w,o.h),a.setScissorTest(!0)):a.setScissorTest(!1)}function i(e,i,n){i||(i=h),n||(n=c),t(),a.render(i,n,e)}function n(e,i,n,s){t(),e?a.clearTarget(e,i,n,s):a.clear(i,n,s)}function s(e,t,i){for(var n in i){var s=e.uniforms[n];if(s){var r=i[n];s.value instanceof THREE.Color?s.value.set(r):s.value=r}}t&&(e.uniforms.tDiffuse.value=t.texture),l.material=e}var r=this.renderer.context,o=this.viewport,a=this.renderer,l=this.srPlane,h=this.srScene,c=this.srCamera,u=this.rt1,d=this.rt2;if(this.renderer.setClearColor(this.clearColor),n(this.renderTarget),this.scene.updateMatrixWorld(!0),this.enableRender&&(this.grid.visible=!1,this.root.visible=!0,this.renderer.render(this.scene,this.camera,this.renderTarget),i(this.renderTarget,this.scene,this.camera)),this.enableGrid&&(this.grid.visible=!0,this.root.visible=!1,i(this.renderTarget,this.scene,this.camera)),this.enableWireframe&&(this.scene.overrideMaterial=this.wireMaterial,i(this.renderTarget,this.scene,this.camera),this.scene.overrideMaterial=null),this.enableStencil&&this.smFill&&this.smCopy&&this.smOverlay){r.enable(r.STENCIL_TEST),r.stencilOp(r.KEEP,r.KEEP,r.REPLACE),THREE.Object3D.prototype.stencilWrite=!0,this.scene.overrideMaterial=this.smFill,n(this.rtStencil),i(this.rtStencil,this.scene,this.camera),this.scene.overrideMaterial=null,THREE.Object3D.prototype.stencilWrite=!1,this.renderer.setClearColor(0,0),n(d),n(u),r.disable(r.DEPTH_TEST),r.stencilOp(r.KEEP,r.KEEP,r.KEEP);for(var p=[this.stencilLit,this.stencilHover,this.stencilSelect],f=0;f<p.length;f++){var m=p[f];r.stencilFunc(r.EQUAL,m.value,255),s(this.smFill),this.renderer.setClearColor(0,1),n(this.rtStencil,!0,!0,!1),i(this.rtStencil),r.stencilFunc(r.ALWAYS,0,255),s(this.smOverlay,this.rtStencil,m.params),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE),i(u),r.disable(r.BLEND)}this.enableFXAA&&this.smFXAA&&(s(this.smFXAA,u),i(d),e()),this.enableBloom&&this.smVBlur&&this.smHBlur&&(s(this.smVBlur,u),i(d),s(this.smHBlur,d),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),i(),r.disable(r.BLEND)),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),s(this.smCopy,u),i(),r.disable(r.BLEND),r.disable(r.STENCIL_TEST),r.enable(r.DEPTH_TEST)}},onTick:function(e){this.preloaderSamples&&this.updatePreloader(),this.transform.update(),this.animatedConnections.length&&(this.needsRedraw=!0,this.needsRetrace=!0),this.orbitTween.playing&&(this.orbit.target.x+=this.orbitTween.delta.x,this.orbit.target.y+=this.orbitTween.delta.y,this.orbit.target.z+=this.orbitTween.delta.z),this.cameraTween.playing&&(this.camera.position.x+=this.cameraTween.delta.x,this.camera.position.y+=this.cameraTween.delta.y,this.camera.position.z+=this.cameraTween.delta.z),(this.orbitTween.playing||this.cameraTween.playing)&&(this.camera.lookAt(this.orbit.target),this.needsRedraw=!0),this.camera.updateMatrixWorld(),this.lastcam.equals(this.camera.matrixWorld)||(this.lastcam.copy(this.camera.matrixWorld),this.projector.updateMatrices(),this.updateLights(),this.updateGrid(),this.needsRetrace=!0,this.needsRedraw=!0),this.needsRetrace&&(this.needsRetrace=!1,this.retrace()),this.needsRedraw&&(this.needsRedraw=!1,this.draw(),this.projector.update(),this.markers.update())}}),THREE.Object3D.prototype.stencilWrite=!1,THREE.Object3D.prototype.onBeforeRender=function(e,t,i,n,s,r){if(this.stencilWrite){var o=e.context;o.stencilFunc(o.ALWAYS,+this.stencilValue||0,255)}},THREE.Object3D.prototype.onAfterRender=function(e,t,i,n,s,r){},TNode=f.unit({unitName:"TNode",init:function(e){this.object=new THREE.Object3D,this.events=new EventEmitter,this.box=new THREE.Box3,this.boxCenter=new THREE.Vector3,this.boxSize=new THREE.Vector3,this.boxLength=1,this.localBox=new THREE.Box3,this.localCenter=new THREE.Vector3,this.localSize=new THREE.Vector3,this.localLength=1,this.localSphere=new THREE.Sphere,this.objectCenter=new THREE.Object3D,this.connections=[],this.object.add(this.objectCenter),e?this.setSample(e):console.warn("new TNode with no sample")},traverse:function(e,t,i){var n=e.call(t||this,this,i);if(n===TNode.TRSTOP)return n;for(var s=0;s<this.connections.length;s++){var r=this.connections[s];if(r.connected&&r.master){var n=r.target.traverse(e,t,i);if(n===TNode.TRSTOP)return n}}},traverseConnections:function(e,t,i,n){null==n&&(n=0);for(var s=0;s<this.connections.length;s++){var r=this.connections[s];e.call(t||this,r,i,n),r.connected&&r.master&&r.target.traverseConnections(e,t,i,n+1)}},includeConnection:function(e,t){if(t&&t.list){for(var i in t.test){var n=t.test[i],s=e[i];if(t.binary?!s!=!n:s!==n)return}t.list.push(e)}},retrieveConnections:function(e,t){var i=[];return this.traverseConnections(this.includeConnection,this,{test:e,binary:t,list:i}),i},setSample:function(e){if(this.sample)return console.warn("TN.setSample: node already has sample");var t=e.clone();return t?(this.sample=e,this.sampleObject=t,this.sample.traverse(this.sampleObject,this.setObjectParent,this),this.sample.box.getCenter(this.objectCenter.position),this.object.add(this.sampleObject),this.connections=[],void e.joints.forEach(this.addConnection,this)):console.warn("TN.setSample: got no sample object")},setObjectParent:function(e){e.node=this},addConnection:function(e){var t=new TConnection(this,e,this.connections.length);t.events.link(this.events),this.connections.push(t)},remConnection:function(){},getConnectedList:function(){for(var e=[],t=0;t<this.connections.length;t++){var i=this.connections[t];i.connected&&e.push(i.connected)}return e},canBeReplacedBy:function(e){if(!e||this.sample===e)return!1;for(var t=[],i=0;i<this.connections.length;i++){var n=this.connections[i];n.connected&&t.push(n.connected.joint)}if(!t.length)return!0;var s=e.joints.slice();e:for(var i=0;i<t.length;i++){for(var r=t[i],o=s.length-1;o>=0;o--){var a=s[o];if(r.canConnect(a)){s.splice(o,1);continue e}}return!1}return!0},replace:function(e){for(var t=this,i=e.getConnectedList(),n=0;n<i.length;n++){var s=i[n],r=s.node,o=s.master;s.disconnect();for(var a=0;a<t.connections.length;a++){var l=t.connections[a];if(!l.connected&&s.canConnect(l)){o?r.connect(s.index,t,l.index):t.connect(l.index,r,s.index);break}}}},pinch:function(){var e=[],t=[],i=[],n=0,s=-1,r=null,o=null,a=f.follow(this,"upnode").pop(),l=0,h=0;a.traverse(function(){h++}),this.traverse(function(){l++});for(var c=0;c<this.connections.length;c++){var u=this.connections[c];if(u.connected){for(var d=u.connected.node,p=0,m=d;m.upnode&&m.upnode!==this;)m=m.upnode;m.traverse(function(){p++}),m===a&&(p-=l),p>n&&(n=p,s=e.length,r=d,o=m),e.push(d),t.push(m),i.push(p)}}return{removeNode:this,removeCount:h-n,maxRoot:o}},pinchr:function(){var e=0;return this.traverse(function(){e++}),{removeNode:this,removeCount:e,maxRoot:null}},connect:function(e,t,i){if(!t)return console.warn("TN.connect to undefined node");var n=this.connections[e],s=t.connections[i];return n&&s?n.connected||s.connected?console.warn("TN.connect to used joint"):(t.events.link(this.events),t.upcon=s,t.upnode=this,void n.connect(s)):console.warn("TN.connect with undefined joint")},disconnect:function(){for(var e=0;e<this.connections.length;e++){var t=this.connections[e];t.connected&&t.disconnect()}this.upnode&&this.events.unlink(this.upnode.events)},destroy:function(){for(var e=0;e<this.connections.length;e++){var t=this.connections[e];t.destroy()}},rotate:function(e){this.upcon?this.upcon.rotate(e):this.object.rotateOnAxis(this.object.up,e)},getRotation:function(){},sizeUnion:function(e){e.sample&&(e.updateBox(),this.box.union(e.localBox))},updateBox:function(){this.localBox.copy(this.sample.box).applyMatrix4(this.object.matrixWorld),this.localBox.getSize(this.localSize),this.localCenter.copy(this.sample.boxCenter).applyMatrix4(this.object.matrixWorld),this.localLength=this.localSize.length()},updateSize:function(){this.object.updateMatrixWorld(),this.box.makeEmpty(),this.traverse(this.sizeUnion,this),this.box.isEmpty()?(this.boxCenter.set(0,0,0),this.boxSize.set(1,1,1).normalize(),this.boxLength=1):(this.box.getCenter(this.boxCenter),this.box.getSize(this.boxSize),this.boxLength=this.boxSize.length())}}),TNode.TRSTOP={},TConnection=f.unit({unitName:"TConnection",init:function(e,t,i){this.node=e,this.index=i,this.target=null,this.master=null,this.connected=null,this.selected=!1,this.inactive=new Gate(Gate.AND,!1),this.events=new EventEmitter,this.object=new THREE.Object3D,this.joint=t.clone(),this.depth=parseFloat(this.joint.depth)||0,this.screw="screw"===this.joint.extra,this.makeTween(),this.marker=new UI.Marker({connection:this}),this.objectInner=new THREE.Object3D,this.objectOuter=new THREE.Object3D,this.node.object.add(this.objectInner),this.node.object.add(this.objectOuter),this.updatePosition()},updatePosition:function(){this.objectInner.position.copy(this.joint.point),this.objectOuter.position.copy(this.joint.normal).setLength(this.depth).add(this.joint.point)},makeTween:function(){this.tween=new TWEEN.Tween({connected:0}).to({connected:1},1e3).easing(TWEEN.Easing.Linear.None).onStart(this.onTweenStart,this).onUpdate(this.onTweenUpdate,this).onComplete(this.onTweenComplete,this)},onTweenStart:function(){},onTweenUpdate:function(e,t){this.transitionProgress(t.connected)},onTweenComplete:function(){this.animating=!1,this.events.emit("connect_end",this)},transitionStageDuration:{approachDelay:100,approachTime:1200,screwDelay:100,screwTime:1200},getTransitionStages:function(){if(!this.connected||!this.master)return[0];var e=this.depth+this.connected.depth,t=this.transitionStageDuration;return e>0?[t.approachDelay,t.approachTime,t.screwDelay,t.screwTime]:[t.approachDelay,t.approachTime]},transitionProgress:function(e){if(this.connected&&this.master){var t=this.getTransitionStages(),i=-1,n=0,s=t.reduce(f.sum),r=Math.max(0,Math.min(1,e))*s;if(s){for(var o=TWEEN.Easing.Cubic.InOut,a=0;a<t.length;a++){var l=t[a];if(r<=l){i=a,n=o(r/l);break}r-=l}var h=this.depth,c=this.connected.depth,u=h&&c?Math.min(h,c):h+c,u=h+c,d=this.screw||this.connected.screw?2*Math.PI:0,p=(this.node.sample.boxLength+this.connected.node.sample.boxLength)/4,m=0,v=0;switch(i){case-1:return;case 0:m=u+p,v=d;break;case 1:m=u+p*(1-n),v=d;break;case 2:m=u,v=d;break;case 3:m=u*(1-n),v=d*(1-n)}this.connected.object.position.copy(this.joint.normal).setLength(m),this.object.quaternion.setFromAxisAngle(this.joint.normal,v)}}},playConnection:function(e,t){if(this.connected&&this.master){this.animating=!0,this.events.emit("connect_start",this);var i=this.getTransitionStages().reduce(f.sum);isNaN(t)||(i*=t),null==e?this.tween.target.connected=1:(this.tween.source.connected=+!e,this.tween.target.connected=+e),this.tween.duration(i).start()}},getPosition:function(e){return e||(e=new THREE.Vector3),e.setFromMatrixPosition(this.objectOuter.matrixWorld),e},getInnerPosition:function(e){return e||(e=new THREE.Vector3),e.setFromMatrixPosition(this.objectInner.matrixWorld),e},canConnect:function(e){return this.joint.canConnect(e.joint)},canConnectList:function(e){return e.filter(this.canConnect,this)},connect:function(e){var t=new THREE.Vector3,i=this,n=e;t.copy(n.joint.normal).negate(),i.node.object.add(i.object),i.object.position.copy(i.joint.point),i.object.add(n.object),n.object.position.set(0,0,0),n.object.quaternion.setFromUnitVectors(t,i.joint.normal),n.object.rotateOnAxis(t,-i.joint.up.angleTo(n.joint.up)),n.object.add(n.node.object),n.node.object.position.copy(n.joint.point).negate(),i.connected=n,i.target=n.node,i.master=!0,n.connected=i,n.target=i.node,n.master=!1,i.events.emit("connect",[i,n]),n.events.emit("connect",[n,i])},disconnect:function(){if(this.connected){var e=this.master?this:this.connected,t=this.master?this.connected:this;e.object.remove(t.object),e.connected=null,e.target=null,e.master=null,t.connected=null,t.target=null,t.master=null,e.events.emit("disconnect",[e,t]),t.events.emit("disconnect",[t,e])}},rotate:function(e){this.connected&&(this.master?this.connected.rotate(e):this.object.rotateOnAxis(this.joint.normal,e))},getRotation:function(){},destroy:function(){this.marker.destroy()},attachControl:function(e){e&&(this.control=e,this.controlObject=new THREE.Object3D,this.joint.matrix.decompose(this.controlObject.position,this.controlObject.rotation,this.controlObject.scale),this.node.object.add(this.controlObject),e.attach(this.controlObject))},updateControl:function(){if(this.controlObject){this.joint.setFromMatrix(this.controlObject.matrix),this.updatePosition();var e=this.connected;e&&(this.master?this.connect(e):e.connect(this))}},detachControl:function(){this.control&&(this.control.detach(),this.node.object.remove(this.controlObject),delete this.controlObject,delete this.control)}}),TSerial={round:function(e){return f.pround(e,9)},toJSON:function(e){var t=[],i=[],n=[],s=[];e.traverse(function(e){var r=t.indexOf(e.sample.src);r===-1&&(r=t.length,t.push(e.sample.src)),i.push(r),n.push(e),s.push(e.upcon)});for(var r=[],o=1;o<n.length;o++){var a=s[o];r.push({t:i[o],a:n.indexOf(a.connected.node),ai:a.connected.index,bi:a.index,r:(new THREE.Vector3).copy(a.object.rotation).toArray().map(TSerial.round)})}return{types:t,nodes:r}},fromJSON:function(e,t,i){var n=TSerial.prepareSamples(e.types,t);return Defer.all(n.map(f.func("load"))).then(function(){return TSerial.constructJSON(e,n,i)})},prepareSamples:function(e,t){return e.map(function(e){return f.apick(t.samples,"src",e)||t.addSample({src:e})})},constructJSON:function(e,t,i){var n=new TNode(t[0]);if(e&&e.nodes){for(var s=[n],r=0;r<e.nodes.length;r++){var o=e.nodes[r];s.push(new TNode(t[o.t]))}for(var r=0;r<e.nodes.length;r++){var o=e.nodes[r],a=s[o.a],l=s[r+1],h=a.connections[o.ai],c=l.connections[o.bi];a.connect(o.ai,l,o.bi),o.r&&c.object.rotation.fromArray(o.r),i&&h.playConnection()}}return n},toString:function(e){function t(e,t){for(d|=t<<p,p+=e;p>7;)u+=String.fromCharCode(255&d),d>>=8,p-=8}function i(){t(8-p,0)}for(var n=e.types.length,s=e.nodes.length,r=0,o=0;o<e.nodes.length;o++){var a=e.nodes[o];r=Math.max(r,a.ai,a.bi)}var l=Math.ceil(Math.log2(n)),h=Math.ceil(Math.log2(s+1)),c=Math.ceil(Math.log2(r+1)),u="",d=0,p=0;t(16,n);for(var o=0;o<n;o++){var f=e.types[o];t(16,f.length);for(var m=0;m<f.length;m++)t(8,f.charCodeAt(m))}t(16,r),t(16,s);for(var o=0;o<s;o++){var a=e.nodes[o];t(l,a.t),t(h,a.a),t(c,a.ai),t(c,a.bi)}return i(),btoa(u)},fromString:function(e){function t(e){for(;r<e;)n|=i.charCodeAt(s)<<r,r+=8,s++;var t=n&(1<<e)-1;return n>>=e,r-=e,t}for(var i=atob(e),n=0,s=0,r=0,o={types:[],nodes:[]},a=t(16),l=0;l<a;l++){for(var h=t(16),c="",u=0;u<h;u++)c+=String.fromCharCode(t(8));o.types.push(c)}for(var d=t(16),p=t(16),f=Math.ceil(Math.log2(a)),m=Math.ceil(Math.log2(p+1)),v=Math.ceil(Math.log2(d+1)),l=0;l<p;l++)o.nodes.push({t:t(f),a:t(m),ai:t(v),bi:t(v)});return o}},UI=f.unit({unitName:"UI"}),UI.MarkerSystem=f.unit(Block,{unitName:"UI_MarkerSystem",ename:"marker-system noselect",create:function(){this.markers=[],this.markersVisible=new Gate(Gate.AND,!1),this.markersVisible.events.on("change",this.onMarkersVisible,this)},onMarkersVisible:function(e){for(var t=0;t<this.markers.length;t++){var i=this.markers[t];i.undisposable||i.visible.set(e,"system")}},addMarker:function(e){var t=this.markers.indexOf(e);t===-1&&(this.markers.push(e),e.undisposable||e.visible.set(this.markersVisible.value,"system"),e.plug(this),e.updateState())},removeMarker:function(e){var t=this.markers.indexOf(e);t!==-1&&(this.markers.splice(t,1),e.unplug())},clear:function(){for(;this.markers.length;)this.removeMarker(this.markers[0])},update:function(e){e&&this.markers.forEach(f.func("updateState")),f.sort(this.markers,this.distanceSort,this),this.markers.forEach(this.updateMarker,this)},distanceSort:function(e){return-e.point.distance},updateMarker:function(e,t){e.element.style.zIndex=t,e.update()}}),UI.Marker=f.unit(Block.Tip,{unitName:"UI_Marker",ename:"marker hand",hidden:!0,align:"top",distance:100,arrowWidth:1,arrowPadding:-2,create:function(){dom.remclass(this.arrow,"tip-arrow"),dom.remclass(this.content,"tip-content"),dom.addclass(this.arrow,"marker-arrow"),dom.addclass(this.content,"marker-content marker-interactive out-02"),this.arrowLine=dom.div("marker-arrow-line marker-interactive out-02",this.arrow),this.elemGroup=dom.span("marker-group",this.content),this.elemInfo=dom.span("marker-info",this.content),dom.display(this.elemGroup,!1),dom.display(this.elemInfo,!1),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.className.baseVal="marker-depth-line marker-interactive out-02",this.svgLine=document.createElementNS("http://www.w3.org/2000/svg","line"),this.svgLine.setAttribute("x1",0),this.svgLine.setAttribute("y1",0),this.svgLineShadow=document.createElementNS("http://www.w3.org/2000/svg","line"),this.svgLineShadow.className.baseVal="marker-depth-line-shadow",this.svgLineShadow.setAttribute("x1",1),this.svgLineShadow.setAttribute("y1",1),dom.append(this.svg,this.svgLineShadow),dom.append(this.svg,this.svgLine),dom.append(this.element,this.svg),this.state={hover:!1,selected:!1,connected:!1,inactive:!1,master:!1},this.connection&&(dom.text(this.elemInfo,this.connection.joint.name),this.connection.events.when({connect:this.updateState},this)),this.watchEvents.push(new EventHandler(this.onTap,this).listen("tap",this.element),new EventHandler(this.onEnter,this).listen("mouseenter",this.element),new EventHandler(this.onLeave,this).listen("mouseleave",this.element))},plug:function(e){this.system&&this.unplug(),this.system=e,this.system&&(this.tipRoot=this.system.element,this.point=this.system.projector.addPoint(),this.inner=this.system.projector.addPoint())},unplug:function(){this.system&&(dom.remove(this.element),this.system.projector.remPoint(this.point),this.system.projector.remPoint(this.inner),delete this.point,delete this.inner,delete this.tipRoot,delete this.system)},destroy:function(){Block.Tip.prototype.destroy.call(this),
this.connection&&this.connection.events.off(null,null,this),this.unplug(),Atlas.free(this.elemGroup)},updateState:function(){if(this.connection){for(var e in this.state){var t=this.connection[e];this.state[e]=t instanceof Gate?t.value:t}this.state.connected?(this.align=this.state.master?"left":"right",this.distance=1e3):(this.align="top",this.distance=100),Atlas.free(this.elemGroup),dom.text(this.elemGroup,"");var i=this.connection.group,n=!isNaN(this.connection.group);n&&(i===-1?Atlas.set(this.elemGroup,"i-deny"):dom.text(this.elemGroup,String.fromCharCode(i+65))),dom.display(this.elemGroup,n),dom.setclass(this.element,this.state);var s=!1;s=!(!this.system||!this.system.verbose)||(this.system&&this.system.debug?!this.state.connected:n&&!this.state.connected),this.visible.set(s,"state")}},onEnter:function(){this.system&&this.system.events.emit("marker_enter",this)},onLeave:function(){this.system&&this.system.events.emit("marker_leave",this)},onTap:function(){this.system&&this.system.events.emit("marker_tap",this)},update:function(){if(this.system){this.connection&&(this.connection.getPosition(this.point.world),this.connection.getInnerPosition(this.inner.world)),this.system.projector.updatePoint(this.point),this.system.projector.updatePoint(this.inner);var e=this.visible.value||this.inTransition,t=Math.round(this.point.screen.x),i=Math.round(this.point.screen.y),n=this.inner.screen.x,s=this.inner.screen.y,r=n-t,o=s-i,a=e&&this.connection&&this.connection.depth&&!isNaN(r)&&!isNaN(o);if(dom.display(this.svg,a),e&&(this.scale=.7*(1.3-Math.min(.7,this.point.distance/1.5)),this.move(t,i,this.align),a)){var l=Math.ceil(Math.abs(r)),h=Math.ceil(Math.abs(o)),c=Math.max(l,h);this.svg.setAttribute("width",2*c+2),this.svg.setAttribute("height",2*c+2),this.svg.setAttribute("viewBox",[-c-1,-c-1,2*c+2,2*c+2].join(" ")),this.svg.style.marginLeft=-c-1+"px",this.svg.style.marginTop=-c-1+"px",this.svg.style.left=t-this.elementPoint.x+"px",this.svg.style.top=i-this.elementPoint.y+"px",this.svgLineShadow.setAttribute("x2",r+1),this.svgLineShadow.setAttribute("y2",o+1),this.svgLine.setAttribute("x2",r),this.svgLine.setAttribute("y2",o)}}},move:function(){Block.Tip.prototype.move.apply(this,arguments);var e=Math.max(0,this.lastDistance),t=this.arrowLine.style,i=this.arrowWidth+"px",n=e+"px";switch(t.left=t.right=t.top=t.bottom="auto",t.width=t.height=i,this.lastAlign){case"left":t.width=n,t.left="100%";break;case"right":t.width=n,t.right="100%";break;case"top":t.height=n,t.top="100%";break;case"bottom":t.height=n,t.bottom="100%"}}}),Plumber=f.unit({unitName:"Plumber",mode:"constructor",explode:0,explodeStepped:!1,catchFiles:!1,catchSamples:!0,dirSamples:"",srcAtlas:"plumber-atlas.svg",srcCubemap:"plumber-cubemap.png",initFromHash:!1,init:function(e){this.get=new Loader,this.timer=new Timer(this.onTick,this),this.ready=new Defer,this.imagery=new Imagery,this.events=new EventEmitter,this.sampler=new Sampler,this.sampler.setImagery(this.imagery),this.connectionParts=[],this.renderer=new THREE.WebGLRenderer({alpha:!1,depth:!0,stencil:!0,antialias:!0,preserveDrawingBuffer:!0}),this.renderer.autoClear=!1,this.canvas=this.renderer.domElement,this.tiles=new TileView,this.element=this.tiles.element,this.view=new View3({renderer:this.renderer}),this.view2=new View3({renderer:this.renderer,enableStencil:!1,enableRaycast:!1}),this.viewTween=new TWEEN.Tween({position:1}).to({position:1},400).easing(TWEEN.Easing.Cubic.Out).onStart(this.onViewTweenStart,this).onUpdate(this.onViewTweenUpdate,this).onComplete(this.onViewTweenComplete,this),this.explodeButton=new Block.Toggle({eroot:this.element,ename:"button-explode out-01",eicon:"i-search",active:!1,deselect:!0}),this.explodeButton.events.on("change",this.onExplode,this),this.splitViewMessage=dom.div("split-view-message"),dom.text(this.splitViewMessage,"no compatible connections"),this.splitViewMessageVisible=new Gate(Gate.AND,!0),this.splitViewMessageVisible.events.on("change",dom.display,dom,this.splitViewMessage),this.splitViewMessageVisible.events.on("opened",this.updateSplitViewMessagePosition,this),this.splitViewMessageVisible.off("g_vm_cons"),this.emptyViewMessage=dom.div("empty-view-message out-03 absmid");var t=dom.div("empty-view-message-center absmid",this.emptyViewMessage),i=dom.div("empty-view-message-frame absmid",this.emptyViewMessage),n=dom.div("empty-view-message-text absmid",this.emptyViewMessage);f.nop(t,i),dom.html(n,["please","add","any product"].join("<br/>")),this.makeDeletePrompt(),dom.addclass(this.element,"ontouchstart"in window?"touch":"no-touch"),dom.addclass(this.element,"plumber"),dom.addclass(this.canvas,"canvas-main"),dom.prepend(this.element,this.canvas),dom.append(this.element,this.splitViewMessage),dom.append(this.element,this.emptyViewMessage),dom.display(this.canvas,!1);for(var s in e)switch(s){case"eroot":dom.append(e.eroot,this.element);break;case"mode":this.mode=e.mode;break;case"clearButton":dom.display(this.view.clearButton,e.clearButton),dom.display(this.view2.clearButton,e.clearButton);break;case"dirSamples":this.sampler.folder=e.dirSamples;break;case"initFromHash":this.initFromHash=!0;break;default:s in this&&(this[s]=e[s])}this.setMode(this.mode,!0),this.fetch()},setMode:function(e,t){if(this.mode!==e||t){this.mode=e;var i,n;switch(e){case"constructor":i=["h",0,0,1],n=[this.view,this.view2];break;default:console.warn("unknown mode given:",e,'fallback to "viewer"'),e="viewer";case"viewer":i=0,n=[this.view2]}if(this.modeis={ctr:"constructor"===e,vwr:"viewer"===e},this.clearTree(),this.view2.setTree(null),this.tiles.setLayout(i),this.tiles.setClients(n),this.splitView=this.tiles.splits[0],this.splitView){var s=this.splitView.position;this.viewTween.target.position=s,this.viewTween.source.position=s}this.splitViewMessageVisible.set(this.modeis.ctr,"g_vm_mode"),this.updateMarkerVisibility(),this.view.markers.markersVisible.set(!!this.modeis.ctr,"g_m_mode"),this.view2.markers.markersVisible.set(!!this.modeis.ctr,"g_m_mode"),this.onViewTweenUpdate(),this.onViewTweenComplete()}},getConnectionsArray:function(){return this.tree.retrieveConnections({connected:!0},!0)},exportJSON:function(){return TSerial.toJSON(this.tree)},importJSON:function(e,t){return TSerial.fromJSON(e,this.sampler,t).then(this.absolutelySetMainTree,this)},exportString:function(){return TSerial.toString(this.exportJSON())},importString:function(e,t){return this.importJSON(TSerial.fromString(e),t)},replaceElement:function(e,t){var i=f.apick(this.sampler.samples,"src",e)||f.apick(this.sampler.samples,"id",e)||this.addSample(e,e);return this.tree&&i?void i.load().then(function(){this.replaceElementBySample(i,t)},this):void this.events.emit("onReplaceElement",{status:"rejected",reason:i?"no tree":"bad sample"})},replaceElementBySample:function(e,t){function i(e){n([e])}function n(e){r.emit("onReplaceElement",{status:"replaced",nodes:e})}function s(e){r.emit("onReplaceElement",{status:"rejected",reason:e})}var r=this.events;if(!this.tree||!e)return s(e?"no tree":"bad sample");switch(t){case-1:var o=[];if(this.tree.traverse(function(t){t.canBeReplacedBy(e)&&o.push(t)},this),o.length){var a=o.map(function(t){return this.replaceNode(t,e)},this);Defer.all(a).then(n,s)}else s("no suitable nodes");break;case 0:var o=[];switch(this.tree.traverse(function(t){t.lit=t.canBeReplacedBy(e),this.view.updateNodeStencil(t),t.lit&&o.push(t)},this),o.length){case 0:return void s("no suitable nodes");case 1:var l=o[0];l.lit=!1,this.view.updateNodeStencil(l),this.replaceNode(l,e,!0).then(i,s);break;default:this.issuedReplace=e,this.litModeStart()}break;default:t instanceof TNode?this.replaceNode(t,e,!0).then(i,s):s("invalid param")}this.view.needsRedraw=!0},litModeStart:function(){this.view.stencilRaycastMask=this.view.stencilLit.value|this.view.stencilHover.value|this.view.stencilSelect.value},litModeClear:function(){this.tree&&this.tree.traverse(function(e){e.lit=!1,this.view.updateNodeStencil(e)},this),this.view.needsRedraw=!0,this.view.stencilRaycastMask=-1},addElement:function(e,t,i){var n=f.apick(this.sampler.samples,"src",t)||f.apick(this.sampler.samples,"id",e)||this.addSample(e,t,i);if(n)return this.displayFigure(n.id),this.deferSample},addSample:function(e,t,i){return this.sampler.addSample({id:e,src:t,link:i})},addFigure:function(e){},addComplex:function(e,t){if(t&&t.types)for(var i=0;i<t.types.length;i++);},fetch:function(){this.get.xml(this.srcAtlas).defer.then(Atlas.setSource),this.get.image(this.srcCubemap).defer.then(this.imagery.unwrapCubemap3x2,this.imagery),this.get.ready().then(this.run,this,null,!0)},makeDeletePrompt:function(){var e=new Block.Tip({tipRoot:this.element,align:"top",point:this.view.projector.addPoint(),hidden:!0});dom.addclass(e.element,"prompt");var t=dom.div("prompt-text",e.content),i=dom.div("prompt-button hand prompt-button-ok",e.content),n=dom.div("prompt-button hand prompt-button-cancel",e.content);dom.text(i,"Yes"),dom.text(n,"No"),e.watchEvents.push(new EventHandler(this.deleteNode,this).listen("tap",i),new EventHandler(this.closeDeletePrompt,this).listen("tap",n)),this.deletePromptTipText=t,this.deletePromptTip=e},makeGUI:function(){function e(){n.view.needsRedraw=!0,n.view2.needsRedraw=!0}function t(e){n.tree&&(n.tree.traverseConnections(f.func("transitionProgress",1-e)),n.view.needsRedraw=!0)}this.gui=new dat.GUI({hideable:!1});var i=["stencilLit","stencilHover","stencilSelect"];this.gui.closed=!0,this.gui.addColor(this.view,"clearColor").name("Clear").onChange(e),i.forEach(function(t){var i=this.gui.addFolder(t),n=this.view[t].params;i.addColor(n,"drawColor").onChange(e),i.add(n,"drawAlpha").min(0).max(1).onChange(e),i.add(n,"lineAlpha").min(0).max(1).onChange(e),i.add(n,"lineAngle").min(0).max(360).onChange(e),i.add(n,"edgeAlpha").min(0).max(1).onChange(e),i.add(n,"fillAlpha").min(0).max(1).onChange(e)},this),this.gui.add(this,"explode").min(0).max(1).name("Explode").onChange(t),this.gui.add(this,"explodeStepped").name("Explode Step");var n=this},onViewClear:function(){this.clear()},onViewClear2:function(){this.displayFigure(null),this.events.emit("onAddElement",{status:"canceled"})},clear:function(){this.displayFigure(null),this.view.setPreloader(null),this.view2.setPreloader(null),this.clearTree()},onViewTweenUpdate:function(){this.splitView&&(this.splitView.position=this.viewTween.source.position,this.tiles.update(),this.view.focusOnTree(0),this.view2.focusOnTree(0))},onViewTweenStart:function(){dom.display(this.tiles.ehelpers,!0)},onViewTweenComplete:function(){this.splitScreen||(this.view2.setTree(null),this.sampleView2=null),dom.display(this.tiles.ehelpers,this.splitScreen)},onExplode:function(e){function t(){var i=n[s++];if(i){for(var r=[],o=0;o<i.length;o++){var a=i[o],l=new Defer;a.events.once("connect_end",l.resolve,l),a.playConnection(e?0:1,.4),r.push(l)}this.explodeStepDefer=Defer.all(r).then(t,this)}}this.explodeStepDefer&&(this.explodeStepDefer.abort(),delete this.explodeStepDefer);var i=this.view.tree||this.view2.tree;if(i)if(this.explodeStepped){var n=[],s=0;i.traverseConnections(function(e,t,i){e.connected&&e.master&&(n[i]||(n[i]=[]),n[i].push(e))}),t.call(this)}else i.traverseConnections(function(t){t.connected&&t.master&&t.playConnection(e?0:1)})},displayFigure:function(e){var t=f.apick(this.sampler.samples,"src",e)||f.apick(this.sampler.samples,"id",e);if(t&&(e=t),this.issuedReplace&&(delete this.issuedReplace,this.litModeClear()),this.sampleView2!==e){this.tree||"viewer"===this.mode?this.sampleView2=e:this.sampleView2=null,this.splitScreen=!!this.sampleView2,this.splitViewMessageVisible.set(this.splitScreen,"g_vm_screen"),this.view.enableRaycast=!this.splitScreen,this.view.hoverNode(null),this.view.selectNode(null),this.view.selectConnection(null),this.view2.setTree(null);var i=this.splitScreen?.5:1;i!==this.viewTween.target.position&&(this.viewTween.target.position=i,this.viewTween.start()),this.updateMarkerVisibility(),dom.togclass(this.emptyViewMessage,"hidden",this.tree||e),e&&(this.sampleView2?this.constructNode(e,this.view2).then(this.setTree2,this.constructError,this):this.constructNode(e,this.view).then(this.setTree1,this.constructError,this))}},isComplexFigure:function(e){return e&&e.types instanceof Array},constructNode:function(e,t){if(this.ready.pending)return this.ready.then(f.binda(this.constructNode,this,arguments));if(t&&t.setPreloader(null),e instanceof Sample)return t&&t.setPreloader([e]),e.load().then(TNode.New);if(this.isComplexFigure(e)){var i=TSerial.prepareSamples(e.types,this.sampler);return t&&t.setPreloader(i),Defer.all(i.map(f.func("load"))).then(function(){return TSerial.constructJSON(e,i,!1)},this)}return Defer.complete(!1,"bad sample")},constructError:function(e){this.events.emit("onAddElement",{status:"error",error:e})},setTree2:function(e){e&&(this.view2.setTree(e),this.updateConnectionGroups(this.tree,e),this.updateMarkerVisibility())},setTree1:function(e){this.absolutelySetMainTree(e),e&&this.events.emit("onAddElement",{status:"connected",node:e})},updateMarkerVisibility:function(){var e=this.debug||this.view2.tree;this.view.markers.markersVisible.set(!!e,"g_m_split"),this.view2.markers.markersVisible.set(!!e,"g_m_split")},updateConnectionGroups:function(e,t){this.cons=e&&e.retrieveConnections({connected:!1},!0)||[],this.cons2=t&&t.retrieveConnections({connected:!1},!0)||[];for(var i=[],n=0;n<this.cons2.length;n++)this.cons2[n].group=-1;for(var n=0;n<this.cons.length;n++){var s=this.cons[n],r=s.canConnectList(this.cons2);if(s.group=-1,r.length){for(var o=!1,a=0;a<i.length;a++)if(f.seq(r,i[a])){s.group=a,o=!0;break}if(!o){var l=i.length;s.group=l;for(var a=0;a<r.length;a++)r[a].group=l;i.push(r)}}}this.hasAvailableConnections=i.length,this.splitViewMessageVisible.set(!this.hasAvailableConnections,"g_vm_cons"),this.updateSplitViewMessagePosition(),this.updateConnectionVisibilitySets(),this.hasAvailableConnections||this.events.emit("onAddElement",{status:"rejected"}),this.view.needsRetrace=!0},updateConnectionVisibilitySets:function(){if(this.cons)for(var e=0;e<this.cons.length;e++)this.updateConnectionVisibility(this.cons[e],this.connectionParts[1]);if(this.cons2)for(var e=0;e<this.cons2.length;e++)this.updateConnectionVisibility(this.cons2[e],this.connectionParts[0])},updateConnectionVisibility:function(e,t){var i=e.group!==-1,n=!t||e.canConnect(t);e.inactive.set(!i||!n,"view2"),e.marker&&(e.marker.visible.set(!this.hasAvailableConnections||i,"active"),e.marker.updateState())},connectRandomNode:function(){var e=f.sort(this.sampler.samples.slice(),Math.random);if(!this.tree)return this.constructNode(e[0],this.view).then(this.setTree1,this.constructError,this);var t=this.tree.retrieveConnections({connected:!1},!0);f.sort(t,Math.random);for(var i=0;i<t.length;i++)for(var n=t[i],s=n.joint,r=0;r<e.length;r++){var o=e[r];if(o.object)for(var a=0;a<o.joints.length;a++){var l=o.joints[a];if(s.canConnect(l))return void this.constructNode(o,this.view).then(function(e){this.makeViewConnection(n,e.connections[a])},this.constructError,this)}else o.load()}},connectNode:function(e){if(e){if(!this.tree)return this.setTree1(e);var t=this.tree.retrieveConnections({connected:!1},!0);f.sort(t,Math.random);e:for(var i=0;i<t.length;i++)for(var n=t[i],s=0;s<e.connections.length;s++){var r=e.connections[s];if(r.canConnect(n)){this.makeViewConnection(n,r);break e}}this.splitScreen&&this.updateConnectionGroups(this.tree,this.view2.tree)}},onkey:function(e){if(e.ctrlKey||e.shiftKey||e.altKey);else if(kbd.down&&kbd.changed)switch(kbd.key){case"ENTER":return void(this.deletePromptTip.visible.value&&this.deleteNode());case"ESC":return void(this.deletePromptTip.visible.value&&this.closeDeletePrompt());case"DEL":return void this.promptDeleteNode(this.view.nodeSelected);case"u":return void(location.hash=this.exportString());case"x":this.debug=!this.debug,this.imagery.materials.subtract.visible=!!this.debug,this.imagery.materials.norcon.visible=!!this.debug,this.updateMarkerVisibility();break;case"r":this.onViewClear();break;case"e":this.preloadAllSamples(),dom.addclass(this.emptyViewMessage,"hidden");break;case"v":return void(this.gui.closed?this.gui.open():this.gui.close())}this.view.onKey(e),this.view2.onKey(e)},replaceNode:function(e,t,i){return e&&t&&e.canBeReplacedBy(t)?this.constructNode(t).then(function(t){return t.replace(e),e.upcon?this.view.setTree(this.view.tree):this.view.setTree(t),i&&this.view.selectNode(t),t},function(e){this.events.emit("onReplaceElement",{status:"rejected",reason:"construct error",error:e})},this):Defer.complete(!1,"bad replacement")},getNodeReplacers:function(e,t){var i=[];if(e)for(var n=0;n<t.length;n++){var s=t[n];e.canBeReplacedBy(s)&&i.push(s)}return i},preloadAllSamples:function(){this.sampler.samples.forEach(f.func("load")),this.view.setPreloader(this.sampler.samples)},rotateNode:function(e){e&&(e.rotate(Math.PI/6),this.view.needsRedraw=!0)},promptDeleteNode:function(e){e&&(this.deletePromptStat=e.pinch(),this.deletePromptStat.removeCount<2?this.deleteNode():(dom.text(this.deletePromptTipText,["Do you want to delete",this.deletePromptStat.removeCount,"nodes?"].join(" ")),this.deletePromptTip.visible.on()))},closeDeletePrompt:function(){this.deletePromptTip.visible.off(),delete this.deletePromptStat},clearTree:function(){this.tree&&(this.deletePromptStat=this.tree.pinchr(),this.deleteNode(),this.absolutelySetMainTree(null))},absolutelySetMainTree:function(e){this.tree=e,this.view.setTree(this.tree),dom.togclass(this.emptyViewMessage,"hidden",!!this.tree)},deleteNode:function(){var e=this.deletePromptStat;e&&(e.removeNode.disconnect(),this.absolutelySetMainTree(e.maxRoot),this.view.selectNode(null),this.closeDeletePrompt(),this.events.emit("onRemoveElement",e))},onresize:function(){var e=this.tiles.element,t=e.offsetWidth,i=e.offsetHeight;this.renderer.setSize(t,i),this.tiles.autoresize(),this.view.resizeRenderTargets(t,i),this.view.resizeShaders(t,i)},updateSplitViewMessagePosition:function(){if(this.splitView){var e=this.splitViewMessage,t=this.splitView,i=e.offsetWidth,n=e.offsetHeight,s=t.split===TileView.VERTICAL_SPLIT?.5:t.position,r=t.split===TileView.HORIZONTAL_SPLIT?.5:t.position,o=t.x+t.w*s-i/2,a=t.y+t.h*r-n/2;e.style.left=o+"px",e.style.top=a+.3*t.h+"px"}},onTilesUpdate:function(){this.hasAvailableConnections||this.updateSplitViewMessagePosition()},onTap:function(e){this.deletePromptTip.visible.value&&(dom.ancestor(e.target,this.deletePromptTip.element)||dom.ancestor(e.target,this.view.markers.element)||this.closeDeletePrompt())},onDragOver:function(e){(this.catchFiles||this.catchSamples)&&(e.dataTransfer.dropEffect="copy",e.preventDefault())},onDrop:function(e){var t=e.dataTransfer;if(t.files&&t.files.length)this.catchFiles&&this.importFile(t.files[0]);else if(this.catchSamples){var i=t.getData("text/sid"),n=f.apick(this.sampler.samples,"id",i);n&&this.constructNode(n,this.view).then(this.connectNode,this.constructError,this)}e.preventDefault()},importFile:function(e){return this.sampler.readFile(e).then(this.onSampleImport,this.onSampleImportFail,this)},onSampleImport:function(e){return this.events.emit("onImportElement",e),e},onSampleImportFail:function(e){console.warn("File import error:",e)},onNodeSelect:function(e,t){var i=this.view.markers;if(t&&t.nodeMarker&&(i.removeMarker(t.nodeMarker),t.nodeMarker.destroy(),t.nodeMarker=null),e&&e.lit&&this.issuedReplace)return this.replaceNode(e,this.issuedReplace,!0),this.litModeClear(),void delete this.issuedReplace;if(e){var n=new UI.Marker({undisposable:!0,deleteNode:e,align:"bottom"});i.addMarker(n),n.visible.on("main"),dom.remclass(n.content,"marker-interactive"),dom.text(n.elemInfo,e.sample.src),dom.addclass(n.elemInfo,"marker-label"),n.bRot=dom.div("marker-action",n.content),n.bDel=dom.div("marker-action",n.content),n.watchEvents.push(new EventHandler(this.rotateNode,this,e).listen("tap",n.bRot),new EventHandler(this.promptDeleteNode,this,e).listen("tap",n.bDel)),n.watchAtlas.push(Atlas.set(n.bRot,"i-rotate"),Atlas.set(n.bDel,"i-delete")),e.sample.link&&(n.bInfo=dom.a(e.sample.link,"marker-action out-02",n.content),n.bInfo.setAttribute("target","_blank"),n.watchAtlas.push(Atlas.set(n.bInfo,"i-info"))),e.nodeMarker=n,kbd.state.SHIFT||this.view.focusOnNode(e)}this.events.emit("onNodeSelect",[e,t])},onConnectionSelect:function(e,t,i){this.connectionParts[t]=i,this.updateConnectionVisibilitySets();var n=this.connectionParts[0],s=this.connectionParts[1];n&&s&&this.makeViewConnection(n,s)},makeViewConnection:function(e,t){this.view.selectConnection(null),this.view2.selectConnection(null),this.view2.setTree(null),t.node.updateSize(),e.node.connect(e.index,t.node,t.index),this.view.setTree(this.tree),e.playConnection(),this.displayFigure(null),this.events.emit("onAddElement",{status:"connected"})},removeSample:function(e){var t=f.apick(this.sampler.samples,"id",e);t&&f.adrop(this.sampler.samples,t)},run:function(){this.makeGUI(),new EventHandler(this.onresize,this).listen("resize",window),new EventHandler(this.onkey,this).listen("keydown",window),new EventHandler(this.onkey,this).listen("keyup",window),new EventHandler(this.onTap,this).listen("tap",window),new EventHandler(this.onDragOver,this).listen("dragover",this.view.element),new EventHandler(this.onDragOver,this).listen("dragover",this.view2.element),new EventHandler(this.onDrop,this).listen("drop",this.view.element),new EventHandler(this.onDrop,this).listen("drop",this.view2.element),this.tiles.events.on("update",this.onTilesUpdate,this),this.view.events.on("connection_select",this.onConnectionSelect,this,[this.view,0]),this.view2.events.on("connection_select",this.onConnectionSelect,this,[this.view2,1]),this.view.events.on("view_clear",this.onViewClear,this),this.view2.events.on("view_clear",this.onViewClear2,this),this.view.events.on("node_select",this.onNodeSelect,this),dom.display(this.canvas,!0),this.onresize(),this.view.onTick(0),this.view2.onTick(0),"function"==typeof bootProgress&&bootProgress(1),this.ready.resolve(!0),this.initFromHash&&this.loadFromHash(),this.timer.play()},loadFromHash:function(){var e=location.hash.slice(1);if(e)try{this.importString(e,!0),location.hash=""}catch(e){console.warn("loadFromHash failed:",e)}},onHash:function(){this.loadFromHash()},onTick:function(e,t){if(kbd.state.t&&this.connectRandomNode(),TWEEN.update(),this.view.onTick(t),this.view2.onTick(t),this.view.nodeSelected){var i=this.view.nodeSelected.nodeMarker;i.point.world.setFromMatrixPosition(this.view.nodeSelected.objectCenter.matrixWorld),this.view.projector.updatePoint(i.point),i.update()}if(this.deletePromptStat){var n=this.deletePromptStat.removeNode,s=this.deletePromptTip.point;s.world.setFromMatrixPosition(n.objectCenter.matrixWorld),this.view.projector.updatePoint(s),this.deletePromptTip.move(Math.round(s.screen.x),Math.round(s.screen.y))}}});