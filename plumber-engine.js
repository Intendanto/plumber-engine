function EventEmitter(){this.lists={},this.queue={},this.links={}}function EventHandler(e,t,i,n){if("function"!=typeof e)throw Error("EventHandler expects function as 1st argument");this.func=e,this.scope=t,this.data=null==i?[]:[].concat(i),this.once=n,this.listens=[]}function Observable(e,t,i,n,s){this.id=++Observable.count,this.value=e,this.targets={},this.sources={},this.set(t,i,n,s)}function Timer(e,t){this.func=e,this.scope=t}function Defer(){this.set.apply(this,arguments),this.pending=!0}function Gate(e,t){this.inputs={},this.method=e,this.value=t,this.events=new EventEmitter}function Loader(){this.reset(),this.data={}}function Drag(e){this.element=e,this.events=new EventEmitter,this.offset={x:0,y:0},this.origin={x:0,y:0},this.point={x:0,y:0},this.mouse={x:0,y:0},this.begin={x:0,y:0},this.delta={x:0,y:0},this.scale={x:1,y:1},this.moves=0,this.min={x:-(1/0),y:-(1/0)},this.max={x:1/0,y:1/0},this.bind("mousedown",this.element),this.bind("touchstart",this.element)}function Momentum(){this.speed={x:0,y:0,z:0},this.point={x:0,y:0,z:0},this.delta={x:0,y:0,z:0},this.target={x:0,y:0,z:0},this.points=[]}function FileImport(){this.element=dom.div("file-import hand"),this.events=new EventEmitter,this.input=dom.input("file"),this.input.setAttribute("accept",".json"),Atlas.set(this.element,"i-file-load","absmid"),dom.on("change",this.input,f.binds(this.onInputChange,this)),dom.on("tap",this.element,f.binds(this.input.click,this.input))}function TileView(){this.events=new EventEmitter,this.element=dom.div("tile-view"),this.econtent=dom.div("tile-content",this.element),this.ehelpers=dom.div("tile-helpers",this.element),this.setClients(),this.setLayout()}function PointProjector(e){this.camera=e,this.points=[],this.matrix=new THREE.Matrix4,this.inverse=new THREE.Matrix4,this.viewport=new THREE.Vector3}function Imagery(){this.get=new Loader,this.list={},this.submaterialIndex=0,this.slotIndex=0,this.products={},this.productsList=[],this.obvMaterialsList=new Observable([]),this.obvProductsLoaded=new Observable(!1),this.pixel=this.makePixel("white"),this.bump=this.makePixel("black"),this.normal=this.makePixel("rgb(127, 127, 255)"),this.buffer=document.createElement("canvas"),this.btx=this.buffer.getContext("2d");var e=this.pixel.image;this.skybox=new THREE.CubeTexture([e,e,e,e,e,e]),this.skybox.needsUpdate=!0;({stripe:this.makePattern(2/3,64,64,this.drawStripe,"#dadada",6,"#666"),stripe2:this.makePattern(1,64,64,this.drawStripe,"#dadada",6,"#666",!0),noise:this.makePattern(1/9,1024,1024,this.drawCloud,.2,.4),checker:this.makePattern(1/3,64,64,this.drawChecker,"#aaa","#333"),checker2:this.makePattern(2/3,64,64,this.drawChecker,"#777","#666")});this.baseMaps={norcon:{color:16777215},subtract:{color:16726391},wireframe:{},normal:{},void:{}},this.materials={},this.usedProducts={};for(var t in this.baseMaps)this.addMaterial(t),this.setMaterial(t,null);this.materials.flume=this.materials.pipe=this.materials.drain,this.materials.flat=this.materials.floor,this.materials.slope=this.materials.roof,this.materials.Material__26=this.materials.black,this.materials.wire_000000000=this.materials.gold}function Sampler(){this.samples={},this.keyIndex=[]}function Sample(e,t){for(var i in e)this[i]=e[i];this.progress=0,this.parent=t,this.joints=[],this.box=new THREE.Box3,this.size=new THREE.Vector3,this.sphere=new THREE.Sphere,this.id||(this.id=f.range(10).map(f.randchar).join("")),this.src&&(this.name=this.src.replace(/\.[^\.]*$/,"").split("/").pop()),this.object?this.configure(this.object):this.src&&(this.format=this.src.replace(/^.*\.([^.]+)$/,"$1").toLowerCase())}function View3(e){for(var t in e)this[t]=e[t];this.element=dom.div("view-3",this.eroot),this.events=new EventEmitter,this.scene=new THREE.Scene,this.ambLight=new THREE.AmbientLight(16777215,.2),this.dirLight=new THREE.DirectionalLight(16777215,1),this.camera=new THREE.PerspectiveCamera,this.orbit=new THREE.OrbitControls(this.camera,this.element),this.raycaster=new THREE.Raycaster,this.root=new THREE.Object3D,this.grid=new THREE.Object3D,this.scene.autoUpdate=!1,this.mouse=new THREE.Vector2,this.mouse2=new THREE.Vector3,this.mouse3=new THREE.Vector3,this.mouse.set(1/0,1/0),this.renderer||(this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.autoClear=!1,this.renderer.clear(),dom.append(this.element,this.renderer.domElement)),this.srScene=new THREE.Scene,this.srPlane=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2)),this.srCamera=new THREE.OrthographicCamera(-1,1,1,-1,-1,1),this.srCamera.updateProjectionMatrix(),this.srScene.add(this.srPlane),this.smCopy=this.makeShader(THREE.CopyShader),this.smFill=this.makeShader(THREE.FillShader),this.smOverlay=this.makeShader(THREE.OverlayShader),this.smHBlur=this.makeShader(THREE.HorizontalBlurShader),this.smVBlur=this.makeShader(THREE.VerticalBlurShader),this.smFXAA=this.makeShader(THREE.FXAAShader),this.clearButton=dom.div("view-clear out-02 hand",this.element),Atlas.set(this.clearButton,"i-cross","absmid"),dom.on("tap",this.clearButton,this.events.will("view_clear")),this.transform=new THREE.TransformControls(this.camera,this.element),this.transform.addEventListener("change",f.binds(this.onTransformControlsChange,this)),this.projector=new PointProjector(this.camera),this.markers=new UI.MarkerSystem({eroot:this.element,projector:this.projector}),this.markers.events.on("marker_tap",this.onMarkerTap,this),this.wireMaterial=new THREE.MeshBasicMaterial({wireframe:!0,color:0}),this.lastcam=new THREE.Matrix4,this.cameraTween=new TWEEN.Tween({x:0,y:0,z:0}).easing(TWEEN.Easing.Cubic.Out),this.orbitTween=new TWEEN.Tween({x:0,y:0,z:0}).easing(TWEEN.Easing.Cubic.Out),this.makeGridSystem(),this.makePreloader(),this.dirLight.position.set(-100,100,100),this.dirLight.target.position.set(0,0,0),this.camera.position.set(1,1,1),this.treeCenter=new THREE.Vector3,this.treeSize=1,this.focusOnTree(0),this.root.add(this.ambLight),this.root.add(this.dirLight),this.scene.add(this.root),this.scene.add(this.grid),this.scene.add(this.transform),dom.on("tap",this.element,this),dom.on("mousemove",this.element,this),dom.on("mouseout",this.element,this)}f={},f.nop=function(){},f.identity=function(e){return e},f.sum=function(e,t){return e+t},f.sub=function(e,t){return e-t},f.nsort=function(e,t){var i=t?-1:1;return function(t,n){return null==t||null==n?-1:i*(t[e]-n[e])}},f.zerosort=function(e,t){return e&&t?e[0]-t[0]:0},f.sort=function(e,t,i){for(var n=e.length,s=[],r=0;r<n;r++){var o=e[r];s.push([t.call(i,o),o])}s.sort(f.zerosort);for(var r=0;r<n;r++)e[r]=s[r][1];return e},f.max=function(e){return Math.max.apply(0,e)},f.min=function(e){return Math.min.apply(0,e)},f.amap=function(e,t,i,n,s,r){if(e&&e.length&&"function"==typeof t)for(var o=0,a=[];o<e.length;o++)a.push(t.call(i,e[o],n,s,r));return a},f.atog=function(e,t,i){if(e){for(var n=e.length-1;n>=0;n--)if(e[n]===t){if(i)return;e.splice(n,1)}i&&e.push(t)}},f.apick=function(e,t,i,n){if(e)for(var s,r=0,o=e.length;r<o;r++)if(s=e[r],(s&&s[t]===i)^n)return s},f.apickf=function(e,t,i,n){if(e)for(var s,r=0,o=e.length;r<o;r++)if(s=e[r],t.call(i,s)^n)return s},f.afind=function(e,t,i,n){if(e)for(var s,r=0,o=e.length,a=[];r<o;r++)s=e[r],(s&&s[t]===i)^n&&a.push(s);return a},f.afindf=function(e,t,i,n){if(e)for(var s,r=0,o=e.length,a=[];r<o;r++)s=e[r],t.call(i,s)^n&&a.push(s);return a},f.adiff=function(e,t){for(var i={prev:t||[],next:e||[],rem:[],remi:[],remc:0,add:[],addi:[],addc:0},n=i.prev.length-1;n>=0;n--){var s=i.prev[n],r=i.next.indexOf(s);r===-1&&(i.rem.push(s),i.remi.push(n),i.remc++)}for(var r=0;r<i.next.length;r++){var s=i.next[r],n=i.prev.indexOf(s);n===-1&&(i.add.push(s),i.addi.push(r),i.addc++)}return i},f.adrop=function(e,t){var i=e.indexOf(t);return~i&&e.splice(i,1),e},f.aflat=function(e){return[].concat.apply([],e)},f.seq=function(e,t){return e.length===t.length&&0===f.snot(e,t).length},f.sor=function(){for(var e=[],t=0;t<arguments.length;t++){var i=arguments[t];if(i)for(var n=0;n<i.length;n++){var s=i[n];e.indexOf(s)===-1&&e.push(s)}}return e},f.sand=function(e,t){if(!e||!t)return[];for(var i=[],n=0,s=e.length;n<s;n++){var r=e[n];t.indexOf(r)!==-1&&i.indexOf(r)===-1&&i.push(r)}return i},f.sxor=function(e,t){if(!e||!t)return e?e:t?t:[];for(var i=[].concat(e,t),n=i.length-1;n>=0;n--){var s=i.indexOf(i[n]);n!==s&&(i.splice(n,1),i.splice(s,1),n--)}return i},f.snot=function(e,t){e=e||[],t=t||[];for(var i=[],n=0,s=e.length;n<s;n++){var r=e[n];t.indexOf(r)===-1&&i.indexOf(r)===-1&&i.push(r)}return i},f.uniqp=function(e,t){return function(i,n,s){return!e^s.indexOf(i)===(t?s.lastIndexOf(i):n)}},f.uniq=function(e,t,i){return i.indexOf(e)===t},f.uniqi=function(e,t,i){return i.indexOf(e)!==t},f.uniqm=function(e,t,i){return i.indexOf(e)===i.lastIndexOf(e)},f.uniqim=function(e,t,i){return i.indexOf(e)!==i.lastIndexOf(e)},f.clamp=function(e,t,i){return e<t?t:e>i?i:e},f.rand=function(e){return Math.floor(Math.random()*(+e||1))},f.any=function(e){return e&&e[f.rand(e.length)]},f.charmap="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",f.randchar=function(){return f.any(f.charmap)},f.exp=function(e){var t=0,i=Math.abs(e);if(0===i||!isFinite(i))return i;if(i<1)for(;Math.pow(10,t)>i;)t--;else for(;Math.pow(10,t+1)<=i;)t++;return t},f.hround=function(e){return Math.round(100*e)/100},f.pround=function(e,t){var i=+t||0;if(i<0){var n=Math.pow(10,-i);return Math.round(e/n)*n}var n=Math.pow(10,i);return Math.round(e*n)/n},f.mround=function(e,t){return f.pround(e,t-f.exp(e))},f.xrad=Math.PI/180,f.torad=function(e){return e*f.xrad},f.xdeg=180/Math.PI,f.todeg=function(e){return e*f.xdeg},f.radist=function(e){return Math.abs(e)>Math.PI?e-2*Math.PI*Math.ceil(Math.floor(Math.abs(e)/Math.PI)/2)*(e<0?-1:1):e},f.prop=function(e){var t=arguments;return function(e){for(var i=0;e&&i<t.length;i++)e=e[t[i]];return e}},f.pset=function(e,t){return function(i){i[e]=t}},f.func=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);return function(i){return i[e]&&i[e].apply&&i[e].apply(i,t)}},f.range=function(e){e=+e||0;for(var t=[],i=0;i<e;i++)t.push(i);return t},f.rangep=function(e,t,i){e=isNaN(e)?0:+e,t=null==t?0:t,i=null==i?"number"==typeof t?1:0:i;for(var n=[],s=0;s<e;s++)n.push(i?s*i+t:t);return n},f.qsenc=function(e,t){t||(t="&=");var i=[];for(var n in e){var s=encodeURIComponent(n),r=e[n];if(null!=r)if(r instanceof Array)for(var o=0;o<r.length;o++)i.push(s+t[1]+encodeURIComponent(r[o]));else i.push(s+t[1]+encodeURIComponent(r))}return i.join(t[0])},f.qsdec=function(e,t){t||(t="&=");for(var i={},n=e.split(t[0]),s=0;s<n.length;s++){var r=n[s].split(t[1]),o=decodeURIComponent(r[0]),a=decodeURIComponent(r[1]);if(o in i){var l=i[o];l instanceof Array?l.push(a):i[o]=[l,a]}else i[o]=a}return i},f.follow=function(e,t){for(var i=[];e;e=e[t])i.push(e);return i},f.copy=function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},f.copylist=function(e,t,i){for(var n in t)i.indexOf(n)!==-1&&Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},f.merge=function(){for(var e={},t=0;t<arguments.length;t++)f.copy(e,arguments[t]);return e},f.throttle=function(e,t){var i=0;return function(){var n=new Date;if(n-i>e)return i=n,t.apply(this,arguments)}},f.postpone=function(e,t){var i;return function(){clearTimeout(i),i=setTimeout(t,e)}},f.implode=function(e,t,i,n){return i||(i=/#\{(\w+)\}/g),e.replace(i,function(e,i){return i in t?t[i]:n?e:""})},f.nzformat=function(e,t){if(isNaN(e))return e+"";var i=Math.abs(e),n=t-Math.max(0,f.exp(i)),s=n>1?Array(n).join("0"):"";return(e<i?"-":"")+s+i},f.nformat=function(e,t,i){var n=Math.abs(e),s=e<n,r=isNaN(e)?2:f.exp(n),o=i?"0":" ",a=t-Math.max(0,r)-s-1,l=a>1?Array(a).join(o):"",h=i&&s?"-":o,c=!i&&s?e:n;return h+l+c},f.dformat=function(e,t){var i={Y:"getFullYear",M:"getMonth",D:"getDate",h:"getHours",i:"getMinutes",s:"getSeconds"},n={M:1};return t.replace(/([YMDhis])(\1+)?/g,function(t,s){return f.nzformat(e[i[s]]()+(n[s]||0),t.length)})},f.rgb=function(e){return"rgb("+[255*e[0]|0,255*e[1]|0,255*e[2]|0]+")"},f.rgba=function(e,t){return"rgba("+[255*e[0]|0,255*e[1]|0,255*e[2]|0].concat(isNaN(t)?1:+t)+")"},f.rcolor=function(e){return"rgba("+[255,255,255].map(f.rand).concat(+e||1)+")"},f.softcolor=function(e){var t=2*Math.PI,i=t*e;return[Math.cos(i)/2+.5,Math.cos(i+2/3*t)/2+.5,Math.cos(i+1/3*t)/2+.5]},f.mitm=function(e,t,i,n){var s=e[t],r="function"==typeof s;e[t]=function(){var e=i.call(this,t,arguments,s);return n?e:r?s.apply(this,arguments):s}},f.inspect=function(e,t){for(var i in e)"function"==typeof e[i]&&f.mitm(e,i,t)},f.binds=function(e,t){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){return e.apply(t,arguments)}},f.binda=function(e,t,i){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){return e.apply(t,i)}},f.bindr=function(e,t,i,n){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){for(var s=[],r=0,o=0;o<i.length;o++)s.push(i[o]===n?arguments[r++]:i[o]);for(;r<arguments.length;)s.push(arguments[r++]);return e.apply(t,s)}},f.unit=function(parent,object){arguments.length<2&&(object=parent,parent=null);var proto=parent?f.copy(Object.create(parent.prototype),object):object,Unit=eval("(function "+(proto.unitName||"Unit")+'() {if(typeof this.init === "function") this.init.apply(this, arguments)})');return Unit.New=function(){var e=Object.create(Unit.prototype);return Unit.apply(e,arguments),e},Unit.prototype=proto,proto.protochain=proto.protochain?proto.protochain.concat(proto):[proto],proto.constructor=Unit,Unit},!function(){if(Date.now||(Date.now=function(){return(new Date).getTime()}),window.performance||(window.performance={}),!window.performance.now){var e=window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:Date.now();window.performance.now=function(){return Date.now()-e}}}(),!function(){function e(e){1===e.which&&(r=e)}function t(e){s(r,e,e,!1),r=null}function i(e){o=e.changedTouches[0]}function n(e){s(o,e.changedTouches[0],e,!0),o=null}function s(e,t,i,n){if(e){var s=t.pageX-e.pageX,r=t.pageY-e.pageY,o=n?64:25;if(!(s*s+r*r>o)){var l=window.performance.now();if(!(l-a<50&&i.isTrusted)){a=l;var h=new MouseEvent("tap",{bubbles:!0,cancelable:!0,pageX:t.pageX,pageY:t.pageY,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,altKey:i.altKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,metaKey:i.metaKey,view:i.view});h.touch=n,i.target.dispatchEvent(h)}}}}var r,o,a;try{new MouseEvent("tap")}catch(e){window.MouseEvent=function(e,t){var i=document.createEvent("MouseEvents");return i.initMouseEvent(e,t.bubbles,t.cancelable,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),i}}document.addEventListener("touchstart",i,!0),document.addEventListener("touchend",n,!0),document.addEventListener("mousedown",e,!0),document.addEventListener("mouseup",t,!0)}(),Function.prototype.bind||(Function.prototype.bind=function(e){var t=Array.prototype.slice.call(arguments,1),i=this;return function(){var n=Array.prototype.slice.call(arguments);return i.apply(e,t.concat(n))}}),window.requestAnimationFrame=window.requestAnimationFrame||window.ORequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.OCancelAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout,dom={},dom.one=function(e,t){return(t||document).querySelector(e)},dom.all=function(e,t){return[].slice.call((t||document).querySelectorAll(e))},dom.elem=function(e,t,i){var n=document.createElement(e);return t&&(n.className=t),i&&i.appendChild(n),n},dom.span=function(e,t){return dom.elem("span",e,t)},dom.div=function(e,t){return dom.elem("div",e,t)},dom.input=function(e,t,i){var n=dom.elem("input",t,i);return n.setAttribute("type",e),n},dom.option=function(e,t,i){var n=dom.elem("option",null,i);return dom.text(n,t),n.value=e,n},dom.img=function(e,t,i){var n=dom.elem("img",t,i);return e&&(n.src=e),n},dom.a=function(e,t,i){var n=dom.elem("a",t,i);return e&&(n.href=e),n},dom.append=function(e,t){if(e instanceof Node)for(var i=1;i<arguments.length;i++){var t=arguments[i];t instanceof Node&&e.appendChild(t)}return e},dom.prepend=function(e,t){e instanceof Node&&t instanceof Node&&e.insertBefore(t,e.firstChild)},dom.insert=function(e,t,i){e instanceof Node&&t instanceof Node&&e.insertBefore(t,i instanceof Node?i:null)},dom.remove=function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t&&t.parentNode&&t.parentNode.removeChild(t)}},dom.empty=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},dom.children=function(){function e(e){return e.nodeType===Node.ELEMENT_NODE}var t=Array.prototype.slice;return function(i){return t.call(i.childNodes).filter(e)}}(),dom.ancestor=function(e,t){for(;e;){if(e===t)return!0;e=e.parentNode}},dom.onceover=function(e,t){return!dom.ancestor(e.relatedTarget,t)&&dom.ancestor(e.target,t)},dom.onceout=function(e,t){return!dom.ancestor(e.relatedTarget,t)},dom.on=function(e,t,i,n){t.addEventListener(e,i,!!n)},dom.off=function(e,t,i,n){t.removeEventListener(e,i,!!n)},dom.pos=function(e,t,i){e&&(null!=t&&(e.style.left="number"==typeof t?Math.round(t)+"px":t),null!=i&&(e.style.top="number"==typeof i?Math.round(i)+"px":i))},dom.size=function(e,t,i){e&&(null!=t&&(e.style.width="number"==typeof t?Math.round(t)+"px":t),null!=t&&(e.style.height="number"==typeof i?Math.round(i)+"px":i))},dom.style=function(e,t){f.copy(e.style,t)},dom.xstyle=function(e,t,i){var n=e.style;n["-webkit-"+t]=i,n["-moz-"+t]=i,n["-ms-"+t]=i,n["-o-"+t]=i,n[t]=i},dom.html=function(e,t){e.innerHTML=t},dom.text=function(e,t){e.textContent=t},dom.display=function(e,t,i){e.style.display=t?null!=i?i:"block":"none"},dom.visible=function(e,t){e.style.visibility=t?"visible":"hidden"},dom.respace=/\s+/,dom.addclass=function(e,t){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),n=t.split(dom.respace).filter(Boolean),s=f.sor(i,n);f.snot(s,i).length&&(e.className=s.join(" "))}},dom.remclass=function(e,t){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),n=t.split(dom.respace).filter(Boolean),s=f.snot(i,n);f.snot(i,s).length&&(e.className=s.join(" "))}},dom.hasclass=function(e,t,i){if(e&&t){var n=e.className.split(dom.respace).filter(Boolean),s=t.split(dom.respace).filter(Boolean),r=f.sand(n,s).length;return i?r:r===s.length}},dom.togclass=function(e,t,i){e&&t&&(arguments.length<3&&(i=!dom.hasclass(e,t)),(i?dom.addclass:dom.remclass)(e,t))},dom.setclass=function(e,t){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),n=i.slice();for(var s in t)f.atog(n,s,!!t[s]);f.sxor(i,n).length&&(e.className=n.join(" "))}},dom.offset=function(e,t,i){for(var n=0,s=0;e&&e!==t;e=e.offsetParent)n+=e.offsetLeft||0,s+=e.offsetTop||0,i&&(n-=e.scrollLeft||0,s-=e.scrollTop||0);return{x:n,y:s}},dom.out=function(e){var t=dom.div(null,document.body),i=dom.elem("textarea",null,document.body);dom.style(t,{top:0,left:0,width:"100%",height:"100%",position:"absolute",zIndex:9e3}),dom.style(i,{left:.1*window.innerWidth+"px",top:.1*window.innerHeight+"px",width:.8*window.innerWidth+"px",height:.8*window.innerHeight+"px",position:"absolute",zIndex:9001,whiteSpace:"nowrap",font:"11px monospace"}),dom.text(i,e),dom.on("click",t,function(){dom.remove(i,t)}),i.focus()},dom.ready=function(e){function t(){document.removeEventListener("DOMContentLoaded",t),window.removeEventListener("load",t),e()}"complete"===document.readyState?e():(document.addEventListener("DOMContentLoaded",t),window.addEventListener("load",t))},kbd={name:{L_ARR:37,U_ARR:38,R_ARR:39,D_ARR:40,SHIFT:16,CTRL:17,ALT:18,CAPS:20,ESC:27,SPACE:32,DEL:46,ENTER:13,TAB:9,BKSP:8,"`":192,"-":189,"=":187,"[":219,"]":221,"\\":220,";":186,"'":222,",":188,".":190,"/":191},map:[],state:{},init:function(){kbd.setmap(),kbd.reset(),window.addEventListener("keydown",kbd.onkeydown,!0),window.addEventListener("keyup",kbd.onkeyup,!0)},setmap:function(){for(var e=48;e<=57;e++)kbd.map[e]=String.fromCharCode(e);for(var e=65;e<=90;e++)kbd.map[e]=String.fromCharCode(e).toLowerCase();for(var t in kbd.name)kbd.map[kbd.name[t]]=t},reset:function(){for(var e=0;e<255;e++)kbd.state[kbd.map[e]]=0},onkeydown:function(e){kbd.setkey(e,1)},onkeyup:function(e){kbd.setkey(e,0)},setkey:function(e,t){kbd.event=e,kbd.down=t,kbd.key=kbd.map[e.keyCode],kbd.changed=kbd.state[kbd.key]!==kbd.down,kbd.state[kbd.key]=kbd.down,kbd.state.SHIFT=+e.shiftKey,kbd.state.CTRL=+e.ctrlKey,kbd.state.ALT=+e.altKey;var i=[];kbd.state.CTRL&&i.push("CTRL"),kbd.state.ALT&&i.push("ALT"),kbd.state.SHIFT&&i.push("SHIFT"),"CTRL"!==kbd.key&&"ALT"!==kbd.key&&"SHIFT"!==kbd.key&&i.push(kbd.key),kbd.seq=i.join("+")}},kbd.init();var perf={precision:4,values:{},time:function(){return window.performance&&window.performance.now?window.performance.now():Date.now?Date.now():(new Date).getTime()},start:function(e){var t=perf.values[e];t||(t=perf.values[e]={totalTime:0,totalCycles:0,totalBest:1/0,totalWorst:-(1/0),localTime:0,localCycles:0,localBest:1/0,localWorst:-(1/0),lastTime:0,startTime:0}),t.startTime=perf.time()},end:function(e,t){var i=perf.values[e];i&&(i.lastTime=perf.time()-i.startTime,i.startTime=0,i.totalCycles++,i.localCycles++,i.totalBest=Math.min(i.totalBest,i.lastTime),i.totalWorst=Math.max(i.totalWorst,i.lastTime),i.localBest=Math.min(i.localBest,i.lastTime),i.localWorst=Math.max(i.localWorst,i.lastTime),i.totalTime+=i.lastTime,i.localTime+=i.lastTime,i.localCycles>=t&&perf.show(e))},flushLocal:function(e){var t=perf.values[e];t&&(t.localTime=0,t.localCycles=0,t.localBest=1/0,t.localWorst=-(1/0))},show:function(e,t){var i=perf.values[e];return i?(console.log("perf",e+":",f.mround(i.localTime/i.localCycles,perf.precision),"avg,",f.mround(i.localBest,perf.precision),"best,",f.mround(i.localWorst,perf.precision),"worst,",f.mround(i.localTime,perf.precision),"ms,",i.localCycles,"cycles,",i.totalCycles,"total cycles,",f.mround(i.totalTime/i.totalCycles,perf.precision),"total avg"),void(t||perf.flushLocal(e))):console.log("perf: no",e)},monitor:function(e,t){setInterval(perf.show,t||1e3,e)}},TWEEN={tweens:[],getAll:function(){return TWEEN.tweens},removeAll:function(){for(var e=TWEEN.tweens.length-1;e>=0;e--)TWEEN.tweens[e].drop=!0},add:function(e){e.drop=!1,TWEEN.tweens.indexOf(e)===-1&&TWEEN.tweens.push(e)},remove:function(e){e.playing=!1,e.drop=!0},loop:function(){TWEEN.update(),TWEEN.timer=requestAnimationFrame(TWEEN.loop)},loopEnd:function(){cancelAnimationFrame(TWEEN.timer)},update:function(e){var t=TWEEN.tweens.length;if(!t)return!1;e=isNaN(e)?window.performance.now():+e;for(var i=t-1;i>=0;i--){var n=TWEEN.tweens[i];!n.drop&&n.update(e)||TWEEN.tweens.splice(i,1)}return!0}};TWEEN.Tween=function(e){this.source={},this.target={},this.delta={},this.durationTime=1e3,this.delayTime=0,this.startTime=null,this.repeatTimes=0,this.enableYoyo=!1,this.reversed=!1,this.easingFunction=TWEEN.Easing.Linear.None,this.interpolationFunction=TWEEN.Interpolation.Linear,this.chainedTweens=[],this.onStartCallbackFired=!1,this.onStartCallback=null,this.onStartScope=null,this.onUpdateCallback=null,this.onUpdateScope=null,this.onCompleteCallback=null,this.onCompleteScope=null,this.onStopCallback=null,this.onStopScope=null,this.playing=!1,e&&this.setSource(e)},TWEEN.Tween.prototype={setSource:function(e){return this.source=e,this},setTarget:function(e){return this.target=e,this},duration:function(e){return this.durationTime=e,this},from:function(e){for(var t in e)this.source[t]=e[t];return this},to:function(e,t){return null!=t&&(this.durationTime=t),this.setTarget(e),this},delay:function(e){return this.delayTime=e,this},repeat:function(e){return this.repeatTimes=e,this},yoyo:function(e){return this.enableYoyo=e,this},easing:function(e){return this.easingFunction=e,this},interpolation:function(e){return this.interpolationFunction=e,this},chain:function(){return this.chainedTweens=arguments,this},onStart:function(e,t){return this.onStartCallback=e,this.onStartScope=t,this},onUpdate:function(e,t){return this.onUpdateCallback=e,this.onUpdateScope=t,this},onComplete:function(e,t){return this.onCompleteCallback=e,this.onCompleteScope=t,this},onStop:function(e,t){return this.onStopCallback=e,this.onStopScope=t,this},stop:function(){return TWEEN.remove(this),this.debug&&console.trace(this.debug,"stop"),null!==this.onStopCallback&&this.onStopCallback.call(this.onStopScope,this.source),this.stopChainedTweens(),this},stopChainedTweens:function(){for(var e=this.chainedTweens.length-1;e>=0;e--)this.chainedTweens[e].stop()},updateSource:function(){this.valuesSource={};for(var e in this.source){var t=this.source[e],i=parseFloat(t,10);isFinite(i)&&(this.valuesSource[e]=i)}return this},updateTarget:function(){this.valuesRelative={},this.valuesTarget={};for(var e in this.target)if(e in this.valuesSource!=!1){var t=this.target[e],i=this.valuesSource[e];if(t instanceof Array)t.length&&(this.valuesTarget[e]=[i].concat(t));else if("string"==typeof t){var n=parseFloat(t,10);isFinite(n)&&(this.valuesRelative[e]=n,this.valuesTarget[e]=i+n)}else"number"==typeof t&&isFinite(t)&&(this.valuesTarget[e]=t)}return this},start:function(e){TWEEN.add(this),this.onStartCallbackFired=!1,this.ended=!1,this.startTime=isNaN(e)?window.performance.now():+e,this.startTime+=this.delayTime,this.updateSource(),this.updateTarget();for(var t in this.valuesTarget)this.delta[t]=this.valuesSource[t];return this.debug&&console.trace(this.debug,"start","\n\tsource:",this.valuesSource,"\n\ttarget:",this.valuesTarget),this},update:function(e){if(this.ended)return this.ended=!1,this.playing=!1,this.debug&&console.log(this.debug,"ended"),!1;if(e<this.startTime)return!0;this.onStartCallbackFired===!1&&(this.onStartCallbackFired=!0,this.playing=!0,null!==this.onStartCallback&&this.onStartCallback.call(this.onStartScope,this.source),this.debug&&console.log(this.debug,"playing"));var t=(e-this.startTime)/this.durationTime;t=t>1?1:t;var i=this.easingFunction(t);for(var n in this.valuesTarget){var s,r=this.valuesTarget[n],o=this.valuesSource[n];s=r instanceof Array?this.interpolationFunction(r,i):o+(r-o)*i,this.delta[n]=s-this.source[n],this.source[n]=s}if(this.debug&&console.log(this.debug,"update","\n\tvalues:",this.source,"\n\tdetta:",this.delta),null!==this.onUpdateCallback&&this.onUpdateCallback.call(this.onUpdateScope,i,this.source),1===t)if(this.repeatTimes>0){this.repeatTimes--;for(var n in this.valuesSource){var o=this.valuesSource[n],r=this.valuesTarget[n];n in this.valuesRelative&&(o+=this.valuesRelative[n]),this.enableYoyo&&(this.valuesTarget[n]=o,o=r),this.valuesSource[n]=o}this.enableYoyo&&(this.reversed=!this.reversed),this.startTime=e+this.delayTime}else{this.ended=!0,null!==this.onCompleteCallback&&this.onCompleteCallback.call(this.onCompleteScope,this.source);for(var a=this.chainedTweens.length-1;a>=0;a--)this.chainedTweens[a].start(this.startTime+this.durationTime)}return!0}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)))},Out:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/n)+1)},InOut:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=n/4):t=n*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?-.5*(i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)):i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*.5+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?.5*(e*e*((t+1)*e-t)):.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,s=Math.floor(n),r=TWEEN.Interpolation.Utils.Linear;return t<0?r(e[0],e[1],n):t>1?r(e[i],e[i-1],i-n):r(e[s],e[s+1>i?i:s+1],n-s)},Bezier:function(e,t){for(var i=0,n=e.length-1,s=Math.pow,r=TWEEN.Interpolation.Utils.Bernstein,o=0;o<=n;o++)i+=s(1-t,n-o)*s(t,o)*e[o]*r(n,o);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,s=Math.floor(n),r=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(s=Math.floor(n=i*(1+t))),r(e[(s-1+i)%i],e[s],e[(s+1)%i],e[(s+2)%i],n-s)):t<0?e[0]-(r(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(r(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):r(e[s?s-1:0],e[s],e[i<s+1?i:s+1],e[i<s+2?i:s+2],n-s)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=TWEEN.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i=1;if(e[t])return e[t];for(var n=t;n>1;n--)i*=n;return e[t]=i,i}}(),CatmullRom:function(e,t,i,n,s){var r=.5*(i-e),o=.5*(n-t),a=s*s,l=s*a;return(2*t-2*i+r+o)*l+(-3*t+3*i-2*r-o)*a+r*s+t}}};var dat=dat||{};dat.gui=dat.gui||{},dat.utils=dat.utils||{},dat.controllers=dat.controllers||{},dat.dom=dat.dom||{},dat.color=dat.color||{},dat.utils.css=function(){return{load:function(e,t){t=t||document;var i=t.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,t.getElementsByTagName("head")[0].appendChild(i)},inject:function(e,t){t=t||document;var i=document.createElement("style");i.type="text/css",i.innerHTML=e,t.getElementsByTagName("head")[0].appendChild(i)}}}(),dat.utils.common=function(){var e=Array.prototype.forEach,t=Array.prototype.slice;return{BREAK:{},extend:function(e){return this.each(t.call(arguments,1),function(t){for(var i in t)this.isUndefined(t[i])||(e[i]=t[i])},this),e},defaults:function(e){return this.each(t.call(arguments,1),function(t){for(var i in t)this.isUndefined(e[i])&&(e[i]=t[i])},this),e},compose:function(){var e=t.call(arguments);return function(){for(var i=t.call(arguments),n=e.length-1;0<=n;n--)i=[e[n].apply(this,i)];return i[0]}},each:function(t,i,n){if(t)if(e&&t.forEach&&t.forEach===e)t.forEach(i,n);else if(t.length===t.length+0)for(var s=0,r=t.length;s<r&&!(s in t&&i.call(n,t[s],s)===this.BREAK);s++);else for(s in t)if(i.call(n,t[s],s)===this.BREAK)break},defer:function(e){setTimeout(e,0)},toArray:function(e){return e.toArray?e.toArray():t.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){return e!==e},isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},
isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)}}}(),dat.controllers.Controller=function(e){var t=function(e,t){this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onFinishChange=this.__onChange=void 0};return e.extend(t.prototype,{onChange:function(e){return this.__onChange=e,this},onFinishChange:function(e){return this.__onFinishChange=e,this},setValue:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}}),t}(dat.utils.common),dat.dom.dom=function(e){function t(t){return"0"===t||e.isUndefined(t)?0:(t=t.match(n),e.isNull(t)?0:parseFloat(t[1]))}var i={};e.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(t,n){e.each(t,function(e){i[e]=n})});var n=/(\d+(\.\d+)?)px/,s={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(t,i,n){e.isUndefined(i)&&(i=!0),e.isUndefined(n)&&(n=!0),t.style.position="absolute",i&&(t.style.left=0,t.style.right=0),n&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,n,s,r){s=s||{};var o=i[n];if(!o)throw Error("Event type "+n+" not supported.");var a=document.createEvent(o);switch(o){case"MouseEvents":a.initMouseEvent(n,s.bubbles||!1,s.cancelable||!0,window,s.clickCount||1,0,0,s.x||s.clientX||0,s.y||s.clientY||0,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":o=a.initKeyboardEvent||a.initKeyEvent,e.defaults(s,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),o(n,s.bubbles||!1,s.cancelable,window,s.ctrlKey,s.altKey,s.shiftKey,s.metaKey,s.keyCode,s.charCode);break;default:a.initEvent(n,s.bubbles||!1,s.cancelable||!0)}e.defaults(a,r),t.dispatchEvent(a)},bind:function(e,t,i,n){return e.addEventListener?e.addEventListener(t,i,n||!1):e.attachEvent&&e.attachEvent("on"+t,i),s},unbind:function(e,t,i,n){return e.removeEventListener?e.removeEventListener(t,i,n||!1):e.detachEvent&&e.detachEvent("on"+t,i),s},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var i=e.className.split(/ +/);-1==i.indexOf(t)&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return s},removeClass:function(e,t){if(t){if(void 0!==e.className)if(e.className===t)e.removeAttribute("class");else{var i=e.className.split(/ +/),n=i.indexOf(t);-1!=n&&(i.splice(n,1),e.className=i.join(" "))}}else e.className=void 0;return s},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){return e=getComputedStyle(e),t(e["border-left-width"])+t(e["border-right-width"])+t(e["padding-left"])+t(e["padding-right"])+t(e.width)},getHeight:function(e){return e=getComputedStyle(e),t(e["border-top-width"])+t(e["border-bottom-width"])+t(e["padding-top"])+t(e["padding-bottom"])+t(e.height)},getOffset:function(e){var t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop;while(e=e.offsetParent);return t},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}};return s}(dat.utils.common),dat.controllers.OptionController=function(e,t,i){var n=function(e,s,r){n.superclass.call(this,e,s);var o=this;if(this.__select=document.createElement("select"),i.isArray(r)){var a={};i.each(r,function(e){a[e]=e}),r=a}i.each(r,function(e,t){var i=document.createElement("option");i.innerHTML=t,i.setAttribute("value",e),o.__select.appendChild(i)}),this.updateDisplay(),t.bind(this.__select,"change",function(){o.setValue(this.options[this.selectedIndex].value)}),this.domElement.appendChild(this.__select)};return n.superclass=e,i.extend(n.prototype,e.prototype,{setValue:function(e){return e=n.superclass.prototype.setValue.call(this,e),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),e},updateDisplay:function(){return this.__select.value=this.getValue(),n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.NumberController=function(e,t){function i(e){return e=e.toString(),-1<e.indexOf(".")?e.length-e.indexOf(".")-1:0}var n=function(e,s,r){n.superclass.call(this,e,s),r=r||{},this.__min=r.min,this.__max=r.max,this.__step=r.step,t.isUndefined(this.__step)?this.__impliedStep=0==this.initialValue?1:Math.pow(10,Math.floor(Math.log(Math.abs(this.initialValue))/Math.LN10))/10:this.__impliedStep=this.__step,this.__precision=i(this.__impliedStep)};return n.superclass=e,t.extend(n.prototype,e.prototype,{setValue:function(e){return void 0!==this.__min&&e<this.__min?e=this.__min:void 0!==this.__max&&e>this.__max&&(e=this.__max),void 0!==this.__step&&0!=e%this.__step&&(e=Math.round(e/this.__step)*this.__step),n.superclass.prototype.setValue.call(this,e)},min:function(e){return this.__min=e,this},max:function(e){return this.__max=e,this},step:function(e){return this.__impliedStep=this.__step=e,this.__precision=i(e),this}}),n}(dat.controllers.Controller,dat.utils.common),dat.controllers.NumberControllerBox=function(e,t,i){var n=function(e,s,r){function o(){var e=parseFloat(c.__input.value);i.isNaN(e)||c.setValue(e)}function a(e){var t=h-e.clientY;c.setValue(c.getValue()+t*c.__impliedStep),h=e.clientY}function l(){t.unbind(window,"mousemove",a),t.unbind(window,"mouseup",l)}this.__truncationSuspended=!1,n.superclass.call(this,e,s,r);var h,c=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),t.bind(this.__input,"change",o),t.bind(this.__input,"blur",function(){o(),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}),t.bind(this.__input,"mousedown",function(e){t.bind(window,"mousemove",a),t.bind(window,"mouseup",l),h=e.clientY}),t.bind(this.__input,"keydown",function(e){13===e.keyCode&&(c.__truncationSuspended=!0,this.blur(),c.__truncationSuspended=!1)}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return n.superclass=e,i.extend(n.prototype,e.prototype,{updateDisplay:function(){var e,t=this.__input;if(this.__truncationSuspended)e=this.getValue();else{e=this.getValue();var i=Math.pow(10,this.__precision);e=Math.round(e*i)/i}return t.value=e,n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common),dat.controllers.NumberControllerSlider=function(e,t,i,n,s){function r(e,t,i,n,s){return n+(e-t)/(i-t)*(s-n)}var o=function(e,i,n,s,a){function l(e){e.preventDefault();var i=t.getOffset(c.__background),n=t.getWidth(c.__background);return c.setValue(r(e.clientX,i.left,i.left+n,c.__min,c.__max)),!1}function h(){t.unbind(window,"mousemove",l),t.unbind(window,"mouseup",h),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}o.superclass.call(this,e,i,{min:n,max:s,step:a});var c=this;this.__background=document.createElement("div"),this.__foreground=document.createElement("div"),t.bind(this.__background,"mousedown",function(e){t.bind(window,"mousemove",l),t.bind(window,"mouseup",h),l(e)}),t.addClass(this.__background,"slider"),t.addClass(this.__foreground,"slider-fg"),this.updateDisplay(),this.__background.appendChild(this.__foreground),this.domElement.appendChild(this.__background)};return o.superclass=e,o.useDefaultStyles=function(){i.inject(s)},n.extend(o.prototype,e.prototype,{updateDisplay:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",o.superclass.prototype.updateDisplay.call(this)}}),o}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,"/**\n * dat-gui JavaScript Controller Library\n * http://code.google.com/p/dat-gui\n *\n * Copyright 2011 Data Arts Team, Google Creative Lab\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n */\n\n.slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}"),dat.controllers.FunctionController=function(e,t,i){var n=function(e,i,s){n.superclass.call(this,e,i);var r=this;this.__button=document.createElement("div"),this.__button.innerHTML=void 0===s?"Fire":s,t.bind(this.__button,"click",function(e){return e.preventDefault(),r.fire(),!1}),t.addClass(this.__button,"button"),this.domElement.appendChild(this.__button)};return n.superclass=e,i.extend(n.prototype,e.prototype,{fire:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.BooleanController=function(e,t,i){var n=function(e,i){n.superclass.call(this,e,i);var s=this;this.__prev=this.getValue(),this.__checkbox=document.createElement("input"),this.__checkbox.setAttribute("type","checkbox"),t.bind(this.__checkbox,"change",function(){s.setValue(!s.__prev)},!1),this.domElement.appendChild(this.__checkbox),this.updateDisplay()};return n.superclass=e,i.extend(n.prototype,e.prototype,{setValue:function(e){return e=n.superclass.prototype.setValue.call(this,e),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),e},updateDisplay:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0):this.__checkbox.checked=!1,n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.color.toString=function(e){return function(t){if(1==t.a||e.isUndefined(t.a)){for(t=t.hex.toString(16);6>t.length;)t="0"+t;return"#"+t}return"rgba("+Math.round(t.r)+","+Math.round(t.g)+","+Math.round(t.b)+","+t.a+")"}}(dat.utils.common),dat.color.interpret=function(e,t){var i,n,s=[{litmus:t.isString,conversions:{THREE_CHAR_HEX:{read:function(e){return e=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i),null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString())}},write:e},SIX_CHAR_HEX:{read:function(e){return e=e.match(/^#([A-F0-9]{6})$/i),null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString())}},write:e},CSS_RGB:{read:function(e){return e=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/),null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:e},CSS_RGBA:{read:function(e){return e=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/),null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:e}}},{litmus:t.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:t.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3==e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4==e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:t.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(t.isNumber(e.r)&&t.isNumber(e.g)&&t.isNumber(e.b)&&t.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(t.isNumber(e.r)&&t.isNumber(e.g)&&t.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(t.isNumber(e.h)&&t.isNumber(e.s)&&t.isNumber(e.v)&&t.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(t.isNumber(e.h)&&t.isNumber(e.s)&&t.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}];return function(){n=!1;var e=1<arguments.length?t.toArray(arguments):arguments[0];return t.each(s,function(s){if(s.litmus(e))return t.each(s.conversions,function(s,r){if(i=s.read(e),!1===n&&!1!==i)return n=i,i.conversionName=r,i.conversion=s,t.BREAK}),t.BREAK}),n}}(dat.color.toString,dat.utils.common),dat.GUI=dat.gui.GUI=function(e,t,i,n,s,r,o,a,l,h,c,u,d,p,f){function m(e,t,i,r){if(void 0===t[i])throw Error("Object "+t+' has no property "'+i+'"');r.color?t=new c(t,i):(t=[t,i].concat(r.factoryArgs),t=n.apply(e,t)),r.before instanceof s&&(r.before=r.before.__li),b(e,t),p.addClass(t.domElement,"c"),i=document.createElement("span"),p.addClass(i,"property-name"),i.innerHTML=t.property;var o=document.createElement("div");return o.appendChild(i),o.appendChild(t.domElement),r=v(e,o,r.before),p.addClass(r,H.CLASS_CONTROLLER_ROW),p.addClass(r,typeof t.getValue()),g(e,r,t),e.__controllers.push(t),t}function v(e,t,i){var n=document.createElement("li");return t&&n.appendChild(t),i?e.__ul.insertBefore(n,params.before):e.__ul.appendChild(n),e.onResize(),n}function g(e,t,i){if(i.__li=t,i.__gui=e,f.extend(i,{options:function(t){return 1<arguments.length?(i.remove(),m(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[f.toArray(arguments)]})):f.isArray(t)||f.isObject(t)?(i.remove(),m(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[t]})):void 0},name:function(e){return i.__li.firstElementChild.firstElementChild.innerHTML=e,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof l){var n=new a(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});f.each(["updateDisplay","onChange","onFinishChange"],function(e){var t=i[e],s=n[e];i[e]=n[e]=function(){var e=Array.prototype.slice.call(arguments);return t.apply(i,e),s.apply(n,e)}}),p.addClass(t,"has-slider"),i.domElement.insertBefore(n.domElement,i.domElement.firstElementChild)}else if(i instanceof a){var s=function(t){return f.isNumber(i.__min)&&f.isNumber(i.__max)?(i.remove(),m(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]})):t};i.min=f.compose(s,i.min),i.max=f.compose(s,i.max)}else i instanceof r?(p.bind(t,"click",function(){p.fakeEvent(i.__checkbox,"click")}),p.bind(i.__checkbox,"click",function(e){e.stopPropagation()})):i instanceof o?(p.bind(t,"click",function(){p.fakeEvent(i.__button,"click")}),p.bind(t,"mouseover",function(){p.addClass(i.__button,"hover")}),p.bind(t,"mouseout",function(){p.removeClass(i.__button,"hover")})):i instanceof c&&(p.addClass(t,"color"),i.updateDisplay=f.compose(function(e){return t.style.borderLeftColor=i.__color.toString(),e},i.updateDisplay),i.updateDisplay());i.setValue=f.compose(function(t){return e.getRoot().__preset_select&&i.isModified()&&_(e.getRoot(),!0),t},i.setValue)}function b(e,t){var i=e.getRoot(),n=i.__rememberedObjects.indexOf(t.object);if(-1!=n){var s=i.__rememberedObjectIndecesToControllers[n];if(void 0===s&&(s={},i.__rememberedObjectIndecesToControllers[n]=s),s[t.property]=t,i.load&&i.load.remembered){if(i=i.load.remembered,i[e.preset])i=i[e.preset];else{if(!i.Default)return;i=i.Default}i[n]&&void 0!==i[n][t.property]&&(n=i[n][t.property],t.initialValue=n,t.setValue(n))}}}function y(e){var t=e.__save_row=document.createElement("li");p.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),p.addClass(t,"save-row");var i=document.createElement("span");i.innerHTML="&nbsp;",p.addClass(i,"button gears");var n=document.createElement("span");n.innerHTML="Save",p.addClass(n,"button"),p.addClass(n,"save");var s=document.createElement("span");s.innerHTML="New",p.addClass(s,"button"),p.addClass(s,"save-as");var r=document.createElement("span");r.innerHTML="Revert",p.addClass(r,"button"),p.addClass(r,"revert");var o=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?f.each(e.load.remembered,function(t,i){T(e,i,i==e.preset)}):T(e,"Default",!1),p.bind(o,"change",function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value}),t.appendChild(o),t.appendChild(i),t.appendChild(n),t.appendChild(s),t.appendChild(r),R){var a=function(){l.style.display=e.useLocalStorage?"block":"none"},t=document.getElementById("dg-save-locally"),l=document.getElementById("dg-local-explain");t.style.display="block",t=document.getElementById("dg-local-storage"),"true"===localStorage.getItem(document.location.href+".isLocal")&&t.setAttribute("checked","checked"),a(),p.bind(t,"change",function(){e.useLocalStorage=!e.useLocalStorage,a()})}var h=document.getElementById("dg-new-constructor");p.bind(h,"keydown",function(e){!e.metaKey||67!==e.which&&67!=e.keyCode||M.hide()}),p.bind(i,"click",function(){h.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),M.show(),h.focus(),h.select()}),p.bind(n,"click",function(){e.save()}),p.bind(s,"click",function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)}),p.bind(r,"click",function(){e.revert()})}function w(e){function t(t){return t.preventDefault(),s=t.clientX,p.addClass(e.__closeButton,H.CLASS_DRAG),p.bind(window,"mousemove",i),p.bind(window,"mouseup",n),!1}function i(t){return t.preventDefault(),e.width+=s-t.clientX,e.onResize(),s=t.clientX,!1}function n(){p.removeClass(e.__closeButton,H.CLASS_DRAG),p.unbind(window,"mousemove",i),p.unbind(window,"mouseup",n)}e.__resize_handle=document.createElement("div"),f.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var s;p.bind(e.__resize_handle,"mousedown",t),p.bind(e.__closeButton,"mousedown",t),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function E(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function x(e,t){var i={};return f.each(e.__rememberedObjects,function(n,s){var r={};f.each(e.__rememberedObjectIndecesToControllers[s],function(e,i){r[i]=t?e.initialValue:e.getValue()}),i[s]=r}),i}function T(e,t,i){var n=document.createElement("option");n.innerHTML=t,n.value=t,e.__preset_select.appendChild(n),i&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function _(e,t){var i=e.__preset_select[e.__preset_select.selectedIndex];i.innerHTML=t?i.value+"*":i.value}function k(e){0!=e.length&&u(function(){k(e)}),f.each(e,function(e){e.updateDisplay()})}e.inject(i);var R;try{R="localStorage"in window&&null!==window.localStorage}catch(e){R=!1}var M,C,S=!0,A=!1,N=[],H=function(e){function t(){var e=i.getRoot();e.width+=1,f.defer(function(){--e.width})}var i=this;this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),p.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],e=e||{},e=f.defaults(e,{autoPlace:!0,width:H.DEFAULT_WIDTH}),e=f.defaults(e,{resizable:e.autoPlace,hideable:e.autoPlace}),f.isUndefined(e.load)?e.load={preset:"Default"}:e.preset&&(e.load.preset=e.preset),f.isUndefined(e.parent)&&e.hideable&&N.push(this),e.resizable=f.isUndefined(e.parent)&&e.resizable,e.autoPlace&&f.isUndefined(e.scrollable)&&(e.scrollable=!0);var n,s=R&&"true"===localStorage.getItem(document.location.href+".isLocal");if(Object.defineProperties(this,{parent:{get:function(){return e.parent}},scrollable:{get:function(){return e.scrollable}},autoPlace:{get:function(){return e.autoPlace}},preset:{get:function(){return i.parent?i.getRoot().preset:e.load.preset},set:function(t){for(i.parent?i.getRoot().preset=t:e.load.preset=t,t=0;t<this.__preset_select.length;t++)this.__preset_select[t].value==this.preset&&(this.__preset_select.selectedIndex=t);i.revert()}},width:{get:function(){return e.width},set:function(t){e.width=t,E(i,t)}},name:{get:function(){return e.name},set:function(t){e.name=t,o&&(o.innerHTML=e.name)}},closed:{get:function(){return e.closed},set:function(t){e.closed=t,e.closed?p.addClass(i.__ul,H.CLASS_CLOSED):p.removeClass(i.__ul,H.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=t?H.TEXT_OPEN:H.TEXT_CLOSED)}},load:{get:function(){return e.load}},useLocalStorage:{get:function(){return s},set:function(e){R&&((s=e)?p.bind(window,"unload",n):p.unbind(window,"unload",n),localStorage.setItem(document.location.href+".isLocal",e))}}}),f.isUndefined(e.parent)){if(e.closed=!1,p.addClass(this.domElement,H.CLASS_MAIN),p.makeSelectable(this.domElement,!1),R&&s){i.useLocalStorage=!0;var r=localStorage.getItem(document.location.href+".gui");r&&(e.load=JSON.parse(r))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=H.TEXT_CLOSED,p.addClass(this.__closeButton,H.CLASS_CLOSE_BUTTON),this.domElement.appendChild(this.__closeButton),p.bind(this.__closeButton,"click",function(){i.closed=!i.closed})}else{void 0===e.closed&&(e.closed=!0);var o=document.createTextNode(e.name);p.addClass(o,"controller-name"),r=v(i,o),p.addClass(this.__ul,H.CLASS_CLOSED),p.addClass(r,"title"),p.bind(r,"click",function(e){return e.preventDefault(),i.closed=!i.closed,!1}),e.closed||(this.closed=!1)}e.autoPlace&&(f.isUndefined(e.parent)&&(S&&(C=document.createElement("div"),p.addClass(C,"dg"),p.addClass(C,H.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(C),S=!1),C.appendChild(this.domElement),p.addClass(this.domElement,H.CLASS_AUTO_PLACE)),this.parent||E(i,e.width)),p.bind(window,"resize",function(){i.onResize()}),p.bind(this.__ul,"webkitTransitionEnd",function(){i.onResize()}),p.bind(this.__ul,"transitionend",function(){i.onResize()}),p.bind(this.__ul,"oTransitionEnd",function(){i.onResize()}),this.onResize(),e.resizable&&w(this),this.saveToLocalStorageIfPossible=n=function(){R&&"true"===localStorage.getItem(document.location.href+".isLocal")&&localStorage.setItem(document.location.href+".gui",JSON.stringify(i.getSaveObject()))},i.getRoot(),e.parent||t()};return H.toggleHide=function(){A=!A,f.each(N,function(e){e.domElement.style.zIndex=A?-999:999,e.domElement.style.opacity=A?0:1})},H.CLASS_AUTO_PLACE="a",H.CLASS_AUTO_PLACE_CONTAINER="ac",H.CLASS_MAIN="main",H.CLASS_CONTROLLER_ROW="cr",H.CLASS_TOO_TALL="taller-than-window",H.CLASS_CLOSED="closed",H.CLASS_CLOSE_BUTTON="close-button",H.CLASS_DRAG="drag",H.DEFAULT_WIDTH=245,H.TEXT_CLOSED="Close Controls",H.TEXT_OPEN="Open Controls",p.bind(window,"keydown",function(e){"text"===document.activeElement.type||72!==e.which&&72!=e.keyCode||H.toggleHide()},!1),f.extend(H.prototype,{add:function(e,t){return m(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return m(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;f.defer(function(){t.onResize()})},destroy:function(){this.autoPlace&&C.removeChild(this.domElement)},addFolder:function(e){if(void 0!==this.__folders[e])throw Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};return t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]),t=new H(t),this.__folders[e]=t,e=v(this,t.domElement),p.addClass(e,"folder"),t},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=p.getOffset(e.__ul).top,i=0;f.each(e.__ul.childNodes,function(t){e.autoPlace&&t===e.__save_row||(i+=p.getHeight(t))}),window.innerHeight-t-20<i?(p.addClass(e.domElement,H.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-20+"px"):(p.removeClass(e.domElement,H.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&f.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},remember:function(){if(f.isUndefined(M)&&(M=new d,M.domElement.innerHTML=t),this.parent)throw Error("You can only call remember on a top level GUI.");var e=this;f.each(Array.prototype.slice.call(arguments),function(t){0==e.__rememberedObjects.length&&y(e),-1==e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)}),this.autoPlace&&E(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,0<this.__rememberedObjects.length&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=x(this)),e.folders={},f.each(this.__folders,function(t,i){e.folders[i]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=x(this),_(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=x(this,!0)),this.load.remembered[e]=x(this),this.preset=e,T(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){f.each(this.__controllers,function(t){this.getRoot().load.remembered?b(e||this.getRoot(),t):t.setValue(t.initialValue)},this),f.each(this.__folders,function(e){e.revert(e)}),e||_(this.getRoot(),!1)},listen:function(e){var t=0==this.__listening.length;this.__listening.push(e),t&&k(this.__listening)}}),H}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg {\n  /** Clear list styles */\n  /* Auto-place container */\n  /* Auto-placed GUI's */\n  /* Line items that don't contain folders. */\n  /** Folder names */\n  /** Hides closed items */\n  /** Controller row */\n  /** Name-half (left) */\n  /** Controller-half (right) */\n  /** Controller placement */\n  /** Shorter number boxes when slider is present. */\n  /** Ensure the entire boolean and function row shows a hand */ }\n  .dg ul {\n    list-style: none;\n    margin: 0;\n    padding: 0;\n    width: 100%;\n    clear: both; }\n  .dg.ac {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 0;\n    z-index: 0; }\n  .dg:not(.ac) .main {\n    /** Exclude mains in ac so that we don't hide close button */\n    overflow: hidden; }\n  .dg.main {\n    -webkit-transition: opacity 0.1s linear;\n    -o-transition: opacity 0.1s linear;\n    -moz-transition: opacity 0.1s linear;\n    transition: opacity 0.1s linear; }\n    .dg.main.taller-than-window {\n      overflow-y: auto; }\n      .dg.main.taller-than-window .close-button {\n        opacity: 1;\n        /* TODO, these are style notes */\n        margin-top: -1px;\n        border-top: 1px solid #2c2c2c; }\n    .dg.main ul.closed .close-button {\n      opacity: 1 !important; }\n    .dg.main:hover .close-button,\n    .dg.main .close-button.drag {\n      opacity: 1; }\n    .dg.main .close-button {\n      /*opacity: 0;*/\n      -webkit-transition: opacity 0.1s linear;\n      -o-transition: opacity 0.1s linear;\n      -moz-transition: opacity 0.1s linear;\n      transition: opacity 0.1s linear;\n      border: 0;\n      position: absolute;\n      line-height: 19px;\n      height: 20px;\n      /* TODO, these are style notes */\n      cursor: pointer;\n      text-align: center;\n      background-color: #000; }\n      .dg.main .close-button:hover {\n        background-color: #111; }\n  .dg.a {\n    float: right;\n    margin-right: 15px;\n    overflow-x: hidden; }\n    .dg.a.has-save > ul {\n      margin-top: 27px; }\n      .dg.a.has-save > ul.closed {\n        margin-top: 0; }\n    .dg.a .save-row {\n      position: fixed;\n      top: 0;\n      z-index: 1002; }\n  .dg li {\n    -webkit-transition: height 0.1s ease-out;\n    -o-transition: height 0.1s ease-out;\n    -moz-transition: height 0.1s ease-out;\n    transition: height 0.1s ease-out; }\n  .dg li:not(.folder) {\n    cursor: auto;\n    height: 27px;\n    line-height: 27px;\n    overflow: hidden;\n    padding: 0 4px 0 5px; }\n  .dg li.folder {\n    padding: 0;\n    border-left: 4px solid rgba(0, 0, 0, 0); }\n  .dg li.title {\n    cursor: pointer;\n    margin-left: -4px; }\n  .dg .closed li:not(.title),\n  .dg .closed ul li,\n  .dg .closed ul li > * {\n    height: 0;\n    overflow: hidden;\n    border: 0; }\n  .dg .cr {\n    clear: both;\n    padding-left: 3px;\n    height: 27px; }\n  .dg .property-name {\n    cursor: default;\n    float: left;\n    clear: left;\n    width: 40%;\n    overflow: hidden;\n    text-overflow: ellipsis; }\n  .dg .c {\n    float: left;\n    width: 60%; }\n  .dg .c input[type=text] {\n    border: 0;\n    margin-top: 4px;\n    padding: 3px;\n    width: 100%;\n    float: right; }\n  .dg .has-slider input[type=text] {\n    width: 30%;\n    /*display: none;*/\n    margin-left: 0; }\n  .dg .slider {\n    float: left;\n    width: 66%;\n    margin-left: -5px;\n    margin-right: 0;\n    height: 19px;\n    margin-top: 4px; }\n  .dg .slider-fg {\n    height: 100%; }\n  .dg .c input[type=checkbox] {\n    margin-top: 9px; }\n  .dg .c select {\n    margin-top: 5px; }\n  .dg .cr.function,\n  .dg .cr.function .property-name,\n  .dg .cr.function *,\n  .dg .cr.boolean,\n  .dg .cr.boolean * {\n    cursor: pointer; }\n  .dg .selector {\n    display: none;\n    position: absolute;\n    margin-left: -9px;\n    margin-top: 23px;\n    z-index: 10; }\n  .dg .c:hover .selector,\n  .dg .selector.drag {\n    display: block; }\n  .dg li.save-row {\n    padding: 0; }\n    .dg li.save-row .button {\n      display: inline-block;\n      padding: 0px 6px; }\n  .dg.dialogue {\n    background-color: #222;\n    width: 460px;\n    padding: 15px;\n    font-size: 13px;\n    line-height: 15px; }\n\n/* TODO Separate style and structure */\n#dg-new-constructor {\n  padding: 10px;\n  color: #222;\n  font-family: Monaco, monospace;\n  font-size: 10px;\n  border: 0;\n  resize: none;\n  box-shadow: inset 1px 1px 1px #888;\n  word-wrap: break-word;\n  margin: 12px 0;\n  display: block;\n  width: 440px;\n  overflow-y: scroll;\n  height: 100px;\n  position: relative; }\n\n#dg-local-explain {\n  display: none;\n  font-size: 11px;\n  line-height: 17px;\n  border-radius: 3px;\n  background-color: #333;\n  padding: 8px;\n  margin-top: 10px; }\n  #dg-local-explain code {\n    font-size: 10px; }\n\n#dat-gui-save-locally {\n  display: none; }\n\n/** Main type */\n.dg {\n  color: #eee;\n  font: 11px 'Lucida Grande', sans-serif;\n  text-shadow: 0 -1px 0 #111;\n  /** Auto place */\n  /* Controller row, <li> */\n  /** Controllers */ }\n  .dg.main {\n    /** Scrollbar */ }\n    .dg.main::-webkit-scrollbar {\n      width: 5px;\n      background: #1a1a1a; }\n    .dg.main::-webkit-scrollbar-corner {\n      height: 0;\n      display: none; }\n    .dg.main::-webkit-scrollbar-thumb {\n      border-radius: 5px;\n      background: #676767; }\n  .dg li:not(.folder) {\n    background: #1a1a1a;\n    border-bottom: 1px solid #2c2c2c; }\n  .dg li.save-row {\n    line-height: 25px;\n    background: #dad5cb;\n    border: 0; }\n    .dg li.save-row select {\n      margin-left: 5px;\n      width: 108px; }\n    .dg li.save-row .button {\n      margin-left: 5px;\n      margin-top: 1px;\n      border-radius: 2px;\n      font-size: 9px;\n      line-height: 7px;\n      padding: 4px 4px 5px 4px;\n      background: #c5bdad;\n      color: #fff;\n      text-shadow: 0 1px 0 #b0a58f;\n      box-shadow: 0 -1px 0 #b0a58f;\n      cursor: pointer; }\n      .dg li.save-row .button.gears {\n        background: #c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;\n        height: 7px;\n        width: 8px; }\n      .dg li.save-row .button:hover {\n        background-color: #bab19e;\n        box-shadow: 0 -1px 0 #b0a58f; }\n  .dg li.folder {\n    border-bottom: 0; }\n  .dg li.title {\n    padding-left: 16px;\n    background: black url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;\n    cursor: pointer;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.2); }\n  .dg .closed li.title {\n    background-image: url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==); }\n  .dg .cr.boolean {\n    border-left: 3px solid #806787; }\n  .dg .cr.function {\n    border-left: 3px solid #e61d5f; }\n  .dg .cr.number {\n    border-left: 3px solid #2fa1d6; }\n    .dg .cr.number input[type=text] {\n      color: #2fa1d6; }\n  .dg .cr.string {\n    border-left: 3px solid #1ed36f; }\n    .dg .cr.string input[type=text] {\n      color: #1ed36f; }\n  .dg .cr.function:hover, .dg .cr.boolean:hover {\n    background: #111; }\n  .dg .c input[type=text] {\n    background: #303030;\n    outline: none; }\n    .dg .c input[type=text]:hover {\n      background: #3c3c3c; }\n    .dg .c input[type=text]:focus {\n      background: #494949;\n      color: #fff; }\n  .dg .c .slider {\n    background: #303030;\n    cursor: ew-resize; }\n  .dg .c .slider-fg {\n    background: #2fa1d6; }\n  .dg .c .slider:hover {\n    background: #3c3c3c; }\n    .dg .c .slider:hover .slider-fg {\n      background: #44abda; }\n",dat.controllers.factory=function(e,t,i,n,s,r,o){
return function(a,l,h,c){var u=a[l];return o.isArray(h)||o.isObject(h)?new e(a,l,h):o.isNumber(u)?o.isNumber(h)&&o.isNumber(c)?new i(a,l,h,c):new t(a,l,{min:h,max:c}):o.isString(u)?new n(a,l):o.isFunction(u)?new s(a,l,""):o.isBoolean(u)?new r(a,l):void 0}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(e,t,i){var n=function(e,i){function s(){r.setValue(r.__input.value)}n.superclass.call(this,e,i);var r=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),t.bind(this.__input,"keyup",s),t.bind(this.__input,"change",s),t.bind(this.__input,"blur",function(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}),t.bind(this.__input,"keydown",function(e){13===e.keyCode&&this.blur()}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return n.superclass=e,i.extend(n.prototype,e.prototype,{updateDisplay:function(){return t.isActive(this.__input)||(this.__input.value=this.getValue()),n.superclass.prototype.updateDisplay.call(this)}}),n}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(e,t,i,n,s){function r(e,t,i,n){e.style.background="",s.each(l,function(s){e.style.cssText+="background: "+s+"linear-gradient("+t+", "+i+" 0%, "+n+" 100%); "})}function o(e){e.style.background="",e.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",e.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var a=function(e,l){function h(e){p(e),t.bind(window,"mousemove",p),t.bind(window,"mouseup",c)}function c(){t.unbind(window,"mousemove",p),t.unbind(window,"mouseup",c)}function u(){var e=n(this.value);!1!==e?(m.__color.__state=e,m.setValue(m.__color.toOriginal())):this.value=m.__color.toString()}function d(){t.unbind(window,"mousemove",f),t.unbind(window,"mouseup",d)}function p(e){e.preventDefault();var i=t.getWidth(m.__saturation_field),n=t.getOffset(m.__saturation_field),s=(e.clientX-n.left+document.body.scrollLeft)/i;return e=1-(e.clientY-n.top+document.body.scrollTop)/i,1<e?e=1:0>e&&(e=0),1<s?s=1:0>s&&(s=0),m.__color.v=e,m.__color.s=s,m.setValue(m.__color.toOriginal()),!1}function f(e){e.preventDefault();var i=t.getHeight(m.__hue_field),n=t.getOffset(m.__hue_field);return e=1-(e.clientY-n.top+document.body.scrollTop)/i,1<e?e=1:0>e&&(e=0),m.__color.h=360*e,m.setValue(m.__color.toOriginal()),!1}a.superclass.call(this,e,l),this.__color=new i(this.getValue()),this.__temp=new i(0);var m=this;this.domElement=document.createElement("div"),t.makeSelectable(this.domElement,!1),this.__selector=document.createElement("div"),this.__selector.className="selector",this.__saturation_field=document.createElement("div"),this.__saturation_field.className="saturation-field",this.__field_knob=document.createElement("div"),this.__field_knob.className="field-knob",this.__field_knob_border="2px solid ",this.__hue_knob=document.createElement("div"),this.__hue_knob.className="hue-knob",this.__hue_field=document.createElement("div"),this.__hue_field.className="hue-field",this.__input=document.createElement("input"),this.__input.type="text",this.__input_textShadow="0 1px 1px ",t.bind(this.__input,"keydown",function(e){13===e.keyCode&&u.call(this)}),t.bind(this.__input,"blur",u),t.bind(this.__selector,"mousedown",function(e){t.addClass(this,"drag").bind(window,"mouseup",function(e){t.removeClass(m.__selector,"drag")})});var v=document.createElement("div");s.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),s.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(.5>this.__color.v?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),s.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),s.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),s.extend(v.style,{width:"100%",height:"100%",background:"none"}),r(v,"top","rgba(0,0,0,0)","#000"),s.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"}),o(this.__hue_field),s.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"}),t.bind(this.__saturation_field,"mousedown",h),t.bind(this.__field_knob,"mousedown",h),t.bind(this.__hue_field,"mousedown",function(e){f(e),t.bind(window,"mousemove",f),t.bind(window,"mouseup",d)}),this.__saturation_field.appendChild(v),this.__selector.appendChild(this.__field_knob),this.__selector.appendChild(this.__saturation_field),this.__selector.appendChild(this.__hue_field),this.__hue_field.appendChild(this.__hue_knob),this.domElement.appendChild(this.__input),this.domElement.appendChild(this.__selector),this.updateDisplay()};a.superclass=e,s.extend(a.prototype,e.prototype,{updateDisplay:function(){var e=n(this.getValue());if(!1!==e){var t=!1;s.each(i.COMPONENTS,function(i){if(!s.isUndefined(e[i])&&!s.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}},this),t&&s.extend(this.__color.__state,e)}s.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var o=.5>this.__color.v||.5<this.__color.s?255:0,a=255-o;s.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+o+","+o+","+o+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,r(this.__saturation_field,"left","#fff",this.__temp.toString()),s.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+o+","+o+","+o+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}});var l=["-moz-","-o-","-webkit-","-ms-",""];return a}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(e,t,i,n){function s(e,t,i){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space?this.__state[t]:(o(this,t,i),this.__state[t])},set:function(e){"RGB"!==this.__state.space&&(o(this,t,i),this.__state.space="RGB"),this.__state[t]=e}})}function r(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space?this.__state[t]:(a(this),this.__state[t])},set:function(e){"HSV"!==this.__state.space&&(a(this),this.__state.space="HSV"),this.__state[t]=e}})}function o(e,i,s){if("HEX"===e.__state.space)e.__state[i]=t.component_from_hex(e.__state.hex,s);else{if("HSV"!==e.__state.space)throw"Corrupted color state";n.extend(e.__state,t.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}}function a(e){var i=t.rgb_to_hsv(e.r,e.g,e.b);n.extend(e.__state,{s:i.s,v:i.v}),n.isNaN(i.h)?n.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=i.h}var l=function(){if(this.__state=e.apply(this,arguments),!1===this.__state)throw"Failed to interpret color arguments";this.__state.a=this.__state.a||1};return l.COMPONENTS="r g b h s v hex a".split(" "),n.extend(l.prototype,{toString:function(){return i(this)},toOriginal:function(){return this.__state.conversion.write(this)}}),s(l.prototype,"r",2),s(l.prototype,"g",1),s(l.prototype,"b",0),r(l.prototype,"h"),r(l.prototype,"s"),r(l.prototype,"v"),Object.defineProperty(l.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(l.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=t.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}}),l}(dat.color.interpret,dat.color.math=function(){var e;return{hsv_to_rgb:function(e,t,i){var n=e/60-Math.floor(e/60),s=i*(1-t),r=i*(1-n*t);return t=i*(1-(1-n)*t),e=[[i,t,s],[r,i,s],[s,i,t],[s,r,i],[t,s,i],[i,s,r]][Math.floor(e/60)%6],{r:255*e[0],g:255*e[1],b:255*e[2]}},rgb_to_hsv:function(e,t,i){var n=Math.min(e,t,i),s=Math.max(e,t,i),n=s-n;return 0==s?{h:NaN,s:0,v:0}:(e=(e==s?(t-i)/n:t==s?2+(i-e)/n:4+(e-t)/n)/6,0>e&&(e+=1),{h:360*e,s:n/s,v:s/255})},rgb_to_hex:function(e,t,i){return e=this.hex_with_component(0,2,e),e=this.hex_with_component(e,1,t),e=this.hex_with_component(e,0,i)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(t,i,n){return n<<(e=8*i)|t&~(255<<e)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}(),dat.dom.CenteredDiv=function(e,t){var i=function(){this.backgroundElement=document.createElement("div"),t.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),e.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),t.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var i=this;e.bind(this.backgroundElement,"click",function(){i.hide()})};return i.prototype.show=function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),t.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})},i.prototype.hide=function(){var t=this,i=function(){t.domElement.style.display="none",t.backgroundElement.style.display="none",e.unbind(t.domElement,"webkitTransitionEnd",i),e.unbind(t.domElement,"transitionend",i),e.unbind(t.domElement,"oTransitionEnd",i)};e.bind(this.domElement,"webkitTransitionEnd",i),e.bind(this.domElement,"transitionend",i),e.bind(this.domElement,"oTransitionEnd",i),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"},i.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-e.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-e.getHeight(this.domElement)/2+"px"},i}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common),EventEmitter.ADD={},EventEmitter.DEL={},EventEmitter.prototype={_add:function(e,t){e.tail?(t.prev=e.tail,e.tail=e.tail.next=t):e.head=e.tail=t},_rem:function(e,t){t.prev?t.prev.next=t.next:e.head=t.next,t.next?t.next.prev=t.prev:e.tail=t.prev},when:function(e,t,i,n){for(var s in e)this.on(s,e[s],t,i,n)},once:function(e,t,i,n){this.on(e,t,i,n,!0)},on:function(e,t,i,n,s){"function"==typeof t&&this.emit(EventEmitter.ADD,{type:e,func:t,scope:i,data:null==n?[]:[].concat(n),once:s})},off:function(e,t,i){this.emit(EventEmitter.DEL,{type:e,func:t,scope:i})},will:function(e,t){var i=this,n=null==t?[]:[].concat(t);return function(){for(var t=n.slice(),s=0;s<arguments.length;s++)t.push(arguments[s]);i.emit(e,t)}},emit:function(e,t){if(this.debug&&console.log(this.debug,e,t),this._add(this.queue,{type:e,data:null==t?[]:t}),!this.processing){for(this.processing=!0;this.queue.head;)this.dispatch(this.queue.head),this._rem(this.queue,this.queue.head);this.processing=!1}},dispatch:function(e){var t=e.type,i=e.data;switch(t){case EventEmitter.ADD:this._add(this.lists[i.type]||(this.lists[i.type]={}),i);break;case EventEmitter.DEL:for(var t in this.lists)for(var n=this.lists[t],s=n.head;s;s=s.next)null!=i.type&&i.type!==t||null!=i.func&&i.func!==s.func||null!=i.scope&&i.scope!==s.scope||this._rem(n,s);break;default:var n=this.lists[t];if(n)for(var s=n.head;s;s=s.next)s.func.apply(s.scope,s.data.concat(i)),s.once&&this._rem(n,s);for(var r=this.links.head;r;r=r.next)r.emitter.emit(r.prefix?r.prefix+t:t,r.data.concat(i))}},relay:function(e,t,i){this.on(e,t.emit,t,i||e)},link:function(e,t,i){this._add(this.links,{emitter:e,prefix:t,data:null==i?[]:[].concat(i)})},unlink:function(e,t){for(var i=this.links.head;i;i=i.next)null!=e&&e!==i.emitter||null!=t&&t!==i.prefix||this._rem(this.links,i)},clone:function(){var e=new EventEmitter;for(var t in this.lists)e.lists[t]=this.lists[t];return e}},EventHandler.prototype={handleEvent:function(e){return this.apply(e)},apply:function(e){return this.once&&this.release(),this.func.apply(this.scope,[].concat(this.data,e||[]))},listen:function(e,t,i){return this.element&&this.release(),this.type=e,this.element=t,this.capture=!!i,this.element&&this.element.addEventListener&&this.element.addEventListener(this.type,this,this.capture),this},release:function(){return this.element&&this.element.removeEventListener&&this.element.removeEventListener(this.type,this,this.capture),delete this.element,this}},Observable.count=0,Observable.stack=[],Observable.context=null,Observable.unwrap=function(e){return e instanceof Observable?e.read():e},Observable.inContext=function(e,t,i,n,s){Observable.stack.push(Observable.context),Observable.context=e;try{return t.call(i,n,s)}finally{Observable.context=Observable.stack.pop()}},Observable.prototype={set:function(e,t,i,n){return this.reader="function"==typeof t?t:null,this.writer="function"==typeof i?i:null,this.equals="function"==typeof n?n:null,this.scope=e,this.stale=!0,this},read:function(){var e=Observable.context;if(e&&e.id!==this.id&&(this.targets[e.id]=e,e.sources[this.id]=this),this.stale)if(this.stale=!1,this.reader){this.sources={};var t=this.value;this.value=Observable.inContext(this,this.reader,this.scope,this.value),this.debug&&console.log("OB",this.id,"read",t,"->",this.value,"deps:",Object.keys(this.sources).map(Number))}else this.debug&&console.log("OB",this.id,"read stale no reader",this.value);else this.debug&&console.log("OB",this.id,"read utmost",this.value);return this.value},write:function(e){return this.value!==e?(this.writer&&this.writer.call(this.scope,e,this.value),this.debug&&console.log("OB",this.id,"write ok",this.value,"->",e),this.value=e,this.touch()):this.debug&&console.log("OB",this.id,"write fail",e),this},touch:function(e){this.stale=!0,this.debug&&console.trace("OB",this.id,"touched");var t=this.debug;for(var i in this.targets){var n=this.targets[i];delete this.targets[i],t|=n.touch()}return t&&console.log("---> OB",this.id),t},destroy:function(){for(var e in this.sources)delete this.sources[e].targets[this.id],delete this.sources[e];this.touch()}},Timer.prototype={time:0,rate:1,running:!1,play:function(){if(this.running)return this;this.running=!0;var e=this,t=0,i=performance.now(),n=i,s=0,r=0;return!function i(){e.id=requestAnimationFrame(i),t++,s=performance.now(),r=(s-n)*e.rate,e.time+=r,e.func.call(e.scope,e.time,r,t),n=s}(),this},stop:function(){return this.running&&(this.running=!1,cancelAnimationFrame(this.id)),this}},Defer.all=function(e){function t(t,a,l){if(a?++r:++o,s[e.indexOf(l)]=t,!(r+o<n)){if(o)throw s;return s}i.pending=!0}var i=new Defer(t,t),n=e&&e.length||0,s=new Array(e.length),r=0,o=0;if(!n)return i.resolve(s),i;for(var a=0;a<n;a++){var l=e[a];l instanceof Defer?l.push(i):(s[a]=l,r++)}return i},Defer.wait=function(e){return function(t){return Defer.timer(e,t)}},Defer.timer=function(e,t){var i=new Defer;return setTimeout(function(){i.resolve(t)},e),i},Defer.prototype={unsafe:!1,set:function(e,t,i,n){return this.onresolve="function"==typeof e?e:null,this.onreject="function"==typeof t?t:null,this.scope=this.onreject?i:t||i,this.unsafe=!!n,this},abort:function(){return delete this.head,delete this.tail,this.set(null)},then:function(e,t,i,n){return this.push(new Defer(e,t,i,n))},anyway:function(e,t,i){return this.push(new Defer(e,e,t,i))},detach:function(e,t){return this.push(new Defer(function(i){setTimeout(function(){e.call(t,i)},0)}))},push:function(e){return this.head?this.tail=this.tail.next=e:this.head=this.tail=e,this.dispatch(),e},resolve:function(e,t){return this.transition(!0,e,t)},reject:function(e,t){return this.transition(!1,e,t)},transition:function(e,t,i){if(this.debug&&console.log("defer",this.debug,e?"resolve":"reject",this.pending?"ok":"no",t),!this.pending)return this;this.pending=!1;var n=e?this.onresolve:this.onreject;if(n)if(this.unsafe)this.value=n.call(this.scope,t,e,i),this.success=!0;else try{this.value=n.call(this.scope,t,e,i),this.success=!0}catch(e){this.value=e,this.success=!1}else this.success=e,this.value=t;return this.dispatch(),this},dispatch:function(){if(this.pending)return this;var e=this.head;if(delete this.head,e)if(this.value instanceof Defer)this.value.push(e);else for(;e;)e.transition(this.success,this.value,this),e=e.next;else if(!this.success)throw this.value;return this}},Gate.prototype={on:function(e){this.inputs[e]=!0,this.check()},off:function(e){this.inputs[e]=!1,this.check()},set:function(e,t){this.inputs[t]=e,this.check()},will:function(e,t){var i=this;return function(){i.set(e,t)}},check:function(e){var t;for(var i in this.inputs)t=void 0===t?this.inputs[i]:this.method(t,this.inputs[i]);void 0===t&&(t=this.value),(!this.value!=!t||e)&&this.events.emit(t?"opened":"closed",!!t),(this.value!==t||e)&&(this.value=t,this.events.emit("change",t))},constructor:Gate},Gate.MULTIPLY=function(e,t){return e*t},Gate.ADD=function(e,t){return e+t},Gate.AND=function(e,t){return e&&t},Gate.OR=function(e,t){return e||t},Loader.prototype={randomize:!1,reset:function(){this.units=[],this.defers=[]},wait:function(e){this.defers.push(e)},abort:function(e){e?e.abort():(this.units.forEach(this.abort,this),this.reset())},load:function(e,t,i){var n=Loader.Resource.types[e];if(!n)throw TypeError("Loader: unknown type: "+e);var s={};for(var r in n)s[r]=n[r];for(var r in i)s[r]=i[r];var o=new Loader.Resource(t,s,this);return this.units.push(o),this.defers.push(o.deferTail),o.transport(),o},progress:function(){this.unitsTotal=this.units.length,this.unitsLoaded=0,this.bytesTotal=0,this.bytesLoaded=0;for(var e=0;e<this.unitsTotal;e++){var t=this.units[e];this.unitsLoaded+=t.deferTail.pending?0:1,this.bytesTotal+=t.bytesTotal,this.bytesLoaded+=t.bytesLoaded}"function"==typeof this.onProgressCallback&&this.onProgressCallback.call(this.onProgressScope,this)},onProgress:function(e,t){this.onProgressCallback=e,this.onProgressScope=t},ready:function(e,t,i){var n=Defer.all(this.defers);return arguments.length?n.then(e,t,i):n}},Loader.imageTransport=function(){var e=this,t=new Image;e.data=t,t.onload=function(){e.deferHead.resolve(t)},t.onerror=function(t){e.deferHead.reject(t)},t.onprogress=function(t){e.bytesLoaded=t.loaded,e.bytesTotal=t.total,e.loader.progress()},t.src=e.source},Loader.ajaxTransport=function(){var e=this,t=new XMLHttpRequest,i=[];for(var n in e.query)i.push(encodeURIComponent(n)+"="+encodeURIComponent(e.query[n]));var s=i.join("&");e.request=t,e.requestType=e.requestType?e.requestType.toUpperCase():"GET","GET"===e.requestType&&s&&(e.source+="?"+s),t.open(e.requestType,e.source,!0),t.responseType=e.responseType||"";for(var r in e.headers)t.setRequestHeader(r,e.headers[r]);t.onreadystatechange=function(){4===t.readyState&&(200<=t.status&&t.status<400?(e.data=t[e.responseName||"responseText"],e.deferHead.resolve(e.data)):e.deferHead.reject(t.status))},t.onprogress=function(t){e.bytesLoaded=t.loaded,e.bytesTotal=t.total,e.loader.progress()},t.send("POST"===e.requestType?s:null)},Loader.extend=function(e,t){Loader.prototype[e]&&console.warn("Loader.extend: overwriting "+e),Loader.Resource.types[e]=t,Loader.prototype[e]=function(t,i){return this.load(e,t,i)}},Loader.Resource=function(e,t,i){for(var n in t)this[n]=t[n];this.url=e,this.loader=i,this.bytesTotal=0,this.bytesLoaded=0,this.source=(this.url+"").replace(/#.*$/,""),(this.randomize||i.randomize)&&(this.source+="&?"[+!~this.source.indexOf("?")]+Math.random()),this.deferHead=new Defer(this.prepare,this),this.saveAs||this.saveTo?this.defer=this.deferHead.then(this.save,this):this.defer=this.deferHead.then(),this.deferTail=this.defer},Loader.Resource.prototype={save:function(e){var t=this.saveTo||this.loader.data,i=this.saveAs||"data";return t[i]=e},abort:function(){return this.request&&this.request.abort(),this.deferHead.init(null),this.deferTail.init(null),this}},Loader.Resource.types={},!function(){var e={image:{transport:Loader.imageTransport},text:{transport:Loader.ajaxTransport},post:{transport:Loader.ajaxTransport,requestType:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},query:null},json:{transport:Loader.ajaxTransport,prepare:JSON.parse},xml:{responseName:"responseXML",transport:Loader.ajaxTransport},buffer:{responseType:"arraybuffer",responseName:"response",transport:Loader.ajaxTransport}};for(var t in e)Loader.extend(t,e[t])}(),Loader.extend("obj",{transport:Loader.ajaxTransport,saveMetadata:!1,computeBoundingBox:!1,randomColor:!0,verbose:!1,prepare:function(e){function t(e){return e<0&&(e=c.vertices.length+e+1),c.vertices[e]||h.verbose&&console.warn("Loader.obj: undefined vertex "+e),e<u?o.vertices.push(c.vertices[e])-1:e-u}function i(){o=new THREE.Geometry,a=new THREE.MeshBasicMaterial,l=new THREE.Mesh(o,a),h.randomColor&&a.color.set(Math.round(16777215*Math.random())),u=c.vertices.length,c.meshes.push(l)}function n(e,t,i,n,s,r,a,l,c,u){if(v.subVectors(a[i],a[t]),g.subVectors(a[e],a[t]),v.cross(g),!v.x&&!v.y&&!v.z)return void(h.verbose&&console.warn('[Loader.obj] collapsed face "'+h.url+'":',u,[e,t,i]));v.normalize();var d=new THREE.Face3(n[e],n[t],n[i]);d.normal.copy(v),c&&d.vertexNormals.push(r[e],r[t],r[i]),o.faceVertexUvs[0].push(l?[s[e],s[t],s[i]]:b),o.faces.push(d)}function s(){o&&o.vertices.length&&(h.computeBoundingBox&&o.computeBoundingBox(),p.add(l))}function r(){d&&(d=!1,s(),i())}for(var o,a,l,h=this,c={vertices:[],normals:[],meshes:[],uvs:[]},u=0,d=!0,p=new THREE.Object3D,f=p,m=new THREE.Vector2,v=new THREE.Vector3,g=new THREE.Vector3,b=[m,m,m],y=(e.length,-1),w=0;w!==-1;){var E=e.indexOf("\n",w+1),x=e.substr(w,E-w).replace(/#.*/,"").trim();if(y++,w=E,x){var T=x.split(/\s+/),_=T[0],k=T.slice(1);switch(_){case"mtllib":break;case"o":break;case"s":break;case"usemtl":l.material.name=k.join(" ");break;case"g":l.name=k.join(" ");break;case"v":r();var R=new THREE.Vector3(parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2]));c.vertices.push(R),o.vertices.push(R);break;case"vn":c.normals.push(new THREE.Vector3(parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2])));break;case"vt":c.uvs.push(new THREE.Vector2(parseFloat(k[0]),parseFloat(k[1])));break;case"f":for(var M=k.length,C=!0,S=!0,A=[],N=[],H=[],L=[],I=0;I<M;I++){var O=k[I].split("/"),P=t(parseInt(O[0])-1),j=c.uvs[parseInt(O[1])-1],D=c.normals[parseInt(O[2])-1];A.push(P),N.push(j),H.push(D),L.push(o.vertices[P]),S&=!!j,C&=!!D}if(4===M)n(0,1,3,A,N,H,L,S,C,y),n(1,2,3,A,N,H,L,S,C,y);else{if(3!==M){h.verbose&&console.warn("[Loader.obj] unknown face with",M,"vertices");continue}n(0,1,2,A,N,H,L,S,C,y)}d=!0;break;default:h.verbose&&console.log('Loader.obj: unhandled "'+x+'"')}}}return s(),this.saveMetadata&&(f.metadata=c),f}}),Drag.prototype={active:!1,disabled:!1,start:function(e,t){this.active=!0,this.moves=0,this.begin.x=e,this.begin.y=t,this.origin.x=this.point.x,this.origin.y=this.point.y,this.offset.x=this.delta.x=0,this.offset.y=this.delta.y=0},move:function(e,t){this.active&&(this.moves++,this.delta.x=-this.point.x,this.delta.y=-this.point.y,this.offset.x=(e-this.begin.x)*this.scale.x,this.offset.y=(t-this.begin.y)*this.scale.y,this.point.x=Math.min(this.max.x,Math.max(this.min.x,this.origin.x+this.offset.x)),this.point.y=Math.min(this.max.y,Math.max(this.min.y,this.origin.y+this.offset.y)),this.delta.x+=this.point.x,this.delta.y+=this.point.y)},end:function(){this.active=!1},enable:function(){this.disabled=!1},disable:function(){this.active&&this.end(),this.disabled=!0},bind:function(e,t){t&&t.addEventListener(e,this)},unbind:function(e,t){t&&t.removeEventListener(e,this)},handleEvent:function(e){if(!this.disabled){if(this.mouse.x=0,this.mouse.y=0,e.touches){for(var t=e.touches.length,i=0;i<t;i++){var n=e.touches[i];this.mouse.x+=n.pageX,this.mouse.y+=n.pageY}this.mouse.x/=t,this.mouse.y/=t}else this.mouse.x=e.pageX,this.mouse.y=e.pageY;var s;switch(e.type){case"mousedown":if(1!==e.which)return;this.mouseActive||(this.mouseActive=!0,this.bind("mousemove",window),this.bind("mouseup",window)),this.start(this.mouse.x,this.mouse.y),s="start";break;case"mousemove":if(!this.mouseActive)return;this.move(this.mouse.x,this.mouse.y),s="drag";break;case"mouseup":if(!this.mouseActive)return;this.mouseActive=!1,this.unbind("mousemove",window),this.unbind("mouseup",window),this.end(),s="end";break;case"touchstart":this.touchActive||(this.touchActive=!0,this.bind("touchstart",window),this.bind("touchmove",window),this.bind("touchend",window),this.unbind("touchstart",this.element)),this.start(this.mouse.x,this.mouse.y),s="start";break;case"touchmove":if(!this.touchActive)return;this.move(this.mouse.x,this.mouse.y),s="drag";break;case"touchend":if(!this.touchActive)return;e.touches.length?this.start(this.mouse.x,this.mouse.y):(this.touchActive=!1,this.unbind("touchstart",window),this.unbind("touchmove",window),this.unbind("touchend",window),this.bind("touchstart",this.element),this.end(),s="end")}s&&this.events.emit(s,[this,e]),e.preventDefault()}}},Momentum.prototype={pointsLength:5,friction:Math.pow(.87,.06),threshold:1e-5,time:function(){return window.performance&&window.performance.now?window.performance.now():Date.now?Date.now():(new Date).getTime()},push:function(e,t,i){this.point.x=+e||0,this.point.y=+t||0,this.point.z=+i||0,this.point.t=this.time(),this.points.push({x:this.point.x,y:this.point.y,z:this.point.z,t:this.point.t});var n=this.points.length-this.pointsLength;n>0&&this.points.splice(0,n)},updateSpeed:function(){this.speed0=Math.sqrt(this.speed.x*this.speed.x+this.speed.y*this.speed.y+this.speed.z*this.speed.z)},updateAccel:function(e){this.limit=1/(1-this.friction)},updateTarget:function(){this.target.x=this.point.x+this.speed.x*this.limit,this.target.y=this.point.y+this.speed.y*this.limit,this.target.z=this.point.z+this.speed.z*this.limit},updateDistance:function(){this.delta.x=this.target.x-this.point.x,this.delta.y=this.target.y-this.point.y,this.delta.z=this.target.z-this.point.z,this.distance=Math.sqrt(this.delta.x*this.delta.x+this.delta.y*this.delta.y+this.delta.z*this.delta.z)},updateDuration:function(){this.duration=Math.log(this.threshold/this.speed0)/Math.log(this.friction)},go:function(){if(!(this.points.length<2)){var e=this.points[0],t=this.point.x-e.x,i=this.point.y-e.y,n=this.point.z-e.z,s=this.point.t-e.t;this.speed.x=t/s,this.speed.y=i/s,this.speed.z=n/s,this.updateSpeed(),this.updateAccel(),this.updateTarget(),this.updateDuration(),this.updateDistance(),this.start()}},to:function(e,t,i){this.target.x=+e||0,this.target.y=+t||0,this.target.z=+i||0,this.updateDistance(),this.updateAccel(),this.speed.x=this.delta.x/this.limit,this.speed.y=this.delta.y/this.limit,this.speed.z=this.delta.z/this.limit,this.updateSpeed(),this.updateDuration(),this.start()},tot:function(e,t,i,n){this.duration=+e||0,this.target.x=+t||0,this.target.y=+i||0,this.target.z=+n||0,this.updateDistance(),this.updateAccel();var s=this.duration,r=this.distance;this.speed.x=this.delta.x/this.limit,this.speed.y=this.delta.y/this.limit,this.speed.z=this.delta.z/this.limit,this.updateSpeed(),this.updateDuration(),this.updateTarget(),this.updateDistance();for(var o=0;Math.abs(s-this.duration)/s>1e-4||Math.abs(r-this.distance)/r>1e-4;){this.friction=Math.pow(this.threshold/this.speed0,1/s),this.limit=1/(1-this.friction),this.updateTarget(),this.updateDistance();var a=r/this.distance;if(this.speed.x*=a,this.speed.y*=a,this.speed.z*=a,this.updateSpeed(),this.updateDuration(),++o>10)break}this.updateTarget(),this.updateDistance(),this.start()},update:function(){if(this.ended=!1,this.active){this.timeNow=this.time(),this.timeDelta=Math.round(this.timeNow-this.timeLast),this.timeLast+=this.timeDelta;for(var e=0,t=0;t<this.timeDelta;t++)e+=Math.pow(this.friction,t);this.delta.x=this.speed.x*e,this.delta.y=this.speed.y*e,this.delta.z=this.speed.z*e,this.point.x+=this.delta.x,this.point.y+=this.delta.y,this.point.z+=this.delta.z;var i=Math.pow(this.friction,this.timeDelta);this.speed.x*=i,this.speed.y*=i,this.speed.z*=i,this.updateSpeed(),this.speed0<this.threshold&&(this.ended=!0,this.stop())}},start:function(){this.updateSpeed(),this.debug&&console.log(this.debug,"start",this.speed0<this.threshold),this.speed0<this.threshold||(this.timeLast=this.time(),this.timeStart=this.timeLast,this.timeEnd=this.timeStart+this.duration,this.active=!0)},stop:function(){this.debug&&console.log(this.debug,"stop",this.active),this.active&&(this.points=[],this.active=!1)}},Block=f.unit({unitName:"Block",etag:"div",ename:"block",visibleMethod:dom.display,cacheSize:!0,x:0,y:0,init:function(e){f.copy(this,e),this.watchAtlas=[],this.watchLocale=[],this.watchEvents=[];for(var t=0;t<this.protochain.length;t++)this.invoke(this.protochain[t],"create");for(var t=0;t<this.protochain.length;t++)this.invoke(this.protochain[t],"createPost")},invoke:function(e,t){if(Object.prototype.hasOwnProperty.call(e,t)&&"function"==typeof e[t])return e[t].call(this)},create:function(){this.events||(this.events=new EventEmitter),this.visible||(this.visible=new Gate(Gate.AND,!this.hidden)),this.element||(this.element=dom.elem(this.etag,null,this.eroot))},createPost:function(){dom.addclass(this.element,this.ename),this.visible.events.on("change",this.visibleMethod,this,this.element),this.visible.check(!0),this.text&&dom.text(this.element,this.text),this.elabel&&this.watchLocale.push(Locale.setText(dom.div("block-label",this.element),this.elabel)),this.etext&&this.watchLocale.push(Locale.setText(this.element,this.etext)),this.etitle&&this.watchLocale.push(Locale.setTitle(this.element,this.etitle)),this.eicon&&(dom.addclass(this.element,"eicon"),this.watchAtlas.push(Atlas.set(this.element,this.eicon,"absmid")))},destroy:function(){this.watchAtlas.forEach(Atlas.free),this.watchAtlas=[],this.watchLocale.forEach(Locale.unwatch),this.watchLocale=[],this.watchEvents.forEach(f.func("release")),this.watchEvents=[],dom.remove(this.element)},resize:function(e,t){e|=0,t|=0,this.cacheSize&&this.width===e&&this.height===t||(this.element.style.width=e+"px",this.element.style.height=t+"px",this.width=e,this.height=t,this.onresize())},autoresize:function(){var e=this.element.offsetWidth,t=this.element.offsetHeight;this.cacheSize&&this.width===e&&this.height===t||(this.width=e,this.height=t,this.onresize())},onresize:function(){}}),Block.Toggle=f.unit(Block,{unitName:"Block_Toggle",ename:"toggle",active:!0,reset:!1,disabled:!1,deselect:!0,
auto:!0,create:function(){this.watchEvents.push(new EventHandler(this.ontap,this).listen("tap",this.element),new EventHandler(this.onover,this).listen("mouseenter",this.element))},createPost:function(){this.update()},ontap:function(){this.auto&&this.toggle(!0)},onover:function(){this.events.emit("hover",this)},toggle:function(e){this.set(!this.active,e)},set:function(e,t,i){return!(!i&&(this.disabled||this.active==e||!this.deselect&&!e))&&(this.reset||(this.active=e,this.update()),t&&(this.events.emit("change",e),this.events.emit(e?"active":"inactive",e)),!0)},update:function(){dom.togclass(this.element,"active",this.active),dom.togclass(this.element,"disabled",this.disabled),dom.togclass(this.element,"hand",!this.disabled&&(this.deselect||!this.active))}}),Block.List=f.unit(Block,{unitName:"Block_List",ename:"list",cname:"list-item",blocks:null,items:null,options:{ename:"list-item",factory:Block},create:function(){this.blocks=[],this.container=this.element},createPost:function(){this.addItemList(this.items)},addItemList:function(e){e&&e.forEach(this.addItem,this)},addItem:function(e){"string"==typeof e&&(e={data:e});var t=f.merge({eroot:this.container},this.options,e);return this.addBlock(new t.factory(t))},addBlock:function(e){return this.blocks.push(e),this.events.emit("block_add",e),e},removeBlock:function(e,t){var i=this.blocks.indexOf(e);return i!==-1&&(this.blocks.splice(i,1),t?e.destroy():dom.remove(e.element),!0)},destroy:function(){Block.prototype.destroy.call(this),this.clearBlocks(!0)},clearBlocks:function(e){for(var t=this.blocks.length-1;t>=0;t--)this.removeBlock(this.blocks[t],e)}}),Block.Menu=f.unit(Block.List,{unitName:"Block_Menu",ename:"menu",active:-1,deselect:!1,options:{ename:"menu-item",factory:Block.Toggle},addBlock:function(e){return e.events.when({change:this.onitemchange,hover:this.onitemhover},this,e),e.set(0),Block.List.prototype.addBlock.call(this,e)},removeBlock:function(e,t){var i=Block.List.prototype.removeBlock.call(this,e,t);return i&&e.events.off(null,null,this),i},update:function(){for(var e=this.blocks.length-1;e>=0;e--){var t=this.blocks[e];if(this.deselect||(t.disabled=t.active),t.active)return this.active=e,this.activeBlock=t,void(this.activeItem=t.data)}this.active=-1,this.activeBlock=null,this.activeItem=null},onitemchange:function(e,t){this.unsetBlocks(e),this.update(),this.events.emit("change",this.activeItem)},onitemhover:function(e){this.events.emit("hover",e)},set:function(e,t){var i=this.blocks[e];i!==this.activeBlock&&(this.unsetBlocks(i,t),i&&i.set(1,t),this.update())},getIndex:function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];if(i.hasOwnProperty("data")&&i.data===e)return t}return-1},setItem:function(e,t){this.set(this.getIndex(e),t)},unsetBlocks:function(e,t){for(var i=0;i<this.blocks.length;i++){var n=this.blocks[i];n!==e&&n.set(0,t)&&(this.deselect||(n.disabled=!1))}}}),Block.Tip=f.unit(Block,{unitName:"Block_Tip",ename:"tip",align:null,distance:8,arrowWidth:12,arrowPadding:8,animationTime:200,tweenDistance:20,create:function(){this.arrow=dom.div("tip-arrow",this.element),this.content=dom.div("tip-content",this.element),this.arrowPoint={x:0,y:0},this.elementPoint={x:0,y:0},this.transitionTween=new TWEEN.Tween({o:0,x:0,y:0}).easing(TWEEN.Easing.Cubic.Out).to({},this.animationTime).onStart(this.onTransitionStart,this).onUpdate(this.onTransitionUpdate,this).onComplete(this.onTransitionEnd,this)},moveToElement:function(e,t,i){if(e){var n=e.offsetWidth,s=e.offsetHeight,r=dom.offset(e,this.element.offsetParent);null==t&&(t=this.align||this.getAlign(r.x,r.y,n,s));var o=r.x,a=r.y;switch(t){case"left":a+=s/2;break;case"right":o+=n,a+=s/2;break;case"top":o+=n/2;break;case"bottom":o+=n/2,a+=s}this.move(o,a,t,i)}},move:function(e,t,i,n){null==i&&(i=this.align||this.getAlign(e,t,0,0));var s=this.element.offsetParent;if(s){var r,o,a,l,h,c=this.arrowWidth/2,u=this.arrowPadding,d=n||this.distance,p=this.element.offsetWidth,f=this.element.offsetHeight,m=s.offsetWidth,v=s.offsetHeight,g=p/2,b=f/2;switch(i){case"left":r=!1,o=e-p-d,a=t-b,l=p,h=b;break;case"right":r=!1,o=e+d,a=t-b,l=0,h=b;break;case"top":r=!0,o=e-g,a=t-d-f,l=g,h=f;break;case"bottom":r=!0,o=e-g,a=t+d,l=g,h=0;break;default:return}var y=Math.max(0,-o);y&&(r&&(l-=Math.min(g-c-u,y)),o+=y);var w=Math.max(0,o+p-m);w&&(r&&(l+=Math.min(g-c-u,w)),o-=w);var E=Math.max(0,-a);E&&(r||(h-=Math.min(b-c-u,E)),a+=E);var x=Math.max(0,a+f-v);switch(x&&(r||(h+=Math.min(b-c-u,x)),a-=x),i){case"left":d+=w-y;break;case"right":d+=y-w;break;case"top":d+=x-E;break;case"bottom":d+=E-x}this.arrowPoint.x===l&&this.arrowPoint.y===h&&Math.abs(this.elementPoint.x-o)<2&&Math.abs(this.elementPoint.y-a)<2&&this.lastDistance===d&&this.lastAlign===i||(this.arrowPoint.x=l,this.arrowPoint.y=h,this.elementPoint.x=o,this.elementPoint.y=a,this.lastDistance=d,this.lastAlign=i,this.updateTransform())}},updateTransform:function(){var e=this.transitionTween.source,t=this.arrowPoint,i=this.elementPoint;this.transform(this.element,i.x+e.x,i.y+e.y),this.arrow.style.left=t.x+"px",this.arrow.style.top=t.y+"px"},transform:function(e,t,i,n){var s=" translateX("+f.hround(t||0)+"px) translateY("+f.hround(i||0)+"px)      scale("+f.hround(n||1)+")";e.style.webkitTransform=s,e.style.mozTransform=s,e.style.msTransform=s,e.style.OTransform=s,e.style.transform=s},getAlign:function(e,t,i,n){var s=this.element.offsetParent;if(!s)return null;var r=s.offsetWidth,o=s.offsetHeight,a=this.element.offsetWidth,l=this.element.offsetHeight,h=t,c=r-e-i,u=o-t-n,d=e,p=["top","right","bottom","left"],f=[h-l,c-a,u-l,d-a],m=Math.max.apply(null,f),v=f.indexOf(m);return p[v]},visibleMethod:function(e,t){var i=this.transitionTween.source,n=this.transitionTween.target,s=this.tweenDistance,r={left:s,right:-s}[this.lastAlign]||0,o={top:s,bottom:-s}[this.lastAlign]||0;return this.initVisible?(n.x=t?0:r,n.y=t?0:o,n.o=+t,this.visible.value&&dom.append(this.tipRoot,this.element),void this.transitionTween.start()):(this.initVisible=!0,i.x=t?r:0,i.y=t?o:0,i.o=+!t,this.onTransitionUpdate(),void this.onTransitionEnd())},onTransitionStart:function(){this.inTransition=!0},onTransitionUpdate:function(){var e=this.transitionTween.source;this.element.style.opacity=e.o,this.updateTransform()},onTransitionEnd:function(){this.visible.value||dom.remove(this.element),this.inTransition=!1}}),Atlas={svg:null,items:[],setSource:function(e){e&&(Atlas.svg=e.documentElement||e,Atlas.svg.removeAttribute("width"),Atlas.svg.removeAttribute("height"),Atlas.update())},update:function(){Atlas.items.forEach(Atlas.updateItem)},set:function(e,t,i){var n=f.apick(Atlas.items,"element",e);return n||(n={element:e},Atlas.items.push(n)),n.id=t,n.name=i,Atlas.svg&&Atlas.updateItem(n),e},free:function(e){for(var t=Atlas.items.length-1;t>=0;t--){var i=Atlas.items[t];if(i.element===e)return dom.remove(i.icon),void Atlas.items.splice(t,1)}},updateItem:function(e){var t=Atlas.get(e.id);t?e.name&&(t.className.baseVal+=" "+e.name):(t=dom.div(e.name),dom.text(t,e.id)),e.icon?(dom.insert(e.element,t,e.icon),dom.remove(e.icon)):dom.append(e.element,t),e.icon=t},get:function(e){if(!Atlas.svg)return null;var t=Atlas.svg.getElementById(e);if(!t)return null;var i=Atlas.svg.cloneNode(!1);return i.appendChild(t.cloneNode(!0)),i.className.baseVal=e,i}},Locale={name:null,data:null,counter:0,assets:{},items:[],add:function(e,t){var i=Locale.assets[e];i||(i=Locale.assets[e]={});for(var n in t)i[n]=t[n]},get:function(e){return Locale.data&&e in Locale.data?Locale.data[e]:Locale.name+"/"+e},set:function(e){Locale.name=e,Locale.data=Locale.assets[Locale.name],Locale.update()},update:function(){Locale.items.forEach(Locale.updateItem)},updateItem:function(e){e.func.call(e.scope,Locale.get(e.token),e.data)},watch:function(e,t,i,n){var s={id:++Locale.counter,token:e,func:t,scope:i,data:n};return Locale.items.push(s),Locale.updateItem(s),s.id},unwatch:function(e){for(var t=Locale.items.length-1;t>=0;t--)if(Locale.items[t].id===e)return void Locale.items.splice(t,1)},setText:function(e,t){return Locale.watch(t,Locale._setText,null,e)},setTitle:function(e,t){return Locale.watch(t,Locale._setAttribute,null,{element:e,name:"title"})},setAttribute:function(e,t,i){return Locale.watch(i,Locale._setAttribute,null,{element:t,name:e})},setHtml:function(e,t){return Locale.watch(t,Locale._setHtml,null,e)},_setAttribute:function(e,t){t.element.setAttribute(t.name,e)},_setText:function(e,t){dom.text(t,e)},_setHtml:function(e,t){dom.html(t,e)}},THREE.Plane.prototype.intersectPlane=function(e,t){for(var i=1e-9,n=this.normal.toArray(),s=this.constant,r=e.normal.toArray(),o=e.constant,a=0;a<6;a++){var l=a<2?1:0,h=a<4?2:1,c=a>>1,u=a%2?l:h,d=a%2?h:l,p=n[c],f=n[u],m=r[c],v=r[u],g=v*p-f*m,b=(m*s-p*o)/g,y=-(f*b+s)/p;if(Math.abs(p)>i&&Math.abs(g)>i){var w=t||new THREE.Ray;return w.direction.crossVectors(this.normal,e.normal).normalize(),w.origin.setComponent(c,y),w.origin.setComponent(u,b),w.origin.setComponent(d,0),w}}},THREE.Box2.prototype.emptyEPS=function(){var e=1e-9;return this.max.x-this.min.x<e||this.max.y-this.min.y<e},THREE.Ray.prototype.atY=function(e,t){var i=(e-this.origin.y)/this.direction.y;return this.at(i,t)},THREE.Ray.prototype.distanceToPlane=function(e,t){var i=e.normal.dot(this.direction);if(0==i)return 0==e.distanceToPoint(this.origin)?0:null;var n=-(this.origin.dot(e.normal)+e.constant)/i;return t||n>=0?n:null},THREE.Ray.prototype.intersectPlane=function(e,t,i){var n=this.distanceToPlane(e,i);return null===n?null:this.at(n,t)},THREE.Sphere.prototype.expandByPoint=function(e){this.center.sub(e);var t=this.center.length()+this.radius;return this.radius=t/2,this.center.setLength(t),this.center.add(e),this},THREE.Sphere.prototype.union=function(e){this.center.sub(e.center);var t=this.center.length()+this.radius,i=t+e.radius;return this.radius=i/2,this.center.setLength(t),this.center.add(e.center),this.center.lerp(e.center,i/t),this},THREE.OrbitControls=function(e,t){function i(){return 2*Math.PI/60/60*f.autoRotateSpeed}function n(){return Math.pow(.95,f.zoomSpeed)}function s(e){if(f.enabled!==!1){if(e.preventDefault(),f.down=!0,0===e.button){if(f.noRotate===!0)return;I=L.ROTATE,v.set(e.clientX,e.clientY)}else if(1===e.button){if(f.noZoom===!0)return;I=L.DOLLY,_.set(e.clientX,e.clientY)}else if(2===e.button){if(f.noPan===!0)return;I=L.PAN,y.set(e.clientX,e.clientY)}document.addEventListener("mousemove",r,!1),document.addEventListener("mouseup",o,!1),f.dispatchEvent(D)}}function r(e){if(f.enabled!==!1){e.preventDefault();var t=f.domElement===document?f.domElement.body:f.domElement,i=t.clientWidth,n=t.clientHeight,s=f.object.position,r=s.clone().sub(f.target),o=r.length();if(o*=Math.tan(f.object.fov/2*Math.PI/180),I===L.ROTATE){if(f.noRotate===!0)return;g.set(e.clientX,e.clientY),b.subVectors(g,v),f.rotateLeft(2*Math.PI*b.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*b.y/t.clientHeight*f.rotateSpeed),v.copy(g)}else if(I===L.DOLLY){if(f.noZoom===!0)return;k.set(e.clientX,e.clientY),R.subVectors(k,_),f.panUp(2*R.y*o/n),_.copy(k)}else if(I===L.PAN){if(f.noPan===!0)return;w.set(e.clientX,e.clientY),E.subVectors(w,y),f.panLeft(2*E.x*o/i),f.panForward(2*E.y*o/n),y.copy(w)}f.update()}}function o(){f.enabled!==!1&&(f.down=!1,document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",o,!1),f.dispatchEvent(B),I=L.NONE)}function a(e){if(f.enabled!==!1&&f.noZoom!==!0){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.deltaY?t=-e.deltaY:void 0!==e.detail&&(t=-e.detail),t>0?f.dollyOut():f.dollyIn(),f.update(),f.dispatchEvent(D),f.dispatchEvent(B)}}function l(e){if(f.enabled===!1||f.noKeys===!0||f.noPan===!0)return!1;switch(e.keyCode){case f.keys.UP:f.pan(0,f.keyPanSpeed),f.update();break;case f.keys.BOTTOM:f.pan(0,-f.keyPanSpeed),f.update();break;case f.keys.LEFT:f.pan(f.keyPanSpeed,0),f.update();break;case f.keys.RIGHT:f.pan(-f.keyPanSpeed,0),f.update();break;default:return!1}return!0}function h(e){if(f.enabled!==!1){switch(e.touches.length){case 1:if(f.noRotate===!0)return;I=L.TOUCH_ROTATE,v.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(f.noZoom===!0)return;I=L.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);_.set(0,n);break;case 3:if(f.noPan===!0)return;I=L.TOUCH_PAN,y.set(e.touches[0].pageX,e.touches[0].pageY);break;default:I=L.NONE}f.dispatchEvent(D)}}function c(e){if(f.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=f.domElement===document?f.domElement.body:f.domElement;switch(e.touches.length){case 1:if(f.noRotate===!0)return;if(I!==L.TOUCH_ROTATE)return;g.set(e.touches[0].pageX,e.touches[0].pageY),b.subVectors(g,v),f.rotateLeft(2*Math.PI*b.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*b.y/t.clientHeight*f.rotateSpeed),v.copy(g),f.update();break;case 2:if(f.noZoom===!0)return;if(I!==L.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,s=Math.sqrt(i*i+n*n);k.set(0,s),S*=_.y/k.y,_.copy(k),f.update();break;case 3:if(f.noPan===!0)return;if(I!==L.TOUCH_PAN)return;w.set(e.touches[0].pageX,e.touches[0].pageY),E.subVectors(w,y),f.pan(E.x,E.y),y.copy(w),f.update();break;default:I=L.NONE}}}function u(){f.enabled!==!1&&(f.dispatchEvent(B),I=L.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=2,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.borderBox=new THREE.Box3;var d=this.borderBox.min,p=this.borderBox.max;d.x=d.y=d.z=-(1/0),p.x=p.y=p.z=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var f=this,m=1e-6,v=new THREE.Vector2,g=new THREE.Vector2,b=new THREE.Vector2,y=new THREE.Vector2,w=new THREE.Vector2,E=new THREE.Vector2,x=new THREE.Vector3,T=new THREE.Vector3,_=new THREE.Vector2,k=new THREE.Vector2,R=new THREE.Vector2,M=0,C=0,S=1,A=new THREE.Vector3,N=new THREE.Vector3,H=new THREE.Quaternion,L={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},I=L.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var O=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),P=O.clone().inverse(),j={type:"change"},D={type:"start"},B={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=i()),C-=e},this.rotateUp=function(e){void 0===e&&(e=i()),M-=e},this.panLeft=function(e){var t=this.object.matrix.elements;x.set(t[0],t[1],t[2]);var i=x.length();x.y=0,x.setLength(i),x.multiplyScalar(-e),A.add(x)},this.panUp=function(e){var t=this.object.matrix.elements;x.set(t[4],t[5],t[6]);var i=x.length();x.x=x.z=0,x.setLength(i),x.multiplyScalar(e),A.add(x)},this.panForward=function(e){var t=this.object.matrix.elements;x.set(t[8],t[9],t[10]);var i=x.length();x.y=0,x.setLength(i),x.multiplyScalar(-e),A.add(x)},this.pan=function(e,t){var i=f.domElement===document?f.domElement.body:f.domElement;if(void 0!==f.object.fov){var n=f.object.position,s=n.clone().sub(f.target),r=s.length();r*=Math.tan(f.object.fov/2*Math.PI/180),f.panLeft(2*e*r/i.clientHeight),f.panUp(2*t*r/i.clientHeight)}else void 0!==f.object.top?(f.panLeft(e*(f.object.right-f.object.left)/i.clientWidth),f.panUp(t*(f.object.top-f.object.bottom)/i.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=n()),S/=e},this.dollyOut=function(e){void 0===e&&(e=n()),S*=e},this.update=function(){var e=this.object.position;T.copy(e).sub(this.target),T.applyQuaternion(O);var t=Math.atan2(T.x,T.z),n=Math.atan2(Math.sqrt(T.x*T.x+T.z*T.z),T.y);this.autoRotate&&this.rotateLeft(i()),t+=C,n+=M,this.disableBorders||(n=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,n))),n=Math.max(m,Math.min(Math.PI-m,n)),this.radius=T.length()*S,this.disableBorders||(this.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this.radius))),this.target.add(A),this.disableBorders||this.borderBox.isEmpty()||(this.target.min(this.borderBox.max),this.target.max(this.borderBox.min)),T.x=this.radius*Math.sin(n)*Math.sin(t),T.y=this.radius*Math.cos(n),T.z=this.radius*Math.sin(n)*Math.cos(t),T.applyQuaternion(P),e.copy(this.target).add(T),T.lengthSq()&&this.object.lookAt(this.target),C=0,M=0,S=1,A.set(0,0,0),(N.distanceToSquared(this.object.position)>m||8*(1-H.dot(this.object.quaternion))>m)&&(this.changed=!0,this.dispatchEvent(j),N.copy(this.object.position),H.copy(this.object.quaternion))},this.reset=function(){I=L.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.domElement.addEventListener("contextmenu",function(e){f.enabled!==!1&&e.preventDefault()},!1),this.onKeyDown=l,this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("wheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1),this.domElement.addEventListener("touchstart",h,!1),this.domElement.addEventListener("touchend",u,!1),this.domElement.addEventListener("touchmove",c,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),function(){"use strict";var e=function(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};e.prototype=Object.create(THREE.MeshBasicMaterial.prototype),e.prototype.constructor=e;var t=function(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};t.prototype=Object.create(THREE.LineBasicMaterial.prototype),t.prototype.constructor=t;var i=new e({visible:!1,transparent:!1});THREE.TransformGizmo=function(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),i={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};this.activePlane=i.XYZE,i.YZ.rotation.set(0,Math.PI/2,0),i.XZ.rotation.set(-Math.PI/2,0,0);for(var n in i)i[n].name=n,this.planes.add(i[n]),this.planes[n]=i[n];var s=function(e,t){for(var i in e)for(n=e[i].length;n--;){var s=e[i][n][0],r=e[i][n][1],o=e[i][n][2];s.name=i,r&&s.position.set(r[0],r[1],r[2]),o&&s.rotation.set(o[0],o[1],o[2]),t.add(s)}};s(this.handleGizmos,this.handles),s(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof THREE.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name===e?t.material.highlight(!0):t.material.highlight(!1))})}},THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformGizmo.prototype.constructor=THREE.TransformGizmo,THREE.TransformGizmo.prototype.update=function(e,t){var i=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,1,0),s=new THREE.Matrix4;this.traverse(function(r){r.name.search("E")!==-1?r.quaternion.setFromRotationMatrix(s.lookAt(t,i,n)):r.name.search("X")===-1&&r.name.search("Y")===-1&&r.name.search("Z")===-1||r.quaternion.setFromEuler(e)})},THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var n=new THREE.Geometry,s=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));s.position.y=.5,s.updateMatrix(),n.merge(s.geometry,s.matrix);var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(n,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(r,new t({color:16711680}))]],Y:[[new THREE.Mesh(n,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(n,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new e({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),i)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()},THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoTranslate.prototype.constructor=THREE.TransformGizmoTranslate,THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var e=function(e,t,i){var n=new THREE.BufferGeometry,s=[];i=i?i:1;for(var r=0;r<=64*i;++r)"x"===t&&s.push(0,Math.cos(r/32*Math.PI)*e,Math.sin(r/32*Math.PI)*e),"y"===t&&s.push(Math.cos(r/32*Math.PI)*e,0,Math.sin(r/32*Math.PI)*e),"z"===t&&s.push(Math.sin(r/32*Math.PI)*e,Math.cos(r/32*Math.PI)*e,0);return n.addAttribute("position",new THREE.Float32BufferAttribute(s,3)),n};this.handleGizmos={X:[[new THREE.Line(new e(1,"x",.5),new t({color:16711680}))]],Y:[[new THREE.Line(new e(1,"y",.5),new t({color:65280}))]],Z:[[new THREE.Line(new e(1,"z",.5),new t({color:255}))]],E:[[new THREE.Line(new e(1.25,"z",1),new t({color:13421568}))]],XYZE:[[new THREE.Line(new e(1,"z",1),new t({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.12,2,24),i)]],XYZE:[[new THREE.Mesh]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){THREE.TransformGizmo.prototype.update.apply(this,arguments);var i=({handles:this.handles,pickers:this.pickers},new THREE.Matrix4),n=new THREE.Euler(0,0,1),s=new THREE.Quaternion,r=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,h=new THREE.Quaternion,c=new THREE.Quaternion,u=t.clone();n.copy(this.planes.XY.rotation),s.setFromEuler(n),i.makeRotationFromQuaternion(s).getInverse(i),u.applyMatrix4(i),this.traverse(function(e){s.setFromEuler(n),"X"===e.name&&(l.setFromAxisAngle(r,Math.atan2(-u.y,u.z)),s.multiplyQuaternions(s,l),e.quaternion.copy(s)),"Y"===e.name&&(h.setFromAxisAngle(o,Math.atan2(u.x,u.z)),s.multiplyQuaternions(s,h),e.quaternion.copy(s)),"Z"===e.name&&(c.setFromAxisAngle(a,Math.atan2(u.y,u.x)),s.multiplyQuaternions(s,c),e.quaternion.copy(s))})},this.init()},THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoRotate.prototype.constructor=THREE.TransformGizmoRotate,THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var n=new THREE.Geometry,s=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));s.position.y=.5,s.updateMatrix(),n.merge(s.geometry,s.matrix);var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(n,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(r,new t({color:16711680}))]],Y:[[new THREE.Mesh(n,new e({color:65280})),[0,.5,0]],[new THREE.Line(o,new t({color:65280}))]],Z:[[new THREE.Mesh(n,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),new e({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.4,.4,.4),i)]]},this.setActivePlane=function(e,t){var i=new THREE.Matrix4;t.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()},THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoScale.prototype.constructor=THREE.TransformGizmoScale,THREE.TransformControls=function(e,t){function i(e){if(void 0!==a.object&&h!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e,i=o(t,c[l].pickers.children),n=null;i&&(n=i.object.name,e.preventDefault()),a.axis!==n&&(a.axis=n,a.update(),a.dispatchEvent(p))}}function n(e){if(void 0!==a.object&&h!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var i=o(t,c[l].pickers.children);if(i){e.preventDefault(),e.stopPropagation(),a.dispatchEvent(f),a.axis=i.object.name,a.update(),k.copy(G).sub(V).normalize(),c[l].setActivePlane(a.axis,k);var n=o(t,[c[l].activePlane]);n&&(j.copy(a.object.position),D.copy(a.object.scale),B.extractRotation(a.object.matrix),X.extractRotation(a.object.matrixWorld),z.extractRotation(a.object.parent.matrixWorld),F.setFromMatrixScale(R.getInverse(a.object.parent.matrixWorld)),w.copy(n.point))}}h=!0}}function s(e){if(void 0!==a.object&&null!==a.axis&&h!==!1&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e,i=o(t,[c[l].activePlane]);i!==!1&&(e.preventDefault(),e.stopPropagation(),y.copy(i.point),"translate"===l?(y.sub(w),y.multiply(F),"local"===a.space&&(y.applyMatrix4(R.getInverse(X)),a.axis.search("X")===-1&&(y.x=0),a.axis.search("Y")===-1&&(y.y=0),a.axis.search("Z")===-1&&(y.z=0),y.applyMatrix4(B),a.object.position.copy(j),a.object.position.add(y)),"world"!==a.space&&a.axis.search("XYZ")===-1||(a.axis.search("X")===-1&&(y.x=0),a.axis.search("Y")===-1&&(y.y=0),a.axis.search("Z")===-1&&(y.z=0),y.applyMatrix4(R.getInverse(z)),a.object.position.copy(j),a.object.position.add(y)),null!==a.translationSnap&&("local"===a.space&&a.object.position.applyMatrix4(R.getInverse(X)),a.axis.search("X")!==-1&&(a.object.position.x=Math.round(a.object.position.x/a.translationSnap)*a.translationSnap),a.axis.search("Y")!==-1&&(a.object.position.y=Math.round(a.object.position.y/a.translationSnap)*a.translationSnap),a.axis.search("Z")!==-1&&(a.object.position.z=Math.round(a.object.position.z/a.translationSnap)*a.translationSnap),"local"===a.space&&a.object.position.applyMatrix4(X))):"scale"===l?(y.sub(w),y.multiply(F),"local"===a.space&&("XYZ"===a.axis?(T=1+y.y/Math.max(D.x,D.y,D.z),a.object.scale.x=D.x*T,a.object.scale.y=D.y*T,a.object.scale.z=D.z*T):(y.applyMatrix4(R.getInverse(X)),"X"===a.axis&&(a.object.scale.x=D.x*(1+y.x/D.x)),"Y"===a.axis&&(a.object.scale.y=D.y*(1+y.y/D.y)),"Z"===a.axis&&(a.object.scale.z=D.z*(1+y.z/D.z))))):"rotate"===l&&(y.sub(V),y.multiply(F),M.copy(w).sub(V),M.multiply(F),"E"===a.axis?(y.applyMatrix4(R.getInverse(_)),M.applyMatrix4(R.getInverse(_)),E.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.set(Math.atan2(M.z,M.y),Math.atan2(M.x,M.z),Math.atan2(M.y,M.x)),C.setFromRotationMatrix(R.getInverse(z)),P.setFromAxisAngle(k,E.z-x.z),H.setFromRotationMatrix(X),C.multiplyQuaternions(C,P),C.multiplyQuaternions(C,H),a.object.quaternion.copy(C)):"XYZE"===a.axis?(P.setFromEuler(y.clone().cross(M).normalize()),C.setFromRotationMatrix(R.getInverse(z)),L.setFromAxisAngle(P,-y.clone().angleTo(M)),H.setFromRotationMatrix(X),C.multiplyQuaternions(C,L),C.multiplyQuaternions(C,H),a.object.quaternion.copy(C)):"local"===a.space?(y.applyMatrix4(R.getInverse(X)),M.applyMatrix4(R.getInverse(X)),E.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.set(Math.atan2(M.z,M.y),Math.atan2(M.x,M.z),Math.atan2(M.y,M.x)),H.setFromRotationMatrix(B),null!==a.rotationSnap?(L.setFromAxisAngle(S,Math.round((E.x-x.x)/a.rotationSnap)*a.rotationSnap),I.setFromAxisAngle(A,Math.round((E.y-x.y)/a.rotationSnap)*a.rotationSnap),O.setFromAxisAngle(N,Math.round((E.z-x.z)/a.rotationSnap)*a.rotationSnap)):(L.setFromAxisAngle(S,E.x-x.x),I.setFromAxisAngle(A,E.y-x.y),O.setFromAxisAngle(N,E.z-x.z)),"X"===a.axis&&H.multiplyQuaternions(H,L),"Y"===a.axis&&H.multiplyQuaternions(H,I),"Z"===a.axis&&H.multiplyQuaternions(H,O),a.object.quaternion.copy(H)):"world"===a.space&&(E.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.set(Math.atan2(M.z,M.y),Math.atan2(M.x,M.z),Math.atan2(M.y,M.x)),C.setFromRotationMatrix(R.getInverse(z)),null!==a.rotationSnap?(L.setFromAxisAngle(S,Math.round((E.x-x.x)/a.rotationSnap)*a.rotationSnap),I.setFromAxisAngle(A,Math.round((E.y-x.y)/a.rotationSnap)*a.rotationSnap),O.setFromAxisAngle(N,Math.round((E.z-x.z)/a.rotationSnap)*a.rotationSnap)):(L.setFromAxisAngle(S,E.x-x.x),I.setFromAxisAngle(A,E.y-x.y),O.setFromAxisAngle(N,E.z-x.z)),H.setFromRotationMatrix(X),"X"===a.axis&&C.multiplyQuaternions(C,L),"Y"===a.axis&&C.multiplyQuaternions(C,I),"Z"===a.axis&&C.multiplyQuaternions(C,O),C.multiplyQuaternions(C,H),a.object.quaternion.copy(C))),a.update(),a.dispatchEvent(p),a.dispatchEvent(v))}}function r(e){e.preventDefault(),void 0!==e.button&&0!==e.button||(h&&null!==a.axis&&(m.mode=l,a.dispatchEvent(m)),h=!1,"TouchEvent"in window&&e instanceof TouchEvent?(a.axis=null,
a.update(),a.dispatchEvent(p)):i(e))}function o(i,n){var s=t.getBoundingClientRect(),r=(i.clientX-s.left)/s.width,o=(i.clientY-s.top)/s.height;b.set(2*r-1,-(2*o)+1),g.setFromCamera(b,e);var a=g.intersectObjects(n,!0);return!!a[0]&&a[0]}THREE.Object3D.call(this),t=void 0!==t?t:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null;var a=this,l="translate",h=!1,c={translate:new THREE.TransformGizmoTranslate,rotate:new THREE.TransformGizmoRotate,scale:new THREE.TransformGizmoScale};for(var u in c){var d=c[u];d.visible=u===l,this.add(d)}var p={type:"change"},f={type:"mouseDown"},m={type:"mouseUp",mode:l},v={type:"objectChange"},g=new THREE.Raycaster,b=new THREE.Vector2,y=new THREE.Vector3,w=new THREE.Vector3,E=new THREE.Vector3,x=new THREE.Vector3,T=1,_=new THREE.Matrix4,k=new THREE.Vector3,R=new THREE.Matrix4,M=new THREE.Vector3,C=new THREE.Quaternion,S=new THREE.Vector3(1,0,0),A=new THREE.Vector3(0,1,0),N=new THREE.Vector3(0,0,1),H=new THREE.Quaternion,L=new THREE.Quaternion,I=new THREE.Quaternion,O=new THREE.Quaternion,P=new THREE.Quaternion,j=new THREE.Vector3,D=new THREE.Vector3,B=new THREE.Matrix4,z=new THREE.Matrix4,F=new THREE.Vector3,V=new THREE.Vector3,U=new THREE.Euler,X=new THREE.Matrix4,G=new THREE.Vector3,Y=new THREE.Euler;t.addEventListener("mousedown",n,!1),t.addEventListener("touchstart",n,!1),t.addEventListener("mousemove",i,!1),t.addEventListener("touchmove",i,!1),t.addEventListener("mousemove",s,!1),t.addEventListener("touchmove",s,!1),t.addEventListener("mouseup",r,!1),t.addEventListener("mouseout",r,!1),t.addEventListener("touchend",r,!1),t.addEventListener("touchcancel",r,!1),t.addEventListener("touchleave",r,!1),this.dispose=function(){t.removeEventListener("mousedown",n),t.removeEventListener("touchstart",n),t.removeEventListener("mousemove",i),t.removeEventListener("touchmove",i),t.removeEventListener("mousemove",s),t.removeEventListener("touchmove",s),t.removeEventListener("mouseup",r),t.removeEventListener("mouseout",r),t.removeEventListener("touchend",r),t.removeEventListener("touchcancel",r),t.removeEventListener("touchleave",r)},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return l},this.setMode=function(e){l=e?e:l,"scale"===l&&(a.space="local");for(var t in c)c[t].visible=t===l;this.update(),a.dispatchEvent(p)},this.setTranslationSnap=function(e){a.translationSnap=e},this.setRotationSnap=function(e){a.rotationSnap=e},this.setSize=function(e){a.size=e,this.update(),a.dispatchEvent(p)},this.setSpace=function(e){a.space=e,this.update(),a.dispatchEvent(p)},this.update=function(){void 0!==a.object&&(a.object.updateMatrixWorld(),V.setFromMatrixPosition(a.object.matrixWorld),U.setFromRotationMatrix(R.extractRotation(a.object.matrixWorld)),e.updateMatrixWorld(),G.setFromMatrixPosition(e.matrixWorld),Y.setFromRotationMatrix(R.extractRotation(e.matrixWorld)),T=V.distanceTo(G)/6*a.size,this.position.copy(V),this.scale.set(T,T,T),e instanceof THREE.PerspectiveCamera?k.copy(G).sub(V).normalize():e instanceof THREE.OrthographicCamera&&k.copy(G).normalize(),"local"===a.space?c[l].update(U,k):"world"===a.space&&c[l].update(new THREE.Euler,k),c[l].highlight(a.axis))}},THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformControls.prototype.constructor=THREE.TransformControls}(),function(){function e(e){var t=new Map;if("Connections"in e)for(var i=e.Connections.properties.connections,n=0,s=i.length;n<s;++n){var r=i[n];t.has(r[0])||t.set(r[0],{parents:[],children:[]});var o={ID:r[1],relationship:r[2]};t.get(r[0]).parents.push(o),t.has(r[1])||t.set(r[1],{parents:[],children:[]});var a={ID:r[0],relationship:r[2]};t.get(r[1]).children.push(a)}return t}function t(e){var t=new Map;if("Video"in e.Objects.subNodes){var n=e.Objects.subNodes.Video;for(var s in n){var r=n[s];if("Content"in r.properties){var o=i(n[s]);t.set(parseInt(s),o)}}}return t}function i(e){var t,i=e.properties.Content,n=new Uint8Array(i),s=e.properties.RelativeFilename||e.properties.Filename,r=s.slice(s.lastIndexOf(".")+1).toLowerCase();switch(r){case"bmp":t="image/bmp";break;case"jpg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;default:return void console.warn("FBXLoader: No support image type "+r)}return window.URL.createObjectURL(new Blob([n],{type:t}))}function n(e,t,i,n){var r=new Map;if("Texture"in e.Objects.subNodes){var o=e.Objects.subNodes.Texture;for(var a in o){var l=s(o[a],t,i,n);r.set(parseInt(a),l)}}return r}function s(e,t,i,n){var s,r=e.id,o=e.name,a=e.properties.FileName,l=e.properties.RelativeFilename,h=n.get(r).children;if(void 0!==h&&h.length>0&&i.has(h[0].ID))s=i.get(h[0].ID);else if(void 0!==l&&"/"!==l[0]&&null===l.match(/^[a-zA-Z]:/))s=l;else{var c=a.split(/[\\\/]/);s=c.length>0?c[c.length-1]:a}var u=t.path;0===s.indexOf("blob:")&&t.setPath(void 0);var d=t.load(s);d.name=o,d.FBX_ID=r;var p=e.properties.Scaling;p&&(d.repeat.x=p.value[0],d.repeat.y=p.value[1]);var f=e.properties.WrapModeU,m=e.properties.WrapModeV,v=void 0!==f?f.value:0,g=void 0!==m?m.value:0;return d.wrapS=0===v?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,d.wrapT=0===g?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,t.setPath(u),d}function r(e,t,i){var n=new Map;if("Material"in e.Objects.subNodes){var s=e.Objects.subNodes.Material;for(var r in s){var a=o(s[r],t,i);n.set(parseInt(r),a)}}return n}function o(e,t,i){var n=e.id,s=e.attrName,r=e.properties.ShadingModel;"object"==typeof r&&(r=r.value);var o,l=i.get(n).children,h=a(e.properties,t,l);switch(r.toLowerCase()){case"unknown":case"phong":o=new THREE.MeshPhongMaterial;break;case"lambert":o=new THREE.MeshLambertMaterial;break;default:console.warn("No implementation given for material type "+r+" in FBXLoader.js.  Defaulting to basic material"),o=new THREE.MeshBasicMaterial({color:3342591})}return o.setValues(h),o.name=s,o}function a(e,t,i){var n={},s=e.Diffuse||e.DiffuseColor;s&&(n.color=W(s));var r=e.Specular||e.SpecularColor;r&&(n.specular=W(r)),e.Shininess&&(n.shininess=e.Shininess.value);var o=e.Emissive||e.EmissiveColor;o&&(n.emissive=W(o)),e.EmissiveFactor&&(n.emissiveIntensity=e.EmissiveFactor.value),e.Opacity&&(n.opacity=e.Opacity.value),n.opacity<1&&(n.transparent=!0);for(var a=0,l=i.length;a<l;++a){var h=i[a],c=h.relationship;switch(c){case"DiffuseColor":case' "DiffuseColor':case"3dsMax|maps|texmap_diffuse":case' "3dsMax|maps|texmap_diffuse':n.map=t.get(h.ID);break;case"Bump":case' "Bump':case"3dsMax|maps|texmap_bump":case' "3dsMax|maps|texmap_bump':n.bumpMap=t.get(h.ID);break;case"NormalMap":case' "NormalMap':n.normalMap=t.get(h.ID);break;case' "AmbientColor':case' "EmissiveColor':case"AmbientColor":case"EmissiveColor":default:console.warn("Unknown texture application of type "+c+", skipping texture")}}return n}function l(e,t){var i={};if("Deformer"in e.Objects.subNodes){var n=e.Objects.subNodes.Deformer;for(var s in n){var r=n[s];if("Skin"===r.attrType){var o=t.get(parseInt(s)),a=h(o,n);a.FBX_ID=parseInt(s),i[s]=a}}}return i}function h(e,t){for(var i={},n=e.children,s=0,r=n.length;s<r;++s){var o=n[s],a=t[o.ID],l={FBX_ID:o.ID,index:s,indices:[],weights:[],transform:q(a.subNodes.Transform.properties.a),transformLink:q(a.subNodes.TransformLink.properties.a),linkMode:a.properties.Mode};"Indexes"in a.subNodes&&(l.indices=G(a.subNodes.Indexes.properties.a),l.weights=X(a.subNodes.Weights.properties.a)),i[o.ID]=l}return{map:i,bones:[]}}function c(e,t,i){var n=new Map;if("Geometry"in e.Objects.subNodes){var s=e.Objects.subNodes.Geometry;for(var r in s){var o=t.get(parseInt(r)),a=u(s[r],o,i);n.set(parseInt(r),a)}}return n}function u(e,t,i){switch(e.attrType){case"Mesh":return d(e,t,i);case"NurbsCurve":return y(e)}}function d(e,t,i){for(var n=0;n<t.children.length;++n){var s=i[t.children[n].ID];if(void 0!==s)break}return p(e,s)}function p(e,t){var i=new O,n=e.subNodes,s=X(n.Vertices.properties.a),r=G(n.PolygonVertexIndex.properties.a);if(n.LayerElementNormal)var o=f(n.LayerElementNormal[0]);if(n.LayerElementUV)var a=m(n.LayerElementUV[0]);if(n.LayerElementColor)var l=v(n.LayerElementColor[0]);if(n.LayerElementMaterial)var h=g(n.LayerElementMaterial[0]);for(var c=[],u=0,d=0;d<r.length;d++){var p=r[d],y=!1;p<0&&(p^=-1,r[d]=p,y=!0);var w=new H,E=[],x=[];if(w.position.fromArray(s,3*p),t){var T=t.map;for(var _ in T)for(var k=T[_],R=k.indices,M=0;M<R.length;M++){var C=R[M];if(C===p){x.push(k.weights[M]),E.push(k.index);break}}if(x.length>4){console.warn("FBXLoader: Vertex has more than 4 skinning weights assigned to vertex.  Deleting additional weights.");var S=[0,0,0,0],A=[0,0,0,0];x.forEach(function(e,t){var i=e,n=E[t];A.forEach(function(e,t,s){if(i>e){s[t]=i,i=e;var r=S[t];S[t]=n,n=r}})}),E=S,x=A}for(var N=x.length;N<4;++N)x[N]=0,E[N]=0;w.skinWeights.fromArray(x),w.skinIndices.fromArray(E)}if(o&&w.normal.fromArray(b(d,u,p,o)),a&&w.uv.fromArray(b(d,u,p,a)),l&&w.color.fromArray(b(d,u,p,l)),c.push(w),y){var L=new I;if(L.genTrianglesFromVertices(c),void 0!==h){var P=b(d,u,p,h);L.materialIndex=P[0]}else L.materialIndex=0;i.faces.push(L),c=[],u++,y=!1}}var j=i.flattenToBuffers(),D=new THREE.BufferGeometry;D.name=e.name,D.addAttribute("position",new THREE.Float32BufferAttribute(j.vertexBuffer,3)),j.normalBuffer.length>0&&D.addAttribute("normal",new THREE.Float32BufferAttribute(j.normalBuffer,3)),j.uvBuffer.length>0&&D.addAttribute("uv",new THREE.Float32BufferAttribute(j.uvBuffer,2)),n.LayerElementColor&&D.addAttribute("color",new THREE.Float32BufferAttribute(j.colorBuffer,3)),t&&(D.addAttribute("skinIndex",new THREE.Float32BufferAttribute(j.skinIndexBuffer,4)),D.addAttribute("skinWeight",new THREE.Float32BufferAttribute(j.skinWeightBuffer,4)),D.FBX_Deformer=t);for(var B=j.materialIndexBuffer,z=B[0],F=0,N=0;N<B.length;++N)B[N]!==z&&(D.addGroup(F,N-F,z),z=B[N],F=N);return D}function f(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType,n=X(e.subNodes.Normals.properties.a),s=[];return"IndexToDirect"===i&&("NormalIndex"in e.subNodes?s=G(e.subNodes.NormalIndex.properties.a):"NormalsIndex"in e.subNodes&&(s=G(e.subNodes.NormalsIndex.properties.a))),{dataSize:3,buffer:n,indices:s,mappingType:t,referenceType:i}}function m(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType,n=X(e.subNodes.UV.properties.a),s=[];return"IndexToDirect"===i&&(s=G(e.subNodes.UVIndex.properties.a)),{dataSize:2,buffer:n,indices:s,mappingType:t,referenceType:i}}function v(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType,n=X(e.subNodes.Colors.properties.a),s=[];return"IndexToDirect"===i&&(s=X(e.subNodes.ColorIndex.properties.a)),{dataSize:4,buffer:n,indices:s,mappingType:t,referenceType:i}}function g(e){var t=e.properties.MappingInformationType,i=e.properties.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};for(var n=G(e.subNodes.Materials.properties.a),s=[],r=0,o=n.length;r<o;++r)s.push(r);return{dataSize:1,buffer:n,indices:s,mappingType:t,referenceType:i}}function b(e,t,i,n){return te[n.mappingType][n.referenceType](e,t,i,n)}function y(e){if(void 0===THREE.NURBSCurve)return console.error("THREE.FBXLoader relies on THREE.NURBSCurve for any nurbs present in the model.  Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var t=parseInt(e.properties.Order);if(isNaN(t))return console.error("FBXLoader: Invalid Order "+e.properties.Order+" given for geometry ID: "+e.id),new THREE.BufferGeometry;for(var i=t-1,n=X(e.subNodes.KnotVector.properties.a),s=[],r=X(e.subNodes.Points.properties.a),o=0,a=r.length;o<a;o+=4)s.push((new THREE.Vector4).fromArray(r,o));var l,h;if("Closed"===e.properties.Form)s.push(s[0]);else if("Periodic"===e.properties.Form){l=i,h=n.length-1-l;for(var o=0;o<i;++o)s.push(s[o])}for(var c=new THREE.NURBSCurve(i,n,s,l,h),u=c.getPoints(7*s.length),d=new Float32Array(3*u.length),o=0,a=u.length;o<a;++o)u[o].toArray(d,3*o);var p=new THREE.BufferGeometry;return p.addAttribute("position",new THREE.BufferAttribute(d,3)),p}function w(e,t,i,n,s){var r=new THREE.Group,o=e.Objects.subNodes.Model,a=[],l=new Map;for(var h in o){for(var c=parseInt(h),u=o[h],d=t.get(c),p=null,f=0;f<d.parents.length;++f)for(var m in i){var v=i[m],g=v.map,b=g[d.parents[f].ID];if(b){var y=p;p=new THREE.Bone,v.bones[b.index]=p,null!==y&&p.add(y)}}if(!p)switch(u.attrType){case"Mesh":for(var w=null,x=null,T=[],_=0,k=d.children.length;_<k;++_){var R=d.children[_];n.has(R.ID)&&(w=n.get(R.ID)),s.has(R.ID)&&T.push(s.get(R.ID))}if(T.length>1?x=T:T.length>0?x=T[0]:(x=new THREE.MeshBasicMaterial({color:3342591}),T.push(x)),"color"in w.attributes)for(var C=0,S=T.length;C<S;++C)T[C].vertexColors=THREE.VertexColors;if(w.FBX_Deformer){for(var A=0,N=T.length;A<N;++A)T[A].skinning=!0;p=new THREE.SkinnedMesh(w,x)}else p=new THREE.Mesh(w,x);break;case"NurbsCurve":for(var w=null,_=0,k=d.children.length;_<k;++_){var R=d.children[_];n.has(R.ID)&&(w=n.get(R.ID))}x=new THREE.LineBasicMaterial({color:3342591,linewidth:5}),p=new THREE.Line(w,x);break;default:p=new THREE.Object3D}p.name=u.attrName.replace(/:/,"").replace(/_/,"").replace(/-/,""),p.FBX_ID=c,a.push(p),l.set(c,p)}for(var H=0,L=a.length;H<L;++H){var p=a[H],u=o[p.FBX_ID];if("Lcl_Translation"in u.properties&&p.position.fromArray(X(u.properties.Lcl_Translation.value)),"Lcl_Rotation"in u.properties){var I=X(u.properties.Lcl_Rotation.value).map(K);I.push("ZYX"),p.rotation.fromArray(I)}if("Lcl_Scaling"in u.properties&&p.scale.fromArray(X(u.properties.Lcl_Scaling.value)),"PreRotation"in u.properties){var O=(new THREE.Euler).setFromVector3(Y(u.properties.PreRotation).multiplyScalar(re),"ZYX");O=(new THREE.Quaternion).setFromEuler(O);var P=(new THREE.Quaternion).setFromEuler(p.rotation);O.multiply(P),p.rotation.setFromQuaternion(O,"ZYX")}for(var d=t.get(p.FBX_ID),j=0;j<d.parents.length;j++){var D=Q(a,function(e){return e.FBX_ID===d.parents[j].ID});if(D>-1){a[D].add(p);break}}null===p.parent&&r.add(p)}r.updateMatrixWorld(!0);var B=e.Objects.subNodes.Pose;for(var h in B)if("BindPose"===B[h].attrType){B=B[h];break}if(B)for(var z=B.subNodes.PoseNode,F=new Map,V=0,U=z.length;V<U;++V){var u=z[V],G=q(u.subNodes.Matrix.properties.a);F.set(parseInt(u.id),G)}for(var m in i){var v=i[m],g=v.map;for(var W in g){var b=g[W],Z=b.index,J=v.bones[Z];if(!F.has(J.FBX_ID))break;var $=F.get(J.FBX_ID);J.matrixWorld.copy($)}v.skeleton=new THREE.Skeleton(v.bones);for(var d=t.get(v.FBX_ID),ee=d.parents,te=0,ie=ee.length;te<ie;++te){var ne=ee[te];if(n.has(ne.ID))for(var se=ne.ID,oe=t.get(se),f=0;f<oe.parents.length;++f)if(l.has(oe.parents[f].ID)){var p=l.get(oe.parents[f].ID);p.bind(v.skeleton,p.matrixWorld);break}}}r.updateMatrixWorld(!0),r.skeleton={bones:a};var ae=E(e,t,r);return M(r,ae),r}function E(e,t,i){var n=e.Objects.subNodes.AnimationCurveNode,s=e.Objects.subNodes.AnimationCurve,r=e.Objects.subNodes.AnimationLayer,o=e.Objects.subNodes.AnimationStack,a={curves:new Map,layers:{},stacks:{},length:0,fps:30,frames:0},l=[];for(var h in n)if(h.match(/\d+/)){var c=x(e,n[h],t,i);l.push(c)}for(var u=new Map,d=0;d<l.length;++d)null!==l[d]&&u.set(l[d].id,l[d]);var p=[];for(h in s)if(h.match(/\d+/)){var f=T(s[h]);if(!t.has(f.id))continue;p.push(f);var m=t.get(f.id).parents[0],v=m.ID,g=m.relationship,b="";if(g.match(/X/))b="x";else if(g.match(/Y/))b="y";else{if(!g.match(/Z/))continue;b="z"}u.get(v).curves[b]=f}u.forEach(function(e){var t=e.containerBoneID;if(a.curves.has(t)||a.curves.set(t,{T:null,R:null,S:null}),a.curves.get(t)[e.attr]=e,"R"===e.attr){var i=e.curves;if(i.x.values=i.x.values.map(K),i.y.values=i.y.values.map(K),i.z.values=i.z.values.map(K),null!==e.preRotations){var n=(new THREE.Euler).setFromVector3(e.preRotations,"ZYX");n=(new THREE.Quaternion).setFromEuler(n);for(var s=new THREE.Euler,r=new THREE.Quaternion,o=0;o<i.x.times.length;++o)s.set(i.x.values[o],i.y.values[o],i.z.values[o],"ZYX"),r.setFromEuler(s).premultiply(n),s.setFromQuaternion(r,"ZYX"),i.x.values[o]=s.x,i.y.values[o]=s.y,i.z.values[o]=s.z}}});for(var h in r){for(var y=[],w=t.get(parseInt(h)).children,E=0;E<w.length;E++)if(u.has(w[E].ID)){var k=u.get(w[E].ID),R=k.containerBoneID;void 0===y[R]&&(y[R]={T:null,R:null,S:null}),y[R][k.attr]=k}a.layers[h]=y}for(var h in o){for(var M=[],w=t.get(parseInt(h)).children,C={max:0,min:Number.MAX_VALUE},E=0;E<w.length;++E){var S=a.layers[w[E].ID];if(void 0!==S){M.push(S);for(var A=0,N=S.length;A<N;++A){var y=S[A];y&&_(y,C)}}}C.max>C.min&&(a.stacks[h]={name:o[h].attrName,layers:M,length:C.max-C.min,frames:30*(C.max-C.min)})}return a}function x(e,t,i,n){var s=e.Objects.subNodes.Model,r={id:t.id,attr:t.attrName,internalID:t.id,attrX:!1,attrY:!1,attrZ:!1,containerBoneID:-1,containerID:-1,curves:{x:null,y:null,z:null},preRotations:null};if(!r.attr.match(/S|R|T/))return null;for(var o in t.properties)o.match(/X/)&&(r.attrX=!0),o.match(/Y/)&&(r.attrY=!0),o.match(/Z/)&&(r.attrZ=!0);for(var a=i.get(r.id),l=a.parents,h=l.length-1;h>=0;--h){var c=Q(n.skeleton.bones,function(e){return e.FBX_ID===l[h].ID});if(c>-1){r.containerBoneID=c,r.containerID=l[h].ID;var u=s[r.containerID.toString()];"PreRotation"in u.properties&&(r.preRotations=Y(u.properties.PreRotation).multiplyScalar(Math.PI/180));break}}return r}function T(e){return{version:null,id:e.id,internalID:e.id,times:X(e.subNodes.KeyTime.properties.a).map(U),values:X(e.subNodes.KeyValueFloat.properties.a),attrFlag:G(e.subNodes.KeyAttrFlags.properties.a),attrData:X(e.subNodes.KeyAttrDataFloat.properties.a)}}function _(e,t){e.R&&k(e.R.curves,t),e.S&&k(e.S.curves,t),e.T&&k(e.T.curves,t)}function k(e,t){e.x&&R(e.x,t),e.y&&R(e.y,t),e.z&&R(e.z,t)}function R(e,t){t.max=e.times[e.times.length-1]>t.max?e.times[e.times.length-1]:t.max,t.min=e.times[0]<t.min?e.times[0]:t.min}function M(e,t){void 0===e.animations&&(e.animations=[]);var i=t.stacks;for(var n in i){for(var s=i[n],r={name:s.name,fps:30,length:s.length,hierarchy:[]},o=e.skeleton.bones,a=0,l=o.length;a<l;++a){var h=o[a],c=h.name.replace(/.*:/,""),u=Q(o,function(e){return h.parent===e});r.hierarchy.push({parent:u,name:c,keys:[]})}for(var d=0;d<=s.frames;d++)for(var a=0,l=o.length;a<l;++a)for(var h=o[a],p=a,f=s.layers[0][p],m=0,v=r.hierarchy.length;m<v;++m){var g=r.hierarchy[m];g.name===h.name&&g.keys.push(C(t,f,h,d))}e.animations.push(THREE.AnimationClip.parseAnimation(r,o))}}function C(e,t,i,n){var s={time:n/e.fps,pos:i.position.toArray(),rot:i.quaternion.toArray(),scl:i.scale.toArray()};if(void 0===t)return s;try{if(S(t,"T")&&A(t.T,n)&&(s.pos=[t.T.curves.x.values[n],t.T.curves.y.values[n],t.T.curves.z.values[n]]),S(t,"R")&&A(t.R,n)){var r=t.R.curves.x.values[n],o=t.R.curves.y.values[n],a=t.R.curves.z.values[n];ne.setFromEuler(ie.set(r,o,a,"ZYX")),s.rot=ne.toArray()}S(t,"S")&&A(t.S,n)&&(s.scl=[t.S.curves.x.values[n],t.S.curves.y.values[n],t.S.curves.z.values[n]])}catch(e){console.log(i),console.log(e)}return s}function S(e,t){if(void 0===e)return!1;var i=e[t];return!!i&&se.every(function(e){return null!==i.curves[e]})}function A(e,t){return se.every(function(i){return N(e.curves[i],t)})}function N(e,t){return void 0!==e.values[t]}function H(){this.position=new THREE.Vector3,this.normal=new THREE.Vector3,this.uv=new THREE.Vector2,this.color=new THREE.Vector3,this.skinIndices=new THREE.Vector4(0,0,0,0),this.skinWeights=new THREE.Vector4(0,0,0,0)}function L(){this.vertices=[]}function I(){this.triangles=[],this.materialIndex=0}function O(){this.faces=[],this.skeleton=null}function P(){}function j(){}function D(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function B(){}function z(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===Z(e,0,t.length)}function F(e){function t(t){var i=e[t-1];return e=e.slice(n+t),n++,i}for(var i=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],n=0,s=0;s<i.length;++s){var r=t(1);if(r==i[s])return!1}return!0}function V(e){var t=/FBXVersion: (\d+)/,i=e.match(t);if(i){var n=parseInt(i[1]);return n}throw new Error("FBXLoader: Cannot find the version number for the file given.")}function U(e){return e/46186158e3}function X(e){for(var t=e.split(","),i=0,n=t.length;i<n;i++)t[i]=parseFloat(t[i]);return t}function G(e){for(var t=e.split(","),i=0,n=t.length;i<n;i++)t[i]=parseInt(t[i]);return t}function Y(e){return(new THREE.Vector3).fromArray(e.value)}function W(e){return(new THREE.Color).fromArray(e.value)}function q(e){return(new THREE.Matrix4).fromArray(X(e))}function Z(e,t,i){void 0===t&&(t=0),void 0===i&&(i=e.byteLength);var n=new Uint8Array(e,t,i);if(void 0!==window.TextDecoder)return(new TextDecoder).decode(n);for(var s="",r=0,o=n.length;r<o;r++)s+=String.fromCharCode(n[r]);return s}function K(e){return e*re}function Q(e,t){for(var i=0,n=e.length;i<n;i++)if(t(e[i]))return i;return-1}function J(e,t){for(var i=0,n=e.length,s=t.length;i<s;i++,n++)e[n]=t[i]}function $(e,t,i,n){for(var s=i,r=0;s<n;s++,r++)e[r]=t[s];return e}THREE.FBXLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},Object.assign(THREE.FBXLoader.prototype,{load:function(e,t,i,n){var s=this,r=e.split(/[\\\/]/);r.pop(),r=r.join("/")+"/";var o=new THREE.FileLoader(this.manager);o.setResponseType("arraybuffer"),o.load(e,function(i){try{var o=s.parse(i,r);t(o)}catch(t){window.setTimeout(function(){n&&n(t),s.manager.itemError(e)},0)}},i,n)},parse:function(i,s){var o;if(z(i))o=(new j).parse(i);else{var a=Z(i);if(!F(a))throw self.manager.itemError(url),new Error("FBXLoader: Unknown format.");if(V(a)<7e3)throw self.manager.itemError(url),new Error("FBXLoader: FBX version not supported for file at "+url+", FileVersion: "+V(a));o=(new P).parse(a)}var h=e(o),u=t(o),d=n(o,new THREE.TextureLoader(this.manager).setPath(s),u,h),p=r(o,d,h),f=l(o,h),m=c(o,h,f),v=w(o,h,f,m,p);return v}});var ee=[],te={ByPolygonVertex:{Direct:function(e,t,i,n){var s=e*n.dataSize,r=e*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)},IndexToDirect:function(e,t,i,n){var s=n.indices[e],r=s*n.dataSize,o=s*n.dataSize+n.dataSize;return $(ee,n.buffer,r,o)}},ByPolygon:{Direct:function(e,t,i,n){var s=t*n.dataSize,r=t*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)},IndexToDirect:function(e,t,i,n){var s=n.indices[t],r=s*n.dataSize,o=s*n.dataSize+n.dataSize;return $(ee,n.buffer,r,o)}},ByVertice:{Direct:function(e,t,i,n){var s=i*n.dataSize,r=i*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)}},AllSame:{IndexToDirect:function(e,t,i,n){var s=n.indices[0]*n.dataSize,r=n.indices[0]*n.dataSize+n.dataSize;return $(ee,n.buffer,s,r)}}},ie=new THREE.Euler,ne=new THREE.Quaternion,se=["x","y","z"];Object.assign(H.prototype,{copy:function(e){var t=e||new H;return t.position.copy(this.position),t.normal.copy(this.normal),t.uv.copy(this.uv),t.skinIndices.copy(this.skinIndices),t.skinWeights.copy(this.skinWeights),t},flattenToBuffers:function(e,t,i,n,s,r){this.position.toArray(e,e.length),this.normal.toArray(t,t.length),this.uv.toArray(i,i.length),this.color.toArray(n,n.length),this.skinIndices.toArray(s,s.length),this.skinWeights.toArray(r,r.length)}}),Object.assign(L.prototype,{copy:function(e){for(var t=e||new L,i=0;i<this.vertices.length;++i)this.vertices[i].copy(t.vertices[i]);return t},flattenToBuffers:function(e,t,i,n,s,r){for(var o=this.vertices,a=0,l=o.length;a<l;++a)o[a].flattenToBuffers(e,t,i,n,s,r)}}),Object.assign(I.prototype,{copy:function(e){for(var t=e||new I,i=0;i<this.triangles.length;++i)this.triangles[i].copy(t.triangles[i]);return t.materialIndex=this.materialIndex,t},genTrianglesFromVertices:function(e){for(var t=2;t<e.length;++t){var i=new L;i.vertices[0]=e[0],i.vertices[1]=e[t-1],i.vertices[2]=e[t],this.triangles.push(i)}},flattenToBuffers:function(e,t,i,n,s,r,o){for(var a=this.triangles,l=this.materialIndex,h=0,c=a.length;h<c;++h)a[h].flattenToBuffers(e,t,i,n,s,r),J(o,[l,l,l])}}),Object.assign(O.prototype,{flattenToBuffers:function(){for(var e=[],t=[],i=[],n=[],s=[],r=[],o=[],a=this.faces,l=0,h=a.length;l<h;++l)a[l].flattenToBuffers(e,t,i,n,s,r,o);return{vertexBuffer:e,normalBuffer:t,uvBuffer:i,colorBuffer:n,skinIndexBuffer:s,skinWeightBuffer:r,materialIndexBuffer:o}}}),Object.assign(P.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new B,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=e.split("\n");for(var i in t){var n=t[i];if(!n.match(/^[\s\t]*;/)&&!n.match(/^[\s\t]*$/)){var s=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):(.*){",""),r=n.match(s);if(r){for(var o=r[1].trim().replace(/^"/,"").replace(/"$/,""),a=r[2].split(","),l=0,n=a.length;l<n;l++)a[l]=a[l].trim().replace(/^"/,"").replace(/"$/,"");this.parseNodeBegin(n,o,a||null)}else{var h=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),r=n.match(h);if(r){var c=r[1].replace(/^"/,"").replace(/"$/,"").trim(),u=r[2].replace(/^"/,"").replace(/"$/,"").trim();this.parseNodeProperty(n,c,u)}else{var d=new RegExp("^\\t{"+(this.currentIndent-1)+"}}");n.match(d)?this.nodeEnd():n.match(/^[^\s\t}]/)&&this.parseNodePropertyContinued(n)}}}}return this.allNodes},parseNodeBegin:function(e,t,i){var n={name:t,properties:{},subNodes:{}},s=this.parseNodeAttr(i),r=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(t,n);else if(t in r.subNodes){var o=r.subNodes[t];this.isFlattenNode(r.subNodes[t])&&(""===s.id?(r.subNodes[t]=[],r.subNodes[t].push(o)):(r.subNodes[t]={},r.subNodes[t][o.id]=o)),""===s.id?r.subNodes[t].push(n):r.subNodes[t][s.id]=n}else"number"==typeof s.id||s.id.match(/^\d+$/)?(r.subNodes[t]={},r.subNodes[t][s.id]=n):r.subNodes[t]=n;i&&(n.id=s.id,n.attrName=s.name,n.attrType=s.type),this.pushStack(n)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var i="",n="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:i,type:n}},parseNodeProperty:function(e,t,i){var n=this.getCurrentNode(),s=n.name;if(void 0!==s){var r=s.match(/Properties(\d)+/);if(r)return void this.parseNodeSpecialProperty(e,t,i)}if("C"==t){var o=i.split(",").slice(1),a=parseInt(o[0]),l=parseInt(o[1]),h=i.split(",").slice(3);t="connections",i=[a,l],J(i,h),void 0===n.properties[t]&&(n.properties[t]=[])}if("Node"==t){var c=parseInt(i);n.properties.id=c,n.id=c}t in n.properties?Array.isArray(n.properties[t])?n.properties[t].push(i):n.properties[t]+=i:Array.isArray(n.properties[t])?n.properties[t].push(i):n.properties[t]=i,this.setCurrentProp(n.properties,t)},parseNodePropertyContinued:function(e){this.currentProp[this.currentPropName]+=e},parseNodeSpecialProperty:function(e,t,i){for(var n=i.split('",'),s=0,r=n.length;s<r;s++)n[s]=n[s].trim().replace(/^\"/,"").replace(/\s/,"_");var o=n[0],a=n[1],l=n[2],h=n[3],c=n[4];switch(a){case"int":case"Bool":case"Integer":c=parseInt(c);break;case"double":case"Float":case"Number":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector":case"Vector3D":c=X(c)}this.getPrevNode().properties[o]={type:a,type2:l,flag:h,value:c},this.setCurrentProp(this.getPrevNode().properties,o)},nodeEnd:function(){this.popStack()},isFlattenNode:function(e){return"subNodes"in e&&"properties"in e}}),Object.assign(j.prototype,{parse:function(e){var t=new D(e);t.skip(23);var i=t.getUint32();console.log("FBX binary version: "+i);for(var n=new B;!this.endOfContent(t);){var s=this.parseNode(t,i);null!==s&&n.add(s.name,s)}return n},endOfContent:function(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+15>=e.size()},parseNode:function(e,t){var i=t>=7500?e.getUint64():e.getUint32(),n=t>=7500?e.getUint64():e.getUint32(),s=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),r=e.getString(s);if(0===i)return null;for(var o=[],a=0;a<n;a++)o.push(this.parseProperty(e));var l=o.length>0?o[0]:"",h=o.length>1?o[1]:"",c=o.length>2?o[2]:"",u={},d={},p=!1;for(1===n&&e.getOffset()===i&&(p=!0);i>e.getOffset();){var f=this.parseNode(e,t);if(null!==f)if(f.singleProperty!==!0)if("Connections"!==r||"C"!==f.name)if(f.name.match(/^Properties\d+$/))for(var m=Object.keys(f.properties),a=0,v=m.length;a<v;a++){var g=m[a];d[g]=f.properties[g]}else if(r.match(/^Properties\d+$/)&&"P"===f.name){var b,y=f.propertyList[0],w=f.propertyList[1],E=f.propertyList[2],x=f.propertyList[3];0===y.indexOf("Lcl ")&&(y=y.replace("Lcl ","Lcl_")),0===w.indexOf("Lcl ")&&(w=w.replace("Lcl ","Lcl_")),b="ColorRGB"===w||"Vector"===w||"Vector3D"===w||0===w.indexOf("Lcl_")?[f.propertyList[4],f.propertyList[5],f.propertyList[6]]:f.propertyList[4],0===w.indexOf("Lcl_")&&(b=b.toString()),d[y]={type:w,type2:E,flag:x,value:b}}else void 0===u[f.name]?"number"==typeof f.id?(u[f.name]={},u[f.name][f.id]=f):u[f.name]=f:""===f.id?(Array.isArray(u[f.name])||(u[f.name]=[u[f.name]]),u[f.name].push(f)):void 0===u[f.name][f.id]?u[f.name][f.id]=f:(Array.isArray(u[f.name][f.id])||(u[f.name][f.id]=[u[f.name][f.id]]),u[f.name][f.id].push(f));else{for(var T=[],a=1,v=f.propertyList.length;a<v;a++)T[a-1]=f.propertyList[a];void 0===d.connections&&(d.connections=[]),d.connections.push(T)}else{var _=f.propertyList[0];Array.isArray(_)?(f.properties[f.name]=f.propertyList[0],u[f.name]=f,f.properties.a=_.toString()):d[f.name]=_}}return{singleProperty:p,id:l,attrName:h,attrType:c,name:r,properties:d,propertyList:o,subNodes:u}},parseProperty:function(e){var t=e.getChar();switch(t){case"F":return e.getFloat32();case"D":return e.getFloat64();case"L":return e.getInt64();case"I":return e.getInt32();case"Y":return e.getInt16();case"C":return e.getBoolean();case"f":case"d":case"l":case"i":case"b":var i=e.getUint32(),n=e.getUint32(),s=e.getUint32();if(0===n)switch(t){case"f":return e.getFloat32Array(i);case"d":return e.getFloat64Array(i);case"l":return e.getInt64Array(i);case"i":return e.getInt32Array(i);case"b":return e.getBooleanArray(i)}if(void 0===window.Zlib)throw new Error("FBXLoader: Import inflate.min.js from https://github.com/imaya/zlib.js");var r=new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(s))),o=new D(r.decompress().buffer);switch(t){case"f":return o.getFloat32Array(i);case"d":return o.getFloat64Array(i);case"l":return o.getInt64Array(i);case"i":return o.getInt32Array(i);case"b":return o.getBooleanArray(i)}case"S":var a=e.getUint32();return e.getString(a);case"R":var a=e.getUint32();return e.getArrayBuffer(a);default:throw new Error("FBXLoader: Unknown property type "+t)}}}),Object.assign(D.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1===(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getBoolean());return t},getInt8:function(){var e=this.dv.getInt8(this.offset);return this.offset+=1,e},getInt8Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt8());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint8Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint8());return t},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt16Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt16());return t},getUint16:function(){var e=this.dv.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},getUint16Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint16());return t},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getUint32Array:function(e){
for(var t=[],i=0;i<e;i++)t.push(this.getUint32());return t},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e},getInt64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getUint64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getUint64());return t},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],i=0;i<e;i++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getChar:function(){return String.fromCharCode(this.getUint8())},getString:function(e){for(var t="";e>0;){var i=this.getUint8();if(e--,0===i)break;t+=String.fromCharCode(i)}return this.skip(e),t}}),Object.assign(B.prototype,{add:function(e,t){this[e]=t},searchConnectionParent:function(e){if(void 0===this.__cache_search_connection_parent&&(this.__cache_search_connection_parent=[]),void 0!==this.__cache_search_connection_parent[e])return this.__cache_search_connection_parent[e];this.__cache_search_connection_parent[e]=[];for(var t=this.Connections.properties.connections,i=[],n=0;n<t.length;++n)if(t[n][0]==e){var s=0===t[n][1]?-1:t[n][1];i.push(s)}return i.length>0?(J(this.__cache_search_connection_parent[e],i),i):(this.__cache_search_connection_parent[e]=[-1],[-1])},searchConnectionChildren:function(e){if(void 0===this.__cache_search_connection_children&&(this.__cache_search_connection_children=[]),void 0!==this.__cache_search_connection_children[e])return this.__cache_search_connection_children[e];this.__cache_search_connection_children[e]=[];for(var t=this.Connections.properties.connections,i=[],n=0;n<t.length;++n)t[n][1]==e&&i.push(0===t[n][0]?-1:t[n][0]);return i.length>0?(J(this.__cache_search_connection_children[e],i),i):(this.__cache_search_connection_children[e]=[],[])},searchConnectionType:function(e,t){var i=e+","+t;if(void 0===this.__cache_search_connection_type&&(this.__cache_search_connection_type={}),void 0!==this.__cache_search_connection_type[i])return this.__cache_search_connection_type[i];this.__cache_search_connection_type[i]="";for(var n=this.Connections.properties.connections,s=0;s<n.length;++s)if(n[s][0]==e&&n[s][1]==t)return this.__cache_search_connection_type[i]=n[s][2],n[s][2];return this.__cache_search_connection_type[e]=null,null}});var re=Math.PI/180}(),THREE.ColladaLoader=function(){function e(e,i,n,s){var r=0;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState?0===o.status||200===o.status?o.response?(De=i,t(o.response,void 0,e)):s?s({type:"error",url:e}):console.error("ColladaLoader: Empty or non-existing file ("+e+")"):s?s({type:"error",url:e}):console.error("ColladaLoader: Couldn't load \""+e+'" ('+o.status+")"):3===o.readyState&&n&&(0===r&&(r=o.getResponseHeader("Content-Length")),n({total:r,loaded:o.responseText.length}))},o.open("GET",e,!0),o.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,i){if(Pe=(new DOMParser).parseFromString(e,"text/xml"),t=t||De,void 0!==i){var l=i.split("/");l.pop(),Le=(l.length<1?".":l.join("/"))+"/"}n(),we(),ze=s("library_images image",R,"image"),Xe=s("library_materials material",Y,"material"),Ge=s("library_effects effect",Q,"effect"),Ue=s("library_geometries geometry",P,"geometry"),Ye=s("library_cameras camera",ne,"camera"),We=s("library_lights light",re,"light"),Ve=s("library_controllers controller",M,"controller"),Fe=s("library_animations animation",$,"animation"),Ne=s("library_visual_scenes visual_scene",A,"visual_scene"),He=s("library_kinematics_models kinematics_model",ae,"kinematics_model"),Ie=[],Oe=[],Me=r(),je=new THREE.Group;for(var h=0;h<Me.nodes.length;h++)je.add(g(Me.nodes[h]));je.scale.multiplyScalar(Ke),a(),Ce=o(),v();var c={scene:je,morphs:Ie,skins:Oe,animations:Se,kinematics:Ae,dae:{images:ze,materials:Xe,cameras:Ye,lights:We,effects:Ge,geometries:Ue,controllers:Ve,animations:Fe,visualScenes:Ne,visualScene:Me,scene:Me,kinematicsModels:He,kinematicsModel:Ce}};return t&&t(c),c}function i(e){qe=e}function n(){var e=Pe.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var i=0;i<t.childNodes.length;i++){var n=t.childNodes[i];switch(n.nodeName){case"unit":var s=n.getAttribute("meter");s&&(Ke=parseFloat(s));break;case"up_axis":Qe=n.textContent.charAt(0)}}}function s(e,t,i){for(var n=Pe.querySelectorAll(e),s={},r=0,o=n.length,a=0;a<o;a++){var l=n[a],h=(new t).parse(l);h.id&&0!==h.id.length||(h.id=i+r++),s[h.id]=h}return s}function r(){var e=Pe.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ne[t.length>0?t:"visual_scene0"]}return null}function o(){var e=Pe.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return He[t.length>0?t:"kinematics_model0"]}return null}function a(){Se=[],l(je)}function l(e){var t=Me.getChildById(e.colladaId,!0),i=null;if(t&&t.keys){i={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},Se.push(i);for(var n=0,s=t.keys.length;n<s;n++)i.length=Math.max(i.length,t.keys[n].time)}else i={hierarchy:[{keys:[],sids:[]}]};for(var n=0,s=e.children.length;n<s;n++)for(var r=l(e.children[n]),o=0,a=r.hierarchy.length;o<a;o++)i.hierarchy.push({keys:[],sids:[]});return i}function h(){var e,t=1e6,i=-t,n=0;for(var s in Fe){var r=Fe[s];e=e||r.id;for(var o=0;o<r.sampler.length;o++){var a=r.sampler[o];a.create(),t=Math.min(t,a.startTime),i=Math.max(i,a.endTime),n=Math.max(n,a.input.length)}}return{start:t,end:i,frames:n,ID:e}}function c(e,t){var i=t instanceof L?Ve[t.url]:t;if(!i||!i.morph)return void console.log("could not find morph controller!");for(var n=i.morph,s=0;s<n.targets.length;s++){var r=n.targets[s],o=Ue[r];if(o.mesh&&o.mesh.primitives&&o.mesh.primitives.length){var a=o.mesh.primitives[0].geometry;a.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:a.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function u(e,t,i,n){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var s=e.channels[0],r=s.sampler.output[i];r instanceof THREE.Matrix4&&(e.world.copy(r),e.localworld.copy(r),0===i&&e.matrix.copy(r))}n&&e.world.multiplyMatrices(n,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)u(e.nodes[o],t,i,e.world)}function d(e,t){for(var i=0;i<e.length;i++){var n=e[i],s=-1;if("JOINT"==n.type){for(var r=0;r<t.joints.length;r++)if(n.sid===t.joints[r]){s=r;break}if(s>=0){var o=t.invBindMatrices[s];n.invBindMatrix=o,n.skinningMatrix=new THREE.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,o),n.animatrix=new THREE.Matrix4,n.animatrix.copy(n.localworld),n.weights=[];for(var r=0;r<t.weights.length;r++)for(var a=0;a<t.weights[r].length;a++){var l=t.weights[r][a];l.joint===s&&n.weights.push(l)}}else console.warn("ColladaLoader: Could not find joint '"+n.sid+"'."),n.skinningMatrix=new THREE.Matrix4,n.weights=[]}}}function p(e){var t=[],i=function(e,t,n){var s={};s.name=t.sid,s.parent=e,s.matrix=t.matrix;var r=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];s.matrix.decompose(r[0],r[1],r[2]),s.pos=[r[0].x,r[0].y,r[0].z],s.scl=[r[2].x,r[2].y,r[2].z],s.rotq=[r[1].x,r[1].y,r[1].z,r[1].w],n.push(s);for(var o in t.nodes)i(t.sid,t.nodes[o],n)};return i(-1,e,t),t}function f(e,t,i){var n=[];u(t,n,-1),d(n,i.skin);for(var s=new THREE.Vector3,r=[],o=0;o<e.vertices.length;o++)r.push(new THREE.Vector3);for(o=0;o<n.length;o++)if("JOINT"==n[o].type)for(var a=0;a<n[o].weights.length;a++){var l=n[o].weights[a],h=l.index,c=l.weight,p=e.vertices[h],f=r[h];s.x=p.x,s.y=p.y,s.z=p.z,s.applyMatrix4(n[o].skinningMatrix),f.x+=s.x*c,f.y+=s.y*c,f.z+=s.z*c}for(var o=0;o<e.vertices.length;o++)e.vertices[o]=r[o]}function m(e,t,i){void 0===i&&(i=40);var n=Ve[t.url];if(!n||!n.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var s=h(),r=Me.getChildById(t.skeleton[0],!0)||Me.getChildBySid(t.skeleton[0],!0),o=p(r),a=n.skin.joints,l=[],c=0;c<a.length;c++)for(var m=0;m<o.length;m++)o[m].name===a[c]&&(l[c]=o[m]);for(var c=0;c<l.length;c++)for(var m=0;m<l.length;m++)l[c].parent===l[m].name&&(l[c].parent=m);var c,m,v;new THREE.Vector3;for(c=0;c<e.vertices.length;c++)e.vertices[c].applyMatrix4(n.skin.bindShapeMatrix);for(var g=[],b=[],y=n.skin.weights,c=0;c<y.length;c++){var w=new THREE.Vector4(y[c][0]?y[c][0].joint:0,y[c][1]?y[c][1].joint:0,y[c][2]?y[c][2].joint:0,y[c][3]?y[c][3].joint:0),v=new THREE.Vector4(y[c][0]?y[c][0].weight:0,y[c][1]?y[c][1].weight:0,y[c][2]?y[c][2].weight:0,y[c][3]?y[c][3].weight:0);g.push(w),b.push(v)}e.skinIndices=g,e.skinWeights=b,e.bones=l;for(var E={name:s.ID,fps:30,length:s.frames/30,hierarchy:[]},m=0;m<l.length;m++)E.hierarchy.push({parent:l[m].parent,name:l[m].name,keys:[]});for(console.log("ColladaLoader:",s.ID+" has "+l.length+" bones."),f(e,r,n),i=0;i<s.frames;i++){var x=[];u(r,x,i),d(x,n.skin);for(var c=0;c<x.length;c++)for(var m=0;m<E.hierarchy.length;m++)if(E.hierarchy[m].name===x[c].sid){var T={};T.time=i/30,T.matrix=x[c].animatrix,0===i&&(x[c].matrix=T.matrix);var _=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];T.matrix.decompose(_[0],_[1],_[2]),T.pos=[_[0].x,_[0].y,_[0].z],T.scl=[_[2].x,_[2].y,_[2].z],T.rot=_[1],E.hierarchy[m].keys.push(T)}e.animation=E}}function v(){if(Ce&&0===Ce.joints.length)return void(Ae=void 0);var e={},t=function(t,i){var n=i.getAttribute("id"),s=Me.getChildById(n,!0),r=Ce.joints[t];je.traverse(function(i){i.colladaId==n&&(e[t]={node:i,transforms:s.transforms,joint:r,position:r.zeroPosition})})};Ae={joints:Ce&&Ce.joints,getJointValue:function(t){var i=e[t];return i?i.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,i){var s=e[t];if(s){var r=s.joint;if(i>r.limits.max||i<r.limits.min)console.log("setJointValue: joint "+t+" value "+i+" outside of limits (min: "+r.limits.min+", max: "+r.limits.max+")");else if(r.static)console.log("setJointValue: joint "+t+" is static");else{var o=s.node,a=r.axis,l=s.transforms,h=new THREE.Matrix4,c=new THREE.Matrix4;for(n=0;n<l.length;n++){var u=l[n];if(u.sid&&u.sid.indexOf("joint"+t)!==-1)switch(r.type){case"revolute":h.multiply(c.makeRotationAxis(a,THREE.Math.degToRad(i)));break;case"prismatic":h.multiply(c.makeTranslation(a.x*i,a.y*i,a.z*i));break;default:console.warn("setJointValue: unknown joint type: "+r.type)}else switch(u.type){case"matrix":h.multiply(u.obj);break;case"translate":h.multiply(c.makeTranslation(u.obj.x,u.obj.y,u.obj.z));break;case"rotate":h.multiply(c.makeRotationAxis(u.obj,u.angle))}}var d=h.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];o.matrix.set.apply(o.matrix,f),o.matrix.decompose(o.position,o.quaternion,o.scale),e[t].position=i}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var i=Pe.querySelector("scene instance_kinematics_scene");if(i)for(var n=0;n<i.childNodes.length;n++){var s=i.childNodes[n];if(1==s.nodeType)switch(s.nodeName){case"bind_joint_axis":var r=s.getAttribute("target").split("/").pop(),o=s.querySelector("axis param").textContent,a=parseInt(o.split("joint").pop().split(".")[0]),l=Pe.querySelector('[sid="'+r+'"]');if(l){var h=l.parentElement;t(a,h)}}}}function g(e,t){var i,n,s,r,o=new THREE.Object3D,a=!1;for(s=0;s<e.controllers.length;s++){var l=Ve[e.controllers[s].url];switch(l.type){case"skin":if(Ue[l.skin.source]){var h=new O;h.url=l.skin.source,h.instance_material=e.controllers[s].instance_material,e.geometries.push(h),a=!0,i=e.controllers[s]}else if(Ve[l.skin.source]){var u=Ve[l.skin.source];if(n=u,u.morph&&Ue[u.morph.source]){var h=new O;h.url=u.morph.source,h.instance_material=e.controllers[s].instance_material,e.geometries.push(h)}}break;case"morph":if(Ue[l.morph.source]){var h=new O;h.url=l.morph.source,h.instance_material=e.controllers[s].instance_material,e.geometries.push(h),n=e.controllers[s]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(s=0;s<e.geometries.length;s++){var p,f=e.geometries[s],v=f.instance_material,b=Ue[f.url],y={},w=[],E=0;if(b){if(!b.mesh||!b.mesh.primitives)continue;if(0===o.name.length&&(o.name=b.id),v)for(r=0;r<v.length;r++){var x=v[r],T=Xe[x.target],_=T.instance_effect.url,k=Ge[_].shader,R=k.material;if(b.doubleSided){if(!(x.symbol in d)){var M=R.clone();M.side=THREE.DoubleSide,d[x.symbol]=M}R=d[x.symbol]}R.opacity=R.opacity?R.opacity:1,y[x.symbol]=E,w.push(R),p=R,p.name=null===T.name||""===T.name?T.id:T.name,E++}var C,S=p||new THREE.MeshLambertMaterial({color:14540253,side:b.doubleSided?THREE.DoubleSide:THREE.FrontSide}),A=b.mesh.geometry3js;if(E>1)for(S=new THREE.MultiMaterial(w),r=0;r<A.faces.length;r++){var N=A.faces[r];N.materialIndex=y[N.daeMaterial]}void 0!==i?(m(A,i),A.morphTargets.length>0?(S.morphTargets=!0,S.skinning=!1):(S.morphTargets=!1,S.skinning=!0),C=new THREE.SkinnedMesh(A,S,!1),C.name="skin_"+Oe.length,Oe.push(C)):void 0!==n?(c(A,n),S.morphTargets=!0,C=new THREE.Mesh(A,S),C.name="morph_"+Ie.length,Ie.push(C)):C=A.isLineStrip===!0?new THREE.Line(A):new THREE.Mesh(A,S),o.add(C)}}for(s=0;s<e.cameras.length;s++){var H=e.cameras[s],L=Ye[H.url],I=new THREE.PerspectiveCamera(L.yfov,parseFloat(L.aspect_ratio),parseFloat(L.znear),parseFloat(L.zfar));o.add(I)}for(s=0;s<e.lights.length;s++){var P=null,j=e.lights[s],D=We[j.url];if(D&&D.technique){var B=D.color.getHex(),z=D.intensity,F=D.distance,V=D.falloff_angle;switch(D.technique){case"directional":P=new THREE.DirectionalLight(B,z,F),P.position.set(0,0,1);break;case"point":P=new THREE.PointLight(B,z,F);break;case"spot":P=new THREE.SpotLight(B,z,F,V),P.position.set(0,0,1);break;case"ambient":P=new THREE.AmbientLight(B)}}P&&o.add(P)}if(o.name=e.name||e.id||"",o.colladaId=e.id||"",o.layer=e.layer||"",o.matrix=e.matrix,o.matrix.decompose(o.position,o.quaternion,o.scale),Ze.centerGeometry&&o.geometry){var U=o.geometry.center();U.multiply(o.scale),U.applyQuaternion(o.quaternion),o.position.sub(U)}for(s=0;s<e.nodes.length;s++)o.add(g(e.nodes[s],e));return o}function b(e){for(var t=Pe.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var n=t[i].attributes.getNamedItem("id");if(n&&n.value===e)return t[i]}}function y(e){var t=[],i=1e6,n=-1e6;for(var s in Fe)for(var r=Fe[s],o=0;o<r.channel.length;o++){var a=r.channel[o],l=r.sampler[o],s=a.target.split("/")[0];s==e.id&&(l.create(),a.sampler=l,i=Math.min(i,l.startTime),n=Math.max(n,l.endTime),t.push(a))}return t.length&&(e.startTime=i,e.endTime=n),t}function w(e){if(e.channels&&e.channels.length){for(var t=[],i=[],n=0,s=e.channels.length;n<s;n++){var r,o=e.channels[n],a=o.fullSid,l=o.sampler,h=l.input,c=e.getTransformBySid(o.sid);if(o.arrIndices){r=[];for(var u=0,d=o.arrIndices.length;u<d;u++)r[u]=ke(o.arrIndices[u])}else r=Re(o.member);if(c){i.indexOf(a)===-1&&i.push(a);for(var u=0,d=h.length;u<d;u++){var p=h[u],f=l.getData(c.type,u,r),m=E(t,p);if(!m){m=new ie(p);var v=x(t,p);t.splice(v===-1?t.length:v,0,m)}m.addTarget(a,c,r,f)}}else console.log('Could not find transform "'+o.sid+'" in node '+e.id)}for(var n=0;n<i.length;n++)for(var g=i[n],u=0;u<t.length;u++){var m=t[u];m.hasTarget(g)||T(t,m,u,g)}e.keys=t,e.sids=i}}function E(e,t){for(var i=null,n=0,s=e.length;n<s&&null===i;n++){var r=e[n];if(r.time===t)i=r;else if(r.time>t)break}return i}function x(e,t){for(var i=-1,n=0,s=e.length;n<s&&i===-1;n++){var r=e[n];r.time>=t&&(i=n)}return i}function T(e,t,i,n){var s=k(e,n,i?i-1:0),r=_(e,n,i+1);if(s&&r){var o,a=(t.time-s.time)/(r.time-s.time),l=s.getTarget(n),h=r.getTarget(n).data,c=l.data;if("matrix"===l.type)o=c;else if(c.length){o=[];for(var u=0;u<c.length;++u)o[u]=c[u]+(h[u]-c[u])*a}else o=c+(h-c)*a;t.addTarget(n,l.transform,l.member,o)}}function _(e,t,i){for(;i<e.length;i++){var n=e[i];if(n.hasTarget(t))return n}return null}function k(e,t,i){for(i=i>=0?i:i+e.length;i>=0;i--){var n=e[i];if(n.hasTarget(t))return n}return null}function R(){this.id="",this.init_from=""}function M(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function C(){this.method=null,this.source=null,this.targets=null,this.weights=null}function S(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function A(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function N(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function H(){this.sid="",this.type="",this.data=[],this.obj=null}function L(){this.url="",this.skeleton=[],this.instance_material=[]}function I(){this.symbol="",this.target=""}function O(){this.url="",this.instance_material=[]}function P(){this.id="",this.mesh=null}function j(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function D(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function B(){D.call(this),this.vcount=[]}function z(){D.call(this),this.vcount=1}function F(){D.call(this),this.vcount=3}function V(){this.source="",this.count=0,this.stride=0,this.params=[]}function U(){this.input={}}function X(){this.semantic="",this.offset=0,this.source="",this.set=0}function G(e){this.id=e,this.type=null}function Y(){this.id="",this.name="",this.instance_effect=null}function W(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function q(e,t){this.type=e,this.effect=t,this.material=null}function Z(e){this.effect=e,this.init_from=null,this.format=null}function K(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Q(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function J(){this.url=""}function $(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ie(e){this.targets=[],this.time=e}function ne(){this.id="",this.name="",this.technique=""}function se(){this.url=""}function re(){this.id="",this.name="",this.technique=""}function oe(){this.url=""}function ae(){this.id="",this.name="",this.joints=[],this.links=[]}function le(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function he(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ce(){this.joint="",this.transforms=[],this.links=[]}function ue(e){var t=e.getAttribute("id");return void 0!=Be[t]?Be[t]:(Be[t]=new G(t).parse(e),Be[t])}function de(e){for(var t=me(e),i=[],n=0,s=t.length;n<s;n++)i.push("true"===t[n]||"1"===t[n]);return i}function pe(e){for(var t=me(e),i=[],n=0,s=t.length;n<s;n++)i.push(parseFloat(t[n]));return i}function fe(e){for(var t=me(e),i=[],n=0,s=t.length;n<s;n++)i.push(parseInt(t[n],10));return i}function me(e){return e.length>0?ve(e).split(/\s+/):[]}function ve(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ge(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function be(e,t){var i=new THREE.ImageLoader;i.load(t,function(t){e.image=t,e.needsUpdate=!0})}function ye(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function we(){if(Ze.convertUpAxis!==!0||Qe===Ze.upAxis)Je=null;else switch(Qe){case"X":Je="Y"===Ze.upAxis?"XtoY":"XtoZ";break;case"Y":Je="X"===Ze.upAxis?"YtoX":"YtoZ";break;case"Z":Je="X"===Ze.upAxis?"ZtoX":"ZtoY"}}function Ee(e,t){if(Ze.convertUpAxis===!0&&Qe!==Ze.upAxis)switch(Je){case"XtoY":var i=e[0];e[0]=t*e[1],e[1]=i;break;case"XtoZ":var i=e[2];e[2]=e[1],e[1]=e[0],e[0]=i;break;case"YtoX":var i=e[0];e[0]=e[1],e[1]=t*i;break;case"YtoZ":var i=e[1];e[1]=t*e[2],e[2]=i;break;case"ZtoX":var i=e[0];e[0]=e[1],e[1]=e[2],e[2]=i;break;case"ZtoY":var i=e[1];e[1]=e[2],e[2]=t*i}}function xe(e,t){if(Ze.convertUpAxis!==!0||Qe===Ze.upAxis)return t;switch(e){case"X":t="XtoY"===Je?t*-1:t;break;case"Y":t="YtoZ"===Je||"YtoX"===Je?t*-1:t;break;case"Z":t="ZtoY"===Je?t*-1:t}return t}function Te(e,t){var i=[e[t],e[t+1],e[t+2]];return Ee(i,-1),new THREE.Vector3(i[0],i[1],i[2])}function _e(e){if(Ze.convertUpAxis){var t=[e[0],e[4],e[8]];Ee(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],Ee(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],Ee(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],Ee(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],Ee(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],Ee(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],Ee(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function ke(e){if(e>-1&&e<3){var t=["X","Y","Z"],i={X:0,Y:1,Z:2};e=Re(t[e]),e=i[e]}return e}function Re(e){if(Ze.convertUpAxis)switch(e){case"X":switch(Je){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(Je){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(Je){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var Me,Ce,Se,Ae,Ne,He,Le,Ie,Oe,Pe=null,je=null,De=null,Be={},ze={},Fe={},Ve={},Ue={},Xe={},Ge={},Ye={},We={},qe=THREE.SmoothShading,Ze={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ke=1,Qe="Y",Je=null;return R.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},M.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new S).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new C).parse(i),this.type=i.nodeName}}return this},C.prototype.parse=function(e){var t,i={},n=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"source":var r=(new G).parse(s);i[r.id]=r;break;case"targets":n=this.parseInputs(s);break;default:console.log(s.nodeName)}}for(t=0;t<n.length;t++){var o=n[t],r=i[o.source];switch(o.semantic){case"MORPH_TARGET":this.targets=r.read();break;case"MORPH_WEIGHT":this.weights=r.read()}}return this},C.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":t.push((new X).parse(n))}}return t},S.prototype.parse=function(e){var t,i,n={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var s=0;s<e.childNodes.length;s++){var r=e.childNodes[s];if(1==r.nodeType)switch(r.nodeName){case"bind_shape_matrix":var o=pe(r.textContent);this.bindShapeMatrix=_e(o);break;case"source":var a=(new G).parse(r);n[a.id]=a;break;case"joints":t=r;break;case"vertex_weights":i=r;break;default:console.log(r.nodeName)}}return this.parseJoints(t,n),this.parseWeights(i,n),this},S.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":var s=(new X).parse(n),r=t[s.source];"JOINT"===s.semantic?this.joints=r.read():"INV_BIND_MATRIX"===s.semantic&&(this.invBindMatrices=r.read())}}},S.prototype.parseWeights=function(e,t){for(var i,n,s=[],r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(1==o.nodeType)switch(o.nodeName){case"input":s.push((new X).parse(o));break;case"v":i=fe(o.textContent);break;case"vcount":n=fe(o.textContent)}}for(var a=0,r=0;r<n.length;r++){for(var l=n[r],h=[],c=0;c<l;c++){for(var u={},d=0;d<s.length;d++){var p=s[d],f=i[a+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}h.push(u),a+=s.length}for(var c=0;c<h.length;c++)h[c].index=r;this.weights.push(h)}},A.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},A.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},A.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new N).parse(i))}}return this},N.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,n=this.channels[t],s=n.target.split("/"),r=(s.shift(),s.shift()),o=r.indexOf(".")>=0,a=r.indexOf("(")>=0;if(o)s=r.split("."),r=s.shift();else if(a){i=r.split("("),r=i.shift();for(var l=0;l<i.length;l++)i[l]=parseInt(i[l].replace(/\)/,""))}if(r===e)return n.info={sid:r,dotSyntax:o,arrSyntax:a,arrIndices:i},n}return null},N.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},N.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},N.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},N.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new N).parse(n));break;case"instance_camera":this.cameras.push((new se).parse(n));break;case"instance_controller":this.controllers.push((new L).parse(n));break;case"instance_geometry":this.geometries.push((new O).parse(n));break;case"instance_light":this.lights.push((new oe).parse(n));break;case"instance_node":t=n.getAttribute("url").replace(/^#/,"");var s=b(t);s&&this.nodes.push((new N).parse(s));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new H).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=y(this),w(this),this.updateMatrix(),this},N.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},H.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),this.convert(),this},H.prototype.convert=function(){switch(this.type){case"matrix":this.obj=_e(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":Ee(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Ee(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},H.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),H.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var n="n"+(t[0]+1)+(t[1]+1);this.obj[n]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},L.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var n=i.querySelectorAll("instance_material"),s=0;s<n.length;s++){var r=n[s];this.instance_material.push((new I).parse(r))}break;case"extra":}}return this},I.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},O.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var n=i.querySelectorAll("instance_material"),s=0;s<n.length;s++){var r=n[s];this.instance_material.push((new I).parse(r))}break}}return this},P.prototype.parse=function(e){this.id=e.getAttribute("id"),ye(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new j(this).parse(i);break;case"extra":}}return this},j.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":ue(i);break;case"vertices":this.vertices=(new U).parse(i);break;case"linestrips":this.primitives.push((new z).parse(i));break;case"triangles":this.primitives.push((new F).parse(i));break;case"polygons":this.primitives.push((new D).parse(i));break;case"polylist":this.primitives.push((new B).parse(i))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var n=Be[this.vertices.input.POSITION.source].data,t=0;t<n.length;t+=3)this.geometry3js.vertices.push(Te(n,t).clone());for(var t=0;t<this.primitives.length;t++){var s=this.primitives[t];s.setVertices(this.vertices),
this.handlePrimitive(s,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},j.prototype.handlePrimitive=function(e,t){if(e instanceof z)return void(t.isLineStrip=!0);var i,n,s,r,o,a,l,h,c=e.p,u=e.inputs,d=0,p=0,f=[];for(i=0;i<u.length;i++){s=u[i];var m=s.offset+1;switch(p=p<m?m:p,s.semantic){case"TEXCOORD":f.push(s.set)}}for(var v=0;v<c.length;++v)for(var g=c[v],b=0;b<g.length;){var y=[],w=[],E=null,x=[];for(h=e.vcount?e.vcount.length?e.vcount[d++]:e.vcount:g.length/p,i=0;i<h;i++)for(n=0;n<u.length;n++)switch(s=u[n],a=Be[s.source],r=g[b+i*p+s.offset],l=a.accessor.params.length,o=r*l,s.semantic){case"VERTEX":y.push(r);break;case"NORMAL":w.push(Te(a.data,o));break;case"TEXCOORD":E=E||{},void 0===E[s.set]&&(E[s.set]=[]),E[s.set].push(new THREE.Vector2(a.data[o],a.data[o+1]));break;case"COLOR":x.push((new THREE.Color).setRGB(a.data[o],a.data[o+1],a.data[o+2]))}if(0===w.length)if(s=this.vertices.input.NORMAL){a=Be[s.source],l=a.accessor.params.length;for(var T=0,_=y.length;T<_;T++)w.push(Te(a.data,y[T]*l))}else t.calcNormals=!0;if(!E&&(E={},s=this.vertices.input.TEXCOORD)){f.push(s.set),a=Be[s.source],l=a.accessor.params.length;for(var T=0,_=y.length;T<_;T++)o=y[T]*l,void 0===E[s.set]&&(E[s.set]=[]),E[s.set].push(new THREE.Vector2(a.data[o],1-a.data[o+1]))}if(0===x.length&&(s=this.vertices.input.COLOR)){a=Be[s.source],l=a.accessor.params.length;for(var T=0,_=y.length;T<_;T++)o=y[T]*l,x.push((new THREE.Color).setRGB(a.data[o],a.data[o+1],a.data[o+2]))}var k,R,M=null,C=[];if(3===h)C.push(new THREE.Face3(y[0],y[1],y[2],w,x.length?x:new THREE.Color));else if(4===h)C.push(new THREE.Face3(y[0],y[1],y[3],w.length?[w[0].clone(),w[1].clone(),w[3].clone()]:[],x.length?[x[0],x[1],x[3]]:new THREE.Color)),C.push(new THREE.Face3(y[1],y[2],y[3],w.length?[w[1].clone(),w[2].clone(),w[3].clone()]:[],x.length?[x[1],x[2],x[3]]:new THREE.Color));else if(h>4&&Ze.subdivideFaces){var S=x.length?x:new THREE.Color;for(n=1;n<h-1;)C.push(new THREE.Face3(y[0],y[n],y[n+1],w.length?[w[0].clone(),w[n++].clone(),w[n].clone()]:[],S))}if(C.length)for(var T=0,_=C.length;T<_;T++)for(M=C[T],M.daeMaterial=e.material,t.faces.push(M),n=0;n<f.length;n++)k=E[f[n]],R=h>4?[k[0],k[T+1],k[T+2]]:4===h?0===T?[k[0],k[1],k[3]]:[k[1].clone(),k[2],k[3].clone()]:[k[0],k[1],k[2]],void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),t.faceVertexUvs[n].push(R);else console.log("dropped face with vcount "+h+" for geometry with id: "+t.id);b+=p*h}},D.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},D.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ge(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new X).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(i.textContent);break;case"p":this.p.push(fe(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},B.prototype=Object.create(D.prototype),B.prototype.constructor=B,z.prototype=Object.create(D.prototype),z.prototype.constructor=z,F.prototype=Object.create(D.prototype),F.prototype.constructor=F,V.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ge(e,"count",0),this.stride=ge(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var n={};n.name=i.getAttribute("name"),n.type=i.getAttribute("type"),this.params.push(n)}}return this},U.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new X).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},X.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ge(e,"set",-1),this.offset=ge(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},G.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=de(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=pe(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=fe(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var n=0;n<i.childNodes.length;n++)if("accessor"===i.childNodes[n].nodeName){this.accessor=(new V).parse(i.childNodes[n]);break}}}return this},G.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var n=this.data.slice(i,i+16),s=_e(n);e.push(s)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},Y.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new J).parse(e.childNodes[t]);break}return this},W.prototype.isColor=function(){return null===this.texture},W.prototype.isTexture=function(){return null!=this.texture},W.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var n=pe(i.textContent);this.color=new THREE.Color,this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},W.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},q.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new W).parse(i);break;case"bump":var n=i.getAttribute("bumptype");n?"heightfield"===n.toLowerCase()?this.bump=(new W).parse(i):"normalmap"===n.toLowerCase()?this.normal=(new W).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+n+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new W).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new W).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var s=i.querySelectorAll("float");s.length>0&&(this[i.nodeName]=parseFloat(s[0].textContent))}}return this.create(),this},q.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var i=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);i>0&&(t=!0,e.transparent=!0,e.opacity=1-i)}var n={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var s in this)switch(s){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var r=this[s];if(r instanceof W)if(r.isTexture()){var o=r.texture,a=this.effect.sampler[o];if(void 0!==a&&void 0!==a.source){var l=this.effect.surface[a.source];if(void 0!==l){var h=ze[l.init_from];if(h){var c,u=Le+h.init_from,d=THREE.Loader.Handlers.get(u);null!==d?c=d.load(u):(c=new THREE.Texture,be(c,u)),"MIRROR"===a.wrap_s?c.wrapS=THREE.MirroredRepeatWrapping:"WRAP"===a.wrap_s||r.texOpts.wrapU?c.wrapS=THREE.RepeatWrapping:c.wrapS=THREE.ClampToEdgeWrapping,"MIRROR"===a.wrap_t?c.wrapT=THREE.MirroredRepeatWrapping:"WRAP"===a.wrap_t||r.texOpts.wrapV?c.wrapT=THREE.RepeatWrapping:c.wrapT=THREE.ClampToEdgeWrapping,c.offset.x=r.texOpts.offsetU,c.offset.y=r.texOpts.offsetV,c.repeat.x=r.texOpts.repeatU,c.repeat.y=r.texOpts.repeatV,e[n[s]]=c,"emission"===s&&(e.emissive=16777215)}}}}else"diffuse"!==s&&t||("emission"===s?e.emissive=r.color.getHex():e[s]=r.color.getHex());break;case"shininess":e[s]=this[s];break;case"reflectivity":e[s]=this[s],e[s]>0&&(e.envMap=Ze.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[s],1!==this[s]&&(e.envMap=Ze.defaultEnvMap);break;case"transparency":}switch(e.shading=qe,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},Z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},K.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},Q.prototype.create=function(){if(null===this.shader)return null},Q.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),ye(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},Q.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"surface":this.surface[t]=new Z(this).parse(n);break;case"sampler2D":this.sampler[t]=new K(this).parse(n);break;case"extra":break;default:console.log(n.nodeName)}}},Q.prototype.parseProfileCOMMON=function(e){for(var t,i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":t=n;break;case"newparam":this.parseNewparam(n);break;case"image":var s=(new R).parse(n);ze[s.id]=s;break;case"extra":break;default:console.log(n.nodeName)}}return t},Q.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new q(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},Q.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},Q.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},J.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},$.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"animation":var n=(new $).parse(i);for(var s in n.source)this.source[s]=n.source[s];for(var r=0;r<n.channel.length;r++)this.channel.push(n.channel[r]),this.sampler.push(n.sampler[r]);break;case"source":var s=(new G).parse(i);this.source[s.id]=s;break;case"sampler":this.sampler.push(new te(this).parse(i));break;case"channel":this.channel.push(new ee(this).parse(i))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),n=i.indexOf(".")>=0,s=i.indexOf("(")>=0;if(n)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(s){var r=i.split("(");this.sid=r.shift();for(var o=0;o<r.length;o++)r[o]=parseInt(r[o].replace(/\)/,""));this.arrIndices=r}else this.sid=i;return this.fullSid=i,this.dotSyntax=n,this.arrSyntax=s,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new X).parse(i))}}return this},te.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,i){var n;if("matrix"===e&&16===this.strideOut)n=this.output[t];else if(this.strideOut>1){n=[],t*=this.strideOut;for(var s=0;s<this.strideOut;++s)n[s]=this.output[t+s];if(3===this.strideOut)switch(e){case"rotate":case"translate":Ee(n,-1);break;case"scale":Ee(n,1)}else 4===this.strideOut&&"matrix"===e&&Ee(n,-1)}else n=this.output[t],i&&"translate"===e&&(n=xe(i,n));return n},ie.prototype.addTarget=function(e,t,i,n){this.targets.push({sid:e,member:i,transform:t,data:n})},ie.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},ie.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ie.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ie.prototype.interpolate=function(e,t){for(var i=0,n=this.targets.length;i<n;i++){var s,r=this.targets[i],o=e.getTarget(r.sid);if("matrix"!==r.transform.type&&o){var a=(t-this.time)/(e.time-this.time),l=o.data,h=r.data;if(a<0&&(a=0),a>1&&(a=1),h.length){s=[];for(var c=0;c<h.length;++c)s[c]=h[c]+(l[c]-h[c])*a}else s=h+(l-h)*a}else s=r.data;r.transform.update(s,r.member)}},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},ne.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++)if(this.technique=i.childNodes[n].nodeName,"perspective"===this.technique)for(var s=i.childNodes[n],r=0;r<s.childNodes.length;r++){var o=s.childNodes[r];switch(o.nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"===this.technique)for(var a=i.childNodes[n],r=0;r<a.childNodes.length;r++){var o=a.childNodes[r];switch(o.nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}return this},se.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},re.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},re.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++){var s=i.childNodes[n];switch(s.nodeName){case"color":var r=pe(s.textContent);this.color=new THREE.Color(0),this.color.setRGB(r[0],r[1],r[2]),this.color.a=r[3];break;case"falloff_angle":this.falloff_angle=parseFloat(s.textContent);break;case"quadratic_attenuation":var o=parseFloat(s.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},re.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"intensity":this.intensity=parseFloat(i.textContent)}}return this},oe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},ae.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new le).parse(i));break;case"link":this.links.push((new he).parse(i))}}return this},le.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),i=pe(t.textContent);this.axis=Te(i,0);var n=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,s=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:n,max:s};for(var r=["prismatic","revolute"],o=0;o<r.length;o++){var a=r[o],l=e.querySelector(a);l&&(this.type=a)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new ce).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new H).parse(i))}}return this},ce.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new he).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new H).parse(i))}}return this},{load:e,parse:t,setPreferredShading:i,applySkin:m,geometries:Ue,options:Ze}},THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FillShader={uniforms:{color:{value:new THREE.Color(1,1,1)},alpha:{value:1},lineAlpha:{value:1},fillAlpha:{value:.2}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3  color;","uniform float alpha;","uniform float lineAlpha;","uniform float fillAlpha;","#define PI 3.141592653589793","#define XRAD 0.017453292519943295","float drawLine(float angle, float step, float thick) {","float a = angle * XRAD;","float ks = thick / step;","float len = dot(gl_FragCoord.xy, vec2(cos(a), sin(a)));","float dist = abs((2.0 * mod(len, step) / step) - 1.0);","return clamp((ks - dist) / ks, 0.0, 1.0);","}","void main() {","gl_FragColor = vec4(color, alpha);","return;","float line1 = drawLine(-30.0, 10.0, 2.0);","float line2 = drawLine(80.0, 20.0, 2.0);","float level = fillAlpha + lineAlpha * max(line1 * 0.9, line2 * 0.3);","gl_FragColor = vec4(color, alpha * level);","}"].join("\n")},THREE.OverlayShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)},drawColor:{value:new THREE.Color(1,1,1)},drawAlpha:{value:1},lineAlpha:{value:1},fillAlpha:{value:0},edgeAlpha:{value:1}},vertexShader:["void main() {","gl_Position = vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","uniform vec3  drawColor;","uniform float drawAlpha;","uniform float lineAlpha;","uniform float fillAlpha;","uniform float edgeAlpha;","float edgeBasic(sampler2D image, vec2 pixel) {","vec4 mtl = texture2D(image, pixel + resolution * vec2(-1.0,  1.0));","vec4 mtc = texture2D(image, pixel + resolution * vec2( 0.0,  1.0));","vec4 mtr = texture2D(image, pixel + resolution * vec2( 1.0,  1.0));","vec4 mcl = texture2D(image, pixel + resolution * vec2(-1.0,  0.0));","vec4 mcc = texture2D(image, pixel + resolution * vec2( 0.0,  0.0));","vec4 mcr = texture2D(image, pixel + resolution * vec2( 1.0,  0.0));","vec4 mbl = texture2D(image, pixel + resolution * vec2(-1.0, -1.0));","vec4 mbc = texture2D(image, pixel + resolution * vec2( 0.0, -1.0));","vec4 mbr = texture2D(image, pixel + resolution * vec2( 1.0, -1.0));","float dtl = abs(mtl.r - mcc.r) / 2.0;","float dtc = abs(mtc.r - mcc.r) / 1.0;","float dtr = abs(mtr.r - mcc.r) / 2.0;","float dcl = abs(mcl.r - mcc.r) / 1.0;","float dcr = abs(mcr.r - mcc.r) / 1.0;","float dbl = abs(mbl.r - mcc.r) / 2.0;","float dbc = abs(mbc.r - mcc.r) / 1.0;","float dbr = abs(mbr.r - mcc.r) / 2.0;","return 0.4 * (dtl + dtc + dtr + dcl + dcr + dbl + dbc + dbr);","}","float edgeFreiChen(sampler2D image, vec2 pixel) {","float n1 = 0.3535533845424652;","float n2 = 0.1666666716337204;","float n3 = 0.1666666716337204;","float n4 = 0.6666666865348816;","mat3 I;","mat3 G[9];","G[0] = mat3( n1, 0, -n1, 0.5, 0, -0.5, n1, 0, -n1 );","G[1] = mat3( n1, 0.5, n1, 0, 0, 0, -n1, -0.5, -n1 );","G[2] = mat3( 0, n1, -0.5, -n1, 0, n1, 0.5, -n1, 0 );","G[3] = mat3( 0.5, -n1, 0, -n1, 0, n1, 0, n1, -0.5 );","G[4] = mat3( 0, -0.5, 0, 0.5, 0, 0.5, 0, -0.5, 0 );","G[5] = mat3( -0.5, 0, 0.5, 0, 0, 0, 0.5, 0, -0.5 );","G[6] = mat3( n2, -n3, n2, -n3, n4, -n3, n2, -n3, n2 );","G[7] = mat3( -n3, n2, -n3, n2, n4, n2, -n3, n2, -n3 );","G[8] = mat3( n3, n3, n3, n3, n3, n3, n3, n3, n3 );","vec3 sample;","for (float i=0.0; i<3.0; i++) {","for (float j=0.0; j<3.0; j++) {","sample = texture2D(image, pixel + resolution * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","}","float cnv[9];","for (int i=0; i<9; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3;","}","float M = (cnv[0] + cnv[1]) + (cnv[2] + cnv[3]);","float S = (cnv[4] + cnv[5]) + (cnv[6] + cnv[7]) + (cnv[8] + M);","return sqrt(M / S);","}","float edgeSobel(sampler2D image, vec2 pixel) {","mat3 I;","mat3 G[2];","G[0] = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","G[1] = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","vec3 sample;","for (float i=0.0; i<3.0; i++)","for (float j=0.0; j<3.0; j++) {","sample = texture2D(image, pixel + resolution * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","float cnv[2];","for (int i=0; i<2; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3; ","}","return 0.017 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]);","}","float drawLine(float angle, float step, float thick) {","float pi = 3.141592653589793;","float kx = cos(angle / 180.0 * pi);","float ky = sin(angle / 180.0 * pi);","float ks = thick / step;","float len = dot(gl_FragCoord.xy, vec2(kx, ky));","float dist = abs((2.0 * mod(len, step) / step) - 1.0);","return clamp((ks - dist) * (1.0 / ks), 0.0, 1.0);","}","void main() {","vec2 pixel = gl_FragCoord.xy * resolution;","float fill = texture2D(tDiffuse, pixel).r;","float line1 = drawLine(-30.0, 10.0, 2.0);","float line2 = drawLine(80.0, 20.0, 2.0);","float level = 0.0;","level += edgeAlpha * edgeBasic(tDiffuse, pixel);","level += lineAlpha * max(fill * line1 * 0.9, fill * line2 * 0.3);","level += fillAlpha * fill;","if(level > 0.0) {","gl_FragColor = vec4(drawColor, drawAlpha * level);","} else {","gl_FragColor = vec4(0.0);","}","}"].join("\n")},THREE.HorizontalBlurShader={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.VerticalBlurShader={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2(  1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0,  1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2(  1.0,  1.0 ) ) * resolution ).xyz;","vec4 rgbaM = texture2D( tDiffuse,   gl_FragCoord.xy * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE ), max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},FileImport.prototype={onInputChange:function(){var e=this.input.files[0];e&&(this.events.emit("import",e),this.input.value=null)}},TileView.VERTICAL_SPLIT=1,TileView.HORIZONTAL_SPLIT=2,TileView.prototype={width:0,height:0,helperSize:1,makeFrame:function(e,t){var i={source:e,parent:t};return e&&e[0]?(i.split="v"===e[0]?TileView.VERTICAL_SPLIT:TileView.HORIZONTAL_SPLIT,i.head=this.makeFrame(e[1],i),i.tail=this.makeFrame(e[2],i),i.position=e[3]||.5,this.splits.push(i)):(i.index=this.frames.length,this.frames.push(i)),i},setLayout:function(e){this.splits=[],this.frames=[],this.root=this.makeFrame(e),this.helpers=[],this.ehelpers.innerHTML="";for(var t=0;t<this.splits.length;t++){var i=this.splits[t],n=new Drag(dom.div("tile-helper",this.ehelpers));n.min.x=n.min.y=0,n.max.x=n.max.y=1,n.events.on("start",this.startHelper,this,i),n.events.on("drag",this.dragHelper,this,i),this.helpers.push(n)}this.update()},setClients:function(e){if(this.clients=e||[],this.econtent.innerHTML="",e)for(var t=0;t<e.length;t++){var i=e[t];i&&i.element&&(dom.addclass(i.element,"tile-client"),dom.append(this.econtent,i.element))}},resize:function(e,t){this.width=e,this.height=t,this.setElement(this.element,NaN,NaN,this.width,this.height),this.update()},autoresize:function(){this.width=this.element.offsetWidth,this.height=this.element.offsetHeight,this.setElement(this.element,NaN,NaN,NaN,NaN),this.update()},update:function(){this.resizeFrame(this.root,0,0,this.width,this.height),this.helpers.forEach(this.updateHelper,this),this.clients.forEach(this.updateClient,this),this.events.emit("update")},resizeFrame:function(e,t,i,n,s){switch(arguments.length>1?(e.x=t,e.y=i,e.w=n,e.h=s):(t=e.x,i=e.y,n=e.w,s=e.h),e.split){case TileView.VERTICAL_SPLIT:var r=e.h*e.position,o=e.h*(1-e.position);this.resizeFrame(e.head,t,i,n,r),this.resizeFrame(e.tail,t,i+r,n,o);break;case TileView.HORIZONTAL_SPLIT:var a=e.w*e.position,l=e.w*(1-e.position);this.resizeFrame(e.head,t,i,a,s),this.resizeFrame(e.tail,t+a,i,l,s)}},setElement:function(e,t,i,n,s){if(e){var r=e.style;r.top=i+"px",
r.left=t+"px",r.width=n+"px",r.height=s+"px"}},showClients:function(){this.setClients(),this.frames.forEach(function(e,t){var i=dom.div("tile-client tile-client-test",this.econtent),n=dom.div("tile-client-index absmid",i),s=dom.div("tile-client-size absmid",i);i.style.backgroundColor=f.rcolor(),n.innerHTML=t,this.clients[t]={element:i,resize:function(e,t){s.innerHTML=Math.round(e)+"x"+Math.round(t)}}},this),this.update()},startHelper:function(e,t){t.point.x=t.origin.x=e.position,t.point.y=t.origin.y=e.position},dragHelper:function(e,t){e.split===TileView.VERTICAL_SPLIT?e.position=f.clamp(t.point.y,0,1):e.position=f.clamp(t.point.x,0,1),e.source[3]=e.position,this.resizeFrame(e),this.update()},updateHelper:function(e,t){var i=this.splits[t];if(i.split===TileView.VERTICAL_SPLIT){var n=i.position*i.h;this.setElement(e.element,i.x,i.y+n,i.w,this.helperSize),dom.addclass(e.element,"tile-helper-vertical"),dom.remclass(e.element,"tile-helper-horizontal"),e.scale.y=1/i.h}else{var s=i.position*i.w;this.setElement(e.element,i.x+s,i.y,this.helperSize,i.h),dom.addclass(e.element,"tile-helper-horizontal"),dom.remclass(e.element,"tile-helper-vertical"),e.scale.x=1/i.w}},updateClient:function(e,t){if(e){var i=this.frames[t];e.element&&dom.display(e.element,!!i),i&&(this.setElement(e.element,i.x,i.y,i.w,i.h),e.resize&&e.resize(i.w,i.h),e.setViewport&&e.setViewport(i))}}},PointProjector.prototype={clear:function(){this.points=[]},addPoint:function(e){var t={world:new THREE.Vector3,screen:new THREE.Vector2,local:!!e,visible:!1};return this.points.push(t),t},remPoint:function(e){var t=this.points.indexOf(e);~t&&this.points.splice(t,1)},viewportToWorld:function(e,t,i){return t||(t=new THREE.Vector3),t.copy(e),t.applyMatrix4(this.inverse),i&&t.sub(this.camera.position),t},worldToViewport:function(e,t,i){return t||(t=new THREE.Vector3),t.copy(e),i&&t.add(this.camera.position),t.applyMatrix4(this.matrix),t},viewportToScreen:function(e,t){return t||(t=new THREE.Vector2),t.x=(e.x/2+.5)*this.width,t.y=(-e.y/2+.5)*this.height,t},screenToViewport:function(e,t){return t||(t=new THREE.Vector3),t.x=e.x/this.width*2-1,t.y=-(e.y/this.height*2-1),t.z=-1,t},screenToWorld:function(e,t,i){return this.screenToViewport(e,this.viewport),this.viewportToWorld(this.viewport,t,i)},worldToScreen:function(e,t,i){return this.worldToViewport(e,this.viewport,i),this.viewportToScreen(this.viewport,t)},resize:function(e,t){this.width=e,this.height=t},updateMatrices:function(){this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.matrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.inverse.getInverse(this.camera.projectionMatrix),this.inverse.multiplyMatrices(this.camera.matrixWorld,this.inverse)},updatePoint:function(e){this.worldToViewport(e.world,this.viewport,e.local),this.viewportToScreen(this.viewport,e.screen),e.local?e.distance=e.world.length():e.distance=e.world.distanceTo(this.camera.position),e.visible=-1<=this.viewport.x&&this.viewport.x<=1&&-1<=this.viewport.y&&this.viewport.y<=1&&-1<=this.viewport.z&&this.viewport.z<=1},update:function(){this.points.forEach(this.updatePoint,this)}},Imagery.prototype={folders:{thumbs:"images/thumbs/",textures:"images/textures/"},types:{alpha:1,normal:2,texture:3,logo:11,thumb:12,icon:21},materialOptions:{defaults:{factory:THREE.MeshPhongMaterial,makeMap:!0,side:THREE.DoubleSide},norcon:{makeMap:!1,factory:THREE.LineBasicMaterial,vertexColors:THREE.VertexColors,linewidth:2,visible:!1},subtract:{visible:!1,transparent:!0,opacity:.5},blue:{makeEnv:!0,reflectivity:.25,shininess:22},gold:{makeEnv:!0,makeBump:!0,reflectivity:.8,shininess:95},black:{makeEnv:!0,reflectivity:.3,shininess:70},glass:{makeEnv:!0,transparent:!0,opacity:.9,reflectivity:.8,side:THREE.FrontSide},corner:{makeAlpha:!0,transparent:!0},pcorner:{makeAlpha:!0,transparent:!0},cut:{transparent:!0,opacity:0},wall:{makeNormal:!0},roof:{makeNormal:!0},normal:{factory:THREE.MeshNormalMaterial,makeMap:!1},wireframe:{wireframe:!0}},textureOptions:{},makeTexture:function(e){var t=new THREE.Texture;return t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.minFilter=THREE.LinearMipMapLinearFilter,t.magFilter=THREE.LinearFilter,t.anisotropy=4,t.image=this.pixel.image,f.copy(t,e),t.needsUpdate=!0,t},makeMaterial:function(e,t){var i=f.merge(this.materialOptions.defaults,this.materialOptions[e]||this.materialOptions[t],{name:e}),n=f.copy({},this.textureOptions[e]||this.textureOptions[t]);i.makeMap&&(i.map=this.makeTexture(n)),i.makeAlpha&&(i.alphaMap=this.makeTexture(n)),i.makeNormal&&(i.normalMap=this.makeTexture(n),i.normalMap.image=this.normal.image),i.makeBump&&(i.bumpMap=this.makeTexture(n),i.bumpMap.image=this.bump.image),i.makeEnv&&(i.envMap=this.skybox);var s=i.factory;delete i.makeMap,delete i.makeAlpha,delete i.makeNormal,delete i.makeBump,delete i.makeEnv,delete i.factory;var r=new s(i);return r.persistent=!0,r.implicit=!0,r.needsUpdate=!0,r.obvImplicit=new Observable(r.implicit),r.obvFabric=new Observable,r.obvLoaded=(new Observable).set(this,function(){this.setMaterialProduct(r,this.getLoadedProduct(r))}),r},configureSampleMaterial:function(e){if(e&&e.material){if("subtract"===e.name)return void(e.material=this.materials.subtract);for(var t=e.material,i=[t.map,t.bumpMap,t.normalMap].filter(Boolean),n=0;n<i.length;n++){var s=i[n],r={image:s.image};this.tileTexture(r),s.wrapS=THREE.RepeatWrapping,s.wrapT=THREE.RepeatWrapping,s.image=r.image,s.repeat.x*=r.repeatX,s.repeat.y*=r.repeatY}t.envMap=this.skybox,t.needsUpdate=!0}},readMaterialLoaded:function(){this.materials[m.name],this.usedProducts[m.name]},addMaterial:function(e,t){var i=this.materials[e]=this.makeMaterial(e,t);return Observable.inContext(null,this.addMaterialInContext,this,i),i},addMaterialInContext:function(e){this.obvMaterialsList.write(this.obvMaterialsList.read().concat(e))},remMaterialInContext:function(e){this.obvMaterialsList.write(f.adrop(this.obvMaterialsList.read().slice(),e))},copyMaterial:function(e,t){e&&t&&(e.implicit?this.setMaterial(e,null):this.setMaterial(e,this.usedProducts[t.name]))},rootMaterial:function(e){var t=this.materials[e];if(t){for(;t.parent;)t=t.parent;return t.name}},addSubmaterial:function(e){var t=this.materials[e];if(t){t.submaterials||(t.submaterials=[]);var i=this.rootMaterial(e),n=t.name+"-"+ ++this.submaterialIndex,s=this.addMaterial(n,i);return t.submaterials.push(s),s.parent=t,this.setMaterial(s,this.usedProducts[e]),s}},remSubmaterial:function(e){var t=e instanceof THREE.Material?e:this.materials[e];t&&(t.parent&&f.adrop(t.parent.submaterials,t),t.dispose(),delete this.usedProducts[t.name],delete this.materials[t.name],Observable.inContext(null,this.remMaterialInContext,this,t))},setMapImage:function(e,t,i){e&&t&&(e.image!==t.image&&(e.image=t.image,e.needsUpdate=!0),e.repeat.x=t.repeatX||1,e.repeat.y=t.repeatY||1,i&&(e.repeat.x=1/(t.cloneX||1)))},setMaterialProduct:function(e,t){if(e&&t){e.obvFabric&&e.obvFabric.write(t),e.color&&e.color.set(t.color||16777215);var i=["outer","fouter"].indexOf(t.unit)!==-1;if(this.setMapImage(e.map,t.texture||this.pixel,i),this.setMapImage(e.bumpMap,t.bump||this.bump,i),this.setMapImage(e.normalMap,t.normal||this.normal,i),this.setMapImage(e.alphaMap,t.alpha||this.pixel,i),e.submaterials)for(var n=0;n<e.submaterials.length;n++){var s=e.submaterials[n];s.implicit&&this.setMaterialProduct(s,t)}}},setImplicitProduct:function(e,t){if(t){for(var i=e.parent;i&&i.implicit;)i=i.parent;e.implicit=!!i&&t===this.usedProducts[i.name]}else e.implicit=!0;e.implicit&&(t=null),e.obvImplicit.write(e.implicit),this.usedProducts[e.name]=t;var n=e.submaterials;if(n)for(var s=0;s<n.length;s++){var r=n[s];this.setImplicitProduct(r,this.usedProducts[r.name])}},isProductLoaded:function(e){return e&&(!e.texture||Observable.unwrap(e.texture.loaded))&&(!e.normal||Observable.unwrap(e.normal.loaded))&&(!e.alpha||Observable.unwrap(e.alpha.loaded))},getLoadedProduct:function(e){for(var t="object"==typeof e?e:this.materials[e];t;){var i=this.usedProducts[t.name];if(this.isProductLoaded(i))return i;if(!t.parent)return this.baseMaps[t.name];t=t.parent}},getUsedProduct:function(e){for(var t="object"==typeof e?e:this.materials[e];t;){var i=this.usedProducts[t.name];if(i)return i;if(!t.parent)return this.baseMaps[t.name];t=t.parent}},setMaterial:function(e,t){var i="object"==typeof e?e:this.materials[e];i&&("object"!=typeof t&&(t=this.products[t]),t&&!t.id&&(t=null),this.setImplicitProduct(i,t),this.setMaterialProduct(i,this.getLoadedProduct(i)))},textureColor:function(e,t,i){this.buffer.width=t,this.buffer.height=i,this.btx.drawImage(e,0,0);for(var n=this.btx.getImageData(0,0,t,i),s=n.data,r=s.length,o=1/(t*i),a=0,l=0,h=0,c=0;c<r;c+=4)a+=s[c+0],l+=s[c+1],h+=s[c+2];return a*o<<16^l*o<<8^h*o<<0},tileTexture:function(e){if(e){var t=e.image;e.width=t.naturalWidth||t.width,e.height=t.naturalHeight||t.height,e.color=this.textureColor(t,e.width,e.height);var i=512,n=i/e.height,s=e.height/e.width;e.cloneX=1,e.cloneY=1,e.repeatX=(e.resolution||1)*n*s,e.repeatY=(e.resolution||1)*n;var r=!(e.width&e.width-1),o=!(e.height&e.height-1);if(!r||!o){for(var a=this.fitTileSize(e.width,e.height,10),l=this.makeCanvas(a.spaceX,a.spaceY),h=0;h<a.cloneX;h++)for(var c=0;c<a.cloneY;c++)l.drawImage(t,0,0,a.sourceX,a.sourceY,h*a.sizeX,c*a.sizeY,a.sizeX,a.sizeY);e.image=l.canvas,e.width=a.spaceX,e.height=a.spaceY,e.cloneX=a.cloneX,e.cloneY=a.cloneY,e.repeatX/=a.cloneX,e.repeatY/=a.cloneY,this.debugFit(a,e)}}},fitTileSize:function(e,t,i){for(var n={sourceX:e,sourceY:t,score:1/0},s=0;s<=i;s++){var r=1<<s,o=Math.round(r/e),a=(r-e*o)/e;if(o)for(var l=0;l<=i;l++){var h=1<<l,c=Math.round(h/t),u=(h-t*c)/t,d=Math.abs(a),p=Math.abs(u),f=Math.abs(a-u),m=Math.sqrt(o*c),v=d+p+f/2+m/10;c&&v<n.score&&(n.sizeX=r/o,n.sizeY=h/c,n.cloneX=o,n.cloneY=c,n.spaceX=r,n.spaceY=h,n.errorX=a,n.errorY=u,n.error=f,n.score=v)}}return n},debugFit:function(e,t){var i;e.error>.4?i=console.error:Math.abs(e.errorX)>.4||Math.abs(e.errorY)>.4?i=console.warn:this.debug&&(i=console.log),i&&i.call(console,"tile:",e.sourceX+"x"+e.sourceY,"->",Math.round(e.sizeX)+"x"+Math.round(e.sizeY),"("+e.spaceX+"x"+e.spaceY+",",e.cloneX+"x"+e.cloneY+")","errors:",+e.errorX.toFixed(2),"-",+e.errorY.toFixed(2),"=",e.error,"\n",t.url)},normalColor:function(e,t,i){return"rgb("+new THREE.Vector3(e,t,i).normalize().multiplyScalar(127).addScalar(127).toArray().map(Math.round)+")"},unwrapCubemap3x2:function(e){for(var t=e.height/2,i=[],n=0;n<2;n++)for(var s=0;s<3;s++){var r=this.makeCanvas(t,t);r.drawImage(e,s*t,n*t,t,t,0,0,t,t),i.push(r.canvas)}var o=[i[2],i[0],i[4],i[3],i[5],i[1]];this.skybox.image=o,this.skybox.needsUpdate=!0},makeCanvas:function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,i.getContext("2d")},makePixel:function(e){var t=this.makeCanvas(1,1);return t.fillStyle=e,t.fillRect(0,0,1,1),{image:t.canvas}},makePattern:function(e,t,i,n){var s=this.makeCanvas(t,i);"function"==typeof n&&n.apply(this,[s,t,i].concat([].slice.call(arguments,4)));var r=512*e/i;return{loaded:!0,width:t,height:i,repeatX:r,repeatY:r,image:s.canvas}},drawDash:function(e,t,i,n,s,r){e.fillStyle=n,e.fillRect(0,0,t,i),e.lineWidth=s,e.strokeStyle=r,e.beginPath(),e.moveTo(2*t,-i),e.lineTo(-t,2*i),e.moveTo(2*t,0),e.lineTo(0,2*i),e.moveTo(t,-i),e.lineTo(-t,i),e.stroke()},drawGrid:function(e,t,i,n,s,r){e.fillStyle=n,e.fillRect(0,0,t,i),e.fillStyle=r,e.fillRect(0,0,t,s),e.fillRect(0,0,s,i)},drawStripe:function(e,t,i,n,s,r,o){e.fillStyle=n,e.fillRect(0,0,t,i),e.fillStyle=r,e.fillRect(0,0,o?s:t,o?i:s)},drawChecker:function(e,t,i,n,s){var r=t>>1,o=i>>1;e.fillStyle=n||"white",e.fillRect(0,0,t,i),e.fillStyle=s||"black",e.fillRect(0,0,r,o),e.fillRect(r,o,r,o)},drawCloud:function(e,t,i,n,s){this.drawRandom(e,t,i,n,s),e.save(),e.globalAlpha=.4,e.scale(4,4),e.drawImage(e.canvas,0,0),e.scale(4,4),e.drawImage(e.canvas,0,0),e.restore()},drawRandom:function(e,t,i,n,s){for(var r=e.getImageData(0,0,t,i),o=r.data,a=255*n|0,l=255*s|0,h=0;h<o.length;h+=4)o[h+0]=o[h+1]=o[h+2]=f.rand(a)+l,o[h+3]=255;e.putImageData(r,0,0)}},Sampler.prototype={folder:"",setImagery:function(e){this.imagery=e},addSample:function(e){if(e&&!e.hide){var t=new Sample(e,this);return this.samples[t.id]&&console.warn("Sample with id",t.id,"already exists"),this.samples[t.id]=t,t}},addSampleList:function(e){e.forEach(this.addSample,this)},getList:function(){return Object.keys(this.samples)},readFile:function(e,t){var i=new FileReader,n=new Defer(function(){return JSON.parse(i.result)});return dom.on("load",i,f.binds(n.resolve,n)),i.readAsText(e),n.then(function(e){var t=new THREE.ObjectLoader,i=new Defer;return t.parse(e,function(e){i.resolve(e)}),i}).then(function(i){return this.addSample({id:t,src:e.name,object:i})},this)}},Sample.prototype={traverse:function(e,t,i,n,s,r){if(e&&(null==r&&(r=0),t.call(i||this,e,n,r),e.children))for(var o=e.children.length,a=s?0:o-1;s?a<o:a>=0;s?a++:a--)this.traverse(e.children[a],t,i,n,s,r+1)},load:function(){if(this.object&&(this.deferLoad=(new Defer).resolve(this)),this.deferLoad)return this.deferLoad;var e=new Defer,t=this.parent.folder+this.src;if(!this.src)return e.resolve(null),e;switch(this.format){case"obj":var i=new Loader;i.obj(t).defer.push(e);break;case"fbx":var i=new THREE.FBXLoader;i.load(t,function(t){e.resolve(t)},void 0,function(t){e.reject(t)});break;case"dae":var i=new THREE.ColladaLoader;i.load(t,function(t){e.resolve(t.scene)},void 0,function(t){e.reject(t)});break;default:case"json":var i=new Loader;i.onProgress(function(){this.progress=i.bytesLoaded/i.bytesTotal},this),i.json(t).defer.then(function(e){var t=new THREE.ObjectLoader,i=new Defer;return t.parse(e,function(e){i.resolve(e)}),i},this).push(e)}return this.deferLoad=e.then(this.configure,this.loadError,this),this.deferLoad},loadError:function(e){console.warn("Sample load error",this.src||this.id,e)},configure:function(e){if(e)return e.position.length()&&console.error("sample",this.src||this.id,"not zero position:",e.position),this.progress=1,this.object=e,this.object.updateMatrixWorld(),this.config||(this.config={}),this.width||(this.width=this.config.width||1),this.height||(this.height=this.config.height||1),this.depth||(this.depth=this.config.depth||1),this.meshes||(this.meshes=this.config.meshes||[]),this.parts=[],this.box.makeEmpty(),this.sphere.radius=-1,this.traverse(this.object,this.configureObject),this.box.getSize(this.size),this},configureJoint:function(e){var t=e.name.slice(1).split("_"),i={id:t[0],param:t[1],extra:t[2],depth:t[3],parts:t,point:new THREE.Vector3,normal:new THREE.Vector3,object:e};i.point.setFromMatrixPosition(e.matrix),i.normal.set(1,0,0).applyMatrix4(e.matrix).sub(i.point);var n=this.parent.imagery&&this.parent.imagery.materials.norcon,s=new THREE.Line(new THREE.Geometry,n);s.geometry.vertices.push(new THREE.Vector3,i.normal.clone().setLength(20)),s.geometry.colors.push(new THREE.Color(0,0,0),new THREE.Color(1,0,0)),s.position.copy(i.point),s.name="debug-connection-normal",e.visible=!1,this.object.add(s),this.joints.push(i)},configureSubtract:function(e){return e.parent.remove(e),e.geometry?(this.subtractMesh&&console.warn("sample",this.src||this.id,"has multiple subtract meshes"),this.subtractMesh=e,void(e.visible=!0)):void console.error("sample",this.src||this.id,"subtract mesh without geometry")},configureObject:function(e){return this.parent.imagery&&this.parent.imagery.configureSampleMaterial(e),/^:/.test(e.name)?void this.configureJoint(e):"subtract"===e.name?void this.configureSubtract(e):void(e.geometry&&(e.userData.stencilWrite=!0,e.geometry.persistent=!0,e.geometry.boundingBox||e.geometry.computeBoundingBox(),e.geometry.boundingSphere||e.geometry.computeBoundingSphere(),this.sphere.radius>0?this.sphere.union(e.geometry.boundingSphere):this.sphere.copy(e.geometry.boundingSphere),this.box.union(e.geometry.boundingBox)))},smoothShadeGeometry:function(e){var t=new THREE.Geometry;return e instanceof THREE.BufferGeometry?t.fromBufferGeometry(e):t.copy(e),t.mergeVertices(),t.computeVertexNormals(),t.computeFaceNormals(),t},configureAnchors:function(e){for(var t=this.width,i=this.height,n=this.depth,s=e.geometry.vertices.length,r=f.apick(this.meshes,"name",e.name)||{},o={ax:r.anchorX||[],ay:r.anchorY||[],az:r.anchorZ||[],anchors:[],offsets:[],size:s,mesh:e},a=o.ax.length,l=o.ay.length,h=o.az.length,c=a===s,u=l===s,d=h===s,p=0;p<s;p++){var m=e.geometry.vertices[p],v=c?r.anchorX[p]:m.x/t,g=u?r.anchorY[p]:m.y/i,b=d?r.anchorZ[p]:m.z/n,y=m.x-v*t,w=m.y-g*i,E=m.z-b*n;o.anchors.push(new THREE.Vector3(v,g,b)),o.offsets.push(new THREE.Vector3(y,w,E))}this.parts.push(o),(a&&!c||l&&!u||h&&!d)&&(this.dirty=!0)},mold:function(e,t){if(e){t||(t={});for(var i=t.width||this.width,n=t.height||this.height,s=t.depth||this.depth,r=0;r<this.parts.length;r++){for(var o=this.parts[r],a=e.children[r],l=0;l<a.geometry.vertices.length;l++){var h=a.geometry.vertices[l],c=o.anchors[l],u=o.offsets[l];h.x=u.x+c.x*i,h.y=u.y+c.y*n,h.z=u.z+c.z*s}a.geometry.verticesNeedUpdate=!0}return e.userData.width=i,e.userData.height=n,e.userData.depth=s,e}},raw:function(){if(this.object){for(var e=this.clone(),t=0;t<e.children.length;t++){var i=e.children[t];i.geometry=i.geometry.clone()}return e}},clone:function(){if(this.object){return this.object.clone(!0)}},bake:function(e){return this.mold(this.raw(),e)},describeObject:function(e,t,i){var n=[];i&&n.push(Array(i+1).join("\t")),n.push(e.type),n.push("name: {"+e.name+"}"),e.material&&n.push("mat: {"+e.material.name+"}"),e.geometry&&n.push("v:",e.geometry instanceof THREE.BufferGeometry?e.geometry.attributes.position.count:e.geometry.vertices.length),n.push("pos: ["+[f.mround(e.position.x,3),f.mround(e.position.y,3),f.mround(e.position.z,3)].join(", ")+"]"),n.push("rot: ["+[f.hround(f.xdeg*e.rotation.x),f.hround(f.xdeg*e.rotation.y),f.hround(f.xdeg*e.rotation.z)].join(", ")+"]"),console.log.apply(console,n)},describe:function(){console.log("sample id: {"+this.id+"} src: {"+(this.src||"")+"}"),this.traverse(this.object,this.describeObject,this,null,!0)}},View3.prototype={enableGrid:!1,enableRender:!0,enableWireframe:!1,enableRaycast:!0,enableStencil:!0,enableFXAA:!0,enableBloom:!0,renderTarget:null,clearColor:"#EEEEEE",focusThetaMin:.5,focusThetaMax:2.2,focusDistance:1,focusDuration:300,stencilNone:{value:0,params:{}},stencilHover:{value:1,params:{drawColor:"#00FF77",drawAlpha:1,lineAlpha:0,edgeAlpha:1,fillAlpha:.03}},stencilSelect:{value:2,params:{drawColor:"#00FF77",drawAlpha:1,lineAlpha:.4,edgeAlpha:.9,fillAlpha:.1}},handleEvent:function(e){switch(e.type){case"mousemove":return this.onMouseMove(e);case"mouseout":return this.onMouseOut(e);case"tap":return this.onTap(e)}},makeShader:function(e){if(e)return new THREE.ShaderMaterial({vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:THREE.UniformsUtils.clone(e.uniforms)})},makeGrid:function(){for(var e=10,t=200,i=new THREE.Color(3355443),n=new THREE.Color(12303291),s=2*e/t,r=[],o=[],a=-t,l=0,h=-e;a<=t;a++,h+=s){r.push(-e,0,h,e,0,h),r.push(h,0,-e,h,0,e);var c=a%10===0?i:n;c.toArray(o,l),l+=3,c.toArray(o,l),l+=3,c.toArray(o,l),l+=3,c.toArray(o,l),l+=3}var u=new THREE.BufferGeometry;u.addAttribute("position",new THREE.Float32BufferAttribute(r,3)),u.addAttribute("color",new THREE.Float32BufferAttribute(o,3));var d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});return d.transparent=!0,new THREE.LineSegments(u,d)},makeGridSystem:function(){this.gridXZ=this.makeGrid(),this.gridXY=this.makeGrid(),this.gridYZ=this.makeGrid(),this.gridXZ.normal=new THREE.Vector3(0,1,0),this.gridXY.normal=new THREE.Vector3(0,0,1),this.gridYZ.normal=new THREE.Vector3(1,0,0),this.grid.add(this.gridXZ),this.grid.add(this.gridXY),this.grid.add(this.gridYZ),this.gridXY.rotation.x=Math.PI/2,this.gridYZ.rotation.z=Math.PI/2},makePreloader:function(){this.preloaderBox=dom.div("view-preloader-box absmid out-03 hidden",this.element),this.preloaderBlocks=[];for(var e=0;e<10;e++)this.preloaderBlocks.push(dom.div("view-preloader-block",this.preloaderBox))},setLoading:function(e){this.preloaderEnabled!==!!e&&(this.preloaderEnabled=!!e,dom.togclass(this.preloaderBox,"hidden",!e))},setProgress:function(e){if(this.preloaderProgress!==e){this.preloaderProgress=e;for(var t=this.preloaderBlocks.length,i=f.clamp(e,0,1)*t,n=Math.floor(i),s=i-n,r=0;r<t;r++)this.preloaderBlocks[r].style.opacity=r<n?1:r>n?0:s}},setPreloader:function(e){e&&e.progress<1?(this.preloaderSample=e,this.setLoading(!0),this.setProgress(e.progress)):(this.preloaderSample=null,this.setLoading(!1))},updateLights:function(){this.dirLight.position.copy(this.camera.position)},updateGrid:function(){if(this.enableGrid){this.raycaster.setFromCamera({x:0,y:0},this.camera);var e=this.raycaster.ray.direction,t=e.dot(this.gridXZ.normal),i=e.dot(this.gridXY.normal),n=e.dot(this.gridYZ.normal);this.gridXZ.material.opacity=Math.abs(t),this.gridXY.material.opacity=Math.abs(i),this.gridYZ.material.opacity=Math.abs(n)}},orbitTo:function(e,t,i,n){var s=1e-9,r=this.camera.position,o=this.orbit.target;e||(e=o);var a=new THREE.Vector3,l=new THREE.Vector3,h=new THREE.Matrix4,c=r.distanceTo(o),u=(r.distanceTo(e),this.orbit.minDistance),d=this.orbit.maxDistance,p=f.clamp(isNaN(i)?c:i,u,d);a.subVectors(r,o).setLength(p);var m=Math.acos(a.y/p),v=Math.max(this.focusThetaMin,this.orbit.minPolarAngle),g=Math.min(this.focusThetaMax,this.orbit.maxPolarAngle),b=f.clamp(isNaN(n)?m:n,v,g);if(Math.abs(b-m)>s){var y=l;y.set(-a.z,0,a.x).normalize(),h.makeRotationAxis(y,m-b),a.applyMatrix4(h)}l.addVectors(e,a),this.orbitTween.stop(),this.cameraTween.stop(),t?(o.distanceToSquared(e)>s&&this.orbitTween.from(o).to(e,t).start(),r.distanceToSquared(l)>s&&this.cameraTween.from(r).to(l,t).start()):(r.copy(l),o.copy(e),this.orbit.update())},focusOnTree:function(e){isNaN(e)&&(e=this.focusDuration),this.updateTreeSize();var t=30*Math.sqrt(this.treeSize);this.orbitTo(this.treeCenter,e,t)},focusOnNode:function(e,t){isNaN(t)&&(t=this.focusDuration);4*e.sample.size.y*this.focusDistance;this.orbitTo(e.localCenter,t)},lookAt:function(){},setTree:function(e){this.tree&&this.root.remove(this.tree.object),this.tree=e,this.tree&&(this.root.add(this.tree.object),this.root.updateMatrixWorld()),this.updateTreeSize(),this.updateProjection(),this.updateConnections(),this.focusOnTree(),this.needsRedraw=!0},updateTreeSize:function(){this.tree?(this.tree.updateSize(),this.treeCenter.copy(this.tree.boxCenter),this.treeSize=this.tree.boxLength):(this.treeCenter.set(0,0,0),this.treeSize=100)},updateConnections:function(){this.markers.clear(),this.tree&&(this.tree.object.updateMatrixWorld(),this.tree.traverseConnections(this.addConnectionMarker,this))},addConnectionMarker:function(e){e.marker=this.markers.addMarker(e.getPosition(),e.data.object.name,e)},updateProjection:function(){this.camera.fov=70,this.camera.aspect=this.width/this.height,this.camera.far=100*this.treeSize,this.camera.near=.01*this.treeSize,this.camera.updateProjectionMatrix(),this.needsRetrace=!0},onTransformControlsChange:function(){var e=this.transformConnection;e&&(e.updateControl(),this.updateConnections(),this.markers.removeMarker(e.marker)),this.needsRedraw=!0},onKey:function(e){if(e.ctrlKey||e.shiftKey||e.altKey);else if(kbd.down&&kbd.changed)switch(kbd.key){case"1":return this.transform.setMode("translate");case"2":return this.transform.setMode("rotate");case"3":return this.transform.setMode("scale");case"q":return this.transform.setSpace("local");case"w":return this.transform.setSpace("world");case"x":return this.enableWireframe=!this.enableWireframe,this.needsRedraw=!0,dom.togclass(this.markers.element,"debug",this.enableWireframe),void this.markers.update();case"z":return this.enableRender=!this.enableRender,void(this.needsRedraw=!0);case"g":return this.enableGrid=!this.enableGrid,void(this.needsRedraw=!0)}},setViewport:function(e){this.viewport=e,this.onResize()},updateConnectionType:function(e,t){console.log(e.marker)},setConnectionTypes:function(e){this.tree&&this.tree.traverseConnections(this.updateConnectionType,this,e)},updateMeshStencil:function(e,t){e.userData.stencilWrite&&(e.stencilValue=t)},updateNodeStencil:function(e){var t=e.selected?this.stencilSelect.value:e.hovered?this.stencilHover.value:this.stencilNone.value;e.sample.traverse(e.sampleObject,this.updateMeshStencil,this,t)},selectConnection:function(e){(!e||e.inactive.value||e.connected)&&(e=null);var t=this.selectedConnection;t!==e&&(t&&(t.selected=!1,t.marker.updateState()),this.selectedConnection=e,e&&(e.selected=!0,e.marker.updateState()),this.events.emit("connection_select",e))},selectNode:function(e){var t=this.nodeSelected;e!==t&&(t&&(t.selected=!1,this.updateNodeStencil(t)),this.nodeSelected=e,e&&(e.selected=!0,this.updateNodeStencil(e)),this.events.emit("node_select",[e,t]),this.needsRedraw=!0)},hoverNode:function(e){var t=this.nodeHovered;e!==t&&(t&&(t.hovered=!1,this.updateNodeStencil(t)),this.nodeHovered=e,e&&(e.hovered=!0,this.updateNodeStencil(e)),dom.togclass(this.element,"hand",!!e),this.events.emit("node_hover",[e,t]),this.needsRedraw=!0)},updatePointer:function(e){this.fpvEnabled?(this.mouse.x=this.width/2,this.mouse.y=this.height/2,this.mouse2.x=0,this.mouse2.y=0):(e&&(this.mouse.x=e.pageX-this.elementOffset.x,this.mouse.y=e.pageY-this.elementOffset.y),this.mouse2.x=this.mouse.x/this.width*2-1,this.mouse2.y=2*-(this.mouse.y/this.height)+1),this.mouse2.z=-1},retrace:function(){if(this.enableRaycast&&this.tree){this.projector.viewportToWorld(this.mouse2,this.mouse3,!0),this.raycaster.setFromCamera(this.mouse2,this.camera);var e=this.raycaster.intersectObject(this.scene,!0);this.hoverNode(e.length&&e[0].object.node)}},onMouseMove:function(e){this.updatePointer(e),this.needsRetrace=!0},onMouseOut:function(e){this.updatePointer(e),this.needsRetrace=!0},onTap:function(e){e.target===this.element&&(this.transformConnection?(this.transformConnection.detachControl(),this.transformConnection=null,this.updateConnections(),this.needsRedraw=!0):this.selectConnection(null),this.selectNode(this.nodeHovered))},onMarkerTap:function(e){var t=e.connection;t&&(kbd.state.CTRL?(this.transformConnection=t,this.transformConnection.attachControl(this.transform),this.markers.removeMarker(t.marker),this.needsRedraw=!0):this.selectConnection(t))},resizeRenderTargets:function(e,t){this.rtStencil=new THREE.WebGLRenderTarget(e,t,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.rt1=this.rtStencil.clone(),this.rt2=this.rtStencil.clone()},resizeShaders:function(e,t){var i=1/e,n=1/t;this.smOverlay&&this.smOverlay.uniforms.resolution.value.set(i,n),this.smFXAA&&this.smFXAA.uniforms.resolution.value.set(i,n),this.smVBlur&&(this.smVBlur.uniforms.v.value=n),this.smHBlur&&(this.smHBlur.uniforms.h.value=i)},onResize:function(){this.width=this.element.offsetWidth,this.height=this.element.offsetHeight,this.elementOffset=dom.offset(this.element),this.projector.resize(this.width,this.height),this.viewport||(this.renderer.setSize(this.width,this.height),this.resizeRenderTargets(this.width,this.height),this.resizeShaders(this.width,this.height)),this.updateProjection(),this.needsRetrace=!0},draw:function(){function e(){var e=d;d=u,u=e}function t(){o?(a.setViewport(o.x,o.y,o.w,o.h),a.setScissor(o.x,o.y,o.w,o.h),a.setScissorTest(!0)):a.setScissorTest(!1)}function i(e,i,n){i||(i=h),n||(n=c),t(),a.render(i,n,e)}function n(e,i,n,s){t(),e?a.clearTarget(e,i,n,s):a.clear(i,n,s)}function s(e,t,i){for(var n in i){var s=e.uniforms[n];if(s){var r=i[n];s.value instanceof THREE.Color?s.value.set(r):s.value=r}}t&&(e.uniforms.tDiffuse.value=t.texture),l.material=e}var r=this.renderer.context,o=this.viewport,a=this.renderer,l=this.srPlane,h=this.srScene,c=this.srCamera,u=this.rt1,d=this.rt2;if(this.renderer.setClearColor(this.clearColor),n(this.renderTarget),this.scene.updateMatrixWorld(!0),this.enableRender&&(this.grid.visible=!1,this.root.visible=!0,this.renderer.render(this.scene,this.camera,this.renderTarget),i(this.renderTarget,this.scene,this.camera)),this.enableGrid&&(this.grid.visible=!0,this.root.visible=!1,i(this.renderTarget,this.scene,this.camera)),this.enableWireframe&&(this.scene.overrideMaterial=this.wireMaterial,i(this.renderTarget,this.scene,this.camera),this.scene.overrideMaterial=null),this.enableStencil&&this.smFill&&this.smCopy&&this.smOverlay){r.enable(r.STENCIL_TEST),r.stencilOp(r.KEEP,r.KEEP,r.REPLACE),this.scene.overrideMaterial=this.smFill,n(this.rtStencil),i(this.rtStencil,this.scene,this.camera),this.scene.overrideMaterial=null,this.renderer.setClearColor(0,0),n(d),n(u),r.disable(r.DEPTH_TEST),r.stencilOp(r.KEEP,r.KEEP,r.KEEP);for(var p=[this.stencilHover,this.stencilSelect],f=0;f<p.length;f++){var m=p[f];r.stencilFunc(r.EQUAL,m.value,255),s(this.smFill),this.renderer.setClearColor(0,1),n(this.rtStencil,!0,!0,!1),i(this.rtStencil),r.stencilFunc(r.ALWAYS,0,255),s(this.smOverlay,this.rtStencil,m.params),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE),i(u),r.disable(r.BLEND)}this.enableFXAA&&this.smFXAA&&(s(this.smFXAA,u),i(d),e()),this.enableBloom&&this.smVBlur&&this.smHBlur&&(s(this.smVBlur,u),i(d),s(this.smHBlur,d),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),i(),r.disable(r.BLEND)),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),s(this.smCopy,u),i(),r.disable(r.BLEND),r.disable(r.STENCIL_TEST),r.enable(r.DEPTH_TEST)}},onTick:function(e){if(this.preloaderSample){var t=this.preloaderSample.progress;this.setProgress(t),this.setLoading(t<1),t>=1&&delete this.preloaderSample}this.transform.update(),this.orbitTween.playing&&(this.orbit.target.x+=this.orbitTween.delta.x,this.orbit.target.y+=this.orbitTween.delta.y,this.orbit.target.z+=this.orbitTween.delta.z),this.cameraTween.playing&&(this.camera.position.x+=this.cameraTween.delta.x,this.camera.position.y+=this.cameraTween.delta.y,this.camera.position.z+=this.cameraTween.delta.z),(this.orbitTween.playing||this.cameraTween.playing)&&(this.camera.lookAt(this.orbit.target),this.needsRedraw=!0),this.camera.updateMatrixWorld(),this.lastcam.equals(this.camera.matrixWorld)||(this.lastcam.copy(this.camera.matrixWorld),this.needsRetrace=!0),this.needsRetrace&&(this.needsRetrace=!1,this.needsRedraw=!0,this.projector.updateMatrices(),this.updateLights(),this.updateGrid(),this.retrace()),this.needsRedraw&&(this.needsRedraw=!1,this.draw(),this.projector.update(),this.markers.update())}},THREE.Object3D.prototype.onBeforeRender=function(e,t,i,n,s,r){if(this.userData.stencilWrite){var o=e.context;o.stencilFunc(o.ALWAYS,+this.stencilValue||0,255)}},THREE.Object3D.prototype.onAfterRender=function(e,t,i,n,s,r){if(this.userData.stencilWrite){e.context}},TNode=f.unit({unitName:"TNode",init:function(e){this.object=new THREE.Object3D,this.box=new THREE.Box3,this.boxCenter=new THREE.Vector3,this.boxSize=new THREE.Vector3,this.boxLength=1,this.sphere=new THREE.Sphere,this.localBox=new THREE.Box3,this.localCenter=new THREE.Vector3,this.localSize=new THREE.Vector3,this.localLength=1,this.localSphere=new THREE.Sphere,this.connections=[],e&&this.setSample(e)},traverse:function(e,t,i){var n=e.call(t||this,this,i);if(n===TNode.TRSTOP)return n;for(var s=0;s<this.connections.length;s++){var r=this.connections[s];if(r.connected&&r.master){var n=r.target.traverse(e,t,i);if(n===TNode.TRSTOP)return n}}},traverseConnections:function(e,t,i){for(var n=0;n<this.connections.length;n++){var s=this.connections[n];e.call(t||this,s,i),s.connected&&s.master&&s.target.traverseConnections(e,t,i)}},includeConnection:function(e,t){if(t&&t.list){for(var i in t.test){var n=t.test[i],s=e[i];if(t.binary?!s!=!n:s!==n)return}t.list.push(e)}},retrieveConnections:function(e,t){var i=[];return this.traverseConnections(this.includeConnection,this,{test:e,binary:t,list:i}),i},setSample:function(e){if(this.sample)return console.warn("TN.setSample: node already has sample");var t=e.clone();return t?(this.sample=e,this.sampleObject=t,this.sample.traverse(this.sampleObject,this.setObjectParent,this),this.object.add(this.sampleObject),
this.connections=[],void e.joints.forEach(this.addConnection,this)):console.warn("TN.setSample: got no sample object")},setObjectParent:function(e){e.node=this},addConnection:function(e){this.connections.push(new TConnection(this,e,this.connections.length))},remConnection:function(){},pinch:function(){var e=[],t=[],i=[],n=0,s=-1,r=null,o=null,a=f.follow(this,"upnode").pop(),l=0,h=0;a.traverse(function(){h++}),this.traverse(function(){l++});for(var c=0;c<this.connections.length;c++){var u=this.connections[c];if(u.connected){for(var d=u.connected.node,p=0,m=d;m.upnode&&m.upnode!==this;)m=m.upnode;m.traverse(function(){p++}),m===a&&(p-=l),p>n&&(n=p,s=e.length,r=d,o=m),e.push(d),t.push(m),i.push(p)}}return{removeNode:this,removeCount:h-n,maxRoot:o}},pinchr:function(){var e=0;return this.traverse(function(){e++}),{removeNode:this,removeCount:e,maxRoot:null}},connect:function(e,t,i){if(!t)return console.warn("TN.connect to undefined node");var n=this.connections[e],s=t.connections[i];return n&&s?n.connected||s.connected?console.warn("TN.connect to used joint"):(t.upcon=s,t.upnode=this,void n.connect(s)):console.warn("TN.connect with undefined joint")},disconnect:function(){for(var e=0;e<this.connections.length;e++){var t=this.connections[e];t.connected&&t.disconnect()}},sizeUnion:function(e){e.sample?(e.localBox.copy(e.sample.box),e.localBox.applyMatrix4(e.object.matrixWorld),e.localBox.getCenter(e.localCenter),e.localBox.getSize(e.localSize),e.localLength=e.localSize.length(),this.box.union(e.localBox),e.localSphere.copy(e.sample.sphere),e.localSphere.center.applyMatrix4(e.object.matrixWorld),this.sphere.union(e.localSphere)):(this.box.expandByPoint(e.object.position),this.sphere.expandByPoint(e.object.position))},updateSize:function(){this.object.updateMatrixWorld(),this.box.makeEmpty(),this.sphere.radius=-1,this.sample&&this.sphere.copy(this.sample.sphere),this.traverse(this.sizeUnion,this),this.box.isEmpty()?(this.boxCenter.set(0,0,0),this.boxSize.set(1,1,1).normalize(),this.boxLength=1):(this.box.getCenter(this.boxCenter),this.box.getSize(this.boxSize),this.boxLength=this.boxSize.length())}}),TNode.TRSTOP={},TConnection=f.unit({unitName:"TConnection",init:function(e,t,i){this.node=e,this.index=i,this.target=null,this.master=null,this.connected=null,this.selected=!1,this.inactive=new Gate(Gate.AND,!1),this.events=new EventEmitter,this.point=new THREE.Vector3,this.normal=new THREE.Vector3,this.matrix=new THREE.Matrix4,this.object=new THREE.Object3D,this.data=t,this.depth=parseFloat(this.data.depth)||0,this.screw="screw"===this.data.extra,this.makeTween(),this.setPosition(t.object.matrix)},makeTween:function(){this.tween=(new TWEEN.Tween).easing(TWEEN.Easing.Cubic.InOut).onStart(this.onTweenStart,this).onUpdate(this.onTweenUpdate,this).onComplete(this.onTweenComplete,this)},onTweenStart:function(){this.events.emit("connect_start",this)},onTweenUpdate:function(){if(this.connected&&this.master){var e=this.tween.source;"distance"in e&&this.connected.object.position.copy(this.normal).setLength(e.distance),"screw"in e&&this.connected.object.rotateOnAxis(this.connected.normal,this.tween.delta.screw)}},onTweenComplete:function(){this.playNextStage()||this.events.emit("connect_end",this)},playNextStage:function(){if(!this.connected||!this.master)return!1;this.stage++;var e=this.depth+this.connected.depth,t=this.screw||this.connected.screw?2*Math.PI:0,i=this.connected.node.boxLength/2,n=!0;switch(this.stage){case 0:this.tween.from({distance:e+i}).to({distance:e}).delay(400).duration(1200),this.onTweenUpdate();break;case 1:if(!e){n=!1;break}this.tween.from({distance:e,screw:-t}).to({distance:0,screw:0}).delay(200).duration(1200);break;default:n=!1}return n&&this.tween.start(),n},playConnection:function(){this.stage=-1,this.playNextStage()},setPosition:function(e){this.matrix.copy(e),this.point.setFromMatrixPosition(e),this.normal.set(1,0,0).applyMatrix4(e).sub(this.point),!this.connected},getPosition:function(e){return e||(e=new THREE.Vector3),this.connected?e.setFromMatrixPosition(this.object.matrixWorld):e.copy(this.normal).setLength(this.depth).add(this.point).applyMatrix4(this.node.object.matrixWorld),e},getInnerPosition:function(e){return e||(e=new THREE.Vector3),e.copy(this.point).applyMatrix4(this.node.object.matrixWorld),e},paramPairsAllow:[["f","m"],["u","u"],["u","f"],["u","m"],["FP","MP"],["female","male"],["uniform","uniform"],["uniform","female"],["uniform","male"],["in","out"],["inner","outer"],["internal","external"]],paramPairsEqual:function(e){return f.seq(e,this)},canConnect:function(e){return this.data.id===e.data.id&&this.paramPairsAllow.some(this.paramPairsEqual,[this.data.param,e.data.param])},canConnectList:function(e){return e.filter(this.canConnect,this)},connect:function(e){var t=new THREE.Vector3,i=new THREE.Quaternion;t.copy(e.normal).negate(),i.setFromUnitVectors(t,this.normal),this.node.object.add(this.object),this.object.position.copy(this.point),this.object.add(e.object),e.object.position.set(0,0,0),e.object.quaternion.copy(i),e.object.add(e.node.object),e.node.object.position.copy(e.point).negate(),this.connected=e,this.target=e.node,this.master=!0,e.connected=this,e.target=this.node,e.master=!1,this.events.emit("connect",[this,e]),e.events.emit("connect",[e,this])},disconnect:function(){if(this.connected){var e=this.master?this:this.connected,t=this.master?this.connected:this;e.object.remove(t.object),e.connected=null,e.target=null,e.master=null,t.connected=null,t.target=null,t.master=null,e.events.emit("disconnect",[e,t]),t.events.emit("disconnect",[t,e])}},attachControl:function(e){e&&(this.control=e,this.controlObject=new THREE.Object3D,this.matrix.decompose(this.controlObject.position,this.controlObject.rotation,this.controlObject.scale),this.node.object.add(this.controlObject),e.attach(this.controlObject))},updateControl:function(){if(this.controlObject){this.setPosition(this.controlObject.matrix);var e=this.connected;e&&(this.master?this.connect(e):e.connect(this))}},detachControl:function(){this.control&&(this.control.detach(),this.node.object.remove(this.controlObject),delete this.controlObject,delete this.control)}}),UI=f.unit({unitName:"UI"}),UI.MarkerSystem=f.unit(Block,{unitName:"UI_MarkerSystem",ename:"marker-system noselect",create:function(){this.markers=[],this.markersVisible=new Gate(Gate.AND,!1),this.markersVisible.events.on("change",this.onMarkersVisible,this)},onMarkersVisible:function(e){for(var t=0;t<this.markers.length;t++){var i=this.markers[t];i.undisposable||i.visible.set(e,"system")}},addMarker:function(e,t,i,n){if(this.projector){var s=new UI.Marker({tipRoot:this.element,events:this.events,projector:this.projector,connection:i});return e&&s.point.world.copy(e),i&&i.getInnerPosition(s.inner.world),n?s.undisposable=!0:s.visible.set(this.markersVisible.value,"system"),s.updateState(),this.markers.push(s),s}},removeMarker:function(e){var t=this.markers.indexOf(e);t!==-1&&(this.markers.splice(t,1),e.destroy())},clear:function(){for(;this.markers.length;)this.removeMarker(this.markers[0])},update:function(){f.sort(this.markers,this.distanceSort,this),this.markers.forEach(this.updateMarker,this)},distanceSort:function(e){return-e.point.distance},updateMarker:function(e,t){e.element.style.zIndex=t,e.update()}}),UI.Marker=f.unit(Block.Tip,{unitName:"UI_Marker",ename:"marker hand",hidden:!0,align:"top",distance:100,arrowWidth:1,arrowPadding:-2,create:function(){dom.remclass(this.arrow,"tip-arrow"),dom.remclass(this.content,"tip-content"),dom.addclass(this.arrow,"marker-arrow"),dom.addclass(this.content,"marker-content marker-interactive out-02"),this.arrowLine=dom.div("marker-arrow-line marker-interactive out-02",this.arrow),this.elemGroup=dom.span("marker-group",this.content),this.elemInfo=dom.span("marker-info",this.content),dom.display(this.elemGroup,!1),dom.display(this.elemInfo,!1),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.className.baseVal="marker-depth-line marker-interactive out-02",this.svgLine=document.createElementNS("http://www.w3.org/2000/svg","line"),this.svgLine.setAttribute("x1",0),this.svgLine.setAttribute("y1",0),dom.append(this.svg,this.svgLine),dom.append(this.element,this.svg),this.state={hover:!1,selected:!1,connected:!1,inactive:!1,master:!1},this.connection&&(dom.text(this.elemInfo,this.connection.data.object.name),this.connection.events.when({connect:this.updateState},this)),this.point=this.projector.addPoint(),this.inner=this.projector.addPoint(),this.watchEvents.push(new EventHandler(this.onTap,this).listen("tap",this.element),new EventHandler(this.onEnter,this).listen("mouseenter",this.element),new EventHandler(this.onLeave,this).listen("mouseleave",this.element))},destroy:function(){Block.Tip.prototype.destroy.call(this),this.connection&&this.connection.events.off(null,null,this),this.projector.remPoint(this.point),Atlas.free(this.elemGroup)},updateState:function(){if(this.connection){for(var e in this.state){var t=this.connection[e];this.state[e]=t instanceof Gate?t.value:t}Atlas.free(this.elemGroup),dom.text(this.elemGroup,"");var i=this.connection.group;isNaN(i)||(i===-1?Atlas.set(this.elemGroup,"i-deny"):dom.text(this.elemGroup,String.fromCharCode(i+65))),dom.display(this.elemGroup,!isNaN(i)),this.visible.set(!isNaN(i),"mapped"),dom.setclass(this.element,this.state),this.visible.set(!this.state.connected,"available")}},onEnter:function(){this.events.emit("marker_enter",this)},onLeave:function(){this.events.emit("marker_leave",this)},onTap:function(){this.events.emit("marker_tap",this)},update:function(){var e=this.visible.value||this.inTransition,t=Math.round(this.point.screen.x),i=Math.round(this.point.screen.y),n=this.inner.screen.x,s=this.inner.screen.y,r=n-t,o=s-i,a=e&&this.connection&&this.connection.depth&&!isNaN(r)&&!isNaN(o);if(dom.display(this.svg,a),e&&(this.scale=.7*(1.3-Math.min(.7,this.point.distance/1.5)),this.move(t,i,this.align),a)){var l=Math.ceil(Math.abs(r)),h=Math.ceil(Math.abs(o)),c=Math.max(l,h);this.svg.setAttribute("width",2*c+2),this.svg.setAttribute("height",2*c+2),this.svg.setAttribute("viewBox",[-c-1,-c-1,2*c+2,2*c+2].join(" ")),this.svg.style.marginLeft=-c-1+"px",this.svg.style.marginTop=-c-1+"px",this.svg.style.left=t-this.elementPoint.x+"px",this.svg.style.top=i-this.elementPoint.y+"px",this.svgLine.setAttribute("x2",r),this.svgLine.setAttribute("y2",o)}},move:function(){Block.Tip.prototype.move.apply(this,arguments);var e=Math.max(0,this.lastDistance),t=this.arrowLine.style,i=this.arrowWidth+"px",n=e+"px";switch(t.left=t.right=t.top=t.bottom="auto",t.width=t.height=i,this.lastAlign){case"left":t.width=n,t.left="100%";break;case"right":t.width=n,t.right="100%";break;case"top":t.height=n,t.top="100%";break;case"bottom":t.height=n,t.bottom="100%"}}}),Plumber=f.unit({unitName:"Plumber",mode:"constructor",catchFiles:!1,catchSamples:!0,srcAtlas:"plumber-atlas.svg",srcCubemap:"plumber-cubemap.png",init:function(e){this.get=new Loader,this.timer=new Timer(this.onTick,this),this.ready=new Defer,this.imagery=new Imagery,this.events=new EventEmitter,this.sampler=new Sampler,this.sampler.setImagery(this.imagery),this.connectionParts=[],this.renderer=new THREE.WebGLRenderer({alpha:!1,depth:!0,stencil:!0,antialias:!0,preserveDrawingBuffer:!0}),this.renderer.autoClear=!1,this.tiles=new TileView,this.view=new View3({renderer:this.renderer}),this.view2=new View3({renderer:this.renderer,enableStencil:!1,enableRaycast:!1}),this.viewTween=new TWEEN.Tween({position:1}).to({position:1},400).easing(TWEEN.Easing.Cubic.Out).onUpdate(this.onViewTweenUpdate,this).onComplete(this.onViewTweenComplete,this),this.splitViewMessage=dom.div("split-view-message"),dom.text(this.splitViewMessage,"no compatible connections"),this.splitViewMessageVisible=new Gate(Gate.AND,!0),this.splitViewMessageVisible.events.on("change",dom.display,dom,this.splitViewMessage),this.splitViewMessageVisible.events.on("opened",this.updateSplitViewMessagePosition,this),this.splitViewMessageVisible.off("g_vm_cons"),this.emptyViewMessage=dom.div("empty-view-message out-03 absmid");var t=(dom.div("empty-view-message-center absmid",this.emptyViewMessage),dom.div("empty-view-message-frame absmid",this.emptyViewMessage),dom.div("empty-view-message-text absmid",this.emptyViewMessage));dom.html(t,["please","add","any product"].join("<br/>")),this.element=this.tiles.element,this.makeDeletePrompt(),dom.addclass(this.element,"ontouchstart"in window?"touch":"no-touch"),dom.addclass(this.element,"plumber"),dom.addclass(this.renderer.domElement,"canvas-main"),dom.prepend(this.element,this.renderer.domElement),dom.append(this.element,this.splitViewMessage),dom.append(this.element,this.emptyViewMessage);for(var i in e)switch(i){case"eroot":dom.append(e.eroot,this.element);break;case"mode":this.mode=e.mode;break;case"clearButton":dom.display(this.view.clearButton,e.clearButton),dom.display(this.view2.clearButton,e.clearButton);break;default:i in this&&(this[i]=e[i])}this.setMode(this.mode,!0),this.fetch()},setMode:function(e,t){if(this.mode!==e||t){this.mode=e;var i,n;switch(e){case"constructor":i=["h",0,0,1],n=[this.view,this.view2];break;default:console.warn("unknown mode given:",e,'fallback to "viewer"'),e="viewer";case"viewer":i=0,n=[this.view2]}if(this.modeis={ctr:"constructor"===e,vwr:"viewer"===e},this.clearTree(),this.view2.setTree(null),this.tiles.setLayout(i),this.tiles.setClients(n),this.splitView=this.tiles.splits[0],this.splitView){var s=this.splitView.position;this.viewTween.target.position=s,this.viewTween.source.position=s}this.splitViewMessageVisible.set(this.modeis.ctr,"g_vm_mode"),this.view.markers.markersVisible.off("g_m_view2"),this.view2.markers.markersVisible.off("g_m_view2"),this.view.markers.markersVisible.set(this.modeis.ctr,"g_m_mode"),this.view2.markers.markersVisible.set(this.modeis.ctr,"g_m_mode"),this.tiles.update()}},getConnectionsArray:function(){return this.tree.retrieveConnections({connected:!0},!0)},addElement:function(e,t,i){var n=t?this.addSample(e,t,i):this.sampler.samples[e];if(n)return this.displaySample(n.id),this.deferSample},addSample:function(e,t,i){return this.sampler.addSample({id:e,src:t,link:i})},fetch:function(){this.get.xml(this.srcAtlas).defer.then(Atlas.setSource),this.get.image(this.srcCubemap).defer.then(this.imagery.unwrapCubemap3x2,this.imagery),this.get.ready().detach(this.run,this)},makeDeletePrompt:function(){var e=new Block.Tip({eroot:this.element,align:"top",hidden:!0});dom.addclass(e.element,"prompt");var t=dom.div("prompt-text",e.content),i=dom.div("prompt-button hand prompt-button-ok",e.content),n=dom.div("prompt-button hand prompt-button-cancel",e.content);dom.text(i,"Yes"),dom.text(n,"No"),e.watchEvents.push(new EventHandler(this.deleteNode,this).listen("tap",i),new EventHandler(this.closeDeletePrompt,this).listen("tap",n)),this.deletePromptTipText=t,this.deletePromptTip=e},makeGUI:function(){function e(){t.view.needsRedraw=!0,t.view2.needsRedraw=!0}this.gui=new dat.GUI({hideable:!1}),this.gui.closed=!0,this.gui.addColor(this.view,"clearColor").name("Clear").onChange(e),this.gui.addColor(this.view.stencilSelect.params,"drawColor").name("Select").onChange(e),this.gui.addColor(this.view.stencilSelect.params,"drawColor").name("Select").onChange(e);var t=this},onViewClear:function(){this.clear()},onViewClear2:function(){this.displaySample(null),this.events.emit("onAddElement",{status:"canceled"})},clear:function(){this.displaySample(null),this.preloadSample(null),this.clearTree()},onViewTweenUpdate:function(e,t){this.splitView&&(this.splitView.position=t.position,this.tiles.update())},onViewTweenComplete:function(){this.splitScreen||(this.view2.setTree(null),this.sampleView2=null)},displaySample:function(e){var t=this.sampler.samples[e];if(t!==this.sampleView2){this.sampleView2=this.tree||"viewer"===this.mode?t:null,this.splitScreen=!(!this.sampleView2||!this.sampleView2.object&&!this.sampleView2.src),this.view.markers.markersVisible.off("g_m_view2"),this.view2.markers.markersVisible.off("g_m_view2"),this.splitViewMessageVisible.set(this.splitScreen,"g_vm_screen"),this.view.enableRaycast=!this.splitScreen,this.view.hoverNode(null),this.view.selectNode(null),this.view.selectConnection(null),this.view2.setTree(null);var i=this.splitScreen?.5:1;i!==this.viewTween.target.position&&(this.viewTween.target.position=i,this.viewTween.start()),this.sampleView2?this.preloadSample(t,this.setSample,this.view2):this.preloadSample(t,this.setMainTree,this.view),dom.togclass(this.emptyViewMessage,"hidden",this.tree||t)}},preloadSample:function(e,t,i){this.deferSample&&(this.deferSample.set(null),this.deferSample=null,this.view.setPreloader(null),this.view2.setPreloader(null)),e&&(i.setPreloader(e),this.deferSample=this.ready.then(e.load,e).detach(t,this))},setSample:function(e){if(e){var t=new TNode(e);this.view2.setTree(t),this.updateConnectionGroups(this.tree,t),this.view.markers.markersVisible.on("g_m_view2"),this.view2.markers.markersVisible.on("g_m_view2")}},setMainTree:function(e){e&&(this.absolutelySetMainTree(new TNode(e)),this.events.emit("onAddElement",{status:"connected"}))},updateConnectionGroups:function(e,t){this.cons=e&&e.retrieveConnections({connected:!1},!0)||[],this.cons2=t&&t.retrieveConnections({connected:!1},!0)||[];for(var i=[],n=0;n<this.cons2.length;n++)this.cons2[n].group=-1;for(var n=0;n<this.cons.length;n++){var s=this.cons[n],r=s.canConnectList(this.cons2);if(s.group=-1,r.length){for(var o=!1,a=0;a<i.length;a++)if(f.seq(r,i[a])){s.group=a,o=!0;break}if(!o){var l=i.length;s.group=l;for(var a=0;a<r.length;a++)r[a].group=l;i.push(r)}}}this.hasAvailableConnections=i.length,this.splitViewMessageVisible.set(!this.hasAvailableConnections,"g_vm_cons"),this.updateSplitViewMessagePosition(),this.updateConnectionVisibilitySets(),this.hasAvailableConnections||this.events.emit("onAddElement",{status:"rejected"}),this.view.needsRetrace=!0},updateConnectionVisibilitySets:function(){if(this.cons)for(var e=0;e<this.cons.length;e++)this.updateConnectionVisibility(this.cons[e],this.connectionParts[1]);if(this.cons2)for(var e=0;e<this.cons2.length;e++)this.updateConnectionVisibility(this.cons2[e],this.connectionParts[0])},updateConnectionVisibility:function(e,t){var i=e.group!==-1,n=!t||e.canConnect(t);e.inactive.set(!i||!n,"view2"),e.marker&&(e.marker.visible.set(!this.hasAvailableConnections||i,"active"),e.marker.updateState())},connectSample:function(e){if(e){if(!this.tree)return void this.setMainTree(e);var t=new TNode(e),i=this.tree.retrieveConnections({connected:!1},!0);f.sort(i,Math.random);e:for(var n=0;n<i.length;n++)for(var s=i[n],r=0;r<t.connections.length;r++){var o=t.connections[r];if(o.canConnect(s)){this.makeViewConnection(s,o);break e}}this.splitScreen&&this.updateConnectionGroups(this.tree,this.view2.tree)}},onkey:function(e){if(e.ctrlKey||e.shiftKey||e.altKey);else if(kbd.down&&kbd.changed)switch(kbd.key){case"ENTER":return void(this.deletePromptTip.visible.value&&this.deleteNode());case"ESC":return void(this.deletePromptTip.visible.value&&this.closeDeletePrompt());case"DEL":return void this.promptDeleteNode(this.view.nodeSelected);case"c":return this.view.focusOnTree(),void this.view2.focusOnTree();case"x":this.debug=!this.debug,this.imagery.materials.subtract.visible=!!this.debug,this.imagery.materials.norcon.visible=!!this.debug,this.debug&&this.view2.tree&&this.view2.tree.sample.describe();break;case"r":this.onViewClear();break;case"t":break;case"v":return void(this.gui.closed?this.gui.open():this.gui.close())}this.view.onKey(e),this.view2.onKey(e)},promptDeleteNode:function(e){e&&(this.deletePromptStat=e.pinch(),this.deletePromptStat.removeCount<2?this.deleteNode():(dom.text(this.deletePromptTipText,["Do you want to delete",this.deletePromptStat.removeCount,"nodes?"].join(" ")),this.deletePromptTip.visible.on()))},closeDeletePrompt:function(){this.deletePromptTip.visible.off(),delete this.deletePromptStat},clearTree:function(){this.tree&&(this.deletePromptStat=this.tree.pinchr(),this.deleteNode(),this.absolutelySetMainTree(null))},absolutelySetMainTree:function(e){this.tree=e,this.view.setTree(this.tree),dom.togclass(this.emptyViewMessage,"hidden",!!this.tree)},deleteNode:function(){var e=this.deletePromptStat;e&&(e.removeNode.disconnect(),this.absolutelySetMainTree(e.maxRoot),this.view.selectNode(null),this.closeDeletePrompt(),this.events.emit("onRemoveElement",e))},onresize:function(){var e=this.tiles.element,t=e.offsetWidth,i=e.offsetHeight;this.renderer.setSize(t,i),this.tiles.autoresize(),this.view.resizeRenderTargets(t,i),this.view.resizeShaders(t,i)},updateSplitViewMessagePosition:function(){if(this.splitView){var e=this.splitViewMessage,t=this.splitView,i=e.offsetWidth,n=e.offsetHeight,s=t.split===TileView.VERTICAL_SPLIT?.5:t.position,r=t.split===TileView.HORIZONTAL_SPLIT?.5:t.position,o=t.x+t.w*s-i/2,a=t.y+t.h*r-n/2;e.style.left=o+"px",e.style.top=a+.3*t.h+"px"}},onTilesUpdate:function(){return void(this.hasAvailableConnections||this.updateSplitViewMessagePosition())},onTap:function(e){this.deletePromptTip.visible.value&&(dom.ancestor(e.target,this.deletePromptTip.element)||dom.ancestor(e.target,this.view.markers.element)||this.closeDeletePrompt())},onDragOver:function(e){(this.catchFiles||this.catchSamples)&&(e.dataTransfer.dropEffect="copy",e.preventDefault())},onDrop:function(e){var t=e.dataTransfer;if(t.files&&t.files.length)this.catchFiles&&(this.importFile(t.files[0]),e.preventDefault());else if(this.catchSamples){var i=t.getData("text/sid"),n=this.sampler.samples[i];this.preloadSample(n,this.connectSample,this.view),e.preventDefault()}},importFile:function(e,t){return this.sampler.readFile(e,t).then(this.onSampleImport,this.onSampleImportFail,this)},onSampleImport:function(e){return this.displaySample(e.id),this.events.emit("onImportElement",e),e},onSampleImportFail:function(e){console.warn("File import error:",e)},onNodeSelect:function(e,t){var i=this.view.markers;if(t&&t.nodeMarker&&(i.removeMarker(t.nodeMarker),t.nodeMarker=null),e){var n=this.view.markers.addMarker(e.localBox.getCenter(),"remove",null,!0);n.deleteNode=e,n.align="bottom",n.visible.on(),dom.remclass(n.content,"marker-interactive"),n.bDel=dom.div("marker-action",n.content),n.watchEvents.push(new EventHandler(this.promptDeleteNode,this,e).listen("tap",n.bDel)),n.watchAtlas.push(Atlas.set(n.bDel,"i-delete")),e.sample.link&&(n.bInfo=dom.a(e.sample.link,"marker-action out-02",n.content),n.bInfo.setAttribute("target","_blank"),n.watchAtlas.push(Atlas.set(n.bInfo,"i-info"))),e.nodeMarker=n,kbd.state.SHIFT||this.view.focusOnNode(e)}},onConnectionSelect:function(e,t,i){this.connectionParts[t]=i,this.updateConnectionVisibilitySets();var n=this.connectionParts[0],s=this.connectionParts[1];n&&s&&this.makeViewConnection(n,s)},animatedConnections:0,makeViewConnection:function(e,t){this.view.markers.markersVisible.off("g_m_view2"),this.view2.markers.markersVisible.off("g_m_view2"),this.view.selectConnection(null),this.view2.selectConnection(null),this.view2.setTree(null),t.node.updateSize(),e.node.connect(e.index,t.node,t.index),this.view.setTree(this.tree),e.events.once("connect_start",function(){this.animatedConnections++},this),e.events.once("connect_end",function(){this.animatedConnections--},this),e.playConnection(),this.displaySample(null),this.events.emit("onAddElement",{status:"connected"})},removeSample:function(e){var t=this.sampler.samples[e];t&&delete this.sampler.samples[e]},run:function(){this.makeGUI(),new EventHandler(this.onresize,this).listen("resize",window),new EventHandler(this.onkey,this).listen("keydown",window),new EventHandler(this.onkey,this).listen("keyup",window),new EventHandler(this.onTap,this).listen("tap",window),new EventHandler(this.onDragOver,this).listen("dragover",this.view.element),new EventHandler(this.onDragOver,this).listen("dragover",this.view2.element),new EventHandler(this.onDrop,this).listen("drop",this.view.element),new EventHandler(this.onDrop,this).listen("drop",this.view2.element),this.tiles.events.on("update",this.onTilesUpdate,this),this.view.events.on("connection_select",this.onConnectionSelect,this,[this.view,0]),this.view2.events.on("connection_select",this.onConnectionSelect,this,[this.view2,1]),this.view.events.on("view_clear",this.onViewClear,this),this.view2.events.on("view_clear",this.onViewClear2,this),this.view.events.on("node_select",this.onNodeSelect,this),this.onresize(),this.view.onTick(0),this.view2.onTick(0),"function"==typeof bootProgress&&bootProgress(1),this.ready.resolve(!0),this.timer.play()},onTick:function(e,t){if(this.animatedConnections&&(this.view.needsRedraw=!0,this.view.needsRetrace=!0),kbd.state.t){var i=f.any(Object.keys(this.sampler.samples));this.preloadSample(this.sampler.samples[i],this.connectSample,this.view)}if(TWEEN.update(),this.view.onTick(t),this.view2.onTick(t),this.deletePromptStat){var n=this.view.projector.worldToScreen(this.deletePromptStat.removeNode.localCenter);this.deletePromptTip.move(Math.round(n.x),Math.round(n.y))}}});