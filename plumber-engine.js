function EventEmitter(){this.lists={},this.queue={},this.links={}}function EventHandler(e,t,n,i){if("function"!=typeof e)throw Error("EventHandler expects function as 1st argument");this.func=e,this.scope=t,this.data=null==n?[]:[].concat(n),this.once=i,this.listens=[]}function Observable(e,t,n,i,o){this.id=++Observable.count,this.value=e,this.targets={},this.sources={},this.set(t,n,i,o)}function Timer(e,t){this.func=e,this.scope=t}function Defer(){this.set.apply(this,arguments),this.pending=!0}function Gate(e,t){this.inputs={},this.method=e,this.value=t,this.events=new EventEmitter}function Loader(){this.reset(),this.data={}}function Drag(e){this.element=e,this.events=new EventEmitter,this.offset={x:0,y:0},this.origin={x:0,y:0},this.point={x:0,y:0},this.mouse={x:0,y:0},this.begin={x:0,y:0},this.delta={x:0,y:0},this.scale={x:1,y:1},this.moves=0,this.min={x:-(1/0),y:-(1/0)},this.max={x:1/0,y:1/0},this.bind("mousedown",this.element),this.bind("touchstart",this.element)}function Momentum(){this.speed={x:0,y:0,z:0},this.point={x:0,y:0,z:0},this.delta={x:0,y:0,z:0},this.target={x:0,y:0,z:0},this.points=[]}function FileImport(){this.element=dom.div("file-import hand"),this.events=new EventEmitter,this.input=dom.input("file"),this.input.setAttribute("accept",".json"),this.input.setAttribute("multiple","multiple"),Atlas.set(this.element,"i-file-load","absmid"),dom.on("change",this.input,f.binds(this.onInputChange,this)),dom.on("tap",this.element,f.binds(this.input.click,this.input))}function TileView(){this.events=new EventEmitter,this.element=dom.div("tile-view"),this.econtent=dom.div("tile-content",this.element),this.ehelpers=dom.div("tile-helpers",this.element),this.setClients(),this.setLayout()}function PointProjector(e){this.camera=e,this.points=[],this.matrix=new THREE.Matrix4,this.inverse=new THREE.Matrix4,this.viewport=new THREE.Vector3}function Imagery(){this.get=new Loader,this.list={},this.submaterialIndex=0,this.slotIndex=0,this.products={},this.productsList=[],this.obvMaterialsList=new Observable([]),this.obvProductsLoaded=new Observable(!1),this.pixel=this.makePixel("white"),this.bump=this.makePixel("black"),this.normal=this.makePixel("rgb(127, 127, 255)"),this.buffer=document.createElement("canvas"),this.btx=this.buffer.getContext("2d");var e=this.pixel.image;this.skybox=new THREE.CubeTexture([e,e,e,e,e,e]),this.skybox.needsUpdate=!0,this.baseMaps={norcon:{color:16777215},subtract:{color:16726391},wireframe:{},normal:{},void:{}},this.sampleMaterials=[],this.materials={},this.usedProducts={};for(var t in this.baseMaps)this.addMaterial(t),this.setMaterial(t,null);this.materials.flume=this.materials.pipe=this.materials.drain,this.materials.flat=this.materials.floor,this.materials.slope=this.materials.roof,this.materials.Material__26=this.materials.black,this.materials.wire_000000000=this.materials.gold}function Sampler(){this.samples=[]}function Sample(e,t){for(var n in e)this[n]=e[n];this.progress=0,this.parent=t,this.joints=[],this.meshes=[],this.box=new THREE.Box3,this.boxSize=new THREE.Vector3,this.boxCenter=new THREE.Vector3,this.boxLength=1,!this.name&&this.src&&(this.name=this.src.replace(/\.[^\.]*$/,"").split("/").pop()),this.object?this.configure(this.object):this.src&&(this.format=this.src.replace(/^.*\.([^.]+)$/,"$1").toLowerCase())}function SampleJoint(e){var t=e.name.slice(1).split("_");this.object=e,this.name=e.name,this.parts=t,this.id=t[0],this.param=t[1],this.extra=t[2],this.depth=t[3],this.point=new THREE.Vector3,this.normal=new THREE.Vector3,this.up=new THREE.Vector3,this.matrix=new THREE.Matrix4,this.setFromMatrix(e.matrixWorld)}f={},f.nop=function(){},f.identity=function(e){return e},f.sum=function(e,t){return e+t},f.sub=function(e,t){return e-t},f.nsort=function(e,t){var n=t?-1:1;return function(t,i){return null==t||null==i?-1:n*(t[e]-i[e])}},f.zerosort=function(e,t){return e&&t?e[0]-t[0]:0},f.sort=function(e,t,n){for(var i=e.length,o=[],s=0;s<i;s++){var r=e[s];o.push([t.call(n,r),r])}o.sort(f.zerosort);for(var s=0;s<i;s++)e[s]=o[s][1];return e},f.max=function(e){return Math.max.apply(0,e)},f.min=function(e){return Math.min.apply(0,e)},f.amap=function(e,t,n,i,o,s){if(e&&e.length&&"function"==typeof t)for(var r=0,a=[];r<e.length;r++)a.push(t.call(n,e[r],i,o,s));return a},f.atog=function(e,t,n){if(e){for(var i=e.length-1;i>=0;i--)if(e[i]===t){if(n)return;e.splice(i,1)}n&&e.push(t)}},f.apick=function(e,t,n,i){if(e)for(var o,s=0,r=e.length;s<r;s++)if(o=e[s],(o&&o[t]===n)^i)return o},f.apickf=function(e,t,n,i){if(e)for(var o,s=0,r=e.length;s<r;s++)if(o=e[s],t.call(n,o)^i)return o},f.afind=function(e,t,n,i){if(e)for(var o,s=0,r=e.length,a=[];s<r;s++)o=e[s],(o&&o[t]===n)^i&&a.push(o);return a},f.afindf=function(e,t,n,i){if(e)for(var o,s=0,r=e.length,a=[];s<r;s++)o=e[s],t.call(n,o)^i&&a.push(o);return a},f.adiff=function(e,t){for(var n={prev:t||[],next:e||[],rem:[],remi:[],remc:0,add:[],addi:[],addc:0},i=n.prev.length-1;i>=0;i--){var o=n.prev[i],s=n.next.indexOf(o);s===-1&&(n.rem.push(o),n.remi.push(i),n.remc++)}for(var s=0;s<n.next.length;s++){var o=n.next[s],i=n.prev.indexOf(o);i===-1&&(n.add.push(o),n.addi.push(s),n.addc++)}return n},f.adrop=function(e,t){var n=e.indexOf(t);return~n&&e.splice(n,1),e},f.aflat=function(e){return[].concat.apply([],e)},f.jeq=function(e,t){if(e===t)return!0;var n=typeof e,i=typeof t;if(n!==i)return!1;switch(n){case"boolean":case"number":case"string":return!1}if(e.length!==t.length)return!1;var o;for(o in e)if(o in t==!1)return!1;for(o in t)if(!f.jeq(e[o],t[o]))return!1;return!0},f.seq=function(e,t){return e.length===t.length&&0===f.snot(e,t).length},f.sor=function(){for(var e=[],t=0;t<arguments.length;t++){var n=arguments[t];if(n)for(var i=0;i<n.length;i++){var o=n[i];e.indexOf(o)===-1&&e.push(o)}}return e},f.sand=function(e,t){if(!e||!t)return[];for(var n=[],i=0,o=e.length;i<o;i++){var s=e[i];t.indexOf(s)!==-1&&n.indexOf(s)===-1&&n.push(s)}return n},f.sxor=function(e,t){if(!e||!t)return e?e:t?t:[];for(var n=[].concat(e,t),i=n.length-1;i>=0;i--){var o=n.indexOf(n[i]);i!==o&&(n.splice(i,1),n.splice(o,1),i--)}return n},f.snot=function(e,t){e=e||[],t=t||[];for(var n=[],i=0,o=e.length;i<o;i++){var s=e[i];t.indexOf(s)===-1&&n.indexOf(s)===-1&&n.push(s)}return n},f.uniqp=function(e,t){return function(n,i,o){return!e^o.indexOf(n)===(t?o.lastIndexOf(n):i)}},f.uniq=function(e,t,n){return n.indexOf(e)===t},f.uniqi=function(e,t,n){return n.indexOf(e)!==t},f.uniqm=function(e,t,n){return n.indexOf(e)===n.lastIndexOf(e)},f.uniqim=function(e,t,n){return n.indexOf(e)!==n.lastIndexOf(e)},f.clamp=function(e,t,n){return e<t?t:e>n?n:e},f.rand=function(e){return Math.floor(Math.random()*(+e||1))},f.any=function(e){return e&&e[f.rand(e.length)]},f.charmap="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",f.randchar=function(){return f.any(f.charmap)},f.exp=function(e){var t=0,n=Math.abs(e);if(0===n||!isFinite(n))return n;if(n<1)for(;Math.pow(10,t)>n;)t--;else for(;Math.pow(10,t+1)<=n;)t++;return t},f.hround=function(e){return Math.round(100*e)/100},f.pround=function(e,t){var n=+t||0;if(n<0){var i=Math.pow(10,-n);return Math.round(e/i)*i}var i=Math.pow(10,n);return Math.round(e*i)/i},f.mround=function(e,t){return f.pround(e,t-f.exp(e))},f.xrad=Math.PI/180,f.torad=function(e){return e*f.xrad},f.xdeg=180/Math.PI,f.todeg=function(e){return e*f.xdeg},f.radist=function(e){return Math.abs(e)>Math.PI?e-2*Math.PI*Math.ceil(Math.floor(Math.abs(e)/Math.PI)/2)*(e<0?-1:1):e},f.prop=function(e){var t=arguments;return function(e){for(var n=0;e&&n<t.length;n++)e=e[t[n]];return e}},f.pset=function(e,t){return function(n){n[e]=t}},f.func=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);return function(n){return n[e]&&n[e].apply&&n[e].apply(n,t)}},f.range=function(e){e=+e||0;for(var t=[],n=0;n<e;n++)t.push(n);return t},f.rangep=function(e,t,n){e=isNaN(e)?0:+e,t=null==t?0:t,n=null==n?"number"==typeof t?1:0:n;for(var i=[],o=0;o<e;o++)i.push(n?o*n+t:t);return i},f.qsenc=function(e,t){t||(t="&=");var n=[];for(var i in e){var o=encodeURIComponent(i),s=e[i];if(null!=s)if(s instanceof Array)for(var r=0;r<s.length;r++)n.push(o+t[1]+encodeURIComponent(s[r]));else n.push(o+t[1]+encodeURIComponent(s))}return n.join(t[0])},f.qsdec=function(e,t){t||(t="&=");for(var n={},i=e.split(t[0]),o=0;o<i.length;o++){var s=i[o].split(t[1]),r=decodeURIComponent(s[0]),a=decodeURIComponent(s[1]);if(r in n){var l=n[r];l instanceof Array?l.push(a):n[r]=[l,a]}else n[r]=a}return n},f.follow=function(e,t){for(var n=[];e;e=e[t])n.push(e);return n},f.copy=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},f.copylist=function(e,t,n){for(var i in t)n.indexOf(i)!==-1&&Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},f.merge=function(){for(var e={},t=0;t<arguments.length;t++)f.copy(e,arguments[t]);return e},f.throttle=function(e,t){var n=0;return function(){var i=new Date;if(i-n>e)return n=i,t.apply(this,arguments)}},f.postpone=function(e,t){var n;return function(){clearTimeout(n),n=setTimeout(t,e)}},f.implode=function(e,t,n,i){return n||(n=/#\{(\w+)\}/g),e.replace(n,function(e,n){return n in t?t[n]:i?e:""})},f.nzformat=function(e,t){if(isNaN(e))return e+"";var n=Math.abs(e),i=t-Math.max(0,f.exp(n)),o=i>1?Array(i).join("0"):"";return(e<n?"-":"")+o+n},f.nformat=function(e,t,n){var i=Math.abs(e),o=e<i,s=isNaN(e)?2:f.exp(i),r=n?"0":" ",a=t-Math.max(0,s)-o-1,l=a>1?Array(a).join(r):"",h=n&&o?"-":r,c=!n&&o?e:i;return h+l+c},f.dformat=function(e,t){var n={Y:"getFullYear",M:"getMonth",D:"getDate",h:"getHours",i:"getMinutes",s:"getSeconds"},i={M:1};return t.replace(/([YMDhis])(\1+)?/g,function(t,o){return f.nzformat(e[n[o]]()+(i[o]||0),t.length)})},f.rgb=function(e){return"rgb("+[255*e[0]|0,255*e[1]|0,255*e[2]|0]+")"},f.rgba=function(e,t){return"rgba("+[255*e[0]|0,255*e[1]|0,255*e[2]|0].concat(isNaN(t)?1:+t)+")"},f.rcolor=function(e){return"rgba("+[255,255,255].map(f.rand).concat(+e||1)+")"},f.softcolor=function(e){var t=2*Math.PI,n=t*e;return[Math.cos(n)/2+.5,Math.cos(n+2/3*t)/2+.5,Math.cos(n+1/3*t)/2+.5]},f.mitm=function(e,t,n,i){var o=e[t],s="function"==typeof o;e[t]=function(){var e=n.call(this,t,arguments,o);return i?e:s?o.apply(this,arguments):o}},f.inspect=function(e,t){for(var n in e)"function"==typeof e[n]&&f.mitm(e,n,t)},f.binds=function(e,t){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){return e.apply(t,arguments)}},f.binda=function(e,t,n){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){return e.apply(t,n)}},f.bindr=function(e,t,n,i){if("function"!=typeof e)throw Error("object to bind is not a function");return function(){for(var o=[],s=0,r=0;r<n.length;r++)o.push(n[r]===i?arguments[s++]:n[r]);for(;s<arguments.length;)o.push(arguments[s++]);return e.apply(t,o)}},f.unit=function(parent,object){arguments.length<2&&(object=parent,parent=null);var proto=parent?f.copy(Object.create(parent.prototype),object):object,Unit=eval("(function "+(proto.unitName||"Unit")+'() {if(typeof this.init === "function") this.init.apply(this, arguments)})');return Unit.New=function(){var e=Object.create(Unit.prototype);return Unit.apply(e,arguments),e},Unit.prototype=proto,proto.protochain=proto.protochain?proto.protochain.concat(proto):[proto],proto.constructor=Unit,Unit},!function(){if(Date.now||(Date.now=function(){return(new Date).getTime()}),window.performance||(window.performance={}),!window.performance.now){var e=window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:Date.now();window.performance.now=function(){return Date.now()-e}}}(),!function(){function e(e){1===e.which&&(l.moves=0,l.startEvent=e,l.startPoint=e,document.addEventListener("mousemove",t,!0))}function t(e){l.startPoint.pageX===e.pageX&&l.startPoint.pageY===e.pageY||l.moves++}function n(e){document.removeEventListener("mousemove",t,!0),l.endPoint=e,l.endEvent=e,r(l)}function i(e){h.startPoint=e.changedTouches[0],h.startEvent=e,h.moves=0}function o(e){h.startPoint.pageX===e.pageX&&h.startPoint.pageY===e.pageY||h.moves++}function s(e){h.endPoint=e.changedTouches[0],h.endEvent=e,r(h)}function r(e){if(e.startPoint&&e.endPoint&&!(e.moves>2)){var t=e.endPoint.pageX-e.startPoint.pageX,n=e.endPoint.pageY-e.startPoint.pageY,i=e.touch?64:25;if(!(t*t+n*n>i)){var o=window.performance.now();if(!(o-a<50&&e.endEvent.isTrusted)){a=o;var s=new MouseEvent("tap",{bubbles:!0,cancelable:!0,pageX:e.endPoint.pageX,pageY:e.endPoint.pageY,screenX:e.endPoint.screenX,screenY:e.endPoint.screenY,clientX:e.endPoint.clientX,clientY:e.endPoint.clientY,altKey:e.endEvent.altKey,ctrlKey:e.endEvent.ctrlKey,shiftKey:e.endEvent.shiftKey,metaKey:e.endEvent.metaKey,view:e.endEvent.view});s.touch=e.touch,s.timeDelta=e.endEvent.timeStamp-e.startEvent.timeStamp;var r=e.endEvent.target;e.startPoint=null,e.endPoint=null,e.startEvent=null,e.endEvent=null,r.dispatchEvent(s)}}}}var a,l={startPoint:null,startEvent:null,endPoint:null,endEvent:null,touch:!1,moves:0},h={startPoint:null,startEvent:null,endPoint:null,endEvent:null,touch:!0,moves:0};try{new MouseEvent("tap")}catch(e){window.MouseEvent=function(e,t){var n=document.createEvent("MouseEvents");return n.initMouseEvent(e,t.bubbles,t.cancelable,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),n}}document.addEventListener("touchstart",i,!0),document.addEventListener("touchmove",o,!0),document.addEventListener("touchend",s,!0),document.addEventListener("mousedown",e,!0),document.addEventListener("mouseup",n,!0)}(),Function.prototype.bind||(Function.prototype.bind=function(e){var t=Array.prototype.slice.call(arguments,1),n=this;return function(){var i=Array.prototype.slice.call(arguments);return n.apply(e,t.concat(i))}}),window.requestAnimationFrame=window.requestAnimationFrame||window.ORequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.OCancelAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout,dom={},dom.one=function(e,t){return(t||document).querySelector(e)},dom.all=function(e,t){return[].slice.call((t||document).querySelectorAll(e))},dom.elem=function(e,t,n){var i=document.createElement(e);return t&&(i.className=t),n&&n.appendChild(i),i},dom.span=function(e,t){return dom.elem("span",e,t)},dom.div=function(e,t){return dom.elem("div",e,t)},dom.input=function(e,t,n){var i=dom.elem("input",t,n);return i.setAttribute("type",e),i},dom.option=function(e,t,n){var i=dom.elem("option",null,n);return dom.text(i,t),i.value=e,i},dom.img=function(e,t,n){var i=dom.elem("img",t,n);return e&&(i.src=e),i},dom.a=function(e,t,n){var i=dom.elem("a",t,n);return e&&(i.href=e),i},dom.append=function(e,t){if(e instanceof Node)for(var n=1;n<arguments.length;n++){var t=arguments[n];t instanceof Node&&e.appendChild(t)}return e},dom.prepend=function(e,t){e instanceof Node&&t instanceof Node&&e.insertBefore(t,e.firstChild)},dom.insert=function(e,t,n){e instanceof Node&&t instanceof Node&&e.insertBefore(t,n instanceof Node?n:null)},dom.remove=function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];t&&t.parentNode&&t.parentNode.removeChild(t)}},dom.empty=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},dom.children=function(){function e(e){return e.nodeType===Node.ELEMENT_NODE}var t=Array.prototype.slice;return function(n){return t.call(n.childNodes).filter(e)}}(),dom.ancestor=function(e,t){for(;e;){if(e===t)return!0;e=e.parentNode}},dom.onceover=function(e,t){return!dom.ancestor(e.relatedTarget,t)&&dom.ancestor(e.target,t)},dom.onceout=function(e,t){return!dom.ancestor(e.relatedTarget,t)},dom.on=function(e,t,n,i){t.addEventListener(e,n,!!i)},dom.off=function(e,t,n,i){t.removeEventListener(e,n,!!i)},dom.pos=function(e,t,n){e&&(null!=t&&(e.style.left="number"==typeof t?Math.round(t)+"px":t),null!=n&&(e.style.top="number"==typeof n?Math.round(n)+"px":n))},dom.size=function(e,t,n){e&&(null!=t&&(e.style.width="number"==typeof t?Math.round(t)+"px":t),null!=t&&(e.style.height="number"==typeof n?Math.round(n)+"px":n))},dom.style=function(e,t){f.copy(e.style,t)},dom.xstyle=function(e,t,n){var i=e.style;i["-webkit-"+t]=n,i["-moz-"+t]=n,i["-ms-"+t]=n,i["-o-"+t]=n,i[t]=n},dom.html=function(e,t){e.innerHTML=t},dom.text=function(e,t){e.textContent=t},dom.display=function(e,t,n){e.style.display=t?null!=n?n:"block":"none"},dom.visible=function(e,t){e.style.visibility=t?"visible":"hidden"},dom.respace=/\s+/,dom.addclass=function(e,t){if(e&&t){var n=e.className.split(dom.respace).filter(Boolean),i=t.split(dom.respace).filter(Boolean),o=f.sor(n,i);f.snot(o,n).length&&(e.className=o.join(" "))}},dom.remclass=function(e,t){if(e&&t){var n=e.className.split(dom.respace).filter(Boolean),i=t.split(dom.respace).filter(Boolean),o=f.snot(n,i);f.snot(n,o).length&&(e.className=o.join(" "))}},dom.hasclass=function(e,t,n){if(e&&t){var i=e.className.split(dom.respace).filter(Boolean),o=t.split(dom.respace).filter(Boolean),s=f.sand(i,o).length;return n?s:s===o.length}},dom.togclass=function(e,t,n){e&&t&&(arguments.length<3&&(n=!dom.hasclass(e,t)),(n?dom.addclass:dom.remclass)(e,t))},dom.setclass=function(e,t){if(e&&t){var n=e.className.split(dom.respace).filter(Boolean),i=n.slice();for(var o in t)f.atog(i,o,!!t[o]);f.sxor(n,i).length&&(e.className=i.join(" "))}},dom.offset=function(e,t,n){for(var i=0,o=0;e&&e!==t;e=e.offsetParent)i+=e.offsetLeft||0,o+=e.offsetTop||0,n&&(i-=e.scrollLeft||0,o-=e.scrollTop||0);return{x:i,y:o}},dom.out=function(e){var t=dom.div(null,document.body),n=dom.elem("textarea",null,document.body);dom.style(t,{top:0,left:0,width:"100%",height:"100%",position:"absolute",zIndex:9e3}),dom.style(n,{left:.1*window.innerWidth+"px",top:.1*window.innerHeight+"px",width:.8*window.innerWidth+"px",height:.8*window.innerHeight+"px",position:"absolute",zIndex:9001,whiteSpace:"nowrap",font:"11px monospace"}),dom.text(n,e),dom.on("click",t,function(){dom.remove(n,t)}),n.focus()},dom.ready=function(e){function t(){document.removeEventListener("DOMContentLoaded",t),window.removeEventListener("load",t),e()}"complete"===document.readyState?e():(document.addEventListener("DOMContentLoaded",t),window.addEventListener("load",t))},kbd={name:{L_ARR:37,U_ARR:38,R_ARR:39,D_ARR:40,SHIFT:16,CTRL:17,ALT:18,CAPS:20,ESC:27,SPACE:32,DEL:46,ENTER:13,TAB:9,BKSP:8,"`":192,"-":189,"=":187,"[":219,"]":221,"\\":220,";":186,"'":222,",":188,".":190,"/":191},map:[],state:{},init:function(){kbd.setmap(),kbd.reset(),window.addEventListener("keydown",kbd.onkeydown,!0),window.addEventListener("keyup",kbd.onkeyup,!0)},setmap:function(){for(var e=48;e<=57;e++)kbd.map[e]=String.fromCharCode(e);for(var e=65;e<=90;e++)kbd.map[e]=String.fromCharCode(e).toLowerCase();for(var t in kbd.name)kbd.map[kbd.name[t]]=t},reset:function(){for(var e=0;e<255;e++)kbd.state[kbd.map[e]]=0},onkeydown:function(e){kbd.setkey(e,1)},onkeyup:function(e){kbd.setkey(e,0)},setkey:function(e,t){kbd.event=e,kbd.down=t,kbd.key=kbd.map[e.keyCode],kbd.changed=kbd.state[kbd.key]!==kbd.down,kbd.state[kbd.key]=kbd.down,kbd.state.SHIFT=+e.shiftKey,kbd.state.CTRL=+e.ctrlKey,kbd.state.ALT=+e.altKey;var n=[];kbd.state.CTRL&&n.push("CTRL"),kbd.state.ALT&&n.push("ALT"),kbd.state.SHIFT&&n.push("SHIFT"),"CTRL"!==kbd.key&&"ALT"!==kbd.key&&"SHIFT"!==kbd.key&&n.push(kbd.key),kbd.seq=n.join("+")}},kbd.init();var perf={precision:4,values:{},time:function(){return window.performance&&window.performance.now?window.performance.now():Date.now?Date.now():(new Date).getTime()},start:function(e){var t=perf.values[e];t||(t=perf.values[e]={totalTime:0,totalCycles:0,totalBest:1/0,totalWorst:-(1/0),localTime:0,localCycles:0,localBest:1/0,localWorst:-(1/0),lastTime:0,startTime:0}),t.startTime=perf.time()},end:function(e,t){var n=perf.values[e];n&&(n.lastTime=perf.time()-n.startTime,n.startTime=0,n.totalCycles++,n.localCycles++,n.totalBest=Math.min(n.totalBest,n.lastTime),n.totalWorst=Math.max(n.totalWorst,n.lastTime),n.localBest=Math.min(n.localBest,n.lastTime),n.localWorst=Math.max(n.localWorst,n.lastTime),n.totalTime+=n.lastTime,n.localTime+=n.lastTime,n.localCycles>=t&&perf.show(e))},flushLocal:function(e){var t=perf.values[e];t&&(t.localTime=0,t.localCycles=0,t.localBest=1/0,t.localWorst=-(1/0))},show:function(e,t){var n=perf.values[e];return n?(console.log("perf",e+":",f.mround(n.localTime/n.localCycles,perf.precision),"avg,",f.mround(n.localBest,perf.precision),"best,",f.mround(n.localWorst,perf.precision),"worst,",f.mround(n.localTime,perf.precision),"ms,",n.localCycles,"cycles,",n.totalCycles,"total cycles,",f.mround(n.totalTime/n.totalCycles,perf.precision),"total avg"),void(t||perf.flushLocal(e))):console.log("perf: no",e)},monitor:function(e,t){setInterval(perf.show,t||1e3,e)}},TWEEN={tweens:[],getAll:function(){return TWEEN.tweens},removeAll:function(){for(var e=TWEEN.tweens.length-1;e>=0;e--)TWEEN.tweens[e].drop=!0},add:function(e){e.drop=!1,TWEEN.tweens.indexOf(e)===-1&&TWEEN.tweens.push(e)},remove:function(e){e.playing=!1,e.drop=!0},loop:function(){TWEEN.update(),TWEEN.timer=requestAnimationFrame(TWEEN.loop)},loopEnd:function(){cancelAnimationFrame(TWEEN.timer)},update:function(e){var t=TWEEN.tweens.length;if(!t)return!1;e=isNaN(e)?window.performance.now():+e;for(var n=t-1;n>=0;n--){var i=TWEEN.tweens[n];!i.drop&&i.update(e)||TWEEN.tweens.splice(n,1)}return!0}};TWEEN.loop(),TWEEN.Tween=function(e){this.source={},this.target={},this.delta={},this.durationTime=1e3,this.delayTime=0,this.startTime=null,this.repeatTimes=0,this.enableYoyo=!1,this.reversed=!1,this.easingFunction=TWEEN.Easing.Linear.None,this.interpolationFunction=TWEEN.Interpolation.Linear,this.chainedTweens=[],this.onStartCallbackFired=!1,this.onStartCallback=null,this.onStartScope=null,this.onUpdateCallback=null,this.onUpdateScope=null,this.onCompleteCallback=null,this.onCompleteScope=null,this.onStopCallback=null,this.onStopScope=null,this.playing=!1,this.ended=!1,e&&this.setSource(e)},TWEEN.Tween.prototype={setSource:function(e){return this.source=e,this},setTarget:function(e){return this.target=e,this},duration:function(e){return this.durationTime=e,this},from:function(e){for(var t in e)this.source[t]=e[t];return this},to:function(e,t){return null!=t&&(this.durationTime=t),this.setTarget(e),this},delay:function(e){return this.delayTime=e,this},repeat:function(e){return this.repeatTimes=e,this},yoyo:function(e){return this.enableYoyo=e,this},easing:function(e){return this.easingFunction=e,this},interpolation:function(e){return this.interpolationFunction=e,this},chain:function(){return this.chainedTweens=arguments,this},onStart:function(e,t){return this.onStartCallback=e,this.onStartScope=t,this},onUpdate:function(e,t){return this.onUpdateCallback=e,this.onUpdateScope=t,this},onComplete:function(e,t){return this.onCompleteCallback=e,this.onCompleteScope=t,this},onStop:function(e,t){return this.onStopCallback=e,this.onStopScope=t,this},stop:function(){return TWEEN.remove(this),this.debug&&console.trace(this.debug,"stop"),null!==this.onStopCallback&&this.onStopCallback.call(this.onStopScope,this.source),this.stopChainedTweens(),this},stopChainedTweens:function(){for(var e=this.chainedTweens.length-1;e>=0;e--)this.chainedTweens[e].stop()},updateSource:function(){this.valuesSource={};for(var e in this.source){var t=this.source[e],n=parseFloat(t,10);isFinite(n)&&(this.valuesSource[e]=n)}return this},updateTarget:function(){this.valuesRelative={},this.valuesTarget={};for(var e in this.target)if(e in this.valuesSource!=!1){var t=this.target[e],n=this.valuesSource[e];if(t instanceof Array)t.length&&(this.valuesTarget[e]=[n].concat(t));else if("string"==typeof t){var i=parseFloat(t,10);isFinite(i)&&(this.valuesRelative[e]=i,this.valuesTarget[e]=n+i)}else"number"==typeof t&&isFinite(t)&&(this.valuesTarget[e]=t)}return this},start:function(e){TWEEN.add(this),this.onStartCallbackFired=!1,this.ended=!1,this.startTime=isNaN(e)?window.performance.now():+e,this.startTime+=this.delayTime,this.updateSource(),this.updateTarget();for(var t in this.valuesTarget)this.delta[t]=this.valuesSource[t];return this.debug&&console.trace(this.debug,"start","\n\tsource:",this.valuesSource,"\n\ttarget:",this.valuesTarget),this},update:function(e){if(this.ended)return this.ended=!1,this.playing=!1,this.debug&&console.log(this.debug,"ended"),!1;if(e<this.startTime)return!0;this.onStartCallbackFired===!1&&(this.onStartCallbackFired=!0,this.playing=!0,null!==this.onStartCallback&&this.onStartCallback.call(this.onStartScope,this.source),this.debug&&console.log(this.debug,"playing"));var t=(e-this.startTime)/this.durationTime;t=t>1?1:t;var n=this.easingFunction(t);for(var i in this.valuesTarget){var o,s=this.valuesTarget[i],r=this.valuesSource[i];o=s instanceof Array?this.interpolationFunction(s,n):r+(s-r)*n,this.delta[i]=o-this.source[i],this.source[i]=o}if(this.debug&&console.log(this.debug,"update","\n\tvalues:",this.source,"\n\tdetta:",this.delta),null!==this.onUpdateCallback&&this.onUpdateCallback.call(this.onUpdateScope,n,this.source),1===t)if(this.repeatTimes>0){this.repeatTimes--;for(var i in this.valuesSource){var r=this.valuesSource[i],s=this.valuesTarget[i];i in this.valuesRelative&&(r+=this.valuesRelative[i]),this.enableYoyo&&(this.valuesTarget[i]=r,r=s),this.valuesSource[i]=r}this.enableYoyo&&(this.reversed=!this.reversed),this.startTime=e+this.delayTime}else{this.ended=!0,null!==this.onCompleteCallback&&this.onCompleteCallback.call(this.onCompleteScope,this.source);for(var a=this.chainedTweens.length-1;a>=0;a--)this.chainedTweens[a].start(this.startTime+this.durationTime)}return!0}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,n=.1,i=.4;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=i/4):t=i*Math.asin(1/n)/(2*Math.PI),-(n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)))},Out:function(e){var t,n=.1,i=.4;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=i/4):t=i*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/i)+1)},InOut:function(e){var t,n=.1,i=.4;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=i/4):t=i*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?-.5*(n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)):n*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)*.5+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?.5*(e*e*((t+1)*e-t)):.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var n=e.length-1,i=n*t,o=Math.floor(i),s=TWEEN.Interpolation.Utils.Linear;return t<0?s(e[0],e[1],i):t>1?s(e[n],e[n-1],n-i):s(e[o],e[o+1>n?n:o+1],i-o)},Bezier:function(e,t){for(var n=0,i=e.length-1,o=Math.pow,s=TWEEN.Interpolation.Utils.Bernstein,r=0;r<=i;r++)n+=o(1-t,i-r)*o(t,r)*e[r]*s(i,r);return n},CatmullRom:function(e,t){var n=e.length-1,i=n*t,o=Math.floor(i),s=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(o=Math.floor(i=n*(1+t))),s(e[(o-1+n)%n],e[o],e[(o+1)%n],e[(o+2)%n],i-o)):t<0?e[0]-(s(e[0],e[0],e[1],e[1],-i)-e[0]):t>1?e[n]-(s(e[n],e[n],e[n-1],e[n-1],i-n)-e[n]):s(e[o?o-1:0],e[o],e[n<o+1?n:o+1],e[n<o+2?n:o+2],i-o)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=TWEEN.Interpolation.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:function(){var e=[1];return function(t){var n=1;if(e[t])return e[t];for(var i=t;i>1;i--)n*=i;return e[t]=n,n}}(),CatmullRom:function(e,t,n,i,o){var s=.5*(n-e),r=.5*(i-t),a=o*o,l=o*a;return(2*t-2*n+s+r)*l+(-3*t+3*n-2*s-r)*a+s*o+t}}};var dat=dat||{};dat.gui=dat.gui||{},dat.utils=dat.utils||{},dat.controllers=dat.controllers||{},dat.dom=dat.dom||{},dat.color=dat.color||{},dat.utils.css=function(){return{load:function(e,t){t=t||document;var n=t.createElement("link");n.type="text/css",n.rel="stylesheet",n.href=e,t.getElementsByTagName("head")[0].appendChild(n)},inject:function(e,t){t=t||document;var n=document.createElement("style");n.type="text/css",n.innerHTML=e,t.getElementsByTagName("head")[0].appendChild(n)}}}(),dat.utils.common=function(){var e=Array.prototype.forEach,t=Array.prototype.slice;return{BREAK:{},extend:function(e){return this.each(t.call(arguments,1),function(t){for(var n in t)this.isUndefined(t[n])||(e[n]=t[n])},this),e},defaults:function(e){return this.each(t.call(arguments,1),function(t){for(var n in t)this.isUndefined(e[n])&&(e[n]=t[n])},this),e},compose:function(){var e=t.call(arguments);return function(){for(var n=t.call(arguments),i=e.length-1;0<=i;i--)n=[e[i].apply(this,n)];return n[0]}},each:function(t,n,i){if(t)if(e&&t.forEach&&t.forEach===e)t.forEach(n,i);else if(t.length===t.length+0)for(var o=0,s=t.length;o<s&&!(o in t&&n.call(i,t[o],o)===this.BREAK);o++);else for(o in t)if(n.call(i,t[o],o)===this.BREAK)break},defer:function(e){setTimeout(e,0)},toArray:function(e){return e.toArray?e.toArray():t.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){return e!==e},isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)}}}(),dat.controllers.Controller=function(e){var t=function(e,t){this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onFinishChange=this.__onChange=void 0};return e.extend(t.prototype,{onChange:function(e){return this.__onChange=e,this},onFinishChange:function(e){return this.__onFinishChange=e,this},setValue:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this},getValue:function(){return this.object[this.property]},updateDisplay:function(){return this},isModified:function(){return this.initialValue!==this.getValue()}}),t}(dat.utils.common),dat.dom.dom=function(e){function t(t){return"0"===t||e.isUndefined(t)?0:(t=t.match(i),e.isNull(t)?0:parseFloat(t[1]))}var n={};e.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(t,i){e.each(t,function(e){n[e]=i})});var i=/(\d+(\.\d+)?)px/,o={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",
e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(t,n,i){e.isUndefined(n)&&(n=!0),e.isUndefined(i)&&(i=!0),t.style.position="absolute",n&&(t.style.left=0,t.style.right=0),i&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,i,o,s){o=o||{};var r=n[i];if(!r)throw Error("Event type "+i+" not supported.");var a=document.createEvent(r);switch(r){case"MouseEvents":a.initMouseEvent(i,o.bubbles||!1,o.cancelable||!0,window,o.clickCount||1,0,0,o.x||o.clientX||0,o.y||o.clientY||0,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":r=a.initKeyboardEvent||a.initKeyEvent,e.defaults(o,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),r(i,o.bubbles||!1,o.cancelable,window,o.ctrlKey,o.altKey,o.shiftKey,o.metaKey,o.keyCode,o.charCode);break;default:a.initEvent(i,o.bubbles||!1,o.cancelable||!0)}e.defaults(a,s),t.dispatchEvent(a)},bind:function(e,t,n,i){return e.addEventListener?e.addEventListener(t,n,i||!1):e.attachEvent&&e.attachEvent("on"+t,n),o},unbind:function(e,t,n,i){return e.removeEventListener?e.removeEventListener(t,n,i||!1):e.detachEvent&&e.detachEvent("on"+t,n),o},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var n=e.className.split(/ +/);-1==n.indexOf(t)&&(n.push(t),e.className=n.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return o},removeClass:function(e,t){if(t){if(void 0!==e.className)if(e.className===t)e.removeAttribute("class");else{var n=e.className.split(/ +/),i=n.indexOf(t);-1!=i&&(n.splice(i,1),e.className=n.join(" "))}}else e.className=void 0;return o},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){return e=getComputedStyle(e),t(e["border-left-width"])+t(e["border-right-width"])+t(e["padding-left"])+t(e["padding-right"])+t(e.width)},getHeight:function(e){return e=getComputedStyle(e),t(e["border-top-width"])+t(e["border-bottom-width"])+t(e["padding-top"])+t(e["padding-bottom"])+t(e.height)},getOffset:function(e){var t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop;while(e=e.offsetParent);return t},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}};return o}(dat.utils.common),dat.controllers.OptionController=function(e,t,n){var i=function(e,o,s){i.superclass.call(this,e,o);var r=this;if(this.__select=document.createElement("select"),n.isArray(s)){var a={};n.each(s,function(e){a[e]=e}),s=a}n.each(s,function(e,t){var n=document.createElement("option");n.innerHTML=t,n.setAttribute("value",e),r.__select.appendChild(n)}),this.updateDisplay(),t.bind(this.__select,"change",function(){r.setValue(this.options[this.selectedIndex].value)}),this.domElement.appendChild(this.__select)};return i.superclass=e,n.extend(i.prototype,e.prototype,{setValue:function(e){return e=i.superclass.prototype.setValue.call(this,e),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),e},updateDisplay:function(){return this.__select.value=this.getValue(),i.superclass.prototype.updateDisplay.call(this)}}),i}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.NumberController=function(e,t){function n(e){return e=e.toString(),-1<e.indexOf(".")?e.length-e.indexOf(".")-1:0}var i=function(e,o,s){i.superclass.call(this,e,o),s=s||{},this.__min=s.min,this.__max=s.max,this.__step=s.step,t.isUndefined(this.__step)?this.__impliedStep=0==this.initialValue?1:Math.pow(10,Math.floor(Math.log(Math.abs(this.initialValue))/Math.LN10))/10:this.__impliedStep=this.__step,this.__precision=n(this.__impliedStep)};return i.superclass=e,t.extend(i.prototype,e.prototype,{setValue:function(e){return void 0!==this.__min&&e<this.__min?e=this.__min:void 0!==this.__max&&e>this.__max&&(e=this.__max),void 0!==this.__step&&0!=e%this.__step&&(e=Math.round(e/this.__step)*this.__step),i.superclass.prototype.setValue.call(this,e)},min:function(e){return this.__min=e,this},max:function(e){return this.__max=e,this},step:function(e){return this.__impliedStep=this.__step=e,this.__precision=n(e),this}}),i}(dat.controllers.Controller,dat.utils.common),dat.controllers.NumberControllerBox=function(e,t,n){var i=function(e,o,s){function r(){var e=parseFloat(c.__input.value);n.isNaN(e)||c.setValue(e)}function a(e){var t=h-e.clientY;c.setValue(c.getValue()+t*c.__impliedStep),h=e.clientY}function l(){t.unbind(window,"mousemove",a),t.unbind(window,"mouseup",l)}this.__truncationSuspended=!1,i.superclass.call(this,e,o,s);var h,c=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),t.bind(this.__input,"change",r),t.bind(this.__input,"blur",function(){r(),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}),t.bind(this.__input,"mousedown",function(e){t.bind(window,"mousemove",a),t.bind(window,"mouseup",l),h=e.clientY}),t.bind(this.__input,"keydown",function(e){13===e.keyCode&&(c.__truncationSuspended=!0,this.blur(),c.__truncationSuspended=!1)}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return i.superclass=e,n.extend(i.prototype,e.prototype,{updateDisplay:function(){var e,t=this.__input;if(this.__truncationSuspended)e=this.getValue();else{e=this.getValue();var n=Math.pow(10,this.__precision);e=Math.round(e*n)/n}return t.value=e,i.superclass.prototype.updateDisplay.call(this)}}),i}(dat.controllers.NumberController,dat.dom.dom,dat.utils.common),dat.controllers.NumberControllerSlider=function(e,t,n,i,o){function s(e,t,n,i,o){return i+(e-t)/(n-t)*(o-i)}var r=function(e,n,i,o,a){function l(e){e.preventDefault();var n=t.getOffset(c.__background),i=t.getWidth(c.__background);return c.setValue(s(e.clientX,n.left,n.left+i,c.__min,c.__max)),!1}function h(){t.unbind(window,"mousemove",l),t.unbind(window,"mouseup",h),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}r.superclass.call(this,e,n,{min:i,max:o,step:a});var c=this;this.__background=document.createElement("div"),this.__foreground=document.createElement("div"),t.bind(this.__background,"mousedown",function(e){t.bind(window,"mousemove",l),t.bind(window,"mouseup",h),l(e)}),t.addClass(this.__background,"slider"),t.addClass(this.__foreground,"slider-fg"),this.updateDisplay(),this.__background.appendChild(this.__foreground),this.domElement.appendChild(this.__background)};return r.superclass=e,r.useDefaultStyles=function(){n.inject(o)},i.extend(r.prototype,e.prototype,{updateDisplay:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",r.superclass.prototype.updateDisplay.call(this)}}),r}(dat.controllers.NumberController,dat.dom.dom,dat.utils.css,dat.utils.common,"/**\n * dat-gui JavaScript Controller Library\n * http://code.google.com/p/dat-gui\n *\n * Copyright 2011 Data Arts Team, Google Creative Lab\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n */\n\n.slider {\n  box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);\n  height: 1em;\n  border-radius: 1em;\n  background-color: #eee;\n  padding: 0 0.5em;\n  overflow: hidden;\n}\n\n.slider-fg {\n  padding: 1px 0 2px 0;\n  background-color: #aaa;\n  height: 1em;\n  margin-left: -0.5em;\n  padding-right: 0.5em;\n  border-radius: 1em 0 0 1em;\n}\n\n.slider-fg:after {\n  display: inline-block;\n  border-radius: 1em;\n  background-color: #fff;\n  border:  1px solid #aaa;\n  content: '';\n  float: right;\n  margin-right: -1em;\n  margin-top: -1px;\n  height: 0.9em;\n  width: 0.9em;\n}"),dat.controllers.FunctionController=function(e,t,n){var i=function(e,n,o){i.superclass.call(this,e,n);var s=this;this.__button=document.createElement("div"),this.__button.innerHTML=void 0===o?"Fire":o,t.bind(this.__button,"click",function(e){return e.preventDefault(),s.fire(),!1}),t.addClass(this.__button,"button"),this.domElement.appendChild(this.__button)};return i.superclass=e,n.extend(i.prototype,e.prototype,{fire:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}),i}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.BooleanController=function(e,t,n){var i=function(e,n){i.superclass.call(this,e,n);var o=this;this.__prev=this.getValue(),this.__checkbox=document.createElement("input"),this.__checkbox.setAttribute("type","checkbox"),t.bind(this.__checkbox,"change",function(){o.setValue(!o.__prev)},!1),this.domElement.appendChild(this.__checkbox),this.updateDisplay()};return i.superclass=e,n.extend(i.prototype,e.prototype,{setValue:function(e){return e=i.superclass.prototype.setValue.call(this,e),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),e},updateDisplay:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0):this.__checkbox.checked=!1,i.superclass.prototype.updateDisplay.call(this)}}),i}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.color.toString=function(e){return function(t){if(1==t.a||e.isUndefined(t.a)){for(t=t.hex.toString(16);6>t.length;)t="0"+t;return"#"+t}return"rgba("+Math.round(t.r)+","+Math.round(t.g)+","+Math.round(t.b)+","+t.a+")"}}(dat.utils.common),dat.color.interpret=function(e,t){var n,i,o=[{litmus:t.isString,conversions:{THREE_CHAR_HEX:{read:function(e){return e=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i),null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString())}},write:e},SIX_CHAR_HEX:{read:function(e){return e=e.match(/^#([A-F0-9]{6})$/i),null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString())}},write:e},CSS_RGB:{read:function(e){return e=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/),null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:e},CSS_RGBA:{read:function(e){return e=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\,\s*(.+)\s*\)/),null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:e}}},{litmus:t.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:t.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3==e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4==e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:t.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(t.isNumber(e.r)&&t.isNumber(e.g)&&t.isNumber(e.b)&&t.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(t.isNumber(e.r)&&t.isNumber(e.g)&&t.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(t.isNumber(e.h)&&t.isNumber(e.s)&&t.isNumber(e.v)&&t.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(t.isNumber(e.h)&&t.isNumber(e.s)&&t.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}];return function(){i=!1;var e=1<arguments.length?t.toArray(arguments):arguments[0];return t.each(o,function(o){if(o.litmus(e))return t.each(o.conversions,function(o,s){if(n=o.read(e),!1===i&&!1!==n)return i=n,n.conversionName=s,n.conversion=o,t.BREAK}),t.BREAK}),i}}(dat.color.toString,dat.utils.common),dat.GUI=dat.gui.GUI=function(e,t,n,i,o,s,r,a,l,h,c,u,d,p,f){function m(e,t,n,s){if(void 0===t[n])throw Error("Object "+t+' has no property "'+n+'"');s.color?t=new c(t,n):(t=[t,n].concat(s.factoryArgs),t=i.apply(e,t)),s.before instanceof o&&(s.before=s.before.__li),b(e,t),p.addClass(t.domElement,"c"),n=document.createElement("span"),p.addClass(n,"property-name"),n.innerHTML=t.property;var r=document.createElement("div");return r.appendChild(n),r.appendChild(t.domElement),s=v(e,r,s.before),p.addClass(s,L.CLASS_CONTROLLER_ROW),p.addClass(s,typeof t.getValue()),g(e,s,t),e.__controllers.push(t),t}function v(e,t,n){var i=document.createElement("li");return t&&i.appendChild(t),n?e.__ul.insertBefore(i,params.before):e.__ul.appendChild(i),e.onResize(),i}function g(e,t,n){if(n.__li=t,n.__gui=e,f.extend(n,{options:function(t){return 1<arguments.length?(n.remove(),m(e,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[f.toArray(arguments)]})):f.isArray(t)||f.isObject(t)?(n.remove(),m(e,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[t]})):void 0},name:function(e){return n.__li.firstElementChild.firstElementChild.innerHTML=e,n},listen:function(){return n.__gui.listen(n),n},remove:function(){return n.__gui.remove(n),n}}),n instanceof l){var i=new a(n.object,n.property,{min:n.__min,max:n.__max,step:n.__step});f.each(["updateDisplay","onChange","onFinishChange"],function(e){var t=n[e],o=i[e];n[e]=i[e]=function(){var e=Array.prototype.slice.call(arguments);return t.apply(n,e),o.apply(i,e)}}),p.addClass(t,"has-slider"),n.domElement.insertBefore(i.domElement,n.domElement.firstElementChild)}else if(n instanceof a){var o=function(t){return f.isNumber(n.__min)&&f.isNumber(n.__max)?(n.remove(),m(e,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[n.__min,n.__max,n.__step]})):t};n.min=f.compose(o,n.min),n.max=f.compose(o,n.max)}else n instanceof s?(p.bind(t,"click",function(){p.fakeEvent(n.__checkbox,"click")}),p.bind(n.__checkbox,"click",function(e){e.stopPropagation()})):n instanceof r?(p.bind(t,"click",function(){p.fakeEvent(n.__button,"click")}),p.bind(t,"mouseover",function(){p.addClass(n.__button,"hover")}),p.bind(t,"mouseout",function(){p.removeClass(n.__button,"hover")})):n instanceof c&&(p.addClass(t,"color"),n.updateDisplay=f.compose(function(e){return t.style.borderLeftColor=n.__color.toString(),e},n.updateDisplay),n.updateDisplay());n.setValue=f.compose(function(t){return e.getRoot().__preset_select&&n.isModified()&&_(e.getRoot(),!0),t},n.setValue)}function b(e,t){var n=e.getRoot(),i=n.__rememberedObjects.indexOf(t.object);if(-1!=i){var o=n.__rememberedObjectIndecesToControllers[i];if(void 0===o&&(o={},n.__rememberedObjectIndecesToControllers[i]=o),o[t.property]=t,n.load&&n.load.remembered){if(n=n.load.remembered,n[e.preset])n=n[e.preset];else{if(!n.Default)return;n=n.Default}n[i]&&void 0!==n[i][t.property]&&(i=n[i][t.property],t.initialValue=i,t.setValue(i))}}}function w(e){var t=e.__save_row=document.createElement("li");p.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),p.addClass(t,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",p.addClass(n,"button gears");var i=document.createElement("span");i.innerHTML="Save",p.addClass(i,"button"),p.addClass(i,"save");var o=document.createElement("span");o.innerHTML="New",p.addClass(o,"button"),p.addClass(o,"save-as");var s=document.createElement("span");s.innerHTML="Revert",p.addClass(s,"button"),p.addClass(s,"revert");var r=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?f.each(e.load.remembered,function(t,n){T(e,n,n==e.preset)}):T(e,"Default",!1),p.bind(r,"change",function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value}),t.appendChild(r),t.appendChild(n),t.appendChild(i),t.appendChild(o),t.appendChild(s),k){var a=function(){l.style.display=e.useLocalStorage?"block":"none"},t=document.getElementById("dg-save-locally"),l=document.getElementById("dg-local-explain");t.style.display="block",t=document.getElementById("dg-local-storage"),"true"===localStorage.getItem(document.location.href+".isLocal")&&t.setAttribute("checked","checked"),a(),p.bind(t,"change",function(){e.useLocalStorage=!e.useLocalStorage,a()})}var h=document.getElementById("dg-new-constructor");p.bind(h,"keydown",function(e){!e.metaKey||67!==e.which&&67!=e.keyCode||M.hide()}),p.bind(n,"click",function(){h.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),M.show(),h.focus(),h.select()}),p.bind(i,"click",function(){e.save()}),p.bind(o,"click",function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)}),p.bind(s,"click",function(){e.revert()})}function y(e){function t(t){return t.preventDefault(),o=t.clientX,p.addClass(e.__closeButton,L.CLASS_DRAG),p.bind(window,"mousemove",n),p.bind(window,"mouseup",i),!1}function n(t){return t.preventDefault(),e.width+=o-t.clientX,e.onResize(),o=t.clientX,!1}function i(){p.removeClass(e.__closeButton,L.CLASS_DRAG),p.unbind(window,"mousemove",n),p.unbind(window,"mouseup",i)}e.__resize_handle=document.createElement("div"),f.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});var o;p.bind(e.__resize_handle,"mousedown",t),p.bind(e.__closeButton,"mousedown",t),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function E(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function x(e,t){var n={};return f.each(e.__rememberedObjects,function(i,o){var s={};f.each(e.__rememberedObjectIndecesToControllers[o],function(e,n){s[n]=t?e.initialValue:e.getValue()}),n[o]=s}),n}function T(e,t,n){var i=document.createElement("option");i.innerHTML=t,i.value=t,e.__preset_select.appendChild(i),n&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function _(e,t){var n=e.__preset_select[e.__preset_select.selectedIndex];n.innerHTML=t?n.value+"*":n.value}function R(e){0!=e.length&&u(function(){R(e)}),f.each(e,function(e){e.updateDisplay()})}e.inject(n);var k;try{k="localStorage"in window&&null!==window.localStorage}catch(e){k=!1}var M,S,C=!0,A=!1,H=[],L=function(e){function t(){var e=n.getRoot();e.width+=1,f.defer(function(){--e.width})}var n=this;this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),p.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],e=e||{},e=f.defaults(e,{autoPlace:!0,width:L.DEFAULT_WIDTH}),e=f.defaults(e,{resizable:e.autoPlace,hideable:e.autoPlace}),f.isUndefined(e.load)?e.load={preset:"Default"}:e.preset&&(e.load.preset=e.preset),f.isUndefined(e.parent)&&e.hideable&&H.push(this),e.resizable=f.isUndefined(e.parent)&&e.resizable,e.autoPlace&&f.isUndefined(e.scrollable)&&(e.scrollable=!0);var i,o=k&&"true"===localStorage.getItem(document.location.href+".isLocal");if(Object.defineProperties(this,{parent:{get:function(){return e.parent}},scrollable:{get:function(){return e.scrollable}},autoPlace:{get:function(){return e.autoPlace}},preset:{get:function(){return n.parent?n.getRoot().preset:e.load.preset},set:function(t){for(n.parent?n.getRoot().preset=t:e.load.preset=t,t=0;t<this.__preset_select.length;t++)this.__preset_select[t].value==this.preset&&(this.__preset_select.selectedIndex=t);n.revert()}},width:{get:function(){return e.width},set:function(t){e.width=t,E(n,t)}},name:{get:function(){return e.name},set:function(t){e.name=t,r&&(r.innerHTML=e.name)}},closed:{get:function(){return e.closed},set:function(t){e.closed=t,e.closed?p.addClass(n.__ul,L.CLASS_CLOSED):p.removeClass(n.__ul,L.CLASS_CLOSED),this.onResize(),n.__closeButton&&(n.__closeButton.innerHTML=t?L.TEXT_OPEN:L.TEXT_CLOSED)}},load:{get:function(){return e.load}},useLocalStorage:{get:function(){return o},set:function(e){k&&((o=e)?p.bind(window,"unload",i):p.unbind(window,"unload",i),localStorage.setItem(document.location.href+".isLocal",e))}}}),f.isUndefined(e.parent)){if(e.closed=!1,p.addClass(this.domElement,L.CLASS_MAIN),p.makeSelectable(this.domElement,!1),k&&o){n.useLocalStorage=!0;var s=localStorage.getItem(document.location.href+".gui");s&&(e.load=JSON.parse(s))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=L.TEXT_CLOSED,p.addClass(this.__closeButton,L.CLASS_CLOSE_BUTTON),this.domElement.appendChild(this.__closeButton),p.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{void 0===e.closed&&(e.closed=!0);var r=document.createTextNode(e.name);p.addClass(r,"controller-name"),s=v(n,r),p.addClass(this.__ul,L.CLASS_CLOSED),p.addClass(s,"title"),p.bind(s,"click",function(e){return e.preventDefault(),n.closed=!n.closed,!1}),e.closed||(this.closed=!1)}e.autoPlace&&(f.isUndefined(e.parent)&&(C&&(S=document.createElement("div"),p.addClass(S,"dg"),p.addClass(S,L.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(S),C=!1),S.appendChild(this.domElement),p.addClass(this.domElement,L.CLASS_AUTO_PLACE)),this.parent||E(n,e.width)),p.bind(window,"resize",function(){n.onResize()}),p.bind(this.__ul,"webkitTransitionEnd",function(){n.onResize()}),p.bind(this.__ul,"transitionend",function(){n.onResize()}),p.bind(this.__ul,"oTransitionEnd",function(){n.onResize()}),this.onResize(),e.resizable&&y(this),this.saveToLocalStorageIfPossible=i=function(){k&&"true"===localStorage.getItem(document.location.href+".isLocal")&&localStorage.setItem(document.location.href+".gui",JSON.stringify(n.getSaveObject()))},n.getRoot(),e.parent||t()};return L.toggleHide=function(){A=!A,f.each(H,function(e){e.domElement.style.zIndex=A?-999:999,e.domElement.style.opacity=A?0:1})},L.CLASS_AUTO_PLACE="a",L.CLASS_AUTO_PLACE_CONTAINER="ac",L.CLASS_MAIN="main",L.CLASS_CONTROLLER_ROW="cr",L.CLASS_TOO_TALL="taller-than-window",L.CLASS_CLOSED="closed",L.CLASS_CLOSE_BUTTON="close-button",L.CLASS_DRAG="drag",L.DEFAULT_WIDTH=245,L.TEXT_CLOSED="Close Controls",L.TEXT_OPEN="Open Controls",p.bind(window,"keydown",function(e){"text"===document.activeElement.type||72!==e.which&&72!=e.keyCode||L.toggleHide()},!1),f.extend(L.prototype,{add:function(e,t){return m(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return m(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;f.defer(function(){t.onResize()})},destroy:function(){this.autoPlace&&S.removeChild(this.domElement)},addFolder:function(e){if(void 0!==this.__folders[e])throw Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};return t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]),t=new L(t),this.__folders[e]=t,e=v(this,t.domElement),p.addClass(e,"folder"),t},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=p.getOffset(e.__ul).top,n=0;f.each(e.__ul.childNodes,function(t){e.autoPlace&&t===e.__save_row||(n+=p.getHeight(t))}),window.innerHeight-t-20<n?(p.addClass(e.domElement,L.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-20+"px"):(p.removeClass(e.domElement,L.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&f.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},remember:function(){if(f.isUndefined(M)&&(M=new d,M.domElement.innerHTML=t),this.parent)throw Error("You can only call remember on a top level GUI.");var e=this;f.each(Array.prototype.slice.call(arguments),function(t){0==e.__rememberedObjects.length&&w(e),-1==e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)}),this.autoPlace&&E(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,0<this.__rememberedObjects.length&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=x(this)),e.folders={},f.each(this.__folders,function(t,n){e.folders[n]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=x(this),_(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=x(this,!0)),this.load.remembered[e]=x(this),this.preset=e,T(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){f.each(this.__controllers,function(t){this.getRoot().load.remembered?b(e||this.getRoot(),t):t.setValue(t.initialValue)},this),f.each(this.__folders,function(e){e.revert(e)}),e||_(this.getRoot(),!1)},listen:function(e){var t=0==this.__listening.length;this.__listening.push(e),t&&R(this.__listening)}}),L}(dat.utils.css,'<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n      \n    </div>\n    \n  </div>\n\n</div>',".dg {\n  /** Clear list styles */\n  /* Auto-place container */\n  /* Auto-placed GUI's */\n  /* Line items that don't contain folders. */\n  /** Folder names */\n  /** Hides closed items */\n  /** Controller row */\n  /** Name-half (left) */\n  /** Controller-half (right) */\n  /** Controller placement */\n  /** Shorter number boxes when slider is present. */\n  /** Ensure the entire boolean and function row shows a hand */ }\n  .dg ul {\n    list-style: none;\n    margin: 0;\n    padding: 0;\n    width: 100%;\n    clear: both; }\n  .dg.ac {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 0;\n    z-index: 0; }\n  .dg:not(.ac) .main {\n    /** Exclude mains in ac so that we don't hide close button */\n    overflow: hidden; }\n  .dg.main {\n    -webkit-transition: opacity 0.1s linear;\n    -o-transition: opacity 0.1s linear;\n    -moz-transition: opacity 0.1s linear;\n    transition: opacity 0.1s linear; }\n    .dg.main.taller-than-window {\n      overflow-y: auto; }\n      .dg.main.taller-than-window .close-button {\n        opacity: 1;\n        /* TODO, these are style notes */\n        margin-top: -1px;\n        border-top: 1px solid #2c2c2c; }\n    .dg.main ul.closed .close-button {\n      opacity: 1 !important; }\n    .dg.main:hover .close-button,\n    .dg.main .close-button.drag {\n      opacity: 1; }\n    .dg.main .close-button {\n      /*opacity: 0;*/\n      -webkit-transition: opacity 0.1s linear;\n      -o-transition: opacity 0.1s linear;\n      -moz-transition: opacity 0.1s linear;\n      transition: opacity 0.1s linear;\n      border: 0;\n      position: absolute;\n      line-height: 19px;\n      height: 20px;\n      /* TODO, these are style notes */\n      cursor: pointer;\n      text-align: center;\n      background-color: #000; }\n      .dg.main .close-button:hover {\n        background-color: #111; }\n  .dg.a {\n    float: right;\n    margin-right: 15px;\n    overflow-x: hidden; }\n    .dg.a.has-save > ul {\n      margin-top: 27px; }\n      .dg.a.has-save > ul.closed {\n        margin-top: 0; }\n    .dg.a .save-row {\n      position: fixed;\n      top: 0;\n      z-index: 1002; }\n  .dg li {\n    -webkit-transition: height 0.1s ease-out;\n    -o-transition: height 0.1s ease-out;\n    -moz-transition: height 0.1s ease-out;\n    transition: height 0.1s ease-out; }\n  .dg li:not(.folder) {\n    cursor: auto;\n    height: 27px;\n    line-height: 27px;\n    overflow: hidden;\n    padding: 0 4px 0 5px; }\n  .dg li.folder {\n    padding: 0;\n    border-left: 4px solid rgba(0, 0, 0, 0); }\n  .dg li.title {\n    cursor: pointer;\n    margin-left: -4px; }\n  .dg .closed li:not(.title),\n  .dg .closed ul li,\n  .dg .closed ul li > * {\n    height: 0;\n    overflow: hidden;\n    border: 0; }\n  .dg .cr {\n    clear: both;\n    padding-left: 3px;\n    height: 27px; }\n  .dg .property-name {\n    cursor: default;\n    float: left;\n    clear: left;\n    width: 40%;\n    overflow: hidden;\n    text-overflow: ellipsis; }\n  .dg .c {\n    float: left;\n    width: 60%; }\n  .dg .c input[type=text] {\n    border: 0;\n    margin-top: 4px;\n    padding: 3px;\n    width: 100%;\n    float: right; }\n  .dg .has-slider input[type=text] {\n    width: 30%;\n    /*display: none;*/\n    margin-left: 0; }\n  .dg .slider {\n    float: left;\n    width: 66%;\n    margin-left: -5px;\n    margin-right: 0;\n    height: 19px;\n    margin-top: 4px; }\n  .dg .slider-fg {\n    height: 100%; }\n  .dg .c input[type=checkbox] {\n    margin-top: 9px; }\n  .dg .c select {\n    margin-top: 5px; }\n  .dg .cr.function,\n  .dg .cr.function .property-name,\n  .dg .cr.function *,\n  .dg .cr.boolean,\n  .dg .cr.boolean * {\n    cursor: pointer; }\n  .dg .selector {\n    display: none;\n    position: absolute;\n    margin-left: -9px;\n    margin-top: 23px;\n    z-index: 10; }\n  .dg .c:hover .selector,\n  .dg .selector.drag {\n    display: block; }\n  .dg li.save-row {\n    padding: 0; }\n    .dg li.save-row .button {\n      display: inline-block;\n      padding: 0px 6px; }\n  .dg.dialogue {\n    background-color: #222;\n    width: 460px;\n    padding: 15px;\n    font-size: 13px;\n    line-height: 15px; }\n\n/* TODO Separate style and structure */\n#dg-new-constructor {\n  padding: 10px;\n  color: #222;\n  font-family: Monaco, monospace;\n  font-size: 10px;\n  border: 0;\n  resize: none;\n  box-shadow: inset 1px 1px 1px #888;\n  word-wrap: break-word;\n  margin: 12px 0;\n  display: block;\n  width: 440px;\n  overflow-y: scroll;\n  height: 100px;\n  position: relative; }\n\n#dg-local-explain {\n  display: none;\n  font-size: 11px;\n  line-height: 17px;\n  border-radius: 3px;\n  background-color: #333;\n  padding: 8px;\n  margin-top: 10px; }\n  #dg-local-explain code {\n    font-size: 10px; }\n\n#dat-gui-save-locally {\n  display: none; }\n\n/** Main type */\n.dg {\n  color: #eee;\n  font: 11px 'Lucida Grande', sans-serif;\n  text-shadow: 0 -1px 0 #111;\n  /** Auto place */\n  /* Controller row, <li> */\n  /** Controllers */ }\n  .dg.main {\n    /** Scrollbar */ }\n    .dg.main::-webkit-scrollbar {\n      width: 5px;\n      background: #1a1a1a; }\n    .dg.main::-webkit-scrollbar-corner {\n      height: 0;\n      display: none; }\n    .dg.main::-webkit-scrollbar-thumb {\n      border-radius: 5px;\n      background: #676767; }\n  .dg li:not(.folder) {\n    background: #1a1a1a;\n    border-bottom: 1px solid #2c2c2c; }\n  .dg li.save-row {\n    line-height: 25px;\n    background: #dad5cb;\n    border: 0; }\n    .dg li.save-row select {\n      margin-left: 5px;\n      width: 108px; }\n    .dg li.save-row .button {\n      margin-left: 5px;\n      margin-top: 1px;\n      border-radius: 2px;\n      font-size: 9px;\n      line-height: 7px;\n      padding: 4px 4px 5px 4px;\n      background: #c5bdad;\n      color: #fff;\n      text-shadow: 0 1px 0 #b0a58f;\n      box-shadow: 0 -1px 0 #b0a58f;\n      cursor: pointer; }\n      .dg li.save-row .button.gears {\n        background: #c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;\n        height: 7px;\n        width: 8px; }\n      .dg li.save-row .button:hover {\n        background-color: #bab19e;\n        box-shadow: 0 -1px 0 #b0a58f; }\n  .dg li.folder {\n    border-bottom: 0; }\n  .dg li.title {\n    padding-left: 16px;\n    background: black url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;\n    cursor: pointer;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.2); }\n  .dg .closed li.title {\n    background-image: url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==); }\n  .dg .cr.boolean {\n    border-left: 3px solid #806787; }\n  .dg .cr.function {\n    border-left: 3px solid #e61d5f; }\n  .dg .cr.number {\n    border-left: 3px solid #2fa1d6; }\n    .dg .cr.number input[type=text] {\n      color: #2fa1d6; }\n  .dg .cr.string {\n    border-left: 3px solid #1ed36f; }\n    .dg .cr.string input[type=text] {\n      color: #1ed36f; }\n  .dg .cr.function:hover, .dg .cr.boolean:hover {\n    background: #111; }\n  .dg .c input[type=text] {\n    background: #303030;\n    outline: none; }\n    .dg .c input[type=text]:hover {\n      background: #3c3c3c; }\n    .dg .c input[type=text]:focus {\n      background: #494949;\n      color: #fff; }\n  .dg .c .slider {\n    background: #303030;\n    cursor: ew-resize; }\n  .dg .c .slider-fg {\n    background: #2fa1d6; }\n  .dg .c .slider:hover {\n    background: #3c3c3c; }\n    .dg .c .slider:hover .slider-fg {\n      background: #44abda; }\n",dat.controllers.factory=function(e,t,n,i,o,s,r){
return function(a,l,h,c){var u=a[l];return r.isArray(h)||r.isObject(h)?new e(a,l,h):r.isNumber(u)?r.isNumber(h)&&r.isNumber(c)?new n(a,l,h,c):new t(a,l,{min:h,max:c}):r.isString(u)?new i(a,l):r.isFunction(u)?new o(a,l,""):r.isBoolean(u)?new s(a,l):void 0}}(dat.controllers.OptionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.StringController=function(e,t,n){var i=function(e,n){function o(){s.setValue(s.__input.value)}i.superclass.call(this,e,n);var s=this;this.__input=document.createElement("input"),this.__input.setAttribute("type","text"),t.bind(this.__input,"keyup",o),t.bind(this.__input,"change",o),t.bind(this.__input,"blur",function(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}),t.bind(this.__input,"keydown",function(e){13===e.keyCode&&this.blur()}),this.updateDisplay(),this.domElement.appendChild(this.__input)};return i.superclass=e,n.extend(i.prototype,e.prototype,{updateDisplay:function(){return t.isActive(this.__input)||(this.__input.value=this.getValue()),i.superclass.prototype.updateDisplay.call(this)}}),i}(dat.controllers.Controller,dat.dom.dom,dat.utils.common),dat.controllers.FunctionController,dat.controllers.BooleanController,dat.utils.common),dat.controllers.Controller,dat.controllers.BooleanController,dat.controllers.FunctionController,dat.controllers.NumberControllerBox,dat.controllers.NumberControllerSlider,dat.controllers.OptionController,dat.controllers.ColorController=function(e,t,n,i,o){function s(e,t,n,i){e.style.background="",o.each(l,function(o){e.style.cssText+="background: "+o+"linear-gradient("+t+", "+n+" 0%, "+i+" 100%); "})}function r(e){e.style.background="",e.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",e.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var a=function(e,l){function h(e){p(e),t.bind(window,"mousemove",p),t.bind(window,"mouseup",c)}function c(){t.unbind(window,"mousemove",p),t.unbind(window,"mouseup",c)}function u(){var e=i(this.value);!1!==e?(m.__color.__state=e,m.setValue(m.__color.toOriginal())):this.value=m.__color.toString()}function d(){t.unbind(window,"mousemove",f),t.unbind(window,"mouseup",d)}function p(e){e.preventDefault();var n=t.getWidth(m.__saturation_field),i=t.getOffset(m.__saturation_field),o=(e.clientX-i.left+document.body.scrollLeft)/n;return e=1-(e.clientY-i.top+document.body.scrollTop)/n,1<e?e=1:0>e&&(e=0),1<o?o=1:0>o&&(o=0),m.__color.v=e,m.__color.s=o,m.setValue(m.__color.toOriginal()),!1}function f(e){e.preventDefault();var n=t.getHeight(m.__hue_field),i=t.getOffset(m.__hue_field);return e=1-(e.clientY-i.top+document.body.scrollTop)/n,1<e?e=1:0>e&&(e=0),m.__color.h=360*e,m.setValue(m.__color.toOriginal()),!1}a.superclass.call(this,e,l),this.__color=new n(this.getValue()),this.__temp=new n(0);var m=this;this.domElement=document.createElement("div"),t.makeSelectable(this.domElement,!1),this.__selector=document.createElement("div"),this.__selector.className="selector",this.__saturation_field=document.createElement("div"),this.__saturation_field.className="saturation-field",this.__field_knob=document.createElement("div"),this.__field_knob.className="field-knob",this.__field_knob_border="2px solid ",this.__hue_knob=document.createElement("div"),this.__hue_knob.className="hue-knob",this.__hue_field=document.createElement("div"),this.__hue_field.className="hue-field",this.__input=document.createElement("input"),this.__input.type="text",this.__input_textShadow="0 1px 1px ",t.bind(this.__input,"keydown",function(e){13===e.keyCode&&u.call(this)}),t.bind(this.__input,"blur",u),t.bind(this.__selector,"mousedown",function(e){t.addClass(this,"drag").bind(window,"mouseup",function(e){t.removeClass(m.__selector,"drag")})});var v=document.createElement("div");o.extend(this.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),o.extend(this.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:this.__field_knob_border+(.5>this.__color.v?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),o.extend(this.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),o.extend(this.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),o.extend(v.style,{width:"100%",height:"100%",background:"none"}),s(v,"top","rgba(0,0,0,0)","#000"),o.extend(this.__hue_field.style,{width:"15px",height:"100px",display:"inline-block",border:"1px solid #555",cursor:"ns-resize"}),r(this.__hue_field),o.extend(this.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:this.__input_textShadow+"rgba(0,0,0,0.7)"}),t.bind(this.__saturation_field,"mousedown",h),t.bind(this.__field_knob,"mousedown",h),t.bind(this.__hue_field,"mousedown",function(e){f(e),t.bind(window,"mousemove",f),t.bind(window,"mouseup",d)}),this.__saturation_field.appendChild(v),this.__selector.appendChild(this.__field_knob),this.__selector.appendChild(this.__saturation_field),this.__selector.appendChild(this.__hue_field),this.__hue_field.appendChild(this.__hue_knob),this.domElement.appendChild(this.__input),this.domElement.appendChild(this.__selector),this.updateDisplay()};a.superclass=e,o.extend(a.prototype,e.prototype,{updateDisplay:function(){var e=i(this.getValue());if(!1!==e){var t=!1;o.each(n.COMPONENTS,function(n){if(!o.isUndefined(e[n])&&!o.isUndefined(this.__color.__state[n])&&e[n]!==this.__color.__state[n])return t=!0,{}},this),t&&o.extend(this.__color.__state,e)}o.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=.5>this.__color.v||.5<this.__color.s?255:0,a=255-r;o.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,s(this.__saturation_field,"left","#fff",this.__temp.toString()),o.extend(this.__input.style,{backgroundColor:this.__input.value=this.__color.toString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}});var l=["-moz-","-o-","-webkit-","-ms-",""];return a}(dat.controllers.Controller,dat.dom.dom,dat.color.Color=function(e,t,n,i){function o(e,t,n){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space?this.__state[t]:(r(this,t,n),this.__state[t])},set:function(e){"RGB"!==this.__state.space&&(r(this,t,n),this.__state.space="RGB"),this.__state[t]=e}})}function s(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space?this.__state[t]:(a(this),this.__state[t])},set:function(e){"HSV"!==this.__state.space&&(a(this),this.__state.space="HSV"),this.__state[t]=e}})}function r(e,n,o){if("HEX"===e.__state.space)e.__state[n]=t.component_from_hex(e.__state.hex,o);else{if("HSV"!==e.__state.space)throw"Corrupted color state";i.extend(e.__state,t.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}}function a(e){var n=t.rgb_to_hsv(e.r,e.g,e.b);i.extend(e.__state,{s:n.s,v:n.v}),i.isNaN(n.h)?i.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=n.h}var l=function(){if(this.__state=e.apply(this,arguments),!1===this.__state)throw"Failed to interpret color arguments";this.__state.a=this.__state.a||1};return l.COMPONENTS="r g b h s v hex a".split(" "),i.extend(l.prototype,{toString:function(){return n(this)},toOriginal:function(){return this.__state.conversion.write(this)}}),o(l.prototype,"r",2),o(l.prototype,"g",1),o(l.prototype,"b",0),s(l.prototype,"h"),s(l.prototype,"s"),s(l.prototype,"v"),Object.defineProperty(l.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(l.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=t.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}}),l}(dat.color.interpret,dat.color.math=function(){var e;return{hsv_to_rgb:function(e,t,n){var i=e/60-Math.floor(e/60),o=n*(1-t),s=n*(1-i*t);return t=n*(1-(1-i)*t),e=[[n,t,o],[s,n,o],[o,n,t],[o,s,n],[t,o,n],[n,o,s]][Math.floor(e/60)%6],{r:255*e[0],g:255*e[1],b:255*e[2]}},rgb_to_hsv:function(e,t,n){var i=Math.min(e,t,n),o=Math.max(e,t,n),i=o-i;return 0==o?{h:NaN,s:0,v:0}:(e=(e==o?(t-n)/i:t==o?2+(n-e)/i:4+(e-t)/i)/6,0>e&&(e+=1),{h:360*e,s:i/o,v:o/255})},rgb_to_hex:function(e,t,n){return e=this.hex_with_component(0,2,e),e=this.hex_with_component(e,1,t),e=this.hex_with_component(e,0,n)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(t,n,i){return i<<(e=8*n)|t&~(255<<e)}}}(),dat.color.toString,dat.utils.common),dat.color.interpret,dat.utils.common),dat.utils.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}(),dat.dom.CenteredDiv=function(e,t){var n=function(){this.backgroundElement=document.createElement("div"),t.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),e.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),t.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var n=this;e.bind(this.backgroundElement,"click",function(){n.hide()})};return n.prototype.show=function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),t.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})},n.prototype.hide=function(){var t=this,n=function(){t.domElement.style.display="none",t.backgroundElement.style.display="none",e.unbind(t.domElement,"webkitTransitionEnd",n),e.unbind(t.domElement,"transitionend",n),e.unbind(t.domElement,"oTransitionEnd",n)};e.bind(this.domElement,"webkitTransitionEnd",n),e.bind(this.domElement,"transitionend",n),e.bind(this.domElement,"oTransitionEnd",n),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"},n.prototype.layout=function(){this.domElement.style.left=window.innerWidth/2-e.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-e.getHeight(this.domElement)/2+"px"},n}(dat.dom.dom,dat.utils.common),dat.dom.dom,dat.utils.common);var saveAs=saveAs||function(e){"use strict";if(!("undefined"==typeof e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=e.document,n=function(){return e.URL||e.webkitURL||e},i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in i,s=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},r=/constructor/i.test(e.HTMLElement)||e.safari,a=/CriOS\/[\d]+/.test(navigator.userAgent),l=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},h="application/octet-stream",c=4e4,u=function(e){var t=function(){"string"==typeof e?n().revokeObjectURL(e):e.remove()};setTimeout(t,c)},d=function(e,t,n){t=[].concat(t);for(var i=t.length;i--;){var o=e["on"+t[i]];if("function"==typeof o)try{o.call(e,n||e)}catch(e){l(e)}}},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},f=function(t,l,c){c||(t=p(t));var f,m=this,v=t.type,g=v===h,b=function(){d(m,"writestart progress write writeend".split(" "))},w=function(){if((a||g&&r)&&e.FileReader){var i=new FileReader;return i.onloadend=function(){var t=a?i.result:i.result.replace(/^data:[^;]*;/,"data:attachment/file;"),n=e.open(t,"_blank");n||(e.location.href=t),t=void 0,m.readyState=m.DONE,b()},i.readAsDataURL(t),void(m.readyState=m.INIT)}if(f||(f=n().createObjectURL(t)),g)e.location.href=f;else{var o=e.open(f,"_blank");o||(e.location.href=f)}m.readyState=m.DONE,b(),u(f)};return m.readyState=m.INIT,o?(f=n().createObjectURL(t),void setTimeout(function(){i.href=f,i.download=l,s(i),b(),u(f),m.readyState=m.DONE})):void w()},m=f.prototype,v=function(e,t,n){return new f(e,t||e.name||"download",n)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t)}:(m.abort=function(){},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,v)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs}),EventEmitter.ADD={},EventEmitter.DEL={},EventEmitter.prototype={_add:function(e,t){e.tail?(t.prev=e.tail,e.tail=e.tail.next=t):e.head=e.tail=t},_rem:function(e,t){t.prev?t.prev.next=t.next:e.head=t.next,t.next?t.next.prev=t.prev:e.tail=t.prev},when:function(e,t,n,i){for(var o in e)this.on(o,e[o],t,n,i)},once:function(e,t,n,i){this.on(e,t,n,i,!0)},on:function(e,t,n,i,o){"function"==typeof t&&this.emit(EventEmitter.ADD,{type:e,func:t,scope:n,data:null==i?[]:[].concat(i),once:o})},off:function(e,t,n){this.emit(EventEmitter.DEL,{type:e,func:t,scope:n})},will:function(e,t){var n=this,i=null==t?[]:[].concat(t);return function(){for(var t=i.slice(),o=0;o<arguments.length;o++)t.push(arguments[o]);n.emit(e,t)}},emit:function(e,t){if(this.debug&&console.log(this.debug,e,t),this._add(this.queue,{type:e,data:null==t?[]:t}),!this.processing){for(this.processing=!0;this.queue.head;)this.dispatch(this.queue.head),this._rem(this.queue,this.queue.head);this.processing=!1}},dispatch:function(e){var t=e.type,n=e.data;switch(t){case EventEmitter.ADD:this._add(this.lists[n.type]||(this.lists[n.type]={}),n);break;case EventEmitter.DEL:for(var t in this.lists)for(var i=this.lists[t],o=i.head;o;o=o.next)null!=n.type&&n.type!==t||null!=n.func&&n.func!==o.func||null!=n.scope&&n.scope!==o.scope||this._rem(i,o);break;default:var i=this.lists[t];if(i)for(var o=i.head;o;o=o.next)o.func.apply(o.scope,o.data.concat(n)),o.once&&this._rem(i,o);for(var s=this.links.head;s;s=s.next)s.emitter.emit(s.prefix?s.prefix+t:t,s.data.concat(n))}},relay:function(e,t,n){this.on(e,t.emit,t,n||e)},link:function(e,t,n){if(e===this)throw Error("EventEmitter can't link to itself");this._add(this.links,{emitter:e,prefix:t,data:null==n?[]:[].concat(n)})},unlink:function(e,t){for(var n=this.links.head;n;n=n.next)null!=e&&e!==n.emitter||null!=t&&t!==n.prefix||this._rem(this.links,n)},clone:function(){var e=new EventEmitter;for(var t in this.lists)e.lists[t]=this.lists[t];return e}},EventHandler.prototype={handleEvent:function(e){return this.apply(e)},apply:function(e){return this.once&&this.release(),this.func.apply(this.scope,[].concat(this.data,e||[]))},listen:function(e,t,n){return this.element&&this.release(),this.type=e,this.element=t,this.capture=!!n,this.element&&this.element.addEventListener&&this.element.addEventListener(this.type,this,this.capture),this},release:function(){return this.element&&this.element.removeEventListener&&this.element.removeEventListener(this.type,this,this.capture),delete this.element,this}},Observable.count=0,Observable.stack=[],Observable.context=null,Observable.unwrap=function(e){return e instanceof Observable?e.read():e},Observable.inContext=function(e,t,n,i,o){Observable.stack.push(Observable.context),Observable.context=e;try{return t.call(n,i,o)}finally{Observable.context=Observable.stack.pop()}},Observable.prototype={set:function(e,t,n,i){return this.reader="function"==typeof t?t:null,this.writer="function"==typeof n?n:null,this.equals="function"==typeof i?i:null,this.scope=e,this.stale=!0,this},read:function(){var e=Observable.context;if(e&&e.id!==this.id&&(this.targets[e.id]=e,e.sources[this.id]=this),this.stale)if(this.stale=!1,this.reader){this.sources={};var t=this.value;this.value=Observable.inContext(this,this.reader,this.scope,this.value),this.debug&&console.log("OB",this.id,"read",t,"->",this.value,"deps:",Object.keys(this.sources).map(Number))}else this.debug&&console.log("OB",this.id,"read stale no reader",this.value);else this.debug&&console.log("OB",this.id,"read utmost",this.value);return this.value},write:function(e){return this.value!==e?(this.writer&&this.writer.call(this.scope,e,this.value),this.debug&&console.log("OB",this.id,"write ok",this.value,"->",e),this.value=e,this.touch()):this.debug&&console.log("OB",this.id,"write fail",e),this},touch:function(e){this.stale=!0,this.debug&&console.trace("OB",this.id,"touched");var t=this.debug;for(var n in this.targets){var i=this.targets[n];delete this.targets[n],t|=i.touch()}return t&&console.log("---> OB",this.id),t},destroy:function(){for(var e in this.sources)delete this.sources[e].targets[this.id],delete this.sources[e];this.touch()}},Timer.prototype={time:0,rate:1,running:!1,play:function(){if(this.running)return this;this.running=!0;var e=this,t=0,n=performance.now(),i=n,o=0,s=0;return document.addEventListener("visibilitychange",function(){i=performance.now()}),!function n(){e.id=requestAnimationFrame(n),t++,o=performance.now(),s=(o-i)*e.rate,e.time+=s,e.func.call(e.scope,e.time,s,t),i=o}(),this},stop:function(){return this.running&&(this.running=!1,cancelAnimationFrame(this.id)),this}},Defer.all=function(e){function t(a,l){var h=e.indexOf(this);return a instanceof Defer?(e[h]=a,void a.then(t,t)):(l?++s:++r,l&&(o[h]=a),void(s+r>=i&&setTimeout(function(){n.transition(!r,o)},0)))}var n=new Defer,i=e&&e.length||0,o=new Array(e.length),s=0,r=0;if(!i)return n.resolve(o),n;for(var a=0;a<i;a++){var l=e[a];l instanceof Defer?l.then(t,t,l):(o[a]=l,s++)}return n},Defer.complete=function(e,t){var n=new Defer;return n.pending=!1,n.success=e,n.value=t,n},Defer.timer=function(e){function t(t,n){var i=new Defer;return setTimeout(function(){i.transition(t,n)},e||0),i}return new Defer(t,t)},Defer.prototype={unsafe:!1,soft:!1,set:function(e,t,n,i){return this.onresolve="function"==typeof e?e:null,this.onreject="function"==typeof t?t:null,this.scope=this.onreject?n:t||n,this.unsafe=!!i,this},abort:function(){return delete this.head,delete this.tail,this.set(null)},then:function(e,t,n,i){return this.push(new Defer(e,t,n,i))},anyway:function(e,t,n){return this.push(new Defer(e,e,t,n))},delay:function(e){return this.push(Defer.timer(e))},push:function(e){return this.tail?this.tail=this.tail.next=e:this.head=this.tail=e,this.dispatch(),e},resolve:function(e,t){return this.transition(!0,e,t)},reject:function(e,t){return this.transition(!1,e,t)},transition:function(e,t){if(this.debug&&console.log("defer",this.debug,e?"resolve":"reject",this.pending?"ok":"no",t),!this.pending)return this;this.pending=!1;var n=e?this.onresolve:this.onreject;if(n)if(this.unsafe)this.value=n.call(this.scope,t,e),this.success=!0;else try{this.value=n.call(this.scope,t,e),this.success=!0}catch(e){this.value=e,this.success=!1}else this.success=e,this.value=t;return this.dispatch(),this},dispatch:function(){if(this.pending)return this;var e=this.head;if(delete this.head,delete this.tail,e)if(this.value instanceof Defer)this.value.push(e);else for(;e;)e.transition(this.success,this.value,this),e=e.next;else if(!this.success&&!this.soft)throw this.value;return this}},Gate.prototype={on:function(e){this.set(!0,e)},off:function(e){this.set(!1,e)},set:function(e,t){this.inputs[t]!==e&&(this.inputs[t]=e,this.check())},will:function(e,t){var n=this;return function(){n.set(e,t)}},check:function(e){var t,n=Object.keys(this.inputs);if(n.length){t=this.inputs[n[0]];for(var i=1;i<n.length;i++)t=this.method(t,this.inputs[n[i]])}else t=this.value;(!this.value!=!t||e)&&this.events.emit(t?"opened":"closed",!!t),(this.value!==t||e)&&(this.value=t,this.events.emit("change",t))},constructor:Gate},Gate.MULTIPLY=function(e,t){return e*t},Gate.ADD=function(e,t){return e+t},Gate.AND=function(e,t){return e&&t},Gate.OR=function(e,t){return e||t},Loader.prototype={randomize:!1,reset:function(){this.units=[],this.defers=[]},wait:function(e){this.defers.push(e)},abort:function(e){e?e.abort():(this.units.forEach(this.abort,this),this.reset())},load:function(e,t,n){var i=Loader.Resource.types[e];if(!i)throw TypeError("Loader: unknown type: "+e);var o={};for(var s in i)o[s]=i[s];for(var s in n)o[s]=n[s];var r=new Loader.Resource(t,o,this);return this.units.push(r),this.defers.push(r.deferTail),r.transport(),r.defer},progress:function(){this.unitsTotal=this.units.length,this.unitsLoaded=0,this.bytesTotal=0,this.bytesLoaded=0;for(var e=0;e<this.unitsTotal;e++){var t=this.units[e];this.unitsLoaded+=t.deferTail.pending?0:1,this.bytesTotal+=t.bytesTotal,this.bytesLoaded+=t.bytesLoaded}"function"==typeof this.onProgressCallback&&this.onProgressCallback.call(this.onProgressScope,this.bytesLoaded,this.bytesTotal)},onProgress:function(e,t){this.onProgressCallback=e,this.onProgressScope=t},ready:function(e,t,n){var i=Defer.all(this.defers);return arguments.length?i.then(e,t,n):i}},Loader.imageTransport=function(){var e=this,t=new Image;e.data=t,t.onload=function(){e.deferHead.resolve(t)},t.onerror=function(t){e.deferHead.reject(t)},t.onprogress=function(t){e.bytesLoaded=t.loaded,e.bytesTotal=t.total,e.loader.progress()},t.src=e.source},Loader.ajaxTransport=function(){var e=this,t=new XMLHttpRequest,n=[];for(var i in e.query)n.push(encodeURIComponent(i)+"="+encodeURIComponent(e.query[i]));var o=n.join("&");e.request=t,e.requestType=e.requestType?e.requestType.toUpperCase():"GET","GET"===e.requestType&&o&&(e.source+="?"+o),t.open(e.requestType,e.source,!0),t.responseType=e.responseType||"";for(var s in e.headers)t.setRequestHeader(s,e.headers[s]);t.onreadystatechange=function(){4===t.readyState&&(200<=t.status&&t.status<400?(e.data=t[e.responseName||"responseText"],e.deferHead.resolve(e.data)):e.deferHead.reject("HTTP "+t.status))},t.onprogress=function(t){e.bytesLoaded=t.loaded,e.bytesTotal=t.lengthComputable?t.total:3*t.loaded,e.loader.progress()},t.send("POST"===e.requestType?o:null)},Loader.extend=function(e,t){Loader.prototype[e]&&console.warn("Loader.extend: overwriting "+e),Loader.Resource.types[e]=t,Loader.prototype[e]=function(t,n){return this.load(e,t,n)}},Loader.Resource=function(e,t,n){for(var i in t)this[i]=t[i];this.url=e,this.loader=n,this.bytesTotal=0,this.bytesLoaded=0,this.source=(this.url+"").replace(/#.*$/,""),(this.randomize||n.randomize)&&(this.source+="&?"[+!~this.source.indexOf("?")]+Math.random()),this.deferHead=new Defer(this.prepare,this),this.saveAs||this.saveTo?this.defer=this.deferHead.then(this.save,this):this.defer=this.deferHead.then(),this.deferTail=this.defer},Loader.Resource.prototype={save:function(e){var t=this.saveTo||this.loader.data,n=this.saveAs||"data";return t[n]=e},abort:function(){return this.request&&this.request.abort(),this.deferHead.init(null),this.deferTail.init(null),this}},Loader.Resource.types={},!function(){var e={image:{transport:Loader.imageTransport},text:{transport:Loader.ajaxTransport},post:{transport:Loader.ajaxTransport,requestType:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},query:null},json:{transport:Loader.ajaxTransport,prepare:JSON.parse},xml:{responseName:"responseXML",transport:Loader.ajaxTransport},buffer:{responseType:"arraybuffer",responseName:"response",transport:Loader.ajaxTransport}};for(var t in e)Loader.extend(t,e[t])}(),Loader.extend("obj",{transport:Loader.ajaxTransport,saveMetadata:!1,computeBoundingBox:!1,randomColor:!0,verbose:!1,prepare:function(e){function t(e){return e<0&&(e=c.vertices.length+e+1),c.vertices[e]||h.verbose&&console.warn("Loader.obj: undefined vertex "+e),e<u?r.vertices.push(c.vertices[e])-1:e-u}function n(){r=new THREE.Geometry,a=new THREE.MeshBasicMaterial,l=new THREE.Mesh(r,a),h.randomColor&&a.color.set(Math.round(16777215*Math.random())),u=c.vertices.length,c.meshes.push(l)}function i(e,t,n,i,o,s,a,l,c,u){if(v.subVectors(a[n],a[t]),g.subVectors(a[e],a[t]),v.cross(g),!v.x&&!v.y&&!v.z)return void(h.verbose&&console.warn('[Loader.obj] collapsed face "'+h.url+'":',u,[e,t,n]));v.normalize();var d=new THREE.Face3(i[e],i[t],i[n]);d.normal.copy(v),c&&d.vertexNormals.push(s[e],s[t],s[n]),r.faceVertexUvs[0].push(l?[o[e],o[t],o[n]]:b),r.faces.push(d)}function o(){r&&r.vertices.length&&(h.computeBoundingBox&&r.computeBoundingBox(),p.add(l))}function s(){d&&(d=!1,o(),n())}for(var r,a,l,h=this,c={vertices:[],normals:[],meshes:[],uvs:[]},u=0,d=!0,p=new THREE.Object3D,f=p,m=new THREE.Vector2,v=new THREE.Vector3,g=new THREE.Vector3,b=[m,m,m],w=-1,y=0;y!==-1;){var E=e.indexOf("\n",y+1),x=e.substr(y,E-y).replace(/#.*/,"").trim();if(w++,y=E,x){var T=x.split(/\s+/),_=T[0],R=T.slice(1);switch(_){case"mtllib":break;case"o":break;case"s":break;case"usemtl":l.material.name=R.join(" ");break;case"g":l.name=R.join(" ");break;case"v":s();var k=new THREE.Vector3(parseFloat(R[0]),parseFloat(R[1]),parseFloat(R[2]));c.vertices.push(k),r.vertices.push(k);break;case"vn":c.normals.push(new THREE.Vector3(parseFloat(R[0]),parseFloat(R[1]),parseFloat(R[2])));break;case"vt":c.uvs.push(new THREE.Vector2(parseFloat(R[0]),parseFloat(R[1])));break;case"f":for(var M=R.length,S=!0,C=!0,A=[],H=[],L=[],N=[],P=0;P<M;P++){var I=R[P].split("/"),D=t(parseInt(I[0])-1),B=c.uvs[parseInt(I[1])-1],O=c.normals[parseInt(I[2])-1];A.push(D),H.push(B),L.push(O),N.push(r.vertices[D]),C&=!!B,S&=!!O}if(4===M)i(0,1,3,A,H,L,N,C,S,w),i(1,2,3,A,H,L,N,C,S,w);else{if(3!==M){h.verbose&&console.warn("[Loader.obj] unknown face with",M,"vertices");continue}i(0,1,2,A,H,L,N,C,S,w)}d=!0;break;default:h.verbose&&console.log('Loader.obj: unhandled "'+x+'"')}}}return o(),this.saveMetadata&&(f.metadata=c),f}}),Drag.prototype={active:!1,disabled:!1,start:function(e,t){this.active=!0,this.moves=0,this.begin.x=e,this.begin.y=t,this.origin.x=this.point.x,this.origin.y=this.point.y,this.offset.x=this.delta.x=0,this.offset.y=this.delta.y=0},move:function(e,t){this.active&&(this.moves++,this.delta.x=-this.point.x,this.delta.y=-this.point.y,this.offset.x=(e-this.begin.x)*this.scale.x,this.offset.y=(t-this.begin.y)*this.scale.y,this.point.x=Math.min(this.max.x,Math.max(this.min.x,this.origin.x+this.offset.x)),this.point.y=Math.min(this.max.y,Math.max(this.min.y,this.origin.y+this.offset.y)),this.delta.x+=this.point.x,this.delta.y+=this.point.y)},end:function(){this.active=!1},enable:function(){this.disabled=!1},disable:function(){this.active&&this.end(),this.disabled=!0},bind:function(e,t){t&&t.addEventListener(e,this)},unbind:function(e,t){t&&t.removeEventListener(e,this)},handleEvent:function(e){if(!this.disabled){if(this.mouse.x=0,this.mouse.y=0,e.touches){for(var t=e.touches.length,n=0;n<t;n++){var i=e.touches[n];this.mouse.x+=i.pageX,this.mouse.y+=i.pageY}this.mouse.x/=t,this.mouse.y/=t}else this.mouse.x=e.pageX,this.mouse.y=e.pageY;var o;switch(e.type){case"mousedown":if(1!==e.which)return;this.mouseActive||(this.mouseActive=!0,this.bind("mousemove",window),this.bind("mouseup",window)),this.start(this.mouse.x,this.mouse.y),o="start";break;case"mousemove":if(!this.mouseActive)return;this.move(this.mouse.x,this.mouse.y),o="drag";break;case"mouseup":if(!this.mouseActive)return;this.mouseActive=!1,this.unbind("mousemove",window),this.unbind("mouseup",window),this.end(),o="end";break;case"touchstart":this.touchActive||(this.touchActive=!0,this.bind("touchstart",window),this.bind("touchmove",window),this.bind("touchend",window),this.unbind("touchstart",this.element)),this.start(this.mouse.x,this.mouse.y),o="start";break;case"touchmove":if(!this.touchActive)return;this.move(this.mouse.x,this.mouse.y),o="drag";break;case"touchend":if(!this.touchActive)return;e.touches.length?this.start(this.mouse.x,this.mouse.y):(this.touchActive=!1,this.unbind("touchstart",window),this.unbind("touchmove",window),this.unbind("touchend",window),this.bind("touchstart",this.element),this.end(),o="end")}o&&this.events.emit(o,[this,e]),e.preventDefault()}}},Momentum.prototype={pointsLength:5,friction:Math.pow(.87,.06),threshold:1e-5,time:function(){return window.performance&&window.performance.now?window.performance.now():Date.now?Date.now():(new Date).getTime()},push:function(e,t,n){this.point.x=+e||0,this.point.y=+t||0,this.point.z=+n||0,this.point.t=this.time(),this.points.push({x:this.point.x,y:this.point.y,z:this.point.z,t:this.point.t});var i=this.points.length-this.pointsLength;i>0&&this.points.splice(0,i)},updateSpeed:function(){this.speed0=Math.sqrt(this.speed.x*this.speed.x+this.speed.y*this.speed.y+this.speed.z*this.speed.z)},updateAccel:function(e){this.limit=1/(1-this.friction)},updateTarget:function(){this.target.x=this.point.x+this.speed.x*this.limit,this.target.y=this.point.y+this.speed.y*this.limit,this.target.z=this.point.z+this.speed.z*this.limit},updateDistance:function(){this.delta.x=this.target.x-this.point.x,this.delta.y=this.target.y-this.point.y,this.delta.z=this.target.z-this.point.z,this.distance=Math.sqrt(this.delta.x*this.delta.x+this.delta.y*this.delta.y+this.delta.z*this.delta.z)},updateDuration:function(){this.duration=Math.log(this.threshold/this.speed0)/Math.log(this.friction)},go:function(){if(!(this.points.length<2)){var e=this.points[0],t=this.point.x-e.x,n=this.point.y-e.y,i=this.point.z-e.z,o=this.point.t-e.t;this.speed.x=t/o,this.speed.y=n/o,this.speed.z=i/o,this.updateSpeed(),this.updateAccel(),this.updateTarget(),this.updateDuration(),this.updateDistance(),this.start()}},to:function(e,t,n){this.target.x=+e||0,this.target.y=+t||0,this.target.z=+n||0,this.updateDistance(),this.updateAccel(),this.speed.x=this.delta.x/this.limit,this.speed.y=this.delta.y/this.limit,this.speed.z=this.delta.z/this.limit,this.updateSpeed(),this.updateDuration(),this.start()},tot:function(e,t,n,i){this.duration=+e||0,this.target.x=+t||0,this.target.y=+n||0,this.target.z=+i||0,this.updateDistance(),this.updateAccel();var o=this.duration,s=this.distance;this.speed.x=this.delta.x/this.limit,this.speed.y=this.delta.y/this.limit,this.speed.z=this.delta.z/this.limit,this.updateSpeed(),this.updateDuration(),this.updateTarget(),this.updateDistance();for(var r=0;Math.abs(o-this.duration)/o>1e-4||Math.abs(s-this.distance)/s>1e-4;){this.friction=Math.pow(this.threshold/this.speed0,1/o),this.limit=1/(1-this.friction),this.updateTarget(),this.updateDistance();var a=s/this.distance;if(this.speed.x*=a,this.speed.y*=a,this.speed.z*=a,this.updateSpeed(),this.updateDuration(),++r>10)break}this.updateTarget(),this.updateDistance(),this.start()},update:function(){if(this.ended=!1,this.active){this.timeNow=this.time(),this.timeDelta=Math.round(this.timeNow-this.timeLast),this.timeLast+=this.timeDelta;for(var e=0,t=0;t<this.timeDelta;t++)e+=Math.pow(this.friction,t);this.delta.x=this.speed.x*e,
this.delta.y=this.speed.y*e,this.delta.z=this.speed.z*e,this.point.x+=this.delta.x,this.point.y+=this.delta.y,this.point.z+=this.delta.z;var n=Math.pow(this.friction,this.timeDelta);this.speed.x*=n,this.speed.y*=n,this.speed.z*=n,this.updateSpeed(),this.speed0<this.threshold&&(this.ended=!0,this.stop())}},start:function(){this.updateSpeed(),this.debug&&console.log(this.debug,"start",this.speed0<this.threshold),this.speed0<this.threshold||(this.timeLast=this.time(),this.timeStart=this.timeLast,this.timeEnd=this.timeStart+this.duration,this.active=!0)},stop:function(){this.debug&&console.log(this.debug,"stop",this.active),this.active&&(this.points=[],this.active=!1)}},Block=f.unit({unitName:"Block",etag:"div",ename:"block",visibleMethod:dom.display,cacheSize:!0,x:0,y:0,init:function(e){f.copy(this,e),this.watchAtlas=[],this.watchLocale=[],this.watchEvents=[];for(var t=0;t<this.protochain.length;t++)this.invoke(this.protochain[t],"create");for(var t=0;t<this.protochain.length;t++)this.invoke(this.protochain[t],"createPost")},invoke:function(e,t){if(Object.prototype.hasOwnProperty.call(e,t)&&"function"==typeof e[t])return e[t].call(this)},create:function(){this.events||(this.events=new EventEmitter),this.visible||(this.visible=new Gate(Gate.AND,!this.hidden)),this.element||(this.element=dom.elem(this.etag,null,this.eroot))},createPost:function(){dom.addclass(this.element,this.ename),this.visible.events.on("change",this.visibleMethod,this,this.element),this.text&&dom.text(this.element,this.text),this.title&&this.element.setAttribute("title",this.title),this.elabel&&this.watchLocale.push(Locale.setText(dom.div("block-label",this.element),this.elabel)),this.etext&&this.watchLocale.push(Locale.setText(this.element,this.etext)),this.etitle&&this.watchLocale.push(Locale.setTitle(this.element,this.etitle)),this.eicon&&(dom.addclass(this.element,"eicon"),this.watchAtlas.push(Atlas.set(this.element,this.eicon,"absmid")))},destroy:function(){this.watchAtlas.forEach(Atlas.free),this.watchAtlas=[],this.watchLocale.forEach(Locale.unwatch),this.watchLocale=[],this.watchEvents.forEach(f.func("release")),this.watchEvents=[],dom.remove(this.element)},resize:function(e,t){e|=0,t|=0,this.cacheSize&&this.width===e&&this.height===t||(this.element.style.width=e+"px",this.element.style.height=t+"px",this.width=e,this.height=t,this.onResize())},autoresize:function(){var e=this.element.offsetWidth,t=this.element.offsetHeight;this.cacheSize&&this.width===e&&this.height===t||(this.width=e,this.height=t,this.onResize())},onResize:function(){}}),Block.Toggle=f.unit(Block,{unitName:"Block_Toggle",ename:"toggle",active:!1,reset:!1,disabled:!1,deselect:!0,auto:!0,create:function(){this.watchEvents.push(new EventHandler(this.ontap,this).listen("tap",this.element),new EventHandler(this.onenter,this).listen("mouseenter",this.element),new EventHandler(this.onleave,this).listen("mouseleave",this.element))},createPost:function(){this.update()},ontap:function(){this.auto&&this.toggle(!0)},onenter:function(){this.events.emit("enter",this)},onleave:function(){this.events.emit("leave",this)},toggle:function(e){this.set(!this.active,e)},set:function(e,t,n){return!(!n&&(this.disabled||this.active==e||!this.deselect&&!e))&&(this.reset||(this.active=e,this.update()),t&&(this.events.emit("change",e),this.events.emit(e?"active":"inactive",e)),!0)},update:function(){dom.togclass(this.element,"active",this.active),dom.togclass(this.element,"disabled",this.disabled),dom.togclass(this.element,"hand",!this.disabled&&(this.deselect||!this.active))}}),Block.List=f.unit(Block,{unitName:"Block_List",ename:"list",cname:"list-item",blocks:null,items:null,options:{ename:"list-item",factory:Block},create:function(){this.blocks=[],this.container=this.element},createPost:function(){this.addItemList(this.items)},addItemList:function(e){e&&e.forEach(this.addItem,this)},addItem:function(e){"string"==typeof e&&(e={data:e});var t=f.merge({eroot:this.container},this.options,e);return this.addBlock(new t.factory(t))},addBlock:function(e){return this.blocks.push(e),this.events.emit("block_add",e),e},removeBlock:function(e,t){var n=this.blocks.indexOf(e);return n!==-1&&(this.blocks.splice(n,1),t?e.destroy():dom.remove(e.element),!0)},destroy:function(){Block.prototype.destroy.call(this),this.clearBlocks(!0)},clearBlocks:function(e){for(var t=this.blocks.length-1;t>=0;t--)this.removeBlock(this.blocks[t],e)}}),Block.Menu=f.unit(Block.List,{unitName:"Block_Menu",ename:"menu",active:-1,options:{ename:"menu-item",factory:Block.Toggle},createPost:function(){this.set(this.active)},addBlock:function(e){return e.events.when({change:this.onitemchange,enter:this.onitementer,leave:this.onitemleave},this,e),e.set(0),Block.List.prototype.addBlock.call(this,e)},removeBlock:function(e,t){var n=Block.List.prototype.removeBlock.call(this,e,t);return n&&e.events.off(null,null,this),n},update:function(){for(var e=this.blocks.length-1;e>=0;e--){var t=this.blocks[e];if(t.active)return this.active=e,this.activeBlock=t,void(this.activeItem=t.data)}this.active=-1,this.activeBlock=null,this.activeItem=null},onitemchange:function(e,t){this.unsetBlocks(e),this.update(),this.events.emit("change",[this.activeItem,this.activeBlock,this.active])},onitementer:function(e){this.events.emit("enter",e)},onitemleave:function(e){this.events.emit("leave",e)},set:function(e,t){var n=this.blocks[e];n!==this.activeBlock&&(this.unsetBlocks(n,t),n&&n.set(1,t),this.update())},getIndex:function(e){for(var t=0;t<this.blocks.length;t++){var n=this.blocks[t];if(n.hasOwnProperty("data")&&n.data===e)return t}return-1},setItem:function(e,t){return this.set(this.getIndex(e),t)},unsetBlocks:function(e,t){for(var n=0;n<this.blocks.length;n++){var i=this.blocks[n];i!==e&&i.set(0,t,!0)}}}),Block.Tip=f.unit(Block,{unitName:"Block_Tip",ename:"tip",align:null,tipRoot:null,integerPosition:!1,hidden:!0,distance:8,arrowWidth:12,arrowPadding:8,animationTime:200,tweenDistance:20,create:function(){this.arrow=dom.div("tip-arrow",this.element),this.content=dom.div("tip-content",this.element),this.arrowPoint={x:0,y:0},this.elementPoint={x:0,y:0},this.transitionTween=new TWEEN.Tween({v:+!this.hidden}).easing(TWEEN.Easing.Cubic.Out).to({},this.animationTime).onStart(this.onTransitionStart,this).onUpdate(this.onTransitionUpdate,this).onComplete(this.onTransitionEnd,this)},createPost:function(){this.visible.check(!0)},moveToElement:function(e,t,n){if(e){var i=e.offsetWidth,o=e.offsetHeight,s=dom.offset(e,this.element.offsetParent);null==t&&(t=this.align||this.getAlign(s.x,s.y,i,o));var r=s.x,a=s.y;switch(t){case"left":a+=o/2;break;case"right":r+=i,a+=o/2;break;case"top":r+=i/2;break;case"bottom":r+=i/2,a+=o}this.move(r,a,t,n)}},move:function(e,t,n,i){null==n&&(n=this.align||this.getAlign(e,t,0,0));var o=this.element.offsetParent;if(o){var s,r,a,l,h,c=this.arrowWidth/2,u=this.arrowPadding,d=i||this.distance,p=this.element.offsetWidth,f=this.element.offsetHeight,m=o.offsetWidth,v=o.offsetHeight,g=p/2,b=f/2;switch(n){case"left":s=!1,r=e-p-d,a=t-b,l=p,h=b;break;case"right":s=!1,r=e+d,a=t-b,l=0,h=b;break;case"top":s=!0,r=e-g,a=t-d-f,l=g,h=f;break;case"bottom":s=!0,r=e-g,a=t+d,l=g,h=0;break;default:return}var w=Math.max(0,-r);w&&(s&&(l-=Math.min(g-c-u,w)),r+=w);var y=Math.max(0,r+p-m);y&&(s&&(l+=Math.min(g-c-u,y)),r-=y);var E=Math.max(0,-a);E&&(s||(h-=Math.min(b-c-u,E)),a+=E);var x=Math.max(0,a+f-v);switch(x&&(s||(h+=Math.min(b-c-u,x)),a-=x),n){case"left":d+=y-w;break;case"right":d+=w-y;break;case"top":d+=x-E;break;case"bottom":d+=E-x}this.integerPosition&&(r=Math.round(r),a=Math.round(a),l=Math.round(l),h=Math.round(h),d=Math.round(d)),this.arrowPoint.x===l&&this.arrowPoint.y===h&&Math.abs(this.elementPoint.x-r)<2&&Math.abs(this.elementPoint.y-a)<2&&this.lastDistance===d&&this.lastAlign===n||(this.arrowPoint.x=l,this.arrowPoint.y=h,this.arrow.style.left=l+"px",this.arrow.style.top=h+"px",this.elementPoint.x=r,this.elementPoint.y=a,this.lastDistance=d,this.lastAlign=n,this.updateTransform())}},alignAxes:{left:{x:1,y:0},right:{x:-1,y:0},top:{x:0,y:1},bottom:{x:0,y:-1}},transitionAxis:null,updateTransform:function(){var e=(1-this.transitionTween.source.v)*this.tweenDistance,t=this.elementPoint,n=this.transitionAxis||this.alignAxes[this.lastAlign||this.align]||{x:0,y:0};this.transform(this.element,t.x+e*n.x,t.y+e*n.y)},transform:function(e,t,n,i){var o=" translateX("+f.hround(t||0)+"px) translateY("+f.hround(n||0)+"px)      scale("+f.hround(i||1)+")";e.style.webkitTransform=o,e.style.mozTransform=o,e.style.msTransform=o,e.style.OTransform=o,e.style.transform=o},getAlign:function(e,t,n,i){var o=this.element.offsetParent;if(!o)return null;var s=o.offsetWidth,r=o.offsetHeight,a=this.element.offsetWidth,l=this.element.offsetHeight,h=t,c=s-e-n,u=r-t-i,d=e,p=["top","right","bottom","left"],f=[h-l,c-a,u-l,d-a],m=Math.max.apply(null,f),v=f.indexOf(m);return p[v]},visibleMethod:function(e,t){return this.initVisible?(this.visible.value&&dom.append(this.tipRoot,this.element),this.transitionTween.target.v=+t,void this.transitionTween.start()):(this.initVisible=!0,this.transitionTween.source.v=+t,this.onTransitionUpdate(),void this.onTransitionEnd())},onTransitionStart:function(){this.inTransition=!0},onTransitionUpdate:function(){this.element.style.opacity=this.transitionTween.source.v,this.updateTransform()},onTransitionEnd:function(){this.visible.value||dom.remove(this.element),this.inTransition=!1}}),Atlas={svg:null,list:null,items:[],setSource:function(e){if(e){Atlas.svg=e.documentElement||e,Atlas.svg.removeAttribute("width"),Atlas.svg.removeAttribute("height"),Atlas.list={};for(var t=Atlas.svg.getElementsByTagName("*"),n=0;n<t.length;n++){var i=t[n],o=i.nodeName.toLowerCase();"metadata"===o?i.parentNode&&i.parentNode.removeChild(i):i.id&&(i.removeAttribute("visibility"),Atlas.list[i.id]=i)}Atlas.update()}},update:function(){Atlas.items.forEach(Atlas.updateItem)},set:function(e,t,n){var i=Atlas.pickItem(e);return i.id=t,i.name=n,Atlas.svg&&Atlas.updateItem(i),e},free:function(e){for(var t=Atlas.items.length-1;t>=0;t--){var n=Atlas.items[t];if(!e||n.element===e)return n.element.removeChild(n.icon),void Atlas.items.splice(t,1)}},pickItem:function(e){for(var t=0;t<Atlas.items.length;t++){var n=Atlas.items[t];if(n.element===e)return n}return n={element:e},Atlas.items.push(n),n},updateItem:function(e){var t=Atlas.clone(e.id);t?e.name&&(t.className.baseVal+=" "+e.name):(t=document.createElement("div"),t.className=e.id+" "+e.name,Atlas.svg&&(t.textContent=e.id)),e.icon?(e.element.insertBefore(t,e.icon),e.element.removeChild(e.icon)):e.element.appendChild(t),e.icon=t},clone:function(e){var t=Atlas.list&&Atlas.list[e];if(!t)return null;var n=Atlas.svg.cloneNode(!1);return n.appendChild(t.cloneNode(!0)),n.className.baseVal=e,n}},Locale={name:null,data:null,counter:0,assets:{},items:[],add:function(e,t){var n=Locale.assets[e];n||(n=Locale.assets[e]={});for(var i in t)n[i]=t[i]},get:function(e){return Locale.data&&e in Locale.data?Locale.data[e]:Locale.name+"/"+e},set:function(e){Locale.name=e,Locale.data=Locale.assets[Locale.name],Locale.update()},update:function(){Locale.items.forEach(Locale.updateItem)},updateItem:function(e){e.func.call(e.scope,Locale.get(e.token),e.data)},watch:function(e,t,n,i){var o={id:++Locale.counter,token:e,func:t,scope:n,data:i};return Locale.items.push(o),Locale.updateItem(o),o.id},unwatch:function(e){for(var t=Locale.items.length-1;t>=0;t--)if(Locale.items[t].id===e)return void Locale.items.splice(t,1)},setText:function(e,t){return Locale.watch(t,Locale._setText,null,e)},setTitle:function(e,t){return Locale.watch(t,Locale._setAttribute,null,{element:e,name:"title"})},setAttribute:function(e,t,n){return Locale.watch(n,Locale._setAttribute,null,{element:t,name:e})},setHtml:function(e,t){return Locale.watch(t,Locale._setHtml,null,e)},_setAttribute:function(e,t){t.element.setAttribute(t.name,e)},_setText:function(e,t){dom.text(t,e)},_setHtml:function(e,t){dom.html(t,e)}},THREE.Plane.prototype.intersectPlane=function(e,t){for(var n=1e-9,i=this.normal.toArray(),o=this.constant,s=e.normal.toArray(),r=e.constant,a=0;a<6;a++){var l=a<2?1:0,h=a<4?2:1,c=a>>1,u=a%2?l:h,d=a%2?h:l,p=i[c],f=i[u],m=s[c],v=s[u],g=v*p-f*m,b=(m*o-p*r)/g,w=-(f*b+o)/p;if(Math.abs(p)>n&&Math.abs(g)>n){var y=t||new THREE.Ray;return y.direction.crossVectors(this.normal,e.normal).normalize(),y.origin.setComponent(c,w),y.origin.setComponent(u,b),y.origin.setComponent(d,0),y}}},THREE.Box2.prototype.emptyEPS=function(){var e=1e-9;return this.max.x-this.min.x<e||this.max.y-this.min.y<e},THREE.Ray.prototype.atY=function(e,t){var n=(e-this.origin.y)/this.direction.y;return this.at(n,t)},THREE.Ray.prototype.distanceToPlane=function(e,t){var n=e.normal.dot(this.direction);if(0==n)return 0==e.distanceToPoint(this.origin)?0:null;var i=-(this.origin.dot(e.normal)+e.constant)/n;return t||i>=0?i:null},THREE.Ray.prototype.intersectPlane=function(e,t,n){var i=this.distanceToPlane(e,n);return null===i?null:this.at(i,t)},THREE.Sphere.prototype.expandByPoint=function(e){this.center.sub(e);var t=this.center.length()+this.radius;return this.radius=t/2,this.center.setLength(t),this.center.add(e),this},THREE.Sphere.prototype.union=function(e){this.center.sub(e.center);var t=this.center.length()+this.radius,n=t+e.radius;return this.radius=n/2,this.center.setLength(t),this.center.add(e.center),this.center.lerp(e.center,n/t),this},THREE.OrbitControls=function(e,t){function n(){return 2*Math.PI/60/60*f.autoRotateSpeed}function i(){return Math.pow(.95,f.zoomSpeed)}function o(e){if(f.enabled!==!1){e.preventDefault(),f.down=!0;var t=f.orthoMode?["pan",null,null][e.button]:["rot","dol","pan"][e.button];switch(t){case"rot":if(f.noRotate===!0)return;P=N.ROTATE,v.set(e.clientX,e.clientY);break;case"dol":if(f.noZoom===!0)return;P=N.DOLLY,_.set(e.clientX,e.clientY);break;case"pan":if(f.noPan===!0)return;P=N.PAN,w.set(e.clientX,e.clientY)}document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",r,!1),f.dispatchEvent(O)}}function s(e){if(f.enabled!==!1){e.preventDefault();var t=f.domElement===document?f.domElement.body:f.domElement,n=t.clientWidth,i=t.clientHeight,o=f.object.position,s=o.clone().sub(f.target),r=s.length();if(r*=Math.tan(f.object.fov/2*Math.PI/180),P===N.ROTATE){if(f.orthoMode)return;if(f.noRotate===!0)return;g.set(e.clientX,e.clientY),b.subVectors(g,v),f.rotateLeft(2*Math.PI*b.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*b.y/t.clientHeight*f.rotateSpeed),v.copy(g)}else if(P===N.DOLLY){if(f.orthoMode)return;if(f.noZoom===!0)return;R.set(e.clientX,e.clientY),k.subVectors(R,_),f.panUp(2*k.y*r/i),_.copy(R)}else if(P===N.PAN){if(f.noPan===!0)return;y.set(e.clientX,e.clientY),E.subVectors(y,w);var a=2*E.x*r/n,l=2*E.y*r/i;f.panLeft(a),f.orthoMode?f.panAbove(l):f.panForward(l),w.copy(y)}f.update()}}function r(){f.enabled!==!1&&(f.down=!1,document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",r,!1),f.dispatchEvent(j),P=N.NONE)}function a(e){if(f.enabled!==!1&&f.noZoom!==!0){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.deltaY?t=-e.deltaY:void 0!==e.detail&&(t=-e.detail),t>0?f.dollyOut():f.dollyIn(),f.update(),f.dispatchEvent(O),f.dispatchEvent(j)}}function l(e){if(f.enabled===!1||f.noKeys===!0||f.noPan===!0)return!1;switch(e.keyCode){case f.keys.UP:f.pan(0,f.keyPanSpeed),f.update();break;case f.keys.BOTTOM:f.pan(0,-f.keyPanSpeed),f.update();break;case f.keys.LEFT:f.pan(f.keyPanSpeed,0),f.update();break;case f.keys.RIGHT:f.pan(-f.keyPanSpeed,0),f.update();break;default:return!1}return!0}function h(e){if(f.enabled!==!1){var t=f.orthoMode?["rot","dol","pan"][e.touches.length-1]:["pan",null,null][e.touches.length-1];switch(t){case"rot":if(f.noRotate===!0)return;P=N.TOUCH_ROTATE,v.set(e.touches[0].pageX,e.touches[0].pageY);break;case"dol":if(f.noZoom===!0)return;P=N.TOUCH_DOLLY;var n=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(n*n+i*i);_.set(0,o);break;case"pan":if(f.noPan===!0)return;P=N.TOUCH_PAN,w.set(e.touches[0].pageX,e.touches[0].pageY);break;default:P=N.NONE}f.dispatchEvent(O)}}function c(e){if(f.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=f.domElement===document?f.domElement.body:f.domElement;switch(e.touches.length){case 1:if(f.noRotate===!0)return;if(P!==N.TOUCH_ROTATE)return;g.set(e.touches[0].pageX,e.touches[0].pageY),b.subVectors(g,v),f.rotateLeft(2*Math.PI*b.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*b.y/t.clientHeight*f.rotateSpeed),v.copy(g),f.update();break;case 2:if(f.noZoom===!0)return;if(P!==N.TOUCH_DOLLY)return;var n=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(n*n+i*i);R.set(0,o),C*=_.y/R.y,_.copy(R),f.update();break;case 3:if(f.noPan===!0)return;if(P!==N.TOUCH_PAN)return;y.set(e.touches[0].pageX,e.touches[0].pageY),E.subVectors(y,w),f.pan(E.x,E.y),w.copy(y),f.update();break;default:P=N.NONE}}}function u(){f.enabled!==!1&&(f.dispatchEvent(j),P=N.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=2,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.radiusChanged=!0,this.borderBox=new THREE.Box3;var d=this.borderBox.min,p=this.borderBox.max;d.x=d.y=d.z=-(1/0),p.x=p.y=p.z=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var f=this,m=1e-6,v=new THREE.Vector2,g=new THREE.Vector2,b=new THREE.Vector2,w=new THREE.Vector2,y=new THREE.Vector2,E=new THREE.Vector2,x=new THREE.Vector3,T=new THREE.Vector3,_=new THREE.Vector2,R=new THREE.Vector2,k=new THREE.Vector2,M=0,S=0,C=1,A=new THREE.Vector3,H=new THREE.Vector3,L=new THREE.Quaternion,N={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},P=N.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var I=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),D=I.clone().inverse(),B={type:"change"},O={type:"start"},j={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=n()),S-=e},this.rotateUp=function(e){void 0===e&&(e=n()),M-=e},this.panLeft=function(e){x.setFromMatrixColumn(this.object.matrix,0);var t=x.length();x.y=0,x.setLength(t),x.multiplyScalar(-e),A.add(x)},this.panAbove=function(e){x.setFromMatrixColumn(this.object.matrix,1);var t=x.length();x.setLength(t),x.multiplyScalar(e),A.add(x)},this.panUp=function(e){x.setFromMatrixColumn(this.object.matrix,1);var t=x.length();x.x=x.z=0,x.setLength(t),x.multiplyScalar(e),A.add(x)},this.panForward=function(e){x.setFromMatrixColumn(this.object.matrix,2);var t=x.length();x.y=0,x.setLength(t),x.multiplyScalar(-e),A.add(x)},this.pan=function(e,t){var n=f.domElement===document?f.domElement.body:f.domElement;if(void 0!==f.object.fov){var i=f.object.position,o=i.clone().sub(f.target),s=o.length();s*=Math.tan(f.object.fov/2*Math.PI/180);var r=2*e*s/n.clientHeight,a=2*t*s/n.clientHeight;f.panLeft(r),f.orthoMode?f.panAbove(a):f.panForward(a)}else void 0!==f.object.top?(f.panLeft(e*(f.object.right-f.object.left)/n.clientWidth),f.panUp(t*(f.object.top-f.object.bottom)/n.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=i()),C/=e},this.dollyOut=function(e){void 0===e&&(e=i()),C*=e},this.update=function(){var e=this.object.position;T.copy(e).sub(this.target),T.applyQuaternion(I);var t=Math.atan2(T.x,T.z),i=Math.atan2(Math.sqrt(T.x*T.x+T.z*T.z),T.y);this.autoRotate&&this.rotateLeft(n()),t+=S,i+=M,this.disableBorders||(i=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,i))),i=Math.max(m,Math.min(Math.PI-m,i));var o=T.length()*C;this.disableBorders||(o=Math.max(this.minDistance,Math.min(this.maxDistance,o))),Math.abs(o-this.radius)>m&&(this.radiusChanged=!0),this.radius=o,this.target.add(A),this.disableBorders||this.borderBox.isEmpty()||(this.target.min(this.borderBox.max),this.target.max(this.borderBox.min)),T.x=this.radius*Math.sin(i)*Math.sin(t),T.y=this.radius*Math.cos(i),T.z=this.radius*Math.sin(i)*Math.cos(t),T.applyQuaternion(D),e.copy(this.target).add(T),T.lengthSq()&&this.object.lookAt(this.target),S=0,M=0,C=1,A.set(0,0,0),(H.distanceToSquared(this.object.position)>m||8*(1-L.dot(this.object.quaternion))>m)&&(this.changed=!0,this.dispatchEvent(B),H.copy(this.object.position),L.copy(this.object.quaternion))},this.reset=function(){P=N.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.domElement.addEventListener("contextmenu",function(e){f.enabled!==!1&&e.preventDefault()},!1),this.onKeyDown=l,this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("wheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1),this.domElement.addEventListener("touchstart",h,!1),this.domElement.addEventListener("touchend",u,!1),this.domElement.addEventListener("touchmove",c,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),function(){"use strict";var e=function(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};e.prototype=Object.create(THREE.MeshBasicMaterial.prototype),e.prototype.constructor=e;var t=function(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};t.prototype=Object.create(THREE.LineBasicMaterial.prototype),t.prototype.constructor=t;var n=new e({visible:!1,transparent:!1});THREE.TransformGizmo=function(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new THREE.PlaneBufferGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),n={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};this.activePlane=n.XYZE,n.YZ.rotation.set(0,Math.PI/2,0),n.XZ.rotation.set(-Math.PI/2,0,0);for(var i in n)n[i].name=i,this.planes.add(n[i]),this.planes[i]=n[i];var o=function(e,t){for(var n in e)for(i=e[n].length;i--;){var o=e[n][i][0],s=e[n][i][1],r=e[n][i][2];o.name=n,s&&o.position.set(s[0],s[1],s[2]),r&&o.rotation.set(r[0],r[1],r[2]),t.add(o)}};o(this.handleGizmos,this.handles),o(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof THREE.Mesh){e.updateMatrix();var t=e.geometry.clone();t.applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name===e?t.material.highlight(!0):t.material.highlight(!1))})}},THREE.TransformGizmo.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformGizmo.prototype.constructor=THREE.TransformGizmo,THREE.TransformGizmo.prototype.update=function(e,t){var n=new THREE.Vector3(0,0,0),i=new THREE.Vector3(0,1,0),o=new THREE.Matrix4;this.traverse(function(s){s.name.search("E")!==-1?s.quaternion.setFromRotationMatrix(o.lookAt(t,n,i)):s.name.search("X")===-1&&s.name.search("Y")===-1&&s.name.search("Z")===-1||s.quaternion.setFromEuler(e)})},THREE.TransformGizmoTranslate=function(){THREE.TransformGizmo.call(this);var i=new THREE.Geometry,o=new THREE.Mesh(new THREE.CylinderGeometry(0,.05,.2,12,1,!1));o.position.y=.5,o.updateMatrix(),i.merge(o.geometry,o.matrix);var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(i,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(s,new t({color:16711680}))]],Y:[[new THREE.Mesh(i,new e({color:65280})),[0,.5,0]],[new THREE.Line(r,new t({color:65280}))]],Z:[[new THREE.Mesh(i,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.1,0),new e({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.29,.29),new e({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),n)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,t){var n=new THREE.Matrix4;t.applyMatrix4(n.getInverse(n.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()},THREE.TransformGizmoTranslate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoTranslate.prototype.constructor=THREE.TransformGizmoTranslate,THREE.TransformGizmoRotate=function(){THREE.TransformGizmo.call(this);var e=function(e,t,n){var i=new THREE.BufferGeometry,o=[];n=n?n:1;for(var s=0;s<=64*n;++s)"x"===t&&o.push(0,Math.cos(s/32*Math.PI)*e,Math.sin(s/32*Math.PI)*e),"y"===t&&o.push(Math.cos(s/32*Math.PI)*e,0,Math.sin(s/32*Math.PI)*e),"z"===t&&o.push(Math.sin(s/32*Math.PI)*e,Math.cos(s/32*Math.PI)*e,0);return i.addAttribute("position",new THREE.Float32BufferAttribute(o,3)),i};this.handleGizmos={X:[[new THREE.Line(new e(1,"x",.5),new t({color:16711680}))]],Y:[[new THREE.Line(new e(1,"y",.5),new t({color:65280}))]],Z:[[new THREE.Line(new e(1,"z",.5),new t({color:255}))]],E:[[new THREE.Line(new e(1.25,"z",1),new t({color:13421568}))]],XYZE:[[new THREE.Line(new e(1,"z",1),new t({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.12,4,12,Math.PI),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.12,2,24),n)]],XYZE:[[new THREE.Mesh]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){THREE.TransformGizmo.prototype.update.apply(this,arguments);var n=new THREE.Matrix4,i=new THREE.Euler(0,0,1),o=new THREE.Quaternion,s=new THREE.Vector3(1,0,0),r=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,h=new THREE.Quaternion,c=new THREE.Quaternion,u=t.clone();i.copy(this.planes.XY.rotation),o.setFromEuler(i),n.makeRotationFromQuaternion(o).getInverse(n),u.applyMatrix4(n),this.traverse(function(e){o.setFromEuler(i),"X"===e.name&&(l.setFromAxisAngle(s,Math.atan2(-u.y,u.z)),o.multiplyQuaternions(o,l),e.quaternion.copy(o)),"Y"===e.name&&(h.setFromAxisAngle(r,Math.atan2(u.x,u.z)),o.multiplyQuaternions(o,h),e.quaternion.copy(o)),"Z"===e.name&&(c.setFromAxisAngle(a,Math.atan2(u.y,u.x)),o.multiplyQuaternions(o,c),e.quaternion.copy(o))})},this.init()},THREE.TransformGizmoRotate.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoRotate.prototype.constructor=THREE.TransformGizmoRotate,THREE.TransformGizmoScale=function(){THREE.TransformGizmo.call(this);var i=new THREE.Geometry,o=new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125));o.position.y=.5,o.updateMatrix(),i.merge(o.geometry,o.matrix);var s=new THREE.BufferGeometry;s.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var r=new THREE.BufferGeometry;r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3));var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(i,new e({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(s,new t({color:16711680}))]],Y:[[new THREE.Mesh(i,new e({color:65280})),[0,.5,0]],[new THREE.Line(r,new t({color:65280}))]],Z:[[new THREE.Mesh(i,new e({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(a,new t({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),new e({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.4,.4,.4),n)]]},this.setActivePlane=function(e,t){var n=new THREE.Matrix4;t.applyMatrix4(n.getInverse(n.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()},THREE.TransformGizmoScale.prototype=Object.create(THREE.TransformGizmo.prototype),THREE.TransformGizmoScale.prototype.constructor=THREE.TransformGizmoScale,THREE.TransformControls=function(e,t){function n(e){if(void 0!==a.object&&h!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e,n=r(t,c[l].pickers.children),i=null;n&&(i=n.object.name,e.preventDefault()),a.axis!==i&&(a.axis=i,a.update(),a.dispatchEvent(p))}}function i(e){if(void 0!==a.object&&h!==!0&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var n=r(t,c[l].pickers.children);if(n){e.preventDefault(),e.stopPropagation(),a.dispatchEvent(f),a.axis=n.object.name,a.update(),R.copy(G).sub(V).normalize(),c[l].setActivePlane(a.axis,R);var i=r(t,[c[l].activePlane]);i&&(B.copy(a.object.position),O.copy(a.object.scale),j.extractRotation(a.object.matrix),X.extractRotation(a.object.matrixWorld),F.extractRotation(a.object.parent.matrixWorld),z.setFromMatrixScale(k.getInverse(a.object.parent.matrixWorld)),y.copy(i.point))}}h=!0}}function o(e){if(void 0!==a.object&&null!==a.axis&&h!==!1&&(void 0===e.button||0===e.button)){
var t=e.changedTouches?e.changedTouches[0]:e,n=r(t,[c[l].activePlane]);n!==!1&&(e.preventDefault(),e.stopPropagation(),w.copy(n.point),"translate"===l?(w.sub(y),w.multiply(z),"local"===a.space&&(w.applyMatrix4(k.getInverse(X)),a.axis.search("X")===-1&&(w.x=0),a.axis.search("Y")===-1&&(w.y=0),a.axis.search("Z")===-1&&(w.z=0),w.applyMatrix4(j),a.object.position.copy(B),a.object.position.add(w)),"world"!==a.space&&a.axis.search("XYZ")===-1||(a.axis.search("X")===-1&&(w.x=0),a.axis.search("Y")===-1&&(w.y=0),a.axis.search("Z")===-1&&(w.z=0),w.applyMatrix4(k.getInverse(F)),a.object.position.copy(B),a.object.position.add(w)),null!==a.translationSnap&&("local"===a.space&&a.object.position.applyMatrix4(k.getInverse(X)),a.axis.search("X")!==-1&&(a.object.position.x=Math.round(a.object.position.x/a.translationSnap)*a.translationSnap),a.axis.search("Y")!==-1&&(a.object.position.y=Math.round(a.object.position.y/a.translationSnap)*a.translationSnap),a.axis.search("Z")!==-1&&(a.object.position.z=Math.round(a.object.position.z/a.translationSnap)*a.translationSnap),"local"===a.space&&a.object.position.applyMatrix4(X))):"scale"===l?(w.sub(y),w.multiply(z),"local"===a.space&&("XYZ"===a.axis?(T=1+w.y/Math.max(O.x,O.y,O.z),a.object.scale.x=O.x*T,a.object.scale.y=O.y*T,a.object.scale.z=O.z*T):(w.applyMatrix4(k.getInverse(X)),"X"===a.axis&&(a.object.scale.x=O.x*(1+w.x/O.x)),"Y"===a.axis&&(a.object.scale.y=O.y*(1+w.y/O.y)),"Z"===a.axis&&(a.object.scale.z=O.z*(1+w.z/O.z))))):"rotate"===l&&(w.sub(V),w.multiply(z),M.copy(y).sub(V),M.multiply(z),"E"===a.axis?(w.applyMatrix4(k.getInverse(_)),M.applyMatrix4(k.getInverse(_)),E.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),x.set(Math.atan2(M.z,M.y),Math.atan2(M.x,M.z),Math.atan2(M.y,M.x)),S.setFromRotationMatrix(k.getInverse(F)),D.setFromAxisAngle(R,E.z-x.z),L.setFromRotationMatrix(X),S.multiplyQuaternions(S,D),S.multiplyQuaternions(S,L),a.object.quaternion.copy(S)):"XYZE"===a.axis?(D.setFromEuler(w.clone().cross(M).normalize()),S.setFromRotationMatrix(k.getInverse(F)),N.setFromAxisAngle(D,-w.clone().angleTo(M)),L.setFromRotationMatrix(X),S.multiplyQuaternions(S,N),S.multiplyQuaternions(S,L),a.object.quaternion.copy(S)):"local"===a.space?(w.applyMatrix4(k.getInverse(X)),M.applyMatrix4(k.getInverse(X)),E.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),x.set(Math.atan2(M.z,M.y),Math.atan2(M.x,M.z),Math.atan2(M.y,M.x)),L.setFromRotationMatrix(j),null!==a.rotationSnap?(N.setFromAxisAngle(C,Math.round((E.x-x.x)/a.rotationSnap)*a.rotationSnap),P.setFromAxisAngle(A,Math.round((E.y-x.y)/a.rotationSnap)*a.rotationSnap),I.setFromAxisAngle(H,Math.round((E.z-x.z)/a.rotationSnap)*a.rotationSnap)):(N.setFromAxisAngle(C,E.x-x.x),P.setFromAxisAngle(A,E.y-x.y),I.setFromAxisAngle(H,E.z-x.z)),"X"===a.axis&&L.multiplyQuaternions(L,N),"Y"===a.axis&&L.multiplyQuaternions(L,P),"Z"===a.axis&&L.multiplyQuaternions(L,I),a.object.quaternion.copy(L)):"world"===a.space&&(E.set(Math.atan2(w.z,w.y),Math.atan2(w.x,w.z),Math.atan2(w.y,w.x)),x.set(Math.atan2(M.z,M.y),Math.atan2(M.x,M.z),Math.atan2(M.y,M.x)),S.setFromRotationMatrix(k.getInverse(F)),null!==a.rotationSnap?(N.setFromAxisAngle(C,Math.round((E.x-x.x)/a.rotationSnap)*a.rotationSnap),P.setFromAxisAngle(A,Math.round((E.y-x.y)/a.rotationSnap)*a.rotationSnap),I.setFromAxisAngle(H,Math.round((E.z-x.z)/a.rotationSnap)*a.rotationSnap)):(N.setFromAxisAngle(C,E.x-x.x),P.setFromAxisAngle(A,E.y-x.y),I.setFromAxisAngle(H,E.z-x.z)),L.setFromRotationMatrix(X),"X"===a.axis&&S.multiplyQuaternions(S,N),"Y"===a.axis&&S.multiplyQuaternions(S,P),"Z"===a.axis&&S.multiplyQuaternions(S,I),S.multiplyQuaternions(S,L),a.object.quaternion.copy(S))),a.update(),a.dispatchEvent(p),a.dispatchEvent(v))}}function s(e){e.preventDefault(),void 0!==e.button&&0!==e.button||(h&&null!==a.axis&&(m.mode=l,a.dispatchEvent(m)),h=!1,"TouchEvent"in window&&e instanceof TouchEvent?(a.axis=null,a.update(),a.dispatchEvent(p)):n(e))}function r(n,i){var o=t.getBoundingClientRect(),s=(n.clientX-o.left)/o.width,r=(n.clientY-o.top)/o.height;b.set(2*s-1,-(2*r)+1),g.setFromCamera(b,e);var a=g.intersectObjects(i,!0);return!!a[0]&&a[0]}THREE.Object3D.call(this),t=void 0!==t?t:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null;var a=this,l="translate",h=!1,c={translate:new THREE.TransformGizmoTranslate,rotate:new THREE.TransformGizmoRotate,scale:new THREE.TransformGizmoScale};for(var u in c){var d=c[u];d.visible=u===l,this.add(d)}var p={type:"change"},f={type:"mouseDown"},m={type:"mouseUp",mode:l},v={type:"objectChange"},g=new THREE.Raycaster,b=new THREE.Vector2,w=new THREE.Vector3,y=new THREE.Vector3,E=new THREE.Vector3,x=new THREE.Vector3,T=1,_=new THREE.Matrix4,R=new THREE.Vector3,k=new THREE.Matrix4,M=new THREE.Vector3,S=new THREE.Quaternion,C=new THREE.Vector3(1,0,0),A=new THREE.Vector3(0,1,0),H=new THREE.Vector3(0,0,1),L=new THREE.Quaternion,N=new THREE.Quaternion,P=new THREE.Quaternion,I=new THREE.Quaternion,D=new THREE.Quaternion,B=new THREE.Vector3,O=new THREE.Vector3,j=new THREE.Matrix4,F=new THREE.Matrix4,z=new THREE.Vector3,V=new THREE.Vector3,U=new THREE.Euler,X=new THREE.Matrix4,G=new THREE.Vector3,W=new THREE.Euler;t.addEventListener("mousedown",i,!1),t.addEventListener("touchstart",i,!1),t.addEventListener("mousemove",n,!1),t.addEventListener("touchmove",n,!1),t.addEventListener("mousemove",o,!1),t.addEventListener("touchmove",o,!1),t.addEventListener("mouseup",s,!1),t.addEventListener("mouseout",s,!1),t.addEventListener("touchend",s,!1),t.addEventListener("touchcancel",s,!1),t.addEventListener("touchleave",s,!1),this.dispose=function(){t.removeEventListener("mousedown",i),t.removeEventListener("touchstart",i),t.removeEventListener("mousemove",n),t.removeEventListener("touchmove",n),t.removeEventListener("mousemove",o),t.removeEventListener("touchmove",o),t.removeEventListener("mouseup",s),t.removeEventListener("mouseout",s),t.removeEventListener("touchend",s),t.removeEventListener("touchcancel",s),t.removeEventListener("touchleave",s)},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return l},this.setMode=function(e){l=e?e:l,"scale"===l&&(a.space="local");for(var t in c)c[t].visible=t===l;this.update(),a.dispatchEvent(p)},this.setTranslationSnap=function(e){a.translationSnap=e},this.setRotationSnap=function(e){a.rotationSnap=e},this.setSize=function(e){a.size=e,this.update(),a.dispatchEvent(p)},this.setSpace=function(e){a.space=e,this.update(),a.dispatchEvent(p)},this.update=function(){void 0!==a.object&&(a.object.updateMatrixWorld(),V.setFromMatrixPosition(a.object.matrixWorld),U.setFromRotationMatrix(k.extractRotation(a.object.matrixWorld)),e.updateMatrixWorld(),G.setFromMatrixPosition(e.matrixWorld),W.setFromRotationMatrix(k.extractRotation(e.matrixWorld)),T=V.distanceTo(G)/6*a.size,this.position.copy(V),this.scale.set(T,T,T),e instanceof THREE.PerspectiveCamera?R.copy(G).sub(V).normalize():e instanceof THREE.OrthographicCamera&&R.copy(G).normalize(),"local"===a.space?c[l].update(U,R):"world"===a.space&&c[l].update(new THREE.Euler,R),c[l].highlight(a.axis))}},THREE.TransformControls.prototype=Object.create(THREE.Object3D.prototype),THREE.TransformControls.prototype.constructor=THREE.TransformControls}(),function(){function e(e){var t=new Map;if("Connections"in e)for(var n=e.Connections.properties.connections,i=0,o=n.length;i<o;++i){var s=n[i];t.has(s[0])||t.set(s[0],{parents:[],children:[]});var r={ID:s[1],relationship:s[2]};t.get(s[0]).parents.push(r),t.has(s[1])||t.set(s[1],{parents:[],children:[]});var a={ID:s[0],relationship:s[2]};t.get(s[1]).children.push(a)}return t}function t(e){var t=new Map;if("Video"in e.Objects.subNodes){var i=e.Objects.subNodes.Video;for(var o in i){var s=i[o];if("Content"in s.properties){var r=n(i[o]);t.set(parseInt(o),r)}}}return t}function n(e){var t,n=e.properties.Content,i=new Uint8Array(n),o=e.properties.RelativeFilename||e.properties.Filename,s=o.slice(o.lastIndexOf(".")+1).toLowerCase();switch(s){case"bmp":t="image/bmp";break;case"jpg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;default:return void console.warn("FBXLoader: No support image type "+s)}return window.URL.createObjectURL(new Blob([i],{type:t}))}function i(e,t,n,i){var s=new Map;if("Texture"in e.Objects.subNodes){var r=e.Objects.subNodes.Texture;for(var a in r){var l=o(r[a],t,n,i);s.set(parseInt(a),l)}}return s}function o(e,t,n,i){var o,s=e.id,r=e.name,a=e.properties.FileName,l=e.properties.RelativeFilename,h=i.get(s).children;if(void 0!==h&&h.length>0&&n.has(h[0].ID))o=n.get(h[0].ID);else if(void 0!==l&&"/"!==l[0]&&null===l.match(/^[a-zA-Z]:/))o=l;else{var c=a.split(/[\\\/]/);o=c.length>0?c[c.length-1]:a}var u=t.path;0===o.indexOf("blob:")&&t.setPath(void 0);var d=t.load(o);d.name=r,d.FBX_ID=s;var p=e.properties.Scaling;p&&(d.repeat.x=p.value[0],d.repeat.y=p.value[1]);var f=e.properties.WrapModeU,m=e.properties.WrapModeV,v=void 0!==f?f.value:0,g=void 0!==m?m.value:0;return d.wrapS=0===v?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,d.wrapT=0===g?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,t.setPath(u),d}function s(e,t,n){var i=new Map;if("Material"in e.Objects.subNodes){var o=e.Objects.subNodes.Material;for(var s in o){var a=r(o[s],t,n);i.set(parseInt(s),a)}}return i}function r(e,t,n){var i=e.id,o=e.attrName,s=e.properties.ShadingModel;"object"==typeof s&&(s=s.value);var r,l=n.get(i).children,h=a(e.properties,t,l);switch(s.toLowerCase()){case"unknown":case"phong":r=new THREE.MeshPhongMaterial;break;case"lambert":r=new THREE.MeshLambertMaterial;break;default:console.warn("No implementation given for material type "+s+" in FBXLoader.js.  Defaulting to basic material"),r=new THREE.MeshBasicMaterial({color:3342591})}return r.setValues(h),r.name=o,r}function a(e,t,n){var i={},o=e.Diffuse||e.DiffuseColor;o&&(i.color=Y(o));var s=e.Specular||e.SpecularColor;s&&(i.specular=Y(s)),e.Shininess&&(i.shininess=e.Shininess.value);var r=e.Emissive||e.EmissiveColor;r&&(i.emissive=Y(r)),e.EmissiveFactor&&(i.emissiveIntensity=e.EmissiveFactor.value),e.Opacity&&(i.opacity=e.Opacity.value),i.opacity<1&&(i.transparent=!0);for(var a=0,l=n.length;a<l;++a){var h=n[a],c=h.relationship;switch(c){case"DiffuseColor":case' "DiffuseColor':case"3dsMax|maps|texmap_diffuse":case' "3dsMax|maps|texmap_diffuse':i.map=t.get(h.ID);break;case"Bump":case' "Bump':case"3dsMax|maps|texmap_bump":case' "3dsMax|maps|texmap_bump':i.bumpMap=t.get(h.ID);break;case"NormalMap":case' "NormalMap':i.normalMap=t.get(h.ID);break;case' "AmbientColor':case' "EmissiveColor':case"AmbientColor":case"EmissiveColor":default:console.warn("Unknown texture application of type "+c+", skipping texture")}}return i}function l(e,t){var n={};if("Deformer"in e.Objects.subNodes){var i=e.Objects.subNodes.Deformer;for(var o in i){var s=i[o];if("Skin"===s.attrType){var r=t.get(parseInt(o)),a=h(r,i);a.FBX_ID=parseInt(o),n[o]=a}}}return n}function h(e,t){for(var n={},i=e.children,o=0,s=i.length;o<s;++o){var r=i[o],a=t[r.ID],l={FBX_ID:r.ID,index:o,indices:[],weights:[],transform:Z(a.subNodes.Transform.properties.a),transformLink:Z(a.subNodes.TransformLink.properties.a),linkMode:a.properties.Mode};"Indexes"in a.subNodes&&(l.indices=G(a.subNodes.Indexes.properties.a),l.weights=X(a.subNodes.Weights.properties.a)),n[r.ID]=l}return{map:n,bones:[]}}function c(e,t,n){var i=new Map;if("Geometry"in e.Objects.subNodes){var o=e.Objects.subNodes.Geometry;for(var s in o){var r=t.get(parseInt(s)),a=u(o[s],r,n);i.set(parseInt(s),a)}}return i}function u(e,t,n){switch(e.attrType){case"Mesh":return d(e,t,n);case"NurbsCurve":return w(e)}}function d(e,t,n){for(var i=0;i<t.children.length;++i){var o=n[t.children[i].ID];if(void 0!==o)break}return p(e,o)}function p(e,t){var n=new I,i=e.subNodes,o=X(i.Vertices.properties.a),s=G(i.PolygonVertexIndex.properties.a);if(i.LayerElementNormal)var r=f(i.LayerElementNormal[0]);if(i.LayerElementUV)var a=m(i.LayerElementUV[0]);if(i.LayerElementColor)var l=v(i.LayerElementColor[0]);if(i.LayerElementMaterial)var h=g(i.LayerElementMaterial[0]);for(var c=[],u=0,d=0;d<s.length;d++){var p=s[d],w=!1;p<0&&(p^=-1,s[d]=p,w=!0);var y=new L,E=[],x=[];if(y.position.fromArray(o,3*p),t){var T=t.map;for(var _ in T)for(var R=T[_],k=R.indices,M=0;M<k.length;M++){var S=k[M];if(S===p){x.push(R.weights[M]),E.push(R.index);break}}if(x.length>4){console.warn("FBXLoader: Vertex has more than 4 skinning weights assigned to vertex.  Deleting additional weights.");var C=[0,0,0,0],A=[0,0,0,0];x.forEach(function(e,t){var n=e,i=E[t];A.forEach(function(e,t,o){if(n>e){o[t]=n,n=e;var s=C[t];C[t]=i,i=s}})}),E=C,x=A}for(var H=x.length;H<4;++H)x[H]=0,E[H]=0;y.skinWeights.fromArray(x),y.skinIndices.fromArray(E)}if(r&&y.normal.fromArray(b(d,u,p,r)),a&&y.uv.fromArray(b(d,u,p,a)),l&&y.color.fromArray(b(d,u,p,l)),c.push(y),w){var N=new P;if(N.genTrianglesFromVertices(c),void 0!==h){var D=b(d,u,p,h);N.materialIndex=D[0]}else N.materialIndex=0;n.faces.push(N),c=[],u++,w=!1}}var B=n.flattenToBuffers(),O=new THREE.BufferGeometry;O.name=e.name,O.addAttribute("position",new THREE.Float32BufferAttribute(B.vertexBuffer,3)),B.normalBuffer.length>0&&O.addAttribute("normal",new THREE.Float32BufferAttribute(B.normalBuffer,3)),B.uvBuffer.length>0&&O.addAttribute("uv",new THREE.Float32BufferAttribute(B.uvBuffer,2)),i.LayerElementColor&&O.addAttribute("color",new THREE.Float32BufferAttribute(B.colorBuffer,3)),t&&(O.addAttribute("skinIndex",new THREE.Float32BufferAttribute(B.skinIndexBuffer,4)),O.addAttribute("skinWeight",new THREE.Float32BufferAttribute(B.skinWeightBuffer,4)),O.FBX_Deformer=t);for(var j=B.materialIndexBuffer,F=j[0],z=0,H=0;H<j.length;++H)j[H]!==F&&(O.addGroup(z,H-z,F),F=j[H],z=H);return O}function f(e){var t=e.properties.MappingInformationType,n=e.properties.ReferenceInformationType,i=X(e.subNodes.Normals.properties.a),o=[];return"IndexToDirect"===n&&("NormalIndex"in e.subNodes?o=G(e.subNodes.NormalIndex.properties.a):"NormalsIndex"in e.subNodes&&(o=G(e.subNodes.NormalsIndex.properties.a))),{dataSize:3,buffer:i,indices:o,mappingType:t,referenceType:n}}function m(e){var t=e.properties.MappingInformationType,n=e.properties.ReferenceInformationType,i=X(e.subNodes.UV.properties.a),o=[];return"IndexToDirect"===n&&(o=G(e.subNodes.UVIndex.properties.a)),{dataSize:2,buffer:i,indices:o,mappingType:t,referenceType:n}}function v(e){var t=e.properties.MappingInformationType,n=e.properties.ReferenceInformationType,i=X(e.subNodes.Colors.properties.a),o=[];return"IndexToDirect"===n&&(o=X(e.subNodes.ColorIndex.properties.a)),{dataSize:4,buffer:i,indices:o,mappingType:t,referenceType:n}}function g(e){var t=e.properties.MappingInformationType,n=e.properties.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};for(var i=G(e.subNodes.Materials.properties.a),o=[],s=0,r=i.length;s<r;++s)o.push(s);return{dataSize:1,buffer:i,indices:o,mappingType:t,referenceType:n}}function b(e,t,n,i){return te[i.mappingType][i.referenceType](e,t,n,i)}function w(e){if(void 0===THREE.NURBSCurve)return console.error("THREE.FBXLoader relies on THREE.NURBSCurve for any nurbs present in the model.  Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var t=parseInt(e.properties.Order);if(isNaN(t))return console.error("FBXLoader: Invalid Order "+e.properties.Order+" given for geometry ID: "+e.id),new THREE.BufferGeometry;for(var n=t-1,i=X(e.subNodes.KnotVector.properties.a),o=[],s=X(e.subNodes.Points.properties.a),r=0,a=s.length;r<a;r+=4)o.push((new THREE.Vector4).fromArray(s,r));var l,h;if("Closed"===e.properties.Form)o.push(o[0]);else if("Periodic"===e.properties.Form){l=n,h=i.length-1-l;for(var r=0;r<n;++r)o.push(o[r])}for(var c=new THREE.NURBSCurve(n,i,o,l,h),u=c.getPoints(7*o.length),d=new Float32Array(3*u.length),r=0,a=u.length;r<a;++r)u[r].toArray(d,3*r);var p=new THREE.BufferGeometry;return p.addAttribute("position",new THREE.BufferAttribute(d,3)),p}function y(e,t,n,i,o){var s=new THREE.Group,r=e.Objects.subNodes.Model,a=[],l=new Map;for(var h in r){for(var c=parseInt(h),u=r[h],d=t.get(c),p=null,f=0;f<d.parents.length;++f)for(var m in n){var v=n[m],g=v.map,b=g[d.parents[f].ID];if(b){var w=p;p=new THREE.Bone,v.bones[b.index]=p,null!==w&&p.add(w)}}if(!p)switch(u.attrType){case"Mesh":for(var y=null,x=null,T=[],_=0,R=d.children.length;_<R;++_){var k=d.children[_];i.has(k.ID)&&(y=i.get(k.ID)),o.has(k.ID)&&T.push(o.get(k.ID))}if(T.length>1?x=T:T.length>0?x=T[0]:(x=new THREE.MeshBasicMaterial({color:3342591}),T.push(x)),"color"in y.attributes)for(var S=0,C=T.length;S<C;++S)T[S].vertexColors=THREE.VertexColors;if(y.FBX_Deformer){for(var A=0,H=T.length;A<H;++A)T[A].skinning=!0;p=new THREE.SkinnedMesh(y,x)}else p=new THREE.Mesh(y,x);break;case"NurbsCurve":for(var y=null,_=0,R=d.children.length;_<R;++_){var k=d.children[_];i.has(k.ID)&&(y=i.get(k.ID))}x=new THREE.LineBasicMaterial({color:3342591,linewidth:5}),p=new THREE.Line(y,x);break;default:p=new THREE.Object3D}p.name=u.attrName.replace(/:/,"").replace(/_/,"").replace(/-/,""),p.FBX_ID=c,a.push(p),l.set(c,p)}for(var L=0,N=a.length;L<N;++L){var p=a[L],u=r[p.FBX_ID];if("Lcl_Translation"in u.properties&&p.position.fromArray(X(u.properties.Lcl_Translation.value)),"Lcl_Rotation"in u.properties){var P=X(u.properties.Lcl_Rotation.value).map(K);P.push("ZYX"),p.rotation.fromArray(P)}if("Lcl_Scaling"in u.properties&&p.scale.fromArray(X(u.properties.Lcl_Scaling.value)),"PreRotation"in u.properties){var I=(new THREE.Euler).setFromVector3(W(u.properties.PreRotation).multiplyScalar(se),"ZYX");I=(new THREE.Quaternion).setFromEuler(I);var D=(new THREE.Quaternion).setFromEuler(p.rotation);I.multiply(D),p.rotation.setFromQuaternion(I,"ZYX")}for(var d=t.get(p.FBX_ID),B=0;B<d.parents.length;B++){var O=Q(a,function(e){return e.FBX_ID===d.parents[B].ID});if(O>-1){a[O].add(p);break}}null===p.parent&&s.add(p)}s.updateMatrixWorld(!0);var j=e.Objects.subNodes.Pose;for(var h in j)if("BindPose"===j[h].attrType){j=j[h];break}if(j)for(var F=j.subNodes.PoseNode,z=new Map,V=0,U=F.length;V<U;++V){var u=F[V],G=Z(u.subNodes.Matrix.properties.a);z.set(parseInt(u.id),G)}for(var m in n){var v=n[m],g=v.map;for(var Y in g){var b=g[Y],q=b.index,J=v.bones[q];if(!z.has(J.FBX_ID))break;var $=z.get(J.FBX_ID);J.matrixWorld.copy($)}v.skeleton=new THREE.Skeleton(v.bones);for(var d=t.get(v.FBX_ID),ee=d.parents,te=0,ne=ee.length;te<ne;++te){var ie=ee[te];if(i.has(ie.ID))for(var oe=ie.ID,re=t.get(oe),f=0;f<re.parents.length;++f)if(l.has(re.parents[f].ID)){var p=l.get(re.parents[f].ID);p.bind(v.skeleton,p.matrixWorld);break}}}s.updateMatrixWorld(!0),s.skeleton={bones:a};var ae=E(e,t,s);return M(s,ae),s}function E(e,t,n){var i=e.Objects.subNodes.AnimationCurveNode,o=e.Objects.subNodes.AnimationCurve,s=e.Objects.subNodes.AnimationLayer,r=e.Objects.subNodes.AnimationStack,a={curves:new Map,layers:{},stacks:{},length:0,fps:30,frames:0},l=[];for(var h in i)if(h.match(/\d+/)){var c=x(e,i[h],t,n);l.push(c)}for(var u=new Map,d=0;d<l.length;++d)null!==l[d]&&u.set(l[d].id,l[d]);var p=[];for(h in o)if(h.match(/\d+/)){var f=T(o[h]);if(!t.has(f.id))continue;p.push(f);var m=t.get(f.id).parents[0],v=m.ID,g=m.relationship,b="";if(g.match(/X/))b="x";else if(g.match(/Y/))b="y";else{if(!g.match(/Z/))continue;b="z"}u.get(v).curves[b]=f}u.forEach(function(e){var t=e.containerBoneID;if(a.curves.has(t)||a.curves.set(t,{T:null,R:null,S:null}),a.curves.get(t)[e.attr]=e,"R"===e.attr){var n=e.curves;if(n.x.values=n.x.values.map(K),n.y.values=n.y.values.map(K),n.z.values=n.z.values.map(K),null!==e.preRotations){var i=(new THREE.Euler).setFromVector3(e.preRotations,"ZYX");i=(new THREE.Quaternion).setFromEuler(i);for(var o=new THREE.Euler,s=new THREE.Quaternion,r=0;r<n.x.times.length;++r)o.set(n.x.values[r],n.y.values[r],n.z.values[r],"ZYX"),s.setFromEuler(o).premultiply(i),o.setFromQuaternion(s,"ZYX"),n.x.values[r]=o.x,n.y.values[r]=o.y,n.z.values[r]=o.z}}});for(var h in s){for(var w=[],y=t.get(parseInt(h)).children,E=0;E<y.length;E++)if(u.has(y[E].ID)){var R=u.get(y[E].ID),k=R.containerBoneID;void 0===w[k]&&(w[k]={T:null,R:null,S:null}),w[k][R.attr]=R}a.layers[h]=w}for(var h in r){for(var M=[],y=t.get(parseInt(h)).children,S={max:0,min:Number.MAX_VALUE},E=0;E<y.length;++E){var C=a.layers[y[E].ID];if(void 0!==C){M.push(C);for(var A=0,H=C.length;A<H;++A){var w=C[A];w&&_(w,S)}}}S.max>S.min&&(a.stacks[h]={name:r[h].attrName,layers:M,length:S.max-S.min,frames:30*(S.max-S.min)})}return a}function x(e,t,n,i){var o=e.Objects.subNodes.Model,s={id:t.id,attr:t.attrName,internalID:t.id,attrX:!1,attrY:!1,attrZ:!1,containerBoneID:-1,containerID:-1,curves:{x:null,y:null,z:null},preRotations:null};if(!s.attr.match(/S|R|T/))return null;for(var r in t.properties)r.match(/X/)&&(s.attrX=!0),r.match(/Y/)&&(s.attrY=!0),r.match(/Z/)&&(s.attrZ=!0);for(var a=n.get(s.id),l=a.parents,h=l.length-1;h>=0;--h){var c=Q(i.skeleton.bones,function(e){return e.FBX_ID===l[h].ID});if(c>-1){s.containerBoneID=c,s.containerID=l[h].ID;var u=o[s.containerID.toString()];"PreRotation"in u.properties&&(s.preRotations=W(u.properties.PreRotation).multiplyScalar(Math.PI/180));break}}return s}function T(e){return{version:null,id:e.id,internalID:e.id,times:X(e.subNodes.KeyTime.properties.a).map(U),values:X(e.subNodes.KeyValueFloat.properties.a),attrFlag:G(e.subNodes.KeyAttrFlags.properties.a),attrData:X(e.subNodes.KeyAttrDataFloat.properties.a)}}function _(e,t){e.R&&R(e.R.curves,t),e.S&&R(e.S.curves,t),e.T&&R(e.T.curves,t)}function R(e,t){e.x&&k(e.x,t),e.y&&k(e.y,t),e.z&&k(e.z,t)}function k(e,t){t.max=e.times[e.times.length-1]>t.max?e.times[e.times.length-1]:t.max,t.min=e.times[0]<t.min?e.times[0]:t.min}function M(e,t){void 0===e.animations&&(e.animations=[]);var n=t.stacks;for(var i in n){for(var o=n[i],s={name:o.name,fps:30,length:o.length,hierarchy:[]},r=e.skeleton.bones,a=0,l=r.length;a<l;++a){var h=r[a],c=h.name.replace(/.*:/,""),u=Q(r,function(e){return h.parent===e});s.hierarchy.push({parent:u,name:c,keys:[]})}for(var d=0;d<=o.frames;d++)for(var a=0,l=r.length;a<l;++a)for(var h=r[a],p=a,f=o.layers[0][p],m=0,v=s.hierarchy.length;m<v;++m){var g=s.hierarchy[m];g.name===h.name&&g.keys.push(S(t,f,h,d))}e.animations.push(THREE.AnimationClip.parseAnimation(s,r))}}function S(e,t,n,i){var o={time:i/e.fps,pos:n.position.toArray(),rot:n.quaternion.toArray(),scl:n.scale.toArray()};if(void 0===t)return o;try{if(C(t,"T")&&A(t.T,i)&&(o.pos=[t.T.curves.x.values[i],t.T.curves.y.values[i],t.T.curves.z.values[i]]),C(t,"R")&&A(t.R,i)){var s=t.R.curves.x.values[i],r=t.R.curves.y.values[i],a=t.R.curves.z.values[i];ie.setFromEuler(ne.set(s,r,a,"ZYX")),o.rot=ie.toArray()}C(t,"S")&&A(t.S,i)&&(o.scl=[t.S.curves.x.values[i],t.S.curves.y.values[i],t.S.curves.z.values[i]])}catch(e){console.log(n),console.log(e)}return o}function C(e,t){if(void 0===e)return!1;var n=e[t];return!!n&&oe.every(function(e){return null!==n.curves[e]})}function A(e,t){return oe.every(function(n){return H(e.curves[n],t)})}function H(e,t){return void 0!==e.values[t]}function L(){this.position=new THREE.Vector3,this.normal=new THREE.Vector3,this.uv=new THREE.Vector2,this.color=new THREE.Vector3,this.skinIndices=new THREE.Vector4(0,0,0,0),this.skinWeights=new THREE.Vector4(0,0,0,0)}function N(){this.vertices=[]}function P(){this.triangles=[],this.materialIndex=0}function I(){this.faces=[],this.skeleton=null}function D(){}function B(){}function O(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}function j(){}function F(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===q(e,0,t.length)}function z(e){function t(t){var n=e[t-1];return e=e.slice(i+t),i++,n}for(var n=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],i=0,o=0;o<n.length;++o){var s=t(1);if(s==n[o])return!1}return!0}function V(e){var t=/FBXVersion: (\d+)/,n=e.match(t);if(n){var i=parseInt(n[1]);return i}throw new Error("FBXLoader: Cannot find the version number for the file given.")}function U(e){return e/46186158e3}function X(e){for(var t=e.split(","),n=0,i=t.length;n<i;n++)t[n]=parseFloat(t[n]);return t}function G(e){for(var t=e.split(","),n=0,i=t.length;n<i;n++)t[n]=parseInt(t[n]);return t}function W(e){return(new THREE.Vector3).fromArray(e.value)}function Y(e){return(new THREE.Color).fromArray(e.value)}function Z(e){return(new THREE.Matrix4).fromArray(X(e))}function q(e,t,n){void 0===t&&(t=0),void 0===n&&(n=e.byteLength);var i=new Uint8Array(e,t,n);if(void 0!==window.TextDecoder)return(new TextDecoder).decode(i);for(var o="",s=0,r=i.length;s<r;s++)o+=String.fromCharCode(i[s]);return o}function K(e){return e*se}function Q(e,t){for(var n=0,i=e.length;n<i;n++)if(t(e[n]))return n;return-1}function J(e,t){for(var n=0,i=e.length,o=t.length;n<o;n++,i++)e[i]=t[n]}function $(e,t,n,i){for(var o=n,s=0;o<i;o++,s++)e[s]=t[o];return e}THREE.FBXLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},Object.assign(THREE.FBXLoader.prototype,{load:function(e,t,n,i){var o=this,s=e.split(/[\\\/]/);s.pop(),s=s.join("/")+"/";var r=new THREE.FileLoader(this.manager);r.setResponseType("arraybuffer"),r.load(e,function(n){try{var r=o.parse(n,s);t(r)}catch(t){window.setTimeout(function(){i&&i(t),o.manager.itemError(e)},0)}},n,i)},parse:function(n,o){var r;if(F(n))r=(new B).parse(n);else{var a=q(n);if(!z(a))throw self.manager.itemError(url),new Error("FBXLoader: Unknown format.");if(V(a)<7e3)throw self.manager.itemError(url),new Error("FBXLoader: FBX version not supported for file at "+url+", FileVersion: "+V(a));r=(new D).parse(a)}var h=e(r),u=t(r),d=i(r,new THREE.TextureLoader(this.manager).setPath(o),u,h),p=s(r,d,h),f=l(r,h),m=c(r,h,f),v=y(r,h,f,m,p);return v}});var ee=[],te={ByPolygonVertex:{Direct:function(e,t,n,i){var o=e*i.dataSize,s=e*i.dataSize+i.dataSize;return $(ee,i.buffer,o,s)},IndexToDirect:function(e,t,n,i){var o=i.indices[e],s=o*i.dataSize,r=o*i.dataSize+i.dataSize;return $(ee,i.buffer,s,r)}},ByPolygon:{Direct:function(e,t,n,i){var o=t*i.dataSize,s=t*i.dataSize+i.dataSize;return $(ee,i.buffer,o,s)},IndexToDirect:function(e,t,n,i){var o=i.indices[t],s=o*i.dataSize,r=o*i.dataSize+i.dataSize;return $(ee,i.buffer,s,r)}},ByVertice:{Direct:function(e,t,n,i){var o=n*i.dataSize,s=n*i.dataSize+i.dataSize;return $(ee,i.buffer,o,s)}},AllSame:{IndexToDirect:function(e,t,n,i){var o=i.indices[0]*i.dataSize,s=i.indices[0]*i.dataSize+i.dataSize;return $(ee,i.buffer,o,s)}}},ne=new THREE.Euler,ie=new THREE.Quaternion,oe=["x","y","z"];Object.assign(L.prototype,{copy:function(e){var t=e||new L;return t.position.copy(this.position),t.normal.copy(this.normal),t.uv.copy(this.uv),t.skinIndices.copy(this.skinIndices),t.skinWeights.copy(this.skinWeights),t},flattenToBuffers:function(e,t,n,i,o,s){this.position.toArray(e,e.length),this.normal.toArray(t,t.length),this.uv.toArray(n,n.length),this.color.toArray(i,i.length),this.skinIndices.toArray(o,o.length),this.skinWeights.toArray(s,s.length)}}),Object.assign(N.prototype,{copy:function(e){for(var t=e||new N,n=0;n<this.vertices.length;++n)this.vertices[n].copy(t.vertices[n]);return t},flattenToBuffers:function(e,t,n,i,o,s){for(var r=this.vertices,a=0,l=r.length;a<l;++a)r[a].flattenToBuffers(e,t,n,i,o,s)}}),Object.assign(P.prototype,{copy:function(e){for(var t=e||new P,n=0;n<this.triangles.length;++n)this.triangles[n].copy(t.triangles[n]);return t.materialIndex=this.materialIndex,t},genTrianglesFromVertices:function(e){for(var t=2;t<e.length;++t){var n=new N;n.vertices[0]=e[0],n.vertices[1]=e[t-1],n.vertices[2]=e[t],this.triangles.push(n)}},flattenToBuffers:function(e,t,n,i,o,s,r){for(var a=this.triangles,l=this.materialIndex,h=0,c=a.length;h<c;++h)a[h].flattenToBuffers(e,t,n,i,o,s),J(r,[l,l,l])}}),Object.assign(I.prototype,{flattenToBuffers:function(){for(var e=[],t=[],n=[],i=[],o=[],s=[],r=[],a=this.faces,l=0,h=a.length;l<h;++l)a[l].flattenToBuffers(e,t,n,i,o,s,r);return{vertexBuffer:e,normalBuffer:t,uvBuffer:n,colorBuffer:i,skinIndexBuffer:o,skinWeightBuffer:s,materialIndexBuffer:r}}}),Object.assign(D.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(e){this.currentIndent=0,this.allNodes=new j,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var t=e.split("\n");for(var n in t){var i=t[n];if(!i.match(/^[\s\t]*;/)&&!i.match(/^[\s\t]*$/)){var o=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):(.*){",""),s=i.match(o);if(s){for(var r=s[1].trim().replace(/^"/,"").replace(/"$/,""),a=s[2].split(","),l=0,i=a.length;l<i;l++)a[l]=a[l].trim().replace(/^"/,"").replace(/"$/,"");this.parseNodeBegin(i,r,a||null)}else{var h=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),s=i.match(h);if(s){var c=s[1].replace(/^"/,"").replace(/"$/,"").trim(),u=s[2].replace(/^"/,"").replace(/"$/,"").trim();this.parseNodeProperty(i,c,u)}else{var d=new RegExp("^\\t{"+(this.currentIndent-1)+"}}");i.match(d)?this.nodeEnd():i.match(/^[^\s\t}]/)&&this.parseNodePropertyContinued(i)}}}}return this.allNodes},parseNodeBegin:function(e,t,n){var i={name:t,properties:{},subNodes:{}},o=this.parseNodeAttr(n),s=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(t,i);else if(t in s.subNodes){var r=s.subNodes[t];this.isFlattenNode(s.subNodes[t])&&(""===o.id?(s.subNodes[t]=[],s.subNodes[t].push(r)):(s.subNodes[t]={},s.subNodes[t][r.id]=r)),""===o.id?s.subNodes[t].push(i):s.subNodes[t][o.id]=i}else"number"==typeof o.id||o.id.match(/^\d+$/)?(s.subNodes[t]={},s.subNodes[t][o.id]=i):s.subNodes[t]=i;n&&(i.id=o.id,i.attrName=o.name,i.attrType=o.type),this.pushStack(i)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var n="",i="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:n,type:i}},parseNodeProperty:function(e,t,n){var i=this.getCurrentNode(),o=i.name;if(void 0!==o){var s=o.match(/Properties(\d)+/);if(s)return void this.parseNodeSpecialProperty(e,t,n)}if("C"==t){var r=n.split(",").slice(1),a=parseInt(r[0]),l=parseInt(r[1]),h=n.split(",").slice(3);t="connections",n=[a,l],J(n,h),void 0===i.properties[t]&&(i.properties[t]=[])}if("Node"==t){var c=parseInt(n);i.properties.id=c,i.id=c}t in i.properties?Array.isArray(i.properties[t])?i.properties[t].push(n):i.properties[t]+=n:Array.isArray(i.properties[t])?i.properties[t].push(n):i.properties[t]=n,this.setCurrentProp(i.properties,t)},parseNodePropertyContinued:function(e){this.currentProp[this.currentPropName]+=e},parseNodeSpecialProperty:function(e,t,n){for(var i=n.split('",'),o=0,s=i.length;o<s;o++)i[o]=i[o].trim().replace(/^\"/,"").replace(/\s/,"_");var r=i[0],a=i[1],l=i[2],h=i[3],c=i[4];switch(a){case"int":case"Bool":case"Integer":c=parseInt(c);break;case"double":case"Float":case"Number":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector":case"Vector3D":c=X(c)}this.getPrevNode().properties[r]={type:a,type2:l,flag:h,value:c},this.setCurrentProp(this.getPrevNode().properties,r)},nodeEnd:function(){this.popStack()},isFlattenNode:function(e){return"subNodes"in e&&"properties"in e}}),Object.assign(B.prototype,{parse:function(e){var t=new O(e);t.skip(23);var n=t.getUint32();console.log("FBX binary version: "+n);for(var i=new j;!this.endOfContent(t);){var o=this.parseNode(t,n);null!==o&&i.add(o.name,o)}return i},endOfContent:function(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+15>=e.size()},parseNode:function(e,t){var n=t>=7500?e.getUint64():e.getUint32(),i=t>=7500?e.getUint64():e.getUint32(),o=t>=7500?e.getUint64():e.getUint32(),s=e.getUint8(),r=e.getString(s);if(this.propertyListLen=o,0===n)return null;for(var a=[],l=0;l<i;l++)a.push(this.parseProperty(e));
var h=a.length>0?a[0]:"",c=a.length>1?a[1]:"",u=a.length>2?a[2]:"",d={},p={},f=!1;for(1===i&&e.getOffset()===n&&(f=!0);n>e.getOffset();){var m=this.parseNode(e,t);if(null!==m)if(m.singleProperty!==!0)if("Connections"!==r||"C"!==m.name)if(m.name.match(/^Properties\d+$/))for(var v=Object.keys(m.properties),l=0,g=v.length;l<g;l++){var b=v[l];p[b]=m.properties[b]}else if(r.match(/^Properties\d+$/)&&"P"===m.name){var w,y=m.propertyList[0],E=m.propertyList[1],x=m.propertyList[2],T=m.propertyList[3];0===y.indexOf("Lcl ")&&(y=y.replace("Lcl ","Lcl_")),0===E.indexOf("Lcl ")&&(E=E.replace("Lcl ","Lcl_")),w="ColorRGB"===E||"Vector"===E||"Vector3D"===E||0===E.indexOf("Lcl_")?[m.propertyList[4],m.propertyList[5],m.propertyList[6]]:m.propertyList[4],0===E.indexOf("Lcl_")&&(w=w.toString()),p[y]={type:E,type2:x,flag:T,value:w}}else void 0===d[m.name]?"number"==typeof m.id?(d[m.name]={},d[m.name][m.id]=m):d[m.name]=m:""===m.id?(Array.isArray(d[m.name])||(d[m.name]=[d[m.name]]),d[m.name].push(m)):void 0===d[m.name][m.id]?d[m.name][m.id]=m:(Array.isArray(d[m.name][m.id])||(d[m.name][m.id]=[d[m.name][m.id]]),d[m.name][m.id].push(m));else{for(var _=[],l=1,g=m.propertyList.length;l<g;l++)_[l-1]=m.propertyList[l];void 0===p.connections&&(p.connections=[]),p.connections.push(_)}else{var R=m.propertyList[0];Array.isArray(R)?(m.properties[m.name]=m.propertyList[0],d[m.name]=m,m.properties.a=R.toString()):p[m.name]=R}}return{singleProperty:f,id:h,attrName:c,attrType:u,name:r,properties:p,propertyList:a,subNodes:d}},parseProperty:function(e){var t=e.getChar();switch(t){case"F":return e.getFloat32();case"D":return e.getFloat64();case"L":return e.getInt64();case"I":return e.getInt32();case"Y":return e.getInt16();case"C":return e.getBoolean();case"f":case"d":case"l":case"i":case"b":var n=e.getUint32(),i=e.getUint32(),o=e.getUint32();if(0===i)switch(t){case"f":return e.getFloat32Array(n);case"d":return e.getFloat64Array(n);case"l":return e.getInt64Array(n);case"i":return e.getInt32Array(n);case"b":return e.getBooleanArray(n)}if(void 0===window.Zlib)throw new Error("FBXLoader: Import inflate.min.js from https://github.com/imaya/zlib.js");var s=new Zlib.Inflate(new Uint8Array(e.getArrayBuffer(o))),r=new O(s.decompress().buffer);switch(t){case"f":return r.getFloat32Array(n);case"d":return r.getFloat64Array(n);case"l":return r.getInt64Array(n);case"i":return r.getInt32Array(n);case"b":return r.getBooleanArray(n)}case"S":var a=e.getUint32();return e.getString(a);case"R":var a=e.getUint32();return e.getArrayBuffer(a);default:throw new Error("FBXLoader: Unknown property type "+t)}}}),Object.assign(O.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(e){this.offset+=e},getBoolean:function(){return 1===(1&this.getUint8())},getBooleanArray:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getBoolean());return t},getInt8:function(){var e=this.dv.getInt8(this.offset);return this.offset+=1,e},getInt8Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt8());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint8Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getUint8());return t},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt16Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt16());return t},getUint16:function(){var e=this.dv.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},getUint16Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getUint16());return t},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getUint32Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getUint32());return t},getInt64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e},getInt64Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt64());return t},getUint64:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e},getUint64Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getUint64());return t},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getFloat64());return t},getArrayBuffer:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},getChar:function(){return String.fromCharCode(this.getUint8())},getString:function(e){for(var t="";e>0;){var n=this.getUint8();if(e--,0===n)break;t+=String.fromCharCode(n)}return this.skip(e),t}}),Object.assign(j.prototype,{add:function(e,t){this[e]=t},searchConnectionParent:function(e){if(void 0===this.__cache_search_connection_parent&&(this.__cache_search_connection_parent=[]),void 0!==this.__cache_search_connection_parent[e])return this.__cache_search_connection_parent[e];this.__cache_search_connection_parent[e]=[];for(var t=this.Connections.properties.connections,n=[],i=0;i<t.length;++i)if(t[i][0]==e){var o=0===t[i][1]?-1:t[i][1];n.push(o)}return n.length>0?(J(this.__cache_search_connection_parent[e],n),n):(this.__cache_search_connection_parent[e]=[-1],[-1])},searchConnectionChildren:function(e){if(void 0===this.__cache_search_connection_children&&(this.__cache_search_connection_children=[]),void 0!==this.__cache_search_connection_children[e])return this.__cache_search_connection_children[e];this.__cache_search_connection_children[e]=[];for(var t=this.Connections.properties.connections,n=[],i=0;i<t.length;++i)t[i][1]==e&&n.push(0===t[i][0]?-1:t[i][0]);return n.length>0?(J(this.__cache_search_connection_children[e],n),n):(this.__cache_search_connection_children[e]=[],[])},searchConnectionType:function(e,t){var n=e+","+t;if(void 0===this.__cache_search_connection_type&&(this.__cache_search_connection_type={}),void 0!==this.__cache_search_connection_type[n])return this.__cache_search_connection_type[n];this.__cache_search_connection_type[n]="";for(var i=this.Connections.properties.connections,o=0;o<i.length;++o)if(i[o][0]==e&&i[o][1]==t)return this.__cache_search_connection_type[n]=i[o][2],i[o][2];return this.__cache_search_connection_type[e]=null,null}});var se=Math.PI/180}(),THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FillShader={uniforms:{color:{value:new THREE.Color(1,1,1)},alpha:{value:1},lineAlpha:{value:1},fillAlpha:{value:.2}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3  color;","uniform float alpha;","uniform float lineAlpha;","uniform float fillAlpha;","#define PI 3.141592653589793","#define XRAD 0.017453292519943295","float drawLine(float angle, float step, float thick) {","float a = angle * XRAD;","float ks = thick / step;","float len = dot(gl_FragCoord.xy, vec2(cos(a), sin(a)));","float dist = abs((2.0 * mod(len, step) / step) - 1.0);","return clamp((ks - dist) / ks, 0.0, 1.0);","}","void main() {","gl_FragColor = vec4(color, alpha);","return;","float line1 = drawLine(-30.0, 10.0, 2.0);","float line2 = drawLine(80.0, 20.0, 2.0);","float level = fillAlpha + lineAlpha * max(line1 * 0.9, line2 * 0.3);","gl_FragColor = vec4(color, alpha * level);","}"].join("\n")},THREE.OverlayShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)},drawColor:{value:new THREE.Color(1,1,1)},drawAlpha:{value:1},lineAlpha:{value:1},lineAngle:{value:0},fillAlpha:{value:0},edgeAlpha:{value:1}},vertexShader:["void main() {","gl_Position = vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","uniform vec3  drawColor;","uniform float drawAlpha;","uniform float lineAlpha;","uniform float lineAngle;","uniform float fillAlpha;","uniform float edgeAlpha;","float edgeBasic(sampler2D image, vec2 pixel) {","vec4 mtl = texture2D(image, pixel + resolution * vec2(-1.0,  1.0));","vec4 mtc = texture2D(image, pixel + resolution * vec2( 0.0,  1.0));","vec4 mtr = texture2D(image, pixel + resolution * vec2( 1.0,  1.0));","vec4 mcl = texture2D(image, pixel + resolution * vec2(-1.0,  0.0));","vec4 mcc = texture2D(image, pixel + resolution * vec2( 0.0,  0.0));","vec4 mcr = texture2D(image, pixel + resolution * vec2( 1.0,  0.0));","vec4 mbl = texture2D(image, pixel + resolution * vec2(-1.0, -1.0));","vec4 mbc = texture2D(image, pixel + resolution * vec2( 0.0, -1.0));","vec4 mbr = texture2D(image, pixel + resolution * vec2( 1.0, -1.0));","float dtl = abs(mtl.r - mcc.r) / 2.0;","float dtc = abs(mtc.r - mcc.r) / 1.0;","float dtr = abs(mtr.r - mcc.r) / 2.0;","float dcl = abs(mcl.r - mcc.r) / 1.0;","float dcr = abs(mcr.r - mcc.r) / 1.0;","float dbl = abs(mbl.r - mcc.r) / 2.0;","float dbc = abs(mbc.r - mcc.r) / 1.0;","float dbr = abs(mbr.r - mcc.r) / 2.0;","return 0.4 * (dtl + dtc + dtr + dcl + dcr + dbl + dbc + dbr);","}","float edgeFreiChen(sampler2D image, vec2 pixel) {","float n1 = 0.3535533845424652;","float n2 = 0.1666666716337204;","float n3 = 0.1666666716337204;","float n4 = 0.6666666865348816;","mat3 I;","mat3 G[9];","G[0] = mat3( n1, 0, -n1, 0.5, 0, -0.5, n1, 0, -n1 );","G[1] = mat3( n1, 0.5, n1, 0, 0, 0, -n1, -0.5, -n1 );","G[2] = mat3( 0, n1, -0.5, -n1, 0, n1, 0.5, -n1, 0 );","G[3] = mat3( 0.5, -n1, 0, -n1, 0, n1, 0, n1, -0.5 );","G[4] = mat3( 0, -0.5, 0, 0.5, 0, 0.5, 0, -0.5, 0 );","G[5] = mat3( -0.5, 0, 0.5, 0, 0, 0, 0.5, 0, -0.5 );","G[6] = mat3( n2, -n3, n2, -n3, n4, -n3, n2, -n3, n2 );","G[7] = mat3( -n3, n2, -n3, n2, n4, n2, -n3, n2, -n3 );","G[8] = mat3( n3, n3, n3, n3, n3, n3, n3, n3, n3 );","vec3 sample;","for (float i=0.0; i<3.0; i++) {","for (float j=0.0; j<3.0; j++) {","sample = texture2D(image, pixel + resolution * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","}","float cnv[9];","for (int i=0; i<9; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3;","}","float M = (cnv[0] + cnv[1]) + (cnv[2] + cnv[3]);","float S = (cnv[4] + cnv[5]) + (cnv[6] + cnv[7]) + (cnv[8] + M);","return sqrt(M / S);","}","float edgeSobel(sampler2D image, vec2 pixel) {","mat3 I;","mat3 G[2];","G[0] = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","G[1] = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","vec3 sample;","for (float i=0.0; i<3.0; i++)","for (float j=0.0; j<3.0; j++) {","sample = texture2D(image, pixel + resolution * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","float cnv[2];","for (int i=0; i<2; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3; ","}","return 0.017 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]);","}","float drawLine(float angle, float step, float thick) {","float pi = 3.141592653589793;","float kx = cos(angle / 180.0 * pi);","float ky = sin(angle / 180.0 * pi);","float ks = thick / step;","float len = dot(gl_FragCoord.xy, vec2(kx, ky));","float dist = abs((2.0 * mod(len, step) / step) - 1.0);","return clamp((ks - dist) * (1.0 / ks), 0.0, 1.0);","}","void main() {","vec2 pixel = gl_FragCoord.xy * resolution;","float fill = texture2D(tDiffuse, pixel).r;","float line1 = drawLine(-30.0 + lineAngle, 10.0, 2.0);","float line2 = drawLine( 80.0 + lineAngle, 20.0, 2.0);","float level = 0.0;","level += edgeAlpha * edgeBasic(tDiffuse, pixel);","level += lineAlpha * max(fill * line1 * 0.9, fill * line2 * 0.3);","level += fillAlpha * fill;","if(level > 0.0) {","gl_FragColor = vec4(drawColor, drawAlpha * level);","} else {","gl_FragColor = vec4(0.0);","}","}"].join("\n")},THREE.HorizontalBlurShader={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.VerticalBlurShader={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2(  1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0,  1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2(  1.0,  1.0 ) ) * resolution ).xyz;","vec4 rgbaM = texture2D( tDiffuse,   gl_FragCoord.xy * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE ), max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},FileImport.prototype={onInputChange:function(){for(var e=0;e<this.input.files.length;e++)this.events.emit("import",this.input.files[e]);this.input.value=null}},TileView.VERTICAL_SPLIT=1,TileView.HORIZONTAL_SPLIT=2,TileView.prototype={width:0,height:0,helperSize:1,makeFrame:function(e,t){var n={source:e,parent:t};return e&&e[0]?(n.split="v"===e[0]?TileView.VERTICAL_SPLIT:TileView.HORIZONTAL_SPLIT,n.head=this.makeFrame(e[1],n),n.tail=this.makeFrame(e[2],n),n.position=e[3]||.5,this.splits.push(n)):(n.index=this.frames.length,this.frames.push(n)),n},setLayout:function(e){this.splits=[],this.frames=[],this.root=this.makeFrame(e),this.helpers=[],this.ehelpers.innerHTML="";for(var t=0;t<this.splits.length;t++){var n=this.splits[t],i=new Drag(dom.div("tile-helper",this.ehelpers));i.min.x=i.min.y=0,i.max.x=i.max.y=1,i.events.on("start",this.startHelper,this,n),i.events.on("drag",this.dragHelper,this,n),this.helpers.push(i)}this.update()},setClients:function(e){if(this.clients=e||[],this.econtent.innerHTML="",e)for(var t=0;t<e.length;t++){var n=e[t];n&&n.element&&(dom.addclass(n.element,"tile-client"),dom.append(this.econtent,n.element))}},resize:function(e,t){this.width=e,this.height=t,this.setElement(this.element,NaN,NaN,this.width,this.height),this.update()},autoresize:function(){this.width=this.element.offsetWidth,this.height=this.element.offsetHeight,this.setElement(this.element,NaN,NaN,NaN,NaN),this.update()},update:function(){this.resizeFrame(this.root,0,0,this.width,this.height),this.helpers.forEach(this.updateHelper,this),this.clients.forEach(this.updateClient,this),this.events.emit("update")},resizeFrame:function(e,t,n,i,o){switch(arguments.length>1?(e.x=t,e.y=n,e.w=i,e.h=o):(t=e.x,n=e.y,i=e.w,o=e.h),e.split){case TileView.VERTICAL_SPLIT:var s=e.h*e.position,r=e.h*(1-e.position);this.resizeFrame(e.head,t,n,i,s),this.resizeFrame(e.tail,t,n+s,i,r);break;case TileView.HORIZONTAL_SPLIT:var a=e.w*e.position,l=e.w*(1-e.position);this.resizeFrame(e.head,t,n,a,o),this.resizeFrame(e.tail,t+a,n,l,o)}},setElement:function(e,t,n,i,o){if(e){var s=e.style;s.top=n+"px",s.left=t+"px",s.width=i+"px",s.height=o+"px"}},showClients:function(){this.setClients(),this.frames.forEach(function(e,t){var n=dom.div("tile-client tile-client-test",this.econtent),i=dom.div("tile-client-index absmid",n),o=dom.div("tile-client-size absmid",n);n.style.backgroundColor=f.rcolor(),i.innerHTML=t,this.clients[t]={element:n,resize:function(e,t){o.innerHTML=Math.round(e)+"x"+Math.round(t)}}},this),this.update()},startHelper:function(e,t){t.point.x=t.origin.x=e.position,t.point.y=t.origin.y=e.position},dragHelper:function(e,t){e.split===TileView.VERTICAL_SPLIT?e.position=f.clamp(t.point.y,0,1):e.position=f.clamp(t.point.x,0,1),e.source[3]=e.position,this.resizeFrame(e),this.update()},updateHelper:function(e,t){var n=this.splits[t];if(n.split===TileView.VERTICAL_SPLIT){var i=n.position*n.h;this.setElement(e.element,n.x,n.y+i,n.w,this.helperSize),dom.addclass(e.element,"tile-helper-vertical"),dom.remclass(e.element,"tile-helper-horizontal"),e.scale.y=1/n.h}else{var o=n.position*n.w;this.setElement(e.element,n.x+o,n.y,this.helperSize,n.h),dom.addclass(e.element,"tile-helper-horizontal"),dom.remclass(e.element,"tile-helper-vertical"),e.scale.x=1/n.w}},updateClient:function(e,t){if(e){var n=this.frames[t];e.element&&dom.display(e.element,!!n),n&&(this.setElement(e.element,n.x,n.y,n.w,n.h),e.resize&&e.resize(n.w,n.h),e.setViewport&&e.setViewport(n))}}},PointProjector.prototype={clear:function(){this.points=[]},addPoint:function(e,t){var n={world:new THREE.Vector3,screen:new THREE.Vector2,local:!!e,visible:!1};return t&&this.points.push(n),n},remPoint:function(e){var t=this.points.indexOf(e);~t&&this.points.splice(t,1)},viewportToWorld:function(e,t,n){return t||(t=new THREE.Vector3),t.copy(e),t.applyMatrix4(this.inverse),n&&t.sub(this.camera.position),t},worldToViewport:function(e,t,n){return t||(t=new THREE.Vector3),t.copy(e),n&&t.add(this.camera.position),t.applyMatrix4(this.matrix),t},viewportToScreen:function(e,t){return t||(t=new THREE.Vector2),t.x=(e.x/2+.5)*this.width,t.y=(-e.y/2+.5)*this.height,t},screenToViewport:function(e,t){return t||(t=new THREE.Vector3),t.x=e.x/this.width*2-1,t.y=-(e.y/this.height*2-1),t.z=-1,t},screenToWorld:function(e,t,n){return this.screenToViewport(e,this.viewport),this.viewportToWorld(this.viewport,t,n)},worldToScreen:function(e,t,n){return this.worldToViewport(e,this.viewport,n),this.viewportToScreen(this.viewport,t)},resize:function(e,t){this.width=e,this.height=t},updateMatrices:function(){this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),this.matrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.inverse.getInverse(this.camera.projectionMatrix),this.inverse.multiplyMatrices(this.camera.matrixWorld,this.inverse)},updatePoint:function(e){this.worldToViewport(e.world,this.viewport,e.local),this.viewportToScreen(this.viewport,e.screen),e.local?e.distance=e.world.length():e.distance=e.world.distanceTo(this.camera.position),e.visible=-1<=this.viewport.x&&this.viewport.x<=1&&-1<=this.viewport.y&&this.viewport.y<=1&&-1<=this.viewport.z&&this.viewport.z<=1},update:function(){this.points.forEach(this.updatePoint,this)}},Imagery.prototype={folders:{thumbs:"images/thumbs/",textures:"images/textures/"},types:{alpha:1,normal:2,texture:3,logo:11,thumb:12,icon:21},materialOptions:{defaults:{factory:THREE.MeshPhongMaterial,makeMap:!0,side:THREE.DoubleSide},norcon:{makeMap:!1,factory:THREE.LineBasicMaterial,vertexColors:THREE.VertexColors,linewidth:2,visible:!1},subtract:{visible:!1,transparent:!0,opacity:.5},blue:{makeEnv:!0,reflectivity:.25,shininess:22},gold:{makeEnv:!0,makeBump:!0,reflectivity:.8,shininess:95},black:{makeEnv:!0,reflectivity:.3,shininess:70},glass:{makeEnv:!0,transparent:!0,opacity:.9,reflectivity:.8,side:THREE.FrontSide},corner:{makeAlpha:!0,transparent:!0},pcorner:{makeAlpha:!0,transparent:!0},cut:{transparent:!0,opacity:0},wall:{makeNormal:!0},roof:{makeNormal:!0},normal:{factory:THREE.MeshNormalMaterial,makeMap:!1},wireframe:{wireframe:!0}},textureOptions:{},makeTexture:function(e){var t=new THREE.Texture;return t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.minFilter=THREE.LinearMipMapLinearFilter,t.magFilter=THREE.LinearFilter,t.anisotropy=4,t.image=this.pixel.image,f.copy(t,e),t.needsUpdate=!0,t},makeMaterial:function(e,t){var n=f.merge(this.materialOptions.defaults,this.materialOptions[e]||this.materialOptions[t],{name:e}),i=f.copy({},this.textureOptions[e]||this.textureOptions[t]);n.makeMap&&(n.map=this.makeTexture(i)),n.makeAlpha&&(n.alphaMap=this.makeTexture(i)),n.makeNormal&&(n.normalMap=this.makeTexture(i),n.normalMap.image=this.normal.image),n.makeBump&&(n.bumpMap=this.makeTexture(i),n.bumpMap.image=this.bump.image),n.makeEnv&&(n.envMap=this.skybox);var o=n.factory;delete n.makeMap,delete n.makeAlpha,delete n.makeNormal,delete n.makeBump,delete n.makeEnv,delete n.factory;var s=new o(n);return s.persistent=!0,s.implicit=!0,s.needsUpdate=!0,s.obvImplicit=new Observable(s.implicit),s.obvFabric=new Observable,s.obvLoaded=(new Observable).set(this,function(){this.setMaterialProduct(s,this.getLoadedProduct(s))}),s},configureSampleMaterial:function(e){if(e&&e.material){if("subtract"===e.name)return void(e.material=this.materials.subtract);var t=e.material;if(this.sampleMaterials.indexOf(t)===-1){this.sampleMaterials.push(t);for(var n=[t.map,t.bumpMap,t.normalMap].filter(Boolean),i=0;i<n.length;i++){var o=n[i],s={image:o.image};this.tileTexture(s),o.wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.image=s.image,o.repeat.x*=s.repeatX,o.repeat.y*=s.repeatY}t.envMap=this.skybox,t.needsUpdate=!0}}},readMaterialLoaded:function(){this.materials[m.name],this.usedProducts[m.name]},addMaterial:function(e,t){var n=this.materials[e]=this.makeMaterial(e,t);return Observable.inContext(null,this.addMaterialInContext,this,n),n},addMaterialInContext:function(e){this.obvMaterialsList.write(this.obvMaterialsList.read().concat(e))},remMaterialInContext:function(e){this.obvMaterialsList.write(f.adrop(this.obvMaterialsList.read().slice(),e))},copyMaterial:function(e,t){e&&t&&(e.implicit?this.setMaterial(e,null):this.setMaterial(e,this.usedProducts[t.name]))},rootMaterial:function(e){var t=this.materials[e];if(t){for(;t.parent;)t=t.parent;return t.name}},addSubmaterial:function(e){var t=this.materials[e];if(t){t.submaterials||(t.submaterials=[]);var n=this.rootMaterial(e),i=t.name+"-"+ ++this.submaterialIndex,o=this.addMaterial(i,n);return t.submaterials.push(o),o.parent=t,this.setMaterial(o,this.usedProducts[e]),o}},remSubmaterial:function(e){var t=e instanceof THREE.Material?e:this.materials[e];t&&(t.parent&&f.adrop(t.parent.submaterials,t),t.dispose(),delete this.usedProducts[t.name],delete this.materials[t.name],Observable.inContext(null,this.remMaterialInContext,this,t))},setMapImage:function(e,t,n){e&&t&&(e.image!==t.image&&(e.image=t.image,e.needsUpdate=!0),e.repeat.x=t.repeatX||1,e.repeat.y=t.repeatY||1,n&&(e.repeat.x=1/(t.cloneX||1)))},setMaterialProduct:function(e,t){if(e&&t){e.obvFabric&&e.obvFabric.write(t),e.color&&e.color.set(t.color||16777215);var n=["outer","fouter"].indexOf(t.unit)!==-1;if(this.setMapImage(e.map,t.texture||this.pixel,n),this.setMapImage(e.bumpMap,t.bump||this.bump,n),this.setMapImage(e.normalMap,t.normal||this.normal,n),this.setMapImage(e.alphaMap,t.alpha||this.pixel,n),e.submaterials)for(var i=0;i<e.submaterials.length;i++){var o=e.submaterials[i];o.implicit&&this.setMaterialProduct(o,t)}}},setImplicitProduct:function(e,t){if(t){for(var n=e.parent;n&&n.implicit;)n=n.parent;e.implicit=!!n&&t===this.usedProducts[n.name]}else e.implicit=!0;e.implicit&&(t=null),e.obvImplicit.write(e.implicit),this.usedProducts[e.name]=t;var i=e.submaterials;if(i)for(var o=0;o<i.length;o++){var s=i[o];this.setImplicitProduct(s,this.usedProducts[s.name])}},isProductLoaded:function(e){return e&&(!e.texture||Observable.unwrap(e.texture.loaded))&&(!e.normal||Observable.unwrap(e.normal.loaded))&&(!e.alpha||Observable.unwrap(e.alpha.loaded))},getLoadedProduct:function(e){for(var t="object"==typeof e?e:this.materials[e];t;){var n=this.usedProducts[t.name];if(this.isProductLoaded(n))return n;if(!t.parent)return this.baseMaps[t.name];t=t.parent}},getUsedProduct:function(e){for(var t="object"==typeof e?e:this.materials[e];t;){var n=this.usedProducts[t.name];if(n)return n;if(!t.parent)return this.baseMaps[t.name];t=t.parent}},setMaterial:function(e,t){var n="object"==typeof e?e:this.materials[e];n&&("object"!=typeof t&&(t=this.products[t]),t&&!t.id&&(t=null),this.setImplicitProduct(n,t),this.setMaterialProduct(n,this.getLoadedProduct(n)))},textureColor:function(e,t,n){this.buffer.width=t,this.buffer.height=n,this.btx.drawImage(e,0,0);for(var i=this.btx.getImageData(0,0,t,n),o=i.data,s=o.length,r=1/(t*n),a=0,l=0,h=0,c=0;c<s;c+=4)a+=o[c+0],l+=o[c+1],h+=o[c+2];return a*r<<16^l*r<<8^h*r<<0},tileTexture:function(e){if(e){var t=e.image;e.width=t.naturalWidth||t.width,e.height=t.naturalHeight||t.height,e.color=this.textureColor(t,e.width,e.height);var n=512,i=n/e.height,o=e.height/e.width;e.cloneX=1,e.cloneY=1,e.repeatX=(e.resolution||1)*i*o,e.repeatY=(e.resolution||1)*i;var s=!(e.width&e.width-1),r=!(e.height&e.height-1);if(!s||!r){for(var a=this.fitTileSize(e.width,e.height,10),l=this.makeCanvas(a.spaceX,a.spaceY),h=0;h<a.cloneX;h++)for(var c=0;c<a.cloneY;c++)l.drawImage(t,0,0,a.sourceX,a.sourceY,h*a.sizeX,c*a.sizeY,a.sizeX,a.sizeY);e.image=l.canvas,e.width=a.spaceX,e.height=a.spaceY,e.cloneX=a.cloneX,e.cloneY=a.cloneY,e.repeatX/=a.cloneX,e.repeatY/=a.cloneY,this.debugFit(a,e)}}},fitTileSize:function(e,t,n){for(var i={sourceX:e,sourceY:t,score:1/0},o=0;o<=n;o++){var s=1<<o,r=Math.round(s/e),a=(s-e*r)/e;if(r)for(var l=0;l<=n;l++){var h=1<<l,c=Math.round(h/t),u=(h-t*c)/t,d=Math.abs(a),p=Math.abs(u),f=Math.abs(a-u),m=Math.sqrt(r*c),v=d+p+f/2+m/10;c&&v<i.score&&(i.sizeX=s/r,i.sizeY=h/c,i.cloneX=r,i.cloneY=c,i.spaceX=s,i.spaceY=h,i.errorX=a,i.errorY=u,i.error=f,i.score=v)}}return i},debugFit:function(e,t){var n;e.error>.4?n=console.error:Math.abs(e.errorX)>.4||Math.abs(e.errorY)>.4?n=console.warn:this.debug&&(n=console.log),n&&n.call(console,"tile:",e.sourceX+"x"+e.sourceY,"->",Math.round(e.sizeX)+"x"+Math.round(e.sizeY),"("+e.spaceX+"x"+e.spaceY+",",e.cloneX+"x"+e.cloneY+")","errors:",+e.errorX.toFixed(2),"-",+e.errorY.toFixed(2),"=",e.error,"\n",t.url)},normalColor:function(e,t,n){return"rgb("+new THREE.Vector3(e,t,n).normalize().multiplyScalar(127).addScalar(127).toArray().map(Math.round)+")"},unwrapCubemap3x2:function(e){for(var t=e.height/2,n=[],i=0;i<2;i++)for(var o=0;o<3;o++){var s=this.makeCanvas(t,t);s.drawImage(e,o*t,i*t,t,t,0,0,t,t),n.push(s.canvas)}var r=[n[2],n[0],n[4],n[3],n[5],n[1]];this.skybox.image=r,this.skybox.needsUpdate=!0},makeCanvas:function(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n.getContext("2d")},makePixel:function(e){var t=this.makeCanvas(1,1);return t.fillStyle=e,t.fillRect(0,0,1,1),{image:t.canvas}},makePattern:function(e,t,n,i){var o=this.makeCanvas(t,n);"function"==typeof i&&i.apply(this,[o,t,n].concat([].slice.call(arguments,4)));var s=512*e/n;return{loaded:!0,width:t,height:n,repeatX:s,repeatY:s,image:o.canvas}},drawDash:function(e,t,n,i,o,s){e.fillStyle=i,e.fillRect(0,0,t,n),e.lineWidth=o,e.strokeStyle=s,e.beginPath(),e.moveTo(2*t,-n),e.lineTo(-t,2*n),e.moveTo(2*t,0),e.lineTo(0,2*n),e.moveTo(t,-n),e.lineTo(-t,n),e.stroke()},drawGrid:function(e,t,n,i,o,s){e.fillStyle=i,e.fillRect(0,0,t,n),e.fillStyle=s,e.fillRect(0,0,t,o),e.fillRect(0,0,o,n)},drawStripe:function(e,t,n,i,o,s,r){e.fillStyle=i,e.fillRect(0,0,t,n),e.fillStyle=s,e.fillRect(0,0,r?o:t,r?n:o)},drawChecker:function(e,t,n,i,o){var s=t>>1,r=n>>1;e.fillStyle=i||"white",e.fillRect(0,0,t,n),e.fillStyle=o||"black",e.fillRect(0,0,s,r),e.fillRect(s,r,s,r)},drawCloud:function(e,t,n,i,o){this.drawRandom(e,t,n,i,o),e.save(),e.globalAlpha=.4,e.scale(4,4),e.drawImage(e.canvas,0,0),e.scale(4,4),e.drawImage(e.canvas,0,0),e.restore()},drawRandom:function(e,t,n,i,o){for(var s=e.getImageData(0,0,t,n),r=s.data,a=255*i|0,l=255*o|0,h=0;h<r.length;h+=4)r[h+0]=r[h+1]=r[h+2]=f.rand(a)+l,r[h+3]=255;e.putImageData(s,0,0)}},Sampler.prototype={folder:"",setImagery:function(e){this.imagery=e},addSample:function(e){if(e&&!e.hide&&(e.object||e.src)){var t=new Sample(e,this),n=f.apick(this.samples,"src",t.src);return n&&(f.adrop(this.samples,n),console.warn("Sample with src",t.src,"already exists")),this.samples.push(t),t}},readFile:function(e){var t=new FileReader,n=new Defer(function(){return JSON.parse(t.result)});return dom.on("load",t,f.binds(n.resolve,n)),t.readAsText(e),n.then(function(e){var t=new THREE.ObjectLoader,n=new Defer;return t.parse(e,function(e){n.resolve(e)}),n}).then(function(t){return this.addSample({src:e.name,object:t})},this)}},Sample.prototype={traverse:function(e,t,n,i,o,s){if(e&&(null==s&&(s=0),t.call(n||this,e,i,s),e.children))for(var r=e.children.length,a=o?0:r-1;o?a<r:a>=0;o?a++:a--)this.traverse(e.children[a],t,n,i,o,s+1);
},load:function(){if(this.object&&(this.deferLoad=(new Defer).resolve(this)),this.deferLoad)return this.deferLoad;var e=new Defer,t=this.parent.folder+this.src;if(!this.src)return e.resolve(null),e;switch(this.broken=!1,this.format){case"obj":var n=new Loader;n.obj(t).defer.push(e);break;case"fbx":var n=new THREE.FBXLoader;n.load(t,function(t){e.resolve(t)},void 0,function(t){e.reject(t)});break;default:case"json":var n=new Loader;n.onProgress(function(){this.broken||(this.progress=n.bytesLoaded/n.bytesTotal)},this),n.json(t).then(function(e){var t=new THREE.ObjectLoader,n=new Defer;return t.parse(e,function(e){n.resolve(e)}),n},this).push(e)}return this.deferLoad=e.then(this.configure,this.loadError,this),this.deferLoad},loadError:function(e){throw this.broken=!0,this.progress=0,console.warn("Sample load error",this.src,e),this.deferLoad=null,e},configure:function(e){if(e)return e.position.length()&&console.error("sample",this.src,"not zero position:",e.position),this.progress=1,this.object=e,this.object.updateMatrixWorld(),this.config||(this.config={}),this.width||(this.width=this.config.width||1),this.height||(this.height=this.config.height||1),this.depth||(this.depth=this.config.depth||1),this.meshes||(this.meshes=this.config.meshes||[]),this.parts=[],this.box.makeEmpty(),this.object.updateMatrixWorld(),this.traverse(this.object,this.configureObject),this.box.getCenter(this.boxCenter),this.box.getSize(this.boxSize),this.boxLength=this.boxSize.length(),this},canReplace:function(e){var t=this.joints.slice();e:for(var n=0;n<e.length;n++){for(var i=e[n],o=t.length-1;o>=0;o--){var s=t[o];if(i.canConnect(s)){t.splice(o,1);continue e}}return!1}return!0},configureSubtract:function(e){return e.parent.remove(e),e.geometry?(this.subtractMesh&&console.warn("sample",this.src,"has multiple subtract meshes"),this.subtractMesh=e,void(e.visible=!0)):void console.error("sample",this.src,"subtract mesh without geometry")},configureObject:function(e){var t=this.parent.imagery;if(0===e.name.indexOf(":")){e.visible=!1;var n=new SampleJoint(e);if(n.makeDebugLine){var i=n.makeDebugLine();t&&(i.material=t.materials.norcon),this.object.add(i)}return void this.joints.push(n)}if("subtract"===e.name)return void this.configureSubtract(e);if(e.geometry){t&&t.configureSampleMaterial(e),e.geometry.persistent=!0,e.geometry.boundingBox||e.geometry.computeBoundingBox();var o=new THREE.Box3;o.copy(e.geometry.boundingBox).applyMatrix4(e.matrixWorld),this.box.union(o)}},smoothShadeGeometry:function(e){var t=new THREE.Geometry;return e instanceof THREE.BufferGeometry?t.fromBufferGeometry(e):t.copy(e),t.mergeVertices(),t.computeVertexNormals(),t.computeFaceNormals(),t},clone:function(){if(this.object)return this.object.clone(!0)},describeObject:function(e,t,n){var i=[];n&&i.push(Array(n+1).join("\t")),i.push(e.type),i.push("name: {"+e.name+"}"),e.material&&i.push("mat: {"+e.material.name+"}"),e.geometry&&i.push("v:",e.geometry instanceof THREE.BufferGeometry?e.geometry.attributes.position.count:e.geometry.vertices.length),i.push("pos: ["+[f.mround(e.position.x,3),f.mround(e.position.y,3),f.mround(e.position.z,3)].join(", ")+"]"),i.push("rot: ["+[f.hround(f.xdeg*e.rotation.x),f.hround(f.xdeg*e.rotation.y),f.hround(f.xdeg*e.rotation.z)].join(", ")+"]"),console.log.apply(console,i)},describe:function(){console.log("sample src: {"+(this.src||"")+"}"),this.traverse(this.object,this.describeObject,this,null,!0)}},SampleJoint.prototype={setFromMatrix:function(e){this.matrix.copy(e),this.point.setFromMatrixPosition(this.matrix),this.normal.set(1,0,0).applyMatrix4(this.matrix).sub(this.point),this.up.set(0,1,0).applyMatrix4(this.matrix).sub(this.point)},clone:function(){return new SampleJoint(this.object)},paramPairsAllow:[["f","m"],["u","u"],["u","f"],["u","m"],["FP","MP"],["female","male"],["uniform","uniform"],["uniform","female"],["uniform","male"],["in","out"],["inner","outer"],["internal","external"]],paramPairsEqual:function(e){return f.seq(e,this)},canConnect:function(e){return this.id===e.id&&this.paramPairsAllow.some(this.paramPairsEqual,[this.param,e.param])},canConnectList:function(e){return e.filter(this.canConnect,this)},makeDebugLine:function(){var e=new THREE.Line(new THREE.Geometry);return e.name="debug-connection-normal",e.geometry.vertices.push(new THREE.Vector3,this.normal.clone().setLength(20)),e.geometry.colors.push(new THREE.Color(0,0,0),new THREE.Color(1,0,0)),e.position.copy(this.point),e}},View3=f.unit({unitName:"View3",ename:"view-3",enableGrid:!1,enableRender:!0,enableWireframe:!1,enableRaycast:!0,enableStencil:!0,enableFXAA:!0,enableBloom:!0,renderTarget:null,clearColor:"#f4f4f4",focusThetaMin:.5,focusThetaMax:2.2,focusDistance:1,focusDuration:500,stencilRaycastMask:-1,stencilNone:{value:1,params:{}},stencilLit:{value:2,params:{drawColor:"#00f0ff",drawAlpha:1,lineAlpha:.11,lineAngle:0,edgeAlpha:.8,fillAlpha:.2}},stencilHover:{value:4,params:{drawColor:"#00ffb3",drawAlpha:1,lineAlpha:.2,lineAngle:0,edgeAlpha:.8,fillAlpha:.11}},stencilSelect:{value:8,params:{drawColor:"#00FF77",drawAlpha:1,lineAlpha:.4,lineAngle:0,edgeAlpha:.9,fillAlpha:.2}},init:function(e){for(var t in e)this[t]=e[t];this.element=dom.div("view-3",this.eroot),this.events=new EventEmitter,this.scene=new THREE.Scene,this.ambLight=new THREE.AmbientLight(16777215,.2),this.dirLight=new THREE.DirectionalLight(16777215,1),this.camera=new THREE.PerspectiveCamera(30),this.orbit=new THREE.OrbitControls(this.camera,this.element),this.raycaster=new THREE.Raycaster,this.root=new THREE.Object3D,this.grid=new THREE.Object3D,this.lastcam=new THREE.Matrix4,this.animatedConnections=[],this.scene.autoUpdate=!1,this.mouse=new THREE.Vector2(1/0,1/0),this.mouse2=new THREE.Vector3,this.mouse3=new THREE.Vector3,this.updatePointer(),this.renderer||(this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.autoClear=!1,this.renderer.clear(),dom.append(this.element,this.renderer.domElement)),this.srScene=new THREE.Scene,this.srPlane=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2)),this.srCamera=new THREE.OrthographicCamera(-1,1,1,-1,-1,1),this.srCamera.updateProjectionMatrix(),this.srScene.add(this.srPlane),this.smCopy=this.makeShader(THREE.CopyShader),this.smFill=this.makeShader(THREE.FillShader),this.smOverlay=this.makeShader(THREE.OverlayShader),this.smHBlur=this.makeShader(THREE.HorizontalBlurShader),this.smVBlur=this.makeShader(THREE.VerticalBlurShader),this.smFXAA=this.makeShader(THREE.FXAAShader),this.clearButton=dom.div("view-clear out-02 hand",this.element),Atlas.set(this.clearButton,"i-cross","absmid"),new EventHandler(this.events.will("view_clear")).listen("tap",this.clearButton),this.transform=new THREE.TransformControls(this.camera,this.element),this.transform.addEventListener("change",f.binds(this.onTransformControlsChange,this)),this.projector=new PointProjector(this.camera),this.markers=new UI.MarkerSystem({eroot:this.element,projector:this.projector}),this.markers.events.on("marker_tap",this.onMarkerTap,this),this.markers.markersVisible.events.on("change",function(e){this.needsRedraw=!0},this),this.wireMaterial=new THREE.MeshBasicMaterial({wireframe:!0,color:0}),this.debugBox=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:16711935,transparent:!0,opacity:.2})),this.debugBox.visible=!1,this.cameraTween=new TWEEN.Tween({x:0,y:0,z:0}).easing(TWEEN.Easing.Cubic.Out),this.orbitTween=new TWEEN.Tween({x:0,y:0,z:0}).easing(TWEEN.Easing.Cubic.Out),this.makeGridSystem(),this.makePreloader(),this.dirLight.position.set(-100,100,100),this.dirLight.target.position.set(0,0,0),this.camera.position.set(1,1,1),this.treeBox=new THREE.Box3,this.treeCenter=new THREE.Vector3,this.treeSize=new THREE.Vector3,this.treeLength=1,this.focusOnTree(0),this.root.add(this.ambLight),this.root.add(this.dirLight),this.scene.add(this.root),this.scene.add(this.grid),this.scene.add(this.transform),new EventHandler(this.onMouseMove,this).listen("mousemove",this.element),new EventHandler(this.onMouseOut,this).listen("mouseout",this.element),new EventHandler(this.onTap,this).listen("tap",this.element)},makeShader:function(e){if(e)return new THREE.ShaderMaterial({vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:THREE.UniformsUtils.clone(e.uniforms)})},makeGrid:function(){for(var e=10,t=200,n=new THREE.Color(3355443),i=new THREE.Color(12303291),o=2*e/t,s=[],r=[],a=-t,l=0,h=-e;a<=t;a++,h+=o){s.push(-e,0,h,e,0,h),s.push(h,0,-e,h,0,e);var c=a%10===0?n:i;c.toArray(r,l),l+=3,c.toArray(r,l),l+=3,c.toArray(r,l),l+=3,c.toArray(r,l),l+=3}var u=new THREE.BufferGeometry;u.addAttribute("position",new THREE.Float32BufferAttribute(s,3)),u.addAttribute("color",new THREE.Float32BufferAttribute(r,3));var d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});return d.transparent=!0,new THREE.LineSegments(u,d)},makeGridSystem:function(){this.gridXZ=this.makeGrid(),this.gridXY=this.makeGrid(),this.gridYZ=this.makeGrid(),this.gridXZ.normal=new THREE.Vector3(0,1,0),this.gridXY.normal=new THREE.Vector3(0,0,1),this.gridYZ.normal=new THREE.Vector3(1,0,0),this.grid.add(this.gridXZ),this.grid.add(this.gridXY),this.grid.add(this.gridYZ),this.gridXY.rotation.x=Math.PI/2,this.gridYZ.rotation.z=Math.PI/2},makePreloader:function(){this.preloaderBox=dom.div("view-preloader-box absmid out-03 hidden",this.element),this.preloaderBlocks=[];for(var e=0;e<10;e++)this.preloaderBlocks.push(dom.div("view-preloader-block",this.preloaderBox))},setLoading:function(e){this.preloaderEnabled!==!!e&&(this.preloaderEnabled=!!e,dom.togclass(this.preloaderBox,"hidden",!e))},setProgress:function(e){if(this.preloaderProgress!==e){this.preloaderProgress=e;for(var t=this.preloaderBlocks.length,n=f.clamp(e,0,1)*t,i=Math.floor(n),o=n-i,s=0;s<t;s++)this.preloaderBlocks[s].style.opacity=s<i?1:s>i?0:o}},setPreloader:function(e){this.preloaderSamples=e,this.updatePreloader()},updatePreloader:function(){var e=1,t=this.preloaderSamples&&this.preloaderSamples.length;if(t){e=0;for(var n=0;n<t;n++)e+=this.preloaderSamples[n].progress;e/=t}this.setProgress(e),this.setLoading(e<1),e>=1&&delete this.preloaderSamples},updateLights:function(){this.dirLight.position.copy(this.camera.position)},updateGrid:function(){if(this.enableGrid){this.raycaster.setFromCamera({x:0,y:0},this.camera);var e=this.raycaster.ray.direction,t=e.dot(this.gridXZ.normal),n=e.dot(this.gridXY.normal),i=e.dot(this.gridYZ.normal);this.gridXZ.material.opacity=Math.abs(t),this.gridXY.material.opacity=Math.abs(n),this.gridYZ.material.opacity=Math.abs(i)}},orbitTo:function(e,t,n,i){var o=1e-9,s=this.camera.position,r=this.orbit.target;e||(e=r);var a=new THREE.Vector3,l=new THREE.Vector3,h=new THREE.Matrix4,c=s.distanceTo(r),u=this.orbit.minDistance,d=this.orbit.maxDistance,p=f.clamp(isNaN(n)?c:n,u,d);a.subVectors(s,r),a.lengthSq()||a.set(1,1,1),a.setLength(p);var m=Math.acos(a.y/p),v=Math.max(this.focusThetaMin,this.orbit.minPolarAngle),g=Math.min(this.focusThetaMax,this.orbit.maxPolarAngle),b=f.clamp(isNaN(i)?m:i,v,g);if(this.orbit.orthoMode&&(b=m),Math.abs(b-m)>o){var w=l;w.set(-a.z,0,a.x).normalize(),h.makeRotationAxis(w,m-b),a.applyMatrix4(h)}l.addVectors(e,a),this.orbitTween.stop(),this.cameraTween.stop(),t?(r.distanceToSquared(e)>o&&this.orbitTween.from(r).to(e,t).start(),s.distanceToSquared(l)>o&&this.cameraTween.from(s).to(l,t).start()):(s.copy(l),r.copy(e),this.orbit.update())},zoom:function(e,t){this.orbit.dollyIn(e),this.orbit.update(),this.needsRedraw=!0},focusOnTree:function(e){null==e&&(e=this.focusDuration);var t=this.getFitDistance(this.treeSize,1.5,1.5);this.orbitTo(this.treeCenter,e,t)},focusOnNode:function(e,t){isNaN(t)&&(t=this.focusDuration),this.orbitTo(e.localCenter,t)},getFitDistance:function(e,t,n){null==e&&(e=this.treeSize),null==t&&(t=1.5),null==n&&(n=1.5);var i=this.camera.fov*f.xrad/2,o=this.camera.aspect,s=Math.max(e.x,e.y,e.z)/2,r=s*(t||1)/Math.tan(i*o),a=s*(n||1)/Math.tan(i);return o?Math.max(r,a):a},lookAt:function(){},setTree:function(e){this.selectNode(null),this.hoverNode(null),this.tree&&(this.root.remove(this.tree.object),this.tree.events.off(null,null,this)),this.tree=e,this.tree&&(this.root.add(this.tree.object),this.tree.traverse(this.updateNodeStencil,this),this.tree.events.on("connect_start",this.onConnectStart,this)),this.animatedConnections.forEach(this.onConnectEnd,this),this.updateTreeSize(),this.updateProjection(),this.updateConnectionTree(),this.focusOnTree(),this.needsRetrace=!0,this.needsRedraw=!0},onConnectStart:function(e){var t=this.animatedConnections.indexOf(e);t===-1&&(this.animatedConnections.push(e),e.events.on("connect_end",this.onConnectEnd,this))},onConnectEnd:function(e){var t=this.animatedConnections.indexOf(e);t!==-1&&(e.events.off(null,null,this),this.animatedConnections.splice(t,1))},updateTreeSize:function(){this.tree?(this.treeBox.makeEmpty(),this.tree.traverseConnections(function(e){e.connected&&e.master&&e.transitionProgress(1)},this),this.tree.object.updateMatrixWorld(),this.tree.traverse(function(e){e.updateBox(),this.treeBox.union(e.localBox)},this),this.tree.traverseConnections(function(e){e.connected&&e.master&&e.onTweenUpdate()},this),this.treeBox.getCenter(this.treeCenter),this.treeBox.getSize(this.treeSize),this.treeLength=this.treeSize.length()):(this.treeBox.makeEmpty(),this.treeCenter.set(0,0,0),this.treeSize.set(1,1,1).normalize(),this.treeLength=1),this.debugBox.position.copy(this.treeCenter),this.debugBox.scale.copy(this.treeSize)},updateConnectionTree:function(){var e=this.markers.markers.slice();this.tree&&this.tree.traverseConnections(this.updateConnection,this,e);for(var t=0;t<e.length;t++)this.markers.removeMarker(e[t])},updateConnection:function(e,t){if(e.marker){this.markers.addMarker(e.marker);var n=t.indexOf(e.marker);n!==-1&&t.splice(n,1)}e.animating&&this.onConnectStart(e)},updateProjection:function(){this.camera.aspect=this.width/this.height;var e=this.getFitDistance(this.treeSize,1.5,1.5);this.camera.far=Math.max(this.orbit.radius+2*this.treeLength,2*e),this.camera.near=Math.max(this.orbit.radius-2*this.treeLength,.01*e),this.camera.updateProjectionMatrix(),this.projector.updateMatrices()},onTransformControlsChange:function(){var e=this.transformConnection;e&&(e.updateControl(),this.updateConnectionTree()),this.needsRedraw=!0},onKey:function(e){if(e.ctrlKey||e.shiftKey||e.altKey);else if(kbd.down&&kbd.changed)switch(kbd.key){case"1":return this.transform.setMode("translate");case"2":return this.transform.setMode("rotate");case"3":return this.transform.setMode("scale");case"q":return this.transform.setSpace("local");case"w":return this.transform.setSpace("world");case"x":return this.debug=!this.debug,this.enableWireframe=this.debug,this.needsRedraw=!0,this.debugBox.visible=this.debug,dom.togclass(this.markers.element,"debug",this.debug),this.markers.debug=this.debug,void this.markers.update(!0);case"s":return this.verbose=!this.verbose,this.markers.verbose=this.verbose,void this.markers.update(!0);case"z":return this.enableRender=!this.enableRender,void(this.needsRedraw=!0);case"c":return void this.focusOnTree();case"g":return this.enableGrid=!this.enableGrid,void(this.needsRedraw=!0)}},setViewport:function(e){this.viewport=e,this.onResize()},updateConnectionType:function(e,t){console.log(e.marker)},setConnectionTypes:function(e){this.tree&&this.tree.traverseConnections(this.updateConnectionType,this,e)},updateMeshStencil:function(e,t){e.stencilValue=t},updateNodeStencil:function(e){var t=e.selected?this.stencilSelect.value:e.hovered?this.stencilHover.value:e.lit?this.stencilLit.value:this.stencilNone.value;e.sample.traverse(e.sampleObject,this.updateMeshStencil,this,t)},selectConnection:function(e){(!e||e.inactive.value||e.connected)&&(e=null);var t=this.selectedConnection;t!==e&&(t&&(t.selected=!1,t.marker.updateState()),this.selectedConnection=e,e&&(e.selected=!0,e.marker.updateState()),this.events.emit("connection_select",e))},selectNode:function(e){var t=this.nodeSelected;e!==t&&(t&&(t.selected=!1,this.updateNodeStencil(t)),this.nodeSelected=e,e&&(e.selected=!0,this.updateNodeStencil(e)),this.events.emit("node_select",[e,t]),this.needsRedraw=!0)},hoverNode:function(e){var t=this.nodeHovered;e!==t&&(t&&(t.hovered=!1,this.updateNodeStencil(t)),this.nodeHovered=e,e&&(e.hovered=!0,this.updateNodeStencil(e)),dom.togclass(this.element,"hand",!!e),this.events.emit("node_hover",[e,t]),this.needsRedraw=!0)},updatePointer:function(e){this.fpvEnabled?(this.mouse.x=this.width/2,this.mouse.y=this.height/2,this.mouse2.x=0,this.mouse2.y=0):(e&&(this.mouse.x=e.pageX-this.elementOffset.x,this.mouse.y=e.pageY-this.elementOffset.y),this.mouse2.x=this.mouse.x/this.width*2-1,this.mouse2.y=2*-(this.mouse.y/this.height)+1),this.mouse2.z=-1},retrace:function(){if(this.enableRaycast&&this.tree){this.projector.viewportToWorld(this.mouse2,this.mouse3,!0),this.raycaster.setFromCamera(this.mouse2,this.camera);for(var e=this.raycaster.intersectObject(this.scene,!0),t=0;t<e.length;t++){var n=e[t].object;if(n.stencilValue&this.stencilRaycastMask)return void this.hoverNode(n.node)}this.hoverNode(null)}},onMouseMove:function(e){this.updatePointer(e),this.needsRetrace=!0},onMouseOut:function(e){this.mouse.x=1/0,this.mouse.y=1/0,this.updatePointer(),this.needsRetrace=!0},onTap:function(e){e.target===this.element&&(this.transformConnection?(this.transformConnection.detachControl(),this.transformConnection=null,this.updateConnectionTree(),this.needsRedraw=!0):this.selectConnection(null),this.selectNode(this.nodeHovered))},onMarkerTap:function(e){var t=e.connection;t&&(kbd.state.CTRL?(this.transformConnection=t,this.transformConnection.attachControl(this.transform),this.needsRedraw=!0):this.selectConnection(t))},resizeRenderTargets:function(e,t){this.rtStencil=new THREE.WebGLRenderTarget(e,t,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),this.rt1=this.rtStencil.clone(),this.rt2=this.rtStencil.clone()},resizeShaders:function(e,t){var n=1/e,i=1/t;this.smOverlay&&this.smOverlay.uniforms.resolution.value.set(n,i),this.smFXAA&&this.smFXAA.uniforms.resolution.value.set(n,i),this.smVBlur&&(this.smVBlur.uniforms.v.value=i),this.smHBlur&&(this.smHBlur.uniforms.h.value=n)},onResize:function(){this.width=this.element.offsetWidth||1,this.height=this.element.offsetHeight||1,this.elementOffset=dom.offset(this.element),this.projector.resize(this.width,this.height),this.viewport||(this.renderer.setSize(this.width,this.height),this.resizeRenderTargets(this.width,this.height),this.resizeShaders(this.width,this.height)),this.updateProjection(),this.needsRetrace=!0,this.needsRedraw=!0},draw:function(){function e(){var e=d;d=u,u=e}function t(){r?(a.setViewport(r.x,r.y,r.w,r.h),a.setScissor(r.x,r.y,r.w,r.h),a.setScissorTest(!0)):a.setScissorTest(!1)}function n(e,n,i){n||(n=h),i||(i=c),t(),a.render(n,i,e)}function i(e,n,i,o){t(),e?a.clearTarget(e,n,i,o):a.clear(n,i,o)}function o(e,t,n){for(var i in n){var o=e.uniforms[i];if(o){var s=n[i];o.value instanceof THREE.Color?o.value.set(s):o.value=s}}t&&(e.uniforms.tDiffuse.value=t.texture),l.material=e}var s=this.renderer.context,r=this.viewport,a=this.renderer,l=this.srPlane,h=this.srScene,c=this.srCamera,u=this.rt1,d=this.rt2;if(this.renderer.setClearColor(this.clearColor),i(this.renderTarget),this.enableRender&&(this.grid.visible=!1,this.root.visible=!0,n(this.renderTarget,this.scene,this.camera)),this.enableGrid&&(this.grid.visible=!0,this.root.visible=!1,n(this.renderTarget,this.scene,this.camera)),this.enableWireframe&&(this.scene.overrideMaterial=this.wireMaterial,n(this.renderTarget,this.scene,this.camera),this.scene.overrideMaterial=null),this.enableStencil&&this.smFill&&this.smCopy&&this.smOverlay){s.enable(s.STENCIL_TEST),s.stencilOp(s.KEEP,s.KEEP,s.REPLACE),THREE.Object3D.prototype.stencilWrite=!0,this.scene.overrideMaterial=this.smFill,i(this.rtStencil),n(this.rtStencil,this.scene,this.camera),this.scene.overrideMaterial=null,THREE.Object3D.prototype.stencilWrite=!1,this.renderer.setClearColor(0,0),i(d),i(u),s.disable(s.DEPTH_TEST),s.stencilOp(s.KEEP,s.KEEP,s.KEEP);for(var p=[this.stencilLit,this.stencilHover,this.stencilSelect],f=0;f<p.length;f++){var m=p[f];s.stencilFunc(s.EQUAL,m.value,255),o(this.smFill),this.renderer.setClearColor(0,1),i(this.rtStencil,!0,!0,!1),n(this.rtStencil),s.stencilFunc(s.ALWAYS,0,255),o(this.smOverlay,this.rtStencil,m.params),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE),n(u),s.disable(s.BLEND)}this.enableFXAA&&this.smFXAA&&(o(this.smFXAA,u),n(d),e()),this.enableBloom&&this.smVBlur&&this.smHBlur&&(o(this.smVBlur,u),n(d),o(this.smHBlur,d),s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),n(),s.disable(s.BLEND)),s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),o(this.smCopy,u),n(),s.disable(s.BLEND),s.disable(s.STENCIL_TEST),s.enable(s.DEPTH_TEST)}},onTick:function(e){this.preloaderSamples&&this.updatePreloader(),this.orbit.autoRotate&&(this.orbit.update(),this.needsRedraw=!0),this.transform.update(),this.animatedConnections.length&&(this.needsRedraw=!0,this.needsRetrace=!0),this.orbitTween.playing&&(this.orbit.target.x+=this.orbitTween.delta.x,this.orbit.target.y+=this.orbitTween.delta.y,this.orbit.target.z+=this.orbitTween.delta.z),this.cameraTween.playing&&(this.camera.position.x+=this.cameraTween.delta.x,this.camera.position.y+=this.cameraTween.delta.y,this.camera.position.z+=this.cameraTween.delta.z),(this.orbitTween.playing||this.cameraTween.playing)&&(this.camera.lookAt(this.orbit.target),this.orbit.update(),this.needsRedraw=!0),(this.orbitTween.ended||this.cameraTween.ended)&&this.orbit.update(),this.orbit.radiusChanged&&(this.orbit.radiusChanged=!1,this.updateProjection()),this.camera.updateMatrixWorld(),this.lastcam.equals(this.camera.matrixWorld)||(this.lastcam.copy(this.camera.matrixWorld),this.projector.updateMatrices(),this.updateLights(),this.updateGrid(),this.needsRetrace=!0,this.needsRedraw=!0),this.needsRetrace&&(this.needsRetrace=!1,this.scene.updateMatrixWorld(!0),this.retrace()),this.needsRedraw&&(this.needsRedraw=!1,this.draw(),this.projector.update(),this.markers.update())}}),THREE.Object3D.prototype.stencilWrite=!1,THREE.Object3D.prototype.onBeforeRender=function(e,t,n,i,o,s){if(this.stencilWrite){var r=e.context;r.stencilFunc(r.ALWAYS,+this.stencilValue||0,255)}},THREE.Object3D.prototype.onAfterRender=function(e,t,n,i,o,s){},TNode=f.unit({unitName:"TNode",init:function(e){this.id=++TNode.count,this.object=new THREE.Object3D,this.events=new EventEmitter,this.localBox=new THREE.Box3,this.localCenter=new THREE.Vector3,this.localSize=new THREE.Vector3,this.localLength=1,this.localSphere=new THREE.Sphere,this.objectCenter=new THREE.Object3D,this.connections=[],this.object.add(this.objectCenter),e?this.setSample(e):console.warn("new TNode with no sample")},traverse:function(e,t,n){var i=e.call(t||this,this,n);if(i===TNode.TRSTOP)return i;for(var o=0;o<this.connections.length;o++){var s=this.connections[o];if(s.connected&&s.master){var i=s.target.traverse(e,t,n);if(i===TNode.TRSTOP)return i}}},traverseConnections:function(e,t,n,i){null==i&&(i=0);for(var o=0;o<this.connections.length;o++){var s=this.connections[o];e.call(t||this,s,n,i),s.connected&&s.master&&s.target.traverseConnections(e,t,n,i+1)}},includeConnection:function(e,t){if(t&&t.list){for(var n in t.test){var i=t.test[n],o=e[n];if(t.binary?!o!=!i:o!==i)return}t.list.push(e)}},retrieveConnections:function(e,t){var n=[];return this.traverseConnections(this.includeConnection,this,{test:e,binary:t,list:n}),n},setSample:function(e){if(this.sample)return console.warn("TN.setSample: node already has sample");var t=e.clone();return t?(this.sample=e,this.type=e.src,this.sampleObject=t,this.sample.traverse(this.sampleObject,this.setObjectParent,this),this.sample.box.getCenter(this.objectCenter.position),this.object.add(this.sampleObject),this.connections=[],void e.joints.forEach(this.addConnection,this)):console.warn("TN.setSample: got no sample object")},setObjectParent:function(e){e.node=this},addConnection:function(e){var t=new TConnection(this,e,this.connections.length);t.events.link(this.events),this.connections.push(t)},remConnection:function(){},getConnectedList:function(){for(var e=[],t=0;t<this.connections.length;t++){var n=this.connections[t];n.connected&&e.push(n.connected)}return e},canBeReplacedBy:function(e){if(!e||this.sample===e)return!1;for(var t=[],n=0;n<this.connections.length;n++){var i=this.connections[n];i.connected&&t.push(i.connected.joint)}if(!t.length)return!0;var o=e.joints.slice();e:for(var n=0;n<t.length;n++){for(var s=t[n],r=o.length-1;r>=0;r--){var a=o[r];if(s.canConnect(a)){o.splice(r,1);continue e}}return!1}return!0},replace:function(e){for(var t=this,n=e.getConnectedList(),i=0;i<n.length;i++){var o=n[i],s=o.node,r=o.master;o.disconnect();for(var a=0;a<t.connections.length;a++){var l=t.connections[a];if(!l.connected&&o.canConnect(l)){r?s.connect(o.index,t,l.index):t.connect(l.index,s,o.index);break}}}},pinch:function(){var e=[],t=[],n=f.follow(this,"upnode").pop();n.traverse(function(t){e.push(t.id)}),this.traverse(function(e){t.push(e.id)});for(var i=f.snot(e,t),o=n,s=this,r=0;r<this.connections.length;r++){var a=this.connections[r];if(a.connected&&a.master){var l=a.connected.node,h=[];l.traverse(function(e){h.push(e.id)}),h.length>i.length&&(s=n,i=h,o=l)}}return{root:s,nodes:f.snot(e,i),nextRoot:o}},pinchr:function(){var e=[];return this.traverse(function(t){e.push(t.id)}),{root:this,nodes:e,nextRoot:null}},connect:function(e,t,n){if(!t)return console.warn("TN.connect to undefined node");if(t===this)return console.error("TN.connect to itself");var i=this.connections[e],o=t.connections[n];return i&&o?i.connected||o.connected?console.warn("TN.connect to used joint"):(t.events.link(this.events),void i.connect(o)):console.warn("TN.connect with undefined joint")},disconnect:function(){for(var e=0;e<this.connections.length;e++){var t=this.connections[e];t.connected&&t.disconnect()}this.upnode&&this.events.unlink(this.upnode.events)},destroy:function(){for(var e=0;e<this.connections.length;e++){var t=this.connections[e];t.destroy()}},rotate:function(e){this.upcon?this.upcon.rotate(e):this.object.rotateOnAxis(this.object.up,e)},getRotation:function(){},updateBox:function(){this.sample?this.localBox.copy(this.sample.box).applyMatrix4(this.object.matrixWorld):this.localBox.makeEmpty(),this.localBox.getSize(this.localSize),this.localCenter.copy(this.sample.boxCenter).applyMatrix4(this.object.matrixWorld),this.localLength=this.localSize.length()}}),TNode.count=0,TNode.TRSTOP={},TConnection=f.unit({unitName:"TConnection",init:function(e,t,n){this.node=e,this.index=n,this.target=null,this.master=null,this.connected=null,this.selected=!1,this.inactive=new Gate(Gate.AND,!1),this.events=new EventEmitter,this.object=new THREE.Object3D,this.joint=t.clone(),this.depth=parseFloat(this.joint.depth)||0,this.screw="screw"===this.joint.extra,this.makeTween(),this.marker=new UI.Marker({connection:this}),this.objectInner=new THREE.Object3D,this.objectOuter=new THREE.Object3D,this.node.object.add(this.objectInner),this.node.object.add(this.objectOuter),this.updatePosition()},updatePosition:function(){this.objectInner.position.copy(this.joint.point),this.objectOuter.position.copy(this.joint.normal).setLength(this.depth).add(this.joint.point)},makeTween:function(){this.tween=new TWEEN.Tween({connected:1}).to({connected:1},1e3).easing(TWEEN.Easing.Linear.None).onStart(this.onTweenStart,this).onUpdate(this.onTweenUpdate,this).onComplete(this.onTweenComplete,this)},onTweenStart:function(){},onTweenUpdate:function(){this.transitionProgress(this.tween.source.connected)},onTweenComplete:function(){this.animating=!1,this.events.emit("connect_end",this)},transitionStageDuration:{approachDelay:100,approachTime:1200,screwDelay:100,screwTime:1200},getTransitionStages:function(){if(!this.connected||!this.master)return[0];var e=this.depth+this.connected.depth,t=this.transitionStageDuration;return e>0?[t.approachDelay,t.approachTime,t.screwDelay,t.screwTime]:[t.approachDelay,t.approachTime]},transitionProgress:function(e){if(this.connected&&this.master){var t=this.getTransitionStages(),n=-1,i=0,o=t.reduce(f.sum),s=Math.max(0,Math.min(1,e))*o;if(o){for(var r=TWEEN.Easing.Cubic.InOut,a=0;a<t.length;a++){var l=t[a];if(s<=l){n=a,i=r(s/l);break}s-=l}var h=this.depth,c=this.connected.depth,u=h&&c?Math.min(h,c):h+c,u=h+c,d=this.screw||this.connected.screw?2*Math.PI:0,p=(this.node.sample.boxLength+this.connected.node.sample.boxLength)/4,m=0,v=0;switch(n){case-1:return;case 0:m=u+p,v=d;break;case 1:m=u+p*(1-i),v=d;break;case 2:m=u,v=d;break;case 3:m=u*(1-i),v=d*(1-i)}this.connected.object.position.copy(this.joint.normal).setLength(m),this.object.quaternion.setFromAxisAngle(this.joint.normal,v)}}},playConnection:function(e,t){if(this.connected&&this.master){this.animating=!0,this.events.emit("connect_start",this);var n=this.getTransitionStages().reduce(f.sum);isNaN(t)||(n*=t),null==e?(this.tween.source.connected=0,this.tween.target.connected=1):(this.tween.source.connected=+!e,this.tween.target.connected=+e),this.onTweenUpdate(),this.tween.duration(n).start()}},getPosition:function(e){return e||(e=new THREE.Vector3),e.setFromMatrixPosition(this.objectOuter.matrixWorld),e},getInnerPosition:function(e){return e||(e=new THREE.Vector3),e.setFromMatrixPosition(this.objectInner.matrixWorld),e},canConnect:function(e){return this.joint.canConnect(e.joint)},canConnectList:function(e){return e.filter(this.canConnect,this)},connect:function(e){if(!this.connected){var t=new THREE.Vector3,n=this,i=e;t.copy(i.joint.normal).negate(),n.node.object.add(n.object),n.object.position.copy(n.joint.point),n.object.add(i.object),i.object.position.set(0,0,0),i.object.quaternion.setFromUnitVectors(t,n.joint.normal),i.object.rotateOnAxis(t,-n.joint.up.angleTo(i.joint.up)),i.object.add(i.node.object),i.node.object.position.copy(i.joint.point).negate(),n.connected=i,n.target=i.node,n.master=!0,i.connected=n,i.target=n.node,i.node.upcon=i,i.node.upnode=n.node,i.master=!1,n.events.emit("connect",[n,i]),i.events.emit("connect",[i,n])}},disconnect:function(){if(this.connected){var e=this.master?this:this.connected,t=this.master?this.connected:this;e.object.remove(t.object),e.connected=null,e.target=null,e.master=null,t.connected=null,t.target.upcon=null,t.target.upnode=null,t.target=null,t.master=null,e.events.emit("disconnect",[e,t]),t.events.emit("disconnect",[t,e])}},rotate:function(e){this.connected&&(this.master?this.connected.rotate(e):this.object.rotateOnAxis(this.joint.normal,e))},getRotation:function(){},destroy:function(){this.marker.destroy()},attachControl:function(e){e&&(this.control=e,this.controlObject=new THREE.Object3D,this.joint.matrix.decompose(this.controlObject.position,this.controlObject.rotation,this.controlObject.scale),this.node.object.add(this.controlObject),e.attach(this.controlObject))},updateControl:function(){if(this.controlObject){this.joint.setFromMatrix(this.controlObject.matrix),this.updatePosition();var e=this.connected;e&&(this.master?this.connect(e):e.connect(this))}},detachControl:function(){this.control&&(this.control.detach(),this.node.object.remove(this.controlObject),delete this.controlObject,delete this.control)}}),TSerial={round:function(e){return f.pround(e,9)},toJSON:function(e){var t=[],n=[],i=[],o=[];e.traverse(function(e){var s=t.indexOf(e.sample.src);s===-1&&(s=t.length,t.push(e.sample.src)),n.push(s),i.push(e),o.push(e.upcon)});for(var s=[],r=1;r<i.length;r++){var a=o[r];s.push({t:n[r],a:i.indexOf(a.connected.node),ai:a.connected.index,bi:a.index,r:(new THREE.Vector3).copy(a.object.rotation).toArray().map(TSerial.round)})}return{types:t,nodes:s}},fromJSON:function(e,t,n){var i=TSerial.prepareSamples(e.types,t);return Defer.all(i.map(f.func("load"))).then(function(){return TSerial.constructJSON(e,i,n)})},prepareSamples:function(e,t){return e.map(function(e){return f.apick(t.samples,"src",e)||t.addSample({src:e})})},constructJSON:function(e,t,n){var i=new TNode(t[0]);
if(e&&e.nodes){for(var o=[i],s=0;s<e.nodes.length;s++){var r=e.nodes[s];o.push(new TNode(t[r.t]))}for(var s=0;s<e.nodes.length;s++){var r=e.nodes[s],a=o[r.a],l=o[s+1],h=a.connections[r.ai],c=l.connections[r.bi];a.connect(r.ai,l,r.bi),r.r&&c.object.rotation.fromArray(r.r),n&&h.playConnection()}}return i},toString:function(e){function t(e,t){for(d|=t<<p,p+=e;p>7;)u+=String.fromCharCode(255&d),d>>=8,p-=8}function n(){t(8-p,0)}for(var i=e.types.length,o=e.nodes.length,s=0,r=0;r<e.nodes.length;r++){var a=e.nodes[r];s=Math.max(s,a.ai,a.bi)}var l=Math.ceil(Math.log2(i)),h=Math.ceil(Math.log2(o+1)),c=Math.ceil(Math.log2(s+1)),u="",d=0,p=0;t(16,i);for(var r=0;r<i;r++){var f=e.types[r];t(16,f.length);for(var m=0;m<f.length;m++)t(8,f.charCodeAt(m))}t(16,s),t(16,o);for(var r=0;r<o;r++){var a=e.nodes[r];t(l,a.t),t(h,a.a),t(c,a.ai),t(c,a.bi)}return n(),btoa(u)},fromString:function(e){function t(e){for(;s<e;)i|=n.charCodeAt(o)<<s,s+=8,o++;var t=i&(1<<e)-1;return i>>=e,s-=e,t}for(var n=atob(e),i=0,o=0,s=0,r={types:[],nodes:[]},a=t(16),l=0;l<a;l++){for(var h=t(16),c="",u=0;u<h;u++)c+=String.fromCharCode(t(8));r.types.push(c)}for(var d=t(16),p=t(16),f=Math.ceil(Math.log2(a)),m=Math.ceil(Math.log2(p+1)),v=Math.ceil(Math.log2(d+1)),l=0;l<p;l++)r.nodes.push({t:t(f),a:t(m),ai:t(v),bi:t(v)});return r}},UI=f.unit({unitName:"UI"}),UI.MarkerSystem=f.unit(Block,{unitName:"UI_MarkerSystem",ename:"marker-system noselect",create:function(){this.markers=[],this.markersVisible=new Gate(Gate.AND,!1),this.markersVisible.events.on("change",this.onMarkersVisible,this)},onMarkersVisible:function(e){for(var t=0;t<this.markers.length;t++){var n=this.markers[t];n.undisposable||n.visible.set(e,"system")}},addMarker:function(e){var t=this.markers.indexOf(e);t===-1&&(this.markers.push(e),e.undisposable||e.visible.set(this.markersVisible.value,"system"),e.plug(this),e.updateState())},removeMarker:function(e){var t=this.markers.indexOf(e);t!==-1&&(this.markers.splice(t,1),e.unplug())},clear:function(){for(;this.markers.length;)this.removeMarker(this.markers[0])},update:function(e){e&&this.markers.forEach(f.func("updateState")),f.sort(this.markers,this.distanceSort,this),this.markers.forEach(this.updateMarker,this)},distanceSort:function(e){return-e.point.distance},updateMarker:function(e,t){e.element.style.zIndex=t,e.update()}}),UI.Marker=f.unit(Block.Tip,{unitName:"UI_Marker",ename:"marker hand",hidden:!0,align:"top",distance:100,arrowWidth:1,arrowPadding:-2,create:function(){dom.remclass(this.arrow,"tip-arrow"),dom.remclass(this.content,"tip-content"),dom.addclass(this.arrow,"marker-arrow"),dom.addclass(this.content,"marker-content marker-interactive out-02"),this.arrowLine=dom.div("marker-arrow-line marker-interactive out-02",this.arrow),this.elemGroup=dom.span("marker-group",this.content),this.elemInfo=dom.span("marker-info",this.content),dom.display(this.elemGroup,!1),dom.display(this.elemInfo,!1),this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.className.baseVal="marker-depth-line marker-interactive out-02",this.svgLine=document.createElementNS("http://www.w3.org/2000/svg","line"),this.svgLine.setAttribute("x1",0),this.svgLine.setAttribute("y1",0),this.svgLineShadow=document.createElementNS("http://www.w3.org/2000/svg","line"),this.svgLineShadow.className.baseVal="marker-depth-line-shadow",this.svgLineShadow.setAttribute("x1",1),this.svgLineShadow.setAttribute("y1",1),dom.append(this.svg,this.svgLineShadow),dom.append(this.svg,this.svgLine),dom.append(this.element,this.svg),this.state={hover:!1,selected:!1,connected:!1,inactive:!1,master:!1},this.connection&&(dom.html(this.elemInfo,"["+this.connection.index+"] "+this.connection.joint.name),this.connection.events.when({connect:this.updateState},this)),this.watchEvents.push(new EventHandler(this.onTap,this).listen("tap",this.element),new EventHandler(this.onEnter,this).listen("mouseenter",this.element),new EventHandler(this.onLeave,this).listen("mouseleave",this.element))},plug:function(e){this.system&&this.unplug(),this.system=e,this.system&&(this.tipRoot=this.system.element,this.point=this.system.projector.addPoint(),this.inner=this.system.projector.addPoint())},unplug:function(){this.system&&(dom.remove(this.element),this.system.projector.remPoint(this.point),this.system.projector.remPoint(this.inner),delete this.point,delete this.inner,delete this.tipRoot,delete this.system)},destroy:function(){Block.Tip.prototype.destroy.call(this),this.connection&&this.connection.events.off(null,null,this),this.unplug(),Atlas.free(this.elemGroup)},updateState:function(){if(this.connection){for(var e in this.state){var t=this.connection[e];this.state[e]=t instanceof Gate?t.value:t}this.state.connected?(this.align=this.state.master?"left":"right",this.distance=1e3):(this.align="top",this.distance=100),Atlas.free(this.elemGroup),dom.text(this.elemGroup,"");var n=this.connection.group,i=!isNaN(this.connection.group);i&&(n===-1?Atlas.set(this.elemGroup,"i-deny"):dom.text(this.elemGroup,String.fromCharCode(n+65))),dom.display(this.elemGroup,i),dom.setclass(this.element,this.state);var o=!1;o=!(!this.system||!this.system.verbose)||(this.system&&this.system.debug?!this.state.connected:i&&!this.state.connected),this.visible.set(o,"state")}},onEnter:function(){this.system&&this.system.events.emit("marker_enter",this)},onLeave:function(){this.system&&this.system.events.emit("marker_leave",this)},onTap:function(){this.system&&this.system.events.emit("marker_tap",this)},update:function(){if(this.system){this.connection&&(this.connection.getPosition(this.point.world),this.connection.getInnerPosition(this.inner.world)),this.system.projector.updatePoint(this.point),this.system.projector.updatePoint(this.inner);var e=this.visible.value||this.inTransition,t=Math.round(this.point.screen.x),n=Math.round(this.point.screen.y),i=this.inner.screen.x,o=this.inner.screen.y,s=i-t,r=o-n,a=e&&this.connection&&this.connection.depth&&!isNaN(s)&&!isNaN(r);if(dom.display(this.svg,a),e&&(this.scale=.7*(1.3-Math.min(.7,this.point.distance/1.5)),this.move(t,n,this.align),a)){var l=Math.ceil(Math.abs(s)),h=Math.ceil(Math.abs(r)),c=Math.max(l,h);this.svg.setAttribute("width",2*c+2),this.svg.setAttribute("height",2*c+2),this.svg.setAttribute("viewBox",[-c-1,-c-1,2*c+2,2*c+2].join(" ")),this.svg.style.marginLeft=-c-1+"px",this.svg.style.marginTop=-c-1+"px",this.svg.style.left=t-this.elementPoint.x+"px",this.svg.style.top=n-this.elementPoint.y+"px",this.svgLineShadow.setAttribute("x2",s+1),this.svgLineShadow.setAttribute("y2",r+1),this.svgLine.setAttribute("x2",s),this.svgLine.setAttribute("y2",r)}}},move:function(){Block.Tip.prototype.move.apply(this,arguments);var e=Math.max(0,this.lastDistance),t=this.arrowLine.style,n=this.arrowWidth+"px",i=e+"px";switch(t.left=t.right=t.top=t.bottom="auto",t.width=t.height=n,this.lastAlign){case"left":t.width=i,t.left="100%";break;case"right":t.width=i,t.right="100%";break;case"top":t.height=i,t.top="100%";break;case"bottom":t.height=i,t.bottom="100%"}}}),Plumber=f.unit({unitName:"Plumber",version:.02,mode:"constructor",explode:0,explodeStepped:!1,catchFiles:!1,catchSamples:!0,dirSamples:"",srcAtlas:"plumber-atlas.svg",srcCubemap:"plumber-cubemap.png",initFromHash:!1,init:function(e){console.log("PB version",this.version),this.get=new Loader,this.timer=new Timer(this.onTick,this),this.ready=new Defer,this.imagery=new Imagery,this.events=new EventEmitter,this.sampler=new Sampler,this.sampler.setImagery(this.imagery),this.connectionParts=[],this.renderer=new THREE.WebGLRenderer({alpha:!1,depth:!0,stencil:!0,antialias:!0,preserveDrawingBuffer:!0}),this.renderer.autoClear=!1,this.canvas=this.renderer.domElement,this.tiles=new TileView,this.element=this.tiles.element,this.view=new View3({renderer:this.renderer}),this.view2=new View3({renderer:this.renderer,enableStencil:!1,enableRaycast:!1}),this.viewTween=new TWEEN.Tween({position:1}).to({position:1},400).easing(TWEEN.Easing.Cubic.Out).onStart(this.onViewTweenStart,this).onUpdate(this.onViewTweenUpdate,this).onComplete(this.onViewTweenComplete,this),this.buttonRoot=dom.div("vp-button-root",this.element),this.explodeButton=new Block.Toggle({eroot:this.element,ename:"vp-button vp-button-explode out-01",eicon:"i-explode",title:"Exploded view"}),this.zoomInButton=new Block.Toggle({eroot:this.buttonRoot,ename:"vp-button vp-button-zoom-in out-01",reset:!0,eicon:"i-zoom-in",title:"Zoom in"}),this.zoomOutButton=new Block.Toggle({eroot:this.buttonRoot,ename:"vp-button vp-button-zoom-out out-01",reset:!0,eicon:"i-zoom-out",title:"Zoom out"}),this.zoomFitButton=new Block.Toggle({eroot:this.buttonRoot,ename:"vp-button vp-button-zoom-fit out-01",reset:!0,eicon:"i-zoom-fit",title:"Fit screen"}),this.screenshotButton=new Block.Toggle({eroot:this.buttonRoot,ename:"vp-button vp-button-screenshot out-01",reset:!0,eicon:"i-photo",title:"Screen shot"}),this.rotateButton=new Block.Toggle({eroot:this.buttonRoot,ename:"vp-button vp-button-rotate out-01",eicon:"i-autorotate",title:"Auto rotate"}),this.displayMenu=new Block.Menu({eroot:this.buttonRoot,ename:"vp-menu vp-menu-display",options:{factory:Block.Toggle,deselect:!1,ename:"vp-button"},items:[{data:"transparent",eicon:"i-dis-transparent",title:"Transparent view"},{data:"normal",eicon:"i-dis-normal",title:"Normal view"},{data:"wireframe",eicon:"i-dis-wireframe",title:"Wireframe view"}],active:1}),this.projectionMenu=new Block.Menu({eroot:this.buttonRoot,ename:"vp-menu vp-menu-projection",options:{factory:Block.Toggle,deselect:!1,ename:"vp-button"},items:[{data:"perspective",eicon:"i-prj-perspective",title:"Perspective"},{data:"left",eicon:"i-prj-left",title:"Left"},{data:"right",eicon:"i-prj-right",title:"Right"},{data:"top",eicon:"i-prj-top",title:"Top"},{data:"bottom",eicon:"i-prj-bottom",title:"Bottom"},{data:"front",eicon:"i-prj-front",title:"Front"},{data:"back",eicon:"i-prj-back",title:"Back"}],active:0}),this.explodeButton.events.on("change",this.onExplode,this),this.zoomInButton.events.on("change",this.onZoom,this,"in"),this.zoomOutButton.events.on("change",this.onZoom,this,"out"),this.zoomFitButton.events.on("change",this.onZoom,this,"fit"),this.screenshotButton.events.on("change",this.onScreenshot,this),this.rotateButton.events.on("change",this.onRotate,this),this.displayMenu.events.on("change",this.onDisplayChange,this),this.projectionMenu.events.on("change",this.onProjectionChange,this),this.splitViewMessage=dom.div("split-view-message"),dom.text(this.splitViewMessage,"no compatible connections"),this.splitViewMessageVisible=new Gate(Gate.AND,!0),this.splitViewMessageVisible.events.on("change",dom.display,dom,this.splitViewMessage),this.splitViewMessageVisible.events.on("opened",this.updateSplitViewMessagePosition,this),this.splitViewMessageVisible.off("g_svm_cons"),this.emptyViewMessage=dom.div("empty-view-message out-03 absmid");var t=dom.div("empty-view-message-center absmid",this.emptyViewMessage),n=dom.div("empty-view-message-frame absmid",this.emptyViewMessage),i=dom.div("empty-view-message-text absmid",this.emptyViewMessage);f.nop(t,n),dom.html(i,["please","add","any product"].join("<br/>")),this.emptyViewMessageVisible=new Gate(Gate.AND,!0),this.emptyViewMessageVisible.events.on("change",function(e){dom.togclass(this.emptyViewMessage,"hidden",!e)},this),this.makeDeletePrompt(),dom.addclass(this.element,"ontouchstart"in window?"touch":"no-touch"),dom.addclass(this.element,"plumber"),dom.addclass(this.canvas,"canvas-main"),dom.prepend(this.element,this.canvas),dom.append(this.element,this.splitViewMessage),dom.append(this.element,this.emptyViewMessage),dom.display(this.canvas,!1);for(var o in e)switch(o){case"eroot":dom.append(e.eroot,this.element);break;case"mode":this.mode=e.mode;break;case"dirSamples":this.sampler.folder=e.dirSamples;break;case"initFromHash":this.initFromHash=!!e.initFromHash;break;default:o in this&&(this[o]=e[o])}this.setMode(this.mode,!0),this.fetch()},setMode:function(e,t){if(this.mode!==e||t){this.mode=e;var n,i;switch(e){case"constructor":n=["h",0,0,1],i=[this.view,this.view2];break;default:console.warn("unknown mode given:",e,'fallback to "viewer"'),e="viewer";case"viewer":n=0,i=[this.view2]}if(this.modeis={ctr:"constructor"===e,vwr:"viewer"===e},dom.setclass(this.element,{"mode-constructor":this.modeis.ctr,"mode-viewer":this.modeis.vwr}),dom.display(this.view.clearButton,this.modeis.ctr),dom.display(this.view2.clearButton,this.modeis.ctr),dom.display(this.buttonRoot,this.modeis.vwr),this.clearTree(),this.view2.setTree(null),this.tiles.setLayout(n),this.tiles.setClients(i),this.splitView=this.tiles.splits[0],this.splitView){var o=this.splitView.position;this.viewTween.target.position=o,this.viewTween.source.position=o}this.splitViewMessageVisible.set(this.modeis.ctr,"g_svm_mode"),this.updateMarkerVisibility(),this.view.markers.markersVisible.set(!!this.modeis.ctr,"g_m_mode"),this.view2.markers.markersVisible.set(!!this.modeis.ctr,"g_m_mode"),this.onViewTweenUpdate(),this.onViewTweenComplete()}},onZoom:function(e){switch(e){case"in":this.view.zoom(1.5),this.view2.zoom(1.5);break;case"out":this.view.zoom(1/1.5),this.view2.zoom(1/1.5);break;case"fit":this.view.focusOnTree(),this.view2.focusOnTree()}},onRotate:function(e){this.view.orbit.autoRotate=e,this.view2.orbit.autoRotate=e},onDisplayChange:function(e){var t="transparent"===e,n="normal"===e,i="wireframe"===e;this.imagery.sampleMaterials.forEach(function(e){t?(e.__pl_display_set=!0,e.__pl_transparent=e.transparent,e.__pl_opacity=e.opacity,e.__pl_depthtest=e.depthTest,e.__pl_depthwrite=e.depthWrite,e.transparent=!0,e.opacity=.5,e.depthTest=!1,e.depthWrite=!1,e.needsUpdate=!0):e.__pl_display_set&&(e.transparent=e.__pl_transparent,e.opacity=e.__pl_opacity,e.depthTest=e.__pl_depthtest,e.depthWrite=e.__pl_depthwrite,delete e.__pl_transparent,delete e.__pl_opacity,delete e.__pl_depthtest,delete e.__pl_depthwrite,delete e.__pl_display_set,e.needsUpdate=!0)},this),this.view.enableRender=n||t,this.view.enableWireframe=i,this.view.needsRedraw=!0,this.view2.enableRender=n||t,this.view2.enableWireframe=i,this.view2.needsRedraw=!0},onProjectionChange:function(e){var t={perspective:[1,1,1],left:[-1,0,0],right:[1,0,0],top:[0,1,0],bottom:[0,-1,0],front:[0,0,1],back:[0,0,-1]},n="perspective"===e;this.view.camera.fov=n?30:.5,this.view.camera.updateProjectionMatrix(),this.view2.camera.fov=n?30:.5,this.view2.camera.updateProjectionMatrix(),this.view.camera.position.fromArray(t[e]).setLength(this.view.getFitDistance()).add(this.view.treeCenter),this.view2.camera.position.fromArray(t[e]).setLength(this.view2.getFitDistance()).add(this.view2.treeCenter),this.view.orbit.target.copy(this.view.treeCenter),this.view2.orbit.target.copy(this.view2.treeCenter),this.view.orbit.orthoMode=!n,this.view2.orbit.orthoMode=!n,this.view.orbit.update(),this.view2.orbit.update(),this.view.needsRedraw=!0,this.view2.needsRedraw=!0},onScreenshot:function(){var e=(new Date).toISOString().split(".")[0].replace(/:/g,".");this.canvas.toBlob(function(t){saveAs(t,"pb-screen-"+e+".jpg")},"image/jpeg",.95)},getConnectionsArray:function(){return this.tree.retrieveConnections({connected:!0},!0)},exportJSON:function(){return TSerial.toJSON(this.tree)},importJSON:function(e,t){return TSerial.fromJSON(e,this.sampler,t).then(this.absolutelySetMainTree,this)},exportString:function(){return TSerial.toString(this.exportJSON())},importString:function(e,t){return this.importJSON(TSerial.fromString(e),t)},replaceElement:function(e,t){var n=this.getSample(e);this.tree&&n?n.load().then(function(){this.replaceElementBySample(n,t)},function(t){this.events.emit("onReplaceElement",{status:"rejected",reason:"bad element: "+e})},this):this.events.emit("onReplaceElement",{status:"rejected",reason:n?"no tree":"bad sample"})},replaceElementBySample:function(e,t){function n(e){i([e])}function i(e){s.emit("onReplaceElement",{status:"replaced",nodes:e.map(f.prop("id"))})}function o(e){s.emit("onReplaceElement",{status:"rejected",reason:e})}var s=this.events;if(!this.tree||!e)return o(e?"no tree":"bad sample");switch(t){case-1:var r=[];if(this.tree.traverse(function(t){t.canBeReplacedBy(e)&&r.push(t)},this),r.length){var a=r.map(function(t){return this.replaceNode(t,e)},this);Defer.all(a).then(i,o)}else o("no suitable nodes");break;case 0:var r=[];switch(this.tree.traverse(function(t){t.lit=t.canBeReplacedBy(e),this.view.updateNodeStencil(t),t.lit&&r.push(t)},this),r.length){case 0:return void o("no suitable nodes");case 1:var l=r[0];l.lit=!1,this.view.updateNodeStencil(l),this.replaceNode(l,e,!0).then(n,o);break;default:this.issuedReplace=e,this.litModeStart()}break;default:var l=t instanceof TNode?t:this.getElementById(t);l?this.replaceNode(l,e,!0).then(n,o):o("invalid param: "+t)}this.view.needsRedraw=!0},litModeStart:function(){this.view.stencilRaycastMask=this.view.stencilLit.value|this.view.stencilHover.value|this.view.stencilSelect.value},litModeClear:function(){this.tree&&this.tree.traverse(function(e){e.lit=!1,this.view.updateNodeStencil(e)},this),this.view.needsRedraw=!0,this.view.stencilRaycastMask=-1},addElement:function(e,t,n){var i=this.getSample(t,n);i?this.displayFigure(i.src):this.events.emit("onAddElement",{status:"error",error:'bad element source: "'+t+'"'})},getSample:function(e,t){return f.apick(this.sampler.samples,"src",e)||this.sampler.addSample({src:e,link:t})},addFigure:function(e){},addComplex:function(e,t){if(t&&t.types)for(var n=0;n<t.types.length;n++);},fetch:function(){this.get.xml(this.srcAtlas).then(Atlas.setSource),this.get.image(this.srcCubemap).then(this.imagery.unwrapCubemap3x2,this.imagery),this.get.ready().then(this.run,this,null,!0)},makeDeletePrompt:function(){var e=new Block.Tip({tipRoot:this.element,align:"top",point:this.view.projector.addPoint(),hidden:!0});dom.addclass(e.element,"prompt");var t=dom.div("prompt-text",e.content),n=dom.div("prompt-button hand prompt-button-ok",e.content),i=dom.div("prompt-button hand prompt-button-cancel",e.content);dom.text(n,"Yes"),dom.text(i,"No"),e.watchEvents.push(new EventHandler(this.deleteNode,this).listen("tap",n),new EventHandler(this.closeDeletePrompt,this).listen("tap",i)),this.deletePromptTipText=t,this.deletePromptTip=e},makeGUI:function(){function e(){i.view.needsRedraw=!0,i.view2.needsRedraw=!0}function t(e){i.tree&&(i.tree.traverseConnections(f.func("transitionProgress",1-e)),i.view.needsRedraw=!0)}this.gui=new dat.GUI({hideable:!1});var n=["stencilLit","stencilHover","stencilSelect"];this.gui.closed=!0,this.gui.addColor(this.view,"clearColor").name("Clear").onChange(e),n.forEach(function(t){var n=this.gui.addFolder(t),i=this.view[t].params;n.addColor(i,"drawColor").onChange(e),n.add(i,"drawAlpha").min(0).max(1).onChange(e),n.add(i,"lineAlpha").min(0).max(1).onChange(e),n.add(i,"lineAngle").min(0).max(360).onChange(e),n.add(i,"edgeAlpha").min(0).max(1).onChange(e),n.add(i,"fillAlpha").min(0).max(1).onChange(e)},this),this.gui.add(this,"explode").min(0).max(1).name("Explode").onChange(t),this.gui.add(this,"explodeStepped").name("Explode Step");var i=this},onViewClear:function(){this.clear()},onViewClear2:function(){this.displayFigure(null),this.events.emit("onAddElement",{status:"canceled"})},clear:function(){this.displayFigure(null),this.view.setPreloader(null),this.view2.setPreloader(null),this.clearTree()},onViewTweenUpdate:function(){this.splitView&&(this.splitView.position=this.viewTween.source.position,this.tiles.update(),this.view.focusOnTree(0),this.view2.focusOnTree(0))},onViewTweenStart:function(){dom.display(this.tiles.ehelpers,!0)},onViewTweenComplete:function(){this.splitScreen||(this.view2.setTree(null),this.sampleView2=null),dom.display(this.tiles.ehelpers,this.splitScreen)},onExplode:function(e){function t(){var n=i[o++];if(n){for(var s=[],r=0;r<n.length;r++){var a=n[r],l=new Defer;a.events.once("connect_end",l.resolve,l),a.playConnection(e?0:1,.4),s.push(l)}this.explodeStepDefer=Defer.all(s).then(t,this)}}this.explodeStepDefer&&(this.explodeStepDefer.abort(),delete this.explodeStepDefer);var n=this.view.tree||this.view2.tree;if(n)if(this.explodeStepped){var i=[],o=0;n.traverseConnections(function(e,t,n){e.connected&&e.master&&(i[n]||(i[n]=[]),i[n].push(e))}),t.call(this)}else n.traverseConnections(function(t){t.connected&&t.master&&t.playConnection(e?0:1)})},displayFigure:function(e){var t=f.apick(this.sampler.samples,"src",e);if(t&&(e=t),this.issuedReplace&&(delete this.issuedReplace,this.litModeClear()),this.sampleView2!==e){this.tree||"viewer"===this.mode?this.sampleView2=e:this.sampleView2=null,this.splitScreen=!!this.sampleView2,this.splitViewMessageVisible.set(this.splitScreen,"g_svm_screen"),this.emptyViewMessageVisible.set(!this.tree&&!e,"g_evm_tree"),this.view.enableRaycast=!this.splitScreen,this.view.hoverNode(null),this.view.selectNode(null),this.view.selectConnection(null),this.view2.setTree(null);var n=this.splitScreen?.5:1;n!==this.viewTween.target.position&&(this.viewTween.target.position=n,this.viewTween.start()),this.updateMarkerVisibility(),e&&(this.sampleView2?this.constructNode(e,this.view2).then(this.setTree2,this.constructError,this):this.constructNode(e,this.view).then(this.setTree1,this.constructError,this))}},isComplexFigure:function(e){return e&&e.types&&e.types.length},constructNode:function(e,t){if(this.ready.pending)return this.ready.then(f.binda(this.constructNode,this,arguments));if(t&&t.setPreloader(null),e instanceof Sample)return t&&t.setPreloader([e]),e.load().then(TNode.New);if(this.isComplexFigure(e)){var n=TSerial.prepareSamples(e.types,this.sampler);return t&&t.setPreloader(n),Defer.all(n.map(f.func("load"))).then(function(){return TSerial.constructJSON(e,n,!1)},this)}return Defer.complete(!1,"bad sample")},constructError:function(e){this.events.emit("onAddElement",{status:"error",error:e})},setTree2:function(e){e&&(this.view2.setTree(e),this.updateConnectionGroups(this.tree,e),this.updateMarkerVisibility())},setTree1:function(e){if(this.absolutelySetMainTree(e),e){var t=[];e.traverse(function(e){t.push(e.id)}),this.events.emit("onAddElement",{status:"connected",root:e,nodes:t})}},getElementIdList:function(){var e=[];return this.tree.traverse(function(t){e.push(t.id)},this),e},getElementById:function(e){var t=null;return this.tree.traverse(function(n){if(n.id===e)return t=n,TNode.TRSTOP}),t},updateMarkerVisibility:function(){var e=this.debug||this.view2.tree;this.view.markers.markersVisible.set(!!e,"g_m_split"),this.view2.markers.markersVisible.set(!!e,"g_m_split")},updateConnectionGroups:function(e,t){this.cons=e&&e.retrieveConnections({connected:!1},!0)||[],this.cons2=t&&t.retrieveConnections({connected:!1},!0)||[];for(var n=[],i=0;i<this.cons2.length;i++)this.cons2[i].group=-1;for(var i=0;i<this.cons.length;i++){var o=this.cons[i],s=o.canConnectList(this.cons2);if(o.group=-1,s.length){for(var r=!1,a=0;a<n.length;a++)if(f.seq(s,n[a])){o.group=a,r=!0;break}if(!r){var l=n.length;o.group=l;for(var a=0;a<s.length;a++)s[a].group=l;n.push(s)}}}this.hasAvailableConnections=n.length,this.splitViewMessageVisible.set(!this.hasAvailableConnections,"g_svm_cons"),this.updateSplitViewMessagePosition(),this.updateConnectionVisibilitySets(),this.hasAvailableConnections||this.events.emit("onAddElement",{status:"rejected"}),this.view.needsRetrace=!0},updateConnectionVisibilitySets:function(){if(this.cons)for(var e=0;e<this.cons.length;e++)this.updateConnectionVisibility(this.cons[e],this.connectionParts[1]);if(this.cons2)for(var e=0;e<this.cons2.length;e++)this.updateConnectionVisibility(this.cons2[e],this.connectionParts[0])},updateConnectionVisibility:function(e,t){var n=e.group!==-1,i=!t||e.canConnect(t);e.inactive.set(!n||!i,"view2"),e.marker&&(e.marker.visible.set(!this.hasAvailableConnections||n,"active"),e.marker.updateState())},connectRandomNode:function(){var e=f.sort(this.sampler.samples.slice(),Math.random);if(!this.tree)return this.constructNode(e[0],this.view).then(this.setTree1,this.constructError,this);var t=this.tree.retrieveConnections({connected:!1},!0);f.sort(t,Math.random);for(var n=0;n<t.length;n++)for(var i=t[n],o=i.joint,s=0;s<e.length;s++){var r=e[s];if(r.object)for(var a=0;a<r.joints.length;a++){var l=r.joints[a];if(o.canConnect(l))return void this.constructNode(r,this.view).then(function(e){this.makeViewConnection(i,e.connections[a],!0)},this.constructError,this)}else r.load()}},connectNode:function(e){if(e){if(!this.tree)return this.setTree1(e);var t=this.tree.retrieveConnections({connected:!1},!0);f.sort(t,Math.random);e:for(var n=0;n<t.length;n++)for(var i=t[n],o=0;o<e.connections.length;o++){var s=e.connections[o];if(s.canConnect(i)){this.makeViewConnection(i,s,!0);break e}}this.splitScreen&&this.updateConnectionGroups(this.tree,this.view2.tree)}},connectElement:function(e,t,n,i,o){var s=this.getSample(e);if(!s)return this.connectElementError("src",{src:e});var r=this.getElementById(n);if(!r)return this.connectElementError("id",{id:n});var a=r.connections[i];return a?a.connected?this.connectElementError("used",{type:r.type,index:i}):void this.constructNode(s).then(function(e){var n=e.connections[t];return n?a.canConnect(n)?void this.makeViewConnection(a,n,o,"onConnectElement"):this.connectElementError("match",{typeA:e.type,indexA:t,typeB:r.type,indexB:i}):this.connectElementError("con",{type:e.type,index:t})},function(e){this.connectElementError("raw",e)},this):this.connectElementError("con",{type:r.type,index:i})},connectElementError:function(e,t){var n={src:"bad element src: [#{src}]",id:"invalid node id: [#{id}]",con:"node [#{type}] don't have connection: [#{index}]",used:"connection [#{type}][#{index}] already used",match:"connections [#{typeA}][#{indexA}] and [#{typeB}][#{indexB}] don't match"};this.events.emit("onConnectElement",{status:"rejected",reason:"raw"===e?t:f.implode(n[e]||"unknown error",t)})},onkey:function(e){if(e.ctrlKey||e.shiftKey||e.altKey);else if(kbd.down&&kbd.changed)switch(kbd.key){case"ENTER":return void(this.deletePromptTip.visible.value&&this.deleteNode());case"ESC":return void(this.deletePromptTip.visible.value&&this.closeDeletePrompt());case"DEL":return void this.promptDeleteNode(this.view.nodeSelected);case"u":return void(location.hash=this.exportString());case"x":this.debug=!this.debug,this.imagery.materials.subtract.visible=!!this.debug,this.imagery.materials.norcon.visible=!!this.debug,this.updateMarkerVisibility();break;case"r":this.onViewClear();break;case"e":this.preloadAllSamples(),this.emptyViewMessageVisible.off("g_evm_tree");break;case"v":return void(this.gui.closed?this.gui.open():this.gui.close())}this.view.onKey(e),this.view2.onKey(e)},replaceNode:function(e,t,n){return e&&t&&e.canBeReplacedBy(t)?this.constructNode(t).then(function(t){return t.replace(e),this.absolutelySetMainTree(e.upcon?this.view.tree:t),n&&this.view.selectNode(t),t},function(e){this.events.emit("onReplaceElement",{status:"rejected",reason:"construct error",error:e})},this):Defer.complete(!1,"bad replacement")},getNodeReplacers:function(e,t){var n=[];if(e)for(var i=0;i<t.length;i++){var o=t[i];e.canBeReplacedBy(o)&&n.push(o)}return n},preloadAllSamples:function(){this.sampler.samples.forEach(f.func("load")),this.view.setPreloader(this.sampler.samples)},rotateNode:function(e){e&&(e.rotate(Math.PI/6),this.view.needsRedraw=!0)},promptDeleteNode:function(e){if(e){var t=this.deletePromptStat=e.pinch();t.nodes.length<2?this.deleteNode():(dom.text(this.deletePromptTipText,["Do you want to delete",t.nodes.length,"nodes?"].join(" ")),this.deletePromptTip.visible.on())}},closeDeletePrompt:function(){this.deletePromptTip.visible.off(),delete this.deletePromptStat},clearTree:function(){this.tree&&(this.deletePromptStat=this.tree.pinchr(),this.deleteNode())},absolutelySetMainTree:function(e){this.tree=e;var t="constructor"===this.mode?this.view:this.view2;t.setTree(this.tree),this.emptyViewMessageVisible.set(!this.tree,"g_evm_tree")},deleteNode:function(){var e=this.deletePromptStat;e&&(e.root.disconnect(),e.nextRoot&&e.nextRoot!==e.root?(e.nextRoot.upnode=null,e.nextRoot.upcon=null,this.absolutelySetMainTree(e.nextRoot)):this.absolutelySetMainTree(null),this.view.selectNode(null),this.closeDeletePrompt(),this.events.emit("onRemoveElement",e))},onresize:function(){var e=this.tiles.element,t=e.offsetWidth||1,n=e.offsetHeight||1;this.renderer.setSize(t,n),this.tiles.autoresize(),this.view.resizeRenderTargets(t,n),this.view.resizeShaders(t,n)},updateSplitViewMessagePosition:function(){if(this.splitView){var e=this.splitViewMessage,t=this.splitView,n=e.offsetWidth,i=e.offsetHeight,o=t.split===TileView.VERTICAL_SPLIT?.5:t.position,s=t.split===TileView.HORIZONTAL_SPLIT?.5:t.position,r=t.x+t.w*o-n/2,a=t.y+t.h*s-i/2;e.style.left=r+"px",e.style.top=a+.3*t.h+"px"}},onTilesUpdate:function(){this.hasAvailableConnections||this.updateSplitViewMessagePosition()},onTap:function(e){this.deletePromptTip.visible.value&&(dom.ancestor(e.target,this.deletePromptTip.element)||dom.ancestor(e.target,this.view.markers.element)||this.closeDeletePrompt())},onDragOver:function(e){(this.catchFiles||this.catchSamples)&&(e.dataTransfer.dropEffect="copy",e.preventDefault())},onDrop:function(e){var t=e.dataTransfer;if(t.files&&t.files.length)this.catchFiles&&this.importFile(t.files[0]);else if(this.catchSamples){var n=t.getData("text/sid"),i=f.apick(this.sampler.samples,"src",n);i&&this.constructNode(i,this.view).then(this.connectNode,this.constructError,this)}e.preventDefault()},importFile:function(e){return this.sampler.readFile(e).then(this.onSampleImport,this.onSampleImportFail,this)},onSampleImport:function(e){return this.events.emit("onImportElement",e),e},onSampleImportFail:function(e){console.warn("File import error:",e)},onNodeSelect:function(e,t){var n=this.view.markers;if(t&&t.nodeMarker&&(n.removeMarker(t.nodeMarker),t.nodeMarker.destroy(),t.nodeMarker=null),e&&e.lit&&this.issuedReplace)return this.replaceNode(e,this.issuedReplace,!0),this.litModeClear(),void delete this.issuedReplace;if(e){var i=new UI.Marker({undisposable:!0,deleteNode:e,align:"bottom"});n.addMarker(i),i.visible.on("main"),dom.remclass(i.content,"marker-interactive"),dom.text(i.elemInfo,"["+e.id+"] "+e.sample.src),dom.addclass(i.elemInfo,"marker-label"),i.bRot=dom.div("marker-action",i.content),i.bDel=dom.div("marker-action",i.content),i.watchEvents.push(new EventHandler(this.rotateNode,this,e).listen("tap",i.bRot),new EventHandler(this.promptDeleteNode,this,e).listen("tap",i.bDel)),i.watchAtlas.push(Atlas.set(i.bRot,"i-rotate"),Atlas.set(i.bDel,"i-delete")),e.sample.link&&(i.bInfo=dom.a(e.sample.link,"marker-action out-02",i.content),i.bInfo.setAttribute("target","_blank"),i.watchAtlas.push(Atlas.set(i.bInfo,"i-info"))),e.nodeMarker=i,kbd.state.SHIFT||this.view.focusOnNode(e)}this.events.emit("onNodeSelect",[e&&e.id,t&&t.id])},onConnectionSelect:function(e,t,n){this.connectionParts[t]=n,this.updateConnectionVisibilitySets();var i=this.connectionParts[0],o=this.connectionParts[1];i&&o&&this.makeViewConnection(i,o,!0)},makeViewConnection:function(e,t,n,i){this.view.selectConnection(null),this.view2.selectConnection(null),this.view2.setTree(null);var o=[];t.node.traverse(function(e){o.push(e.id)}),t.object.updateMatrixWorld(),e.node.connect(e.index,t.node,t.index),this.view.setTree(this.tree),this.displayFigure(null),n&&e.playConnection(),this.events.emit(i||"onAddElement",{status:"connected",root:t.node,nodes:o})},removeSample:function(e){var t=f.apick(this.sampler.samples,"src",e);t&&f.adrop(this.sampler.samples,t)},run:function(){this.makeGUI(),new EventHandler(this.onresize,this).listen("resize",window),new EventHandler(this.onkey,this).listen("keydown",window),new EventHandler(this.onkey,this).listen("keyup",window),new EventHandler(this.onTap,this).listen("tap",window),new EventHandler(this.onDragOver,this).listen("dragover",this.view.element),new EventHandler(this.onDragOver,this).listen("dragover",this.view2.element),new EventHandler(this.onDrop,this).listen("drop",this.view.element),new EventHandler(this.onDrop,this).listen("drop",this.view2.element),
this.tiles.events.on("update",this.onTilesUpdate,this),this.view.events.on("connection_select",this.onConnectionSelect,this,[this.view,0]),this.view2.events.on("connection_select",this.onConnectionSelect,this,[this.view2,1]),this.view.events.on("view_clear",this.onViewClear,this),this.view2.events.on("view_clear",this.onViewClear2,this),this.view.events.on("node_select",this.onNodeSelect,this),dom.display(this.canvas,!0),this.onresize(),this.view.onTick(0),this.view2.onTick(0),"function"==typeof bootProgress&&bootProgress(1),this.ready.resolve(!0),this.initFromHash&&this.loadFromHash(),this.timer.play()},loadFromHash:function(){var e=location.hash.slice(1);if(e)try{this.importString(e,!0),location.hash=""}catch(e){console.warn("loadFromHash failed:",e)}},onHash:function(){this.loadFromHash()},onTick:function(e,t){if(kbd.state.t&&this.connectRandomNode(),this.view.onTick(t),this.view2.onTick(t),this.view.nodeSelected){var n=this.view.nodeSelected.nodeMarker;n.point.world.setFromMatrixPosition(this.view.nodeSelected.objectCenter.matrixWorld),this.view.projector.updatePoint(n.point),n.update()}if(this.deletePromptStat){var i=this.deletePromptStat.root,o=this.deletePromptTip.point;o.world.setFromMatrixPosition(i.objectCenter.matrixWorld),this.view.projector.updatePoint(o),this.deletePromptTip.move(Math.round(o.screen.x),Math.round(o.screen.y))}}});